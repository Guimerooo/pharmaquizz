<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PharmaSpace</title>
  <style>
    * {showAnswer &&  margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    </style>
</head>
<body>
  <div id="root"></div>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ========== FIREBASE CONFIGURATION ==========
    const firebaseConfig = {
      apiKey: "AIzaSyCIOU8mbcdOM8NaPfGqjv1PccCb63UlU6A",
      authDomain: "pharmaspace-a13af.firebaseapp.com",
      databaseURL: "https://pharmaspace-a13af-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "pharmaspace-a13af",
      storageBucket: "pharmaspace-a13af.firebasestorage.app",
      messagingSenderId: "596839487470",
      appId: "1:596839487470:web:d0948c48de44f7c7fb60ff"
    };

    // Initialize Firebase
    let firebaseApp;
    let db;
    let firebaseEnabled = false;

    try {
      firebaseApp = firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      firebaseEnabled = true;
      console.log('üî• Firebase initialis√© avec succ√®s !');
    } catch (error) {
      console.error('‚ùå Erreur Firebase:', error);
      firebaseEnabled = false;
    }

    // ========== FIREBASE SYNC FUNCTIONS ==========
    
    // Helper pour sauvegarder dans Firebase ET localStorage
    const saveToFirebase = async (path, data) => {
      if (firebaseEnabled) {
        try {
          await db.ref(path).set(data);
          console.log(`üî• Sauvegard√© sur Firebase: ${path}`);
        } catch (error) {
          console.error(`‚ùå Erreur sauvegarde Firebase ${path}:`, error);
        }
      }
      // Toujours sauvegarder en local comme backup
      localStorage.setItem(`pharmaspace_${path}`, JSON.stringify(data));
    };

    // Helper pour charger depuis Firebase avec fallback localStorage
    const loadFromFirebase = async (path, defaultValue) => {
      // D'abord essayer localStorage pour un chargement rapide
      const localData = localStorage.getItem(`pharmaspace_${path}`);
      let initialData = localData ? JSON.parse(localData) : defaultValue;

      // Puis √©couter Firebase pour les mises √† jour
      if (firebaseEnabled) {
        db.ref(path).on('value', (snapshot) => {
          const firebaseData = snapshot.val();
          if (firebaseData) {
            console.log(`üî• Donn√©es re√ßues de Firebase: ${path}`);
            // Mettre √† jour localStorage
            localStorage.setItem(`pharmaspace_${path}`, JSON.stringify(firebaseData));
          }
        });
      }

      return initialData;
    };

    // Fonction pour migrer les donn√©es existantes vers Firebase
    const migrateToFirebase = async () => {
      if (!firebaseEnabled) {
        alert('‚ùå Firebase n\'est pas activ√© !');
        return;
      }

      try {
        console.log('üîÑ Migration vers Firebase...');

        // R√©cup√©rer toutes les donn√©es du localStorage
        const medications = localStorage.getItem('pharmaspace_medications');
        const classes = localStorage.getItem('pharmaspace_classes');
        const forms = localStorage.getItem('pharmaspace_forms');
        const conseilsCategories = localStorage.getItem('conseilsCategories');
        const conseilsOfficine = localStorage.getItem('conseilsOfficine');

        // Envoyer sur Firebase
        const updates = {};
        if (medications) updates['medications'] = JSON.parse(medications);
        if (classes) updates['classes'] = JSON.parse(classes);
        if (forms) updates['forms'] = JSON.parse(forms);
        if (conseilsCategories) updates['conseilsCategories'] = JSON.parse(conseilsCategories);
        if (conseilsOfficine) updates['conseilsOfficine'] = JSON.parse(conseilsOfficine);

        // Migrer aussi les cat√©gories de documents
        const plaintes = conseilsOfficine ? JSON.parse(conseilsOfficine) : [];
        const docCategories = {};
        plaintes.forEach(plainte => {
          const savedCategories = localStorage.getItem('docCategories_' + plainte.id);
          if (savedCategories) {
            docCategories[plainte.id] = JSON.parse(savedCategories);
          }
        });
        if (Object.keys(docCategories).length > 0) {
          updates['docCategories'] = docCategories;
        }

        // Envoyer tout en une fois
        await db.ref().update(updates);

        console.log('‚úÖ Migration termin√©e !');
        alert('‚úÖ Migration vers Firebase r√©ussie !\n\nüî• Vos donn√©es sont maintenant synchronis√©es en temps r√©el sur tous vos appareils.');
      } catch (error) {
        console.error('‚ùå Erreur migration:', error);
        alert('‚ùå Erreur lors de la migration : ' + error.message);
      }
    };

    // ========== CODE CONSEILS OFFICINE ==========

    const INITIAL_CATEGORIES = [
      "Syst√®me respiratoire",
      "Douleurs & Fi√®vre",
      "Syst√®me digestif",
      "Bouche & Peau"
    ];

    const INITIAL_PLAINTES = [
      { id: "rhume", nom: "Rhume", categorie: "Syst√®me respiratoire", emoji: "ü§ß", couleur: "#3B82F6", description: "√âcoulement nasal, congestion", specialites: [], informations: "", documents: [] },
      { id: "toux", nom: "Toux", categorie: "Syst√®me respiratoire", emoji: "üò∑", couleur: "#06B6D4", description: "Toux s√®che ou grasse", specialites: [], informations: "", documents: [] },
      { id: "gorge", nom: "Maux de gorge", categorie: "Syst√®me respiratoire", emoji: "ü§í", couleur: "#0EA5E9", description: "Irritation, douleur", specialites: [], informations: "", documents: [] },
      { id: "tete", nom: "Maux de t√™te", categorie: "Douleurs & Fi√®vre", emoji: "ü§ï", couleur: "#EF4444", description: "C√©phal√©es, migraines", specialites: [], informations: "", documents: [] },
      { id: "fievre", nom: "Fi√®vre", categorie: "Douleurs & Fi√®vre", emoji: "üå°Ô∏è", couleur: "#F97316", description: "Temp√©rature > 38¬∞C", specialites: [], informations: "", documents: [] },
      { id: "nausees", nom: "Naus√©es", categorie: "Syst√®me digestif", emoji: "ü§¢", couleur: "#10B981", description: "Envie de vomir", specialites: [], informations: "", documents: [] },
      { id: "estomac", nom: "Br√ªlures d'estomac", categorie: "Syst√®me digestif", emoji: "üî•", couleur: "#F59E0B", description: "Reflux gastrique", specialites: [], informations: "", documents: [] },
      { id: "constipation", nom: "Constipation", categorie: "Syst√®me digestif", emoji: "üí©", couleur: "#84CC16", description: "Difficult√© √† aller √† la selle", specialites: [], informations: "", documents: [] },
      { id: "diarrhee", nom: "Diarrh√©e", categorie: "Syst√®me digestif", emoji: "üöΩ", couleur: "#14B8A6", description: "Selles liquides", specialites: [], informations: "", documents: [] },
      { id: "aphte", nom: "Aphte", categorie: "Bouche & Peau", emoji: "üò£", couleur: "#EC4899", description: "Ulc√©ration buccale", specialites: [], informations: "", documents: [] },
      { id: "herpes", nom: "Boutons de fi√®vre", categorie: "Bouche & Peau", emoji: "üòñ", couleur: "#F43F5E", description: "Herp√®s labial", specialites: [], informations: "", documents: [] },
      { id: "ampoules", nom: "Cloche aux pieds", categorie: "Bouche & Peau", emoji: "ü¶∂", couleur: "#8B5CF6", description: "Ampoules", specialites: [], informations: "", documents: [] },
      { id: "piercing", nom: "Piercing aux oreilles", categorie: "Bouche & Peau", emoji: "üëÇ", couleur: "#A855F7", description: "Soins post-piercing", specialites: [], informations: "", documents: [] }
    ];

    const EditIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
        <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
      </svg>
    );

    const DeleteIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
      </svg>
    );

    const LinkIcon = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/>
        <path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/>
      </svg>
    );

    function parseContent(content, couleur) {
      if (!content) return [];

      const lines = content.split('\n');
      const elements = [];
      let i = 0;

      while (i < lines.length) {
        const line = lines[i];
        
        // D√©tecter l'indentation (espaces en d√©but de ligne)
        const indentMatch = line.match(/^(\s+)/);
        const indentLevel = indentMatch ? indentMatch[1].length : 0;

        if (line.trim() === '[row]') {
          const rowContent = [];
          i++;
          while (i < lines.length && lines[i].trim() !== '[/row]') {
            rowContent.push(lines[i]);
            i++;
          }
          
          const rowElements = [];
          rowContent.forEach(rowLine => {
            const imgMatch = rowLine.match(/\[img-(small|medium|large)\](https?:\/\/[^\[]+)\[\/img-(small|medium|large)\]/) ||
                            rowLine.match(/\[img\](https?:\/\/[^\[]+)\[\/img\]/);
            
            if (imgMatch) {
              const size = imgMatch[1] || 'full';
              const url = imgMatch[2] || imgMatch[1];
              rowElements.push({ type: 'image', url, size });
            }
          });

          if (rowElements.length > 0) {
            elements.push({ type: 'row', items: rowElements });
          }
          i++;
          continue;
        }

        const imgCenterSmall = line.match(/\[img-center-small\](https?:\/\/[^\[]+)\[\/img-center-small\]/);
        const imgCenterMedium = line.match(/\[img-center-medium\](https?:\/\/[^\[]+)\[\/img-center-medium\]/);
        const imgCenterLarge = line.match(/\[img-center-large\](https?:\/\/[^\[]+)\[\/img-center-large\]/);
        const imgCenterFull = line.match(/\[img-center\](https?:\/\/[^\[]+)\[\/img-center\]/);

        const imgSmall = line.match(/\[img-small\](https?:\/\/[^\[]+)\[\/img-small\]/);
        const imgMedium = line.match(/\[img-medium\](https?:\/\/[^\[]+)\[\/img-medium\]/);
        const imgLarge = line.match(/\[img-large\](https?:\/\/[^\[]+)\[\/img-large\]/);
        const imgFull = line.match(/\[img\](https?:\/\/[^\[]+)\[\/img\]/);

        if (imgCenterSmall) {
          elements.push({ type: 'image', url: imgCenterSmall[1], size: 'small', centered: true });
        } else if (imgCenterMedium) {
          elements.push({ type: 'image', url: imgCenterMedium[1], size: 'medium', centered: true });
        } else if (imgCenterLarge) {
          elements.push({ type: 'image', url: imgCenterLarge[1], size: 'large', centered: true });
        } else if (imgCenterFull) {
          elements.push({ type: 'image', url: imgCenterFull[1], size: 'full', centered: true });
        } else if (imgSmall) {
          elements.push({ type: 'image', url: imgSmall[1], size: 'small' });
        } else if (imgMedium) {
          elements.push({ type: 'image', url: imgMedium[1], size: 'medium' });
        } else if (imgLarge) {
          elements.push({ type: 'image', url: imgLarge[1], size: 'large' });
        } else if (imgFull) {
          elements.push({ type: 'image', url: imgFull[1], size: 'full' });
        } else if (line.startsWith('http') && (line.match(/\.(jpg|jpeg|png|gif|webp)$/i) || line.includes('imgur') || line.includes('ibb.co'))) {
          elements.push({ type: 'image', url: line, size: 'full' });
        } else if (line.startsWith('http')) {
          elements.push({ type: 'link', url: line });
        } else {
          elements.push({ type: 'text', content: line.trimEnd(), indent: indentLevel });
        }

        i++;
      }

      return elements;
    }

    function renderParsedContent(elements, couleur) {
      return elements.map((el, idx) => {
        if (el.type === 'row') {
          return (
            <div key={idx} style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap', margin: '1rem 0' }}>
              {el.items.map((item, itemIdx) => {
                const width = item.size === 'small' ? '30%' : item.size === 'medium' ? '48%' : item.size === 'large' ? '70%' : '100%';
                return (
                  <img
                    key={itemIdx}
                    src={item.url}
                    alt="Image"
                    style={{
                      width: width,
                      minWidth: '150px',
                      borderRadius: '8px',
                      boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                      objectFit: 'cover'
                    }}
                  />
                );
              })}
            </div>
          );
        } else if (el.type === 'image') {
          const sizeMap = {
            'small': '30%',
            'medium': '50%',
            'large': '70%',
            'full': '100%'
          };
          const width = sizeMap[el.size] || '100%';
          const isInline = el.size === 'small' || el.size === 'medium';

          if (el.centered) {
            return (
              <div key={idx} style={{ textAlign: 'center', margin: '1rem 0' }}>
                <img
                  src={el.url}
                  alt="Image"
                  style={{
                    width: width,
                    maxWidth: '100%',
                    borderRadius: '8px',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                    display: 'inline-block'
                  }}
                />
              </div>
            );
          }

          return (
            <img
              key={idx}
              src={el.url}
              alt="Image"
              style={{
                width: width,
                maxWidth: '100%',
                borderRadius: '8px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                margin: '0.5rem 0',
                display: isInline ? 'inline-block' : 'block',
                marginRight: isInline ? '1rem' : '0',
                verticalAlign: 'top'
              }}
            />
          );
        } else if (el.type === 'link') {
          return (
            <div key={idx}>
              <a href={el.url} target="_blank" style={{ color: couleur, textDecoration: 'underline' }}>
                {el.url}
              </a>
            </div>
          );
        } else {
          // Parser le formatage du texte avec indentation
          const marginLeft = (el.indent || 0) * 10; // 10px par espace
          return <div key={idx} style={{ marginLeft: `${marginLeft}px` }}>{parseFormattedText(el.content || '\u00A0')}</div>;
        }
      });
    }

    function parseFormattedText(text) {
      if (!text || text === '\u00A0') return text;
      
      // Titres
      if (text.startsWith('### ')) {
        return <h3 style={{ fontSize: '1.1rem', fontWeight: 'bold', marginTop: '1rem', marginBottom: '0.5rem', color: '#1e293b' }}>{text.substring(4)}</h3>;
      }
      if (text.startsWith('## ')) {
        return <h2 style={{ fontSize: '1.3rem', fontWeight: 'bold', marginTop: '1.2rem', marginBottom: '0.6rem', color: '#1e293b' }}>{text.substring(3)}</h2>;
      }
      if (text.startsWith('# ')) {
        return <h1 style={{ fontSize: '1.5rem', fontWeight: 'bold', marginTop: '1.5rem', marginBottom: '0.7rem', color: '#1e293b' }}>{text.substring(2)}</h1>;
      }
      
      // Listes
      if (text.startsWith('- ') || text.startsWith('‚Ä¢ ')) {
        return <li style={{ marginLeft: '1.5rem' }}>{parseInlineFormatting(text.substring(2))}</li>;
      }
      if (/^\d+\.\s/.test(text)) {
        const content = text.replace(/^\d+\.\s/, '');
        return <li style={{ marginLeft: '1.5rem', listStyleType: 'decimal' }}>{parseInlineFormatting(content)}</li>;
      }
      
      // Texte normal avec formatage inline
      return parseInlineFormatting(text);
    }

    function parseInlineFormatting(text) {
      const parts = [];
      let remaining = text;
      let key = 0;

      while (remaining.length > 0) {
        // Couleurs
        const colorRedMatch = remaining.match(/^\[color-red\](.*?)\[\/color-red\]/);
        const colorBlueMatch = remaining.match(/^\[color-blue\](.*?)\[\/color-blue\]/);
        const colorGreenMatch = remaining.match(/^\[color-green\](.*?)\[\/color-green\]/);
        const colorOrangeMatch = remaining.match(/^\[color-orange\](.*?)\[\/color-orange\]/);
        
        // Gras
        const boldMatch = remaining.match(/^\*\*(.*?)\*\*/);
        
        // Italique
        const italicMatch = remaining.match(/^\*(.*?)\*/);
        
        // Soulign√©
        const underlineMatch = remaining.match(/^__(.*?)__/);
        
        // Barr√©
        const strikeMatch = remaining.match(/^~~(.*?)~~/);
        
        if (colorRedMatch) {
          parts.push(<span key={key++} style={{ color: '#dc2626', fontWeight: 600 }}>{colorRedMatch[1]}</span>);
          remaining = remaining.substring(colorRedMatch[0].length);
        } else if (colorBlueMatch) {
          parts.push(<span key={key++} style={{ color: '#1d4ed8', fontWeight: 600 }}>{colorBlueMatch[1]}</span>);
          remaining = remaining.substring(colorBlueMatch[0].length);
        } else if (colorGreenMatch) {
          parts.push(<span key={key++} style={{ color: '#047857', fontWeight: 600 }}>{colorGreenMatch[1]}</span>);
          remaining = remaining.substring(colorGreenMatch[0].length);
        } else if (colorOrangeMatch) {
          parts.push(<span key={key++} style={{ color: '#c2410c', fontWeight: 600 }}>{colorOrangeMatch[1]}</span>);
          remaining = remaining.substring(colorOrangeMatch[0].length);
        } else if (boldMatch) {
          parts.push(<strong key={key++}>{boldMatch[1]}</strong>);
          remaining = remaining.substring(boldMatch[0].length);
        } else if (underlineMatch) {
          parts.push(<u key={key++}>{underlineMatch[1]}</u>);
          remaining = remaining.substring(underlineMatch[0].length);
        } else if (strikeMatch) {
          parts.push(<s key={key++}>{strikeMatch[1]}</s>);
          remaining = remaining.substring(strikeMatch[0].length);
        } else if (italicMatch && !remaining.startsWith('**')) {
          parts.push(<em key={key++}>{italicMatch[1]}</em>);
          remaining = remaining.substring(italicMatch[0].length);
        } else {
          parts.push(remaining[0]);
          remaining = remaining.substring(1);
        }
      }

      return parts.length > 0 ? <>{parts}</> : text;
    }

    function getPharmaQuizzMed(dci, nomCommercial) {
      if (!dci && !nomCommercial) return null;
      try {
        const flashcards = JSON.parse(localStorage.getItem('pharmaspace_medications') || '[]');
        
        // Essai 1: Correspondance exacte DCI
        if (dci) {
          let med = flashcards.find(f => f.dci.toLowerCase() === dci.toLowerCase());
          if (med) return med;
          
          // Essai 2: DCI contient (pour g√©rer les associations)
          med = flashcards.find(f => {
            const dciNorm = dci.toLowerCase().trim();
            const fDciNorm = f.dci.toLowerCase().trim();
            return dciNorm.includes(fDciNorm) || fDciNorm.includes(dciNorm);
          });
          if (med) return med;
        }
        
        // Essai 3: Correspondance nom commercial
        if (nomCommercial) {
          const nomNorm = nomCommercial.toLowerCase().trim();
          let med = flashcards.find(f => 
            f.commercial && f.commercial.some(c => c.toLowerCase() === nomNorm)
          );
          if (med) return med;
          
          // Essai 4: Nom commercial partiel
          med = flashcards.find(f => 
            f.commercial && f.commercial.some(c => {
              const cNorm = c.toLowerCase();
              return nomNorm.includes(cNorm) || cNorm.includes(nomNorm);
            })
          );
          if (med) return med;
        }
        
        return null;
      } catch (e) {
        console.error('Erreur getPharmaQuizzMed:', e);
        return null;
      }
    }

    function PlainteCard({ plainte, index, totalCount, categorie, setSelectedPlainte, setEditingPlainte, setShowAddPlainte, deletePlainte, movePlainteUp, movePlainteDown, isOnline = true }) {
      const [showMenu, setShowMenu] = React.useState(false);
      const [isHovered, setIsHovered] = React.useState(false);
      const [menuPosition, setMenuPosition] = React.useState({ top: 0, left: 0 });
      const buttonRef = React.useRef(null);
      const nbSpecialites = plainte.specialites?.length || 0;
      const nbDocuments = plainte.documents?.length || 0;
      const nbFichesConseils = plainte.fichesConseils?.length || 0;
      const hasInfo = nbSpecialites > 0 || nbDocuments > 0 || nbFichesConseils > 0;
      
      const handleMenuToggle = (e) => {
        e.stopPropagation();
        if (!showMenu && buttonRef.current) {
          const rect = buttonRef.current.getBoundingClientRect();
          setMenuPosition({
            top: rect.top,
            left: rect.left - 190 // 180px width + 10px margin
          });
        }
        setShowMenu(!showMenu);
      };
      
      return (
        <div
          style={{
            background: 'white',
            border: '1px solid #e2e8f0',
            borderLeft: `4px solid ${plainte.couleur}`,
            borderRadius: '8px',
            padding: '1rem 1.25rem',
            transition: 'all 0.2s',
            cursor: 'pointer',
            position: 'relative',
            boxShadow: '0 1px 3px rgba(0,0,0,0.06)',
            minHeight: '80px',
            display: 'flex',
            flexDirection: 'column',
            justifyContent: 'center'
          }}
          onClick={() => setSelectedPlainte(plainte)}
          onMouseEnter={(e) => {
            e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
            e.currentTarget.style.transform = 'translateY(-2px)';
            setIsHovered(true);
          }}
          onMouseLeave={(e) => {
            e.currentTarget.style.boxShadow = '0 1px 3px rgba(0,0,0,0.06)';
            e.currentTarget.style.transform = 'translateY(0)';
            setIsHovered(false);
            setShowMenu(false);
          }}
        >
          {/* Image + Titre */}
          <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: hasInfo ? '0.5rem' : 0 }}>
            {plainte.imageUrl && (
              <img 
                src={plainte.imageUrl} 
                alt={plainte.nom}
                style={{
                  width: '60px',
                  height: '60px',
                  borderRadius: '8px',
                  objectFit: 'cover',
                  flexShrink: 0
                }}
                onError={(e) => e.target.style.display = 'none'}
              />
            )}
            <h3 style={{
              margin: 0,
              fontSize: '1rem',
              fontWeight: 600,
              color: '#0f172a',
              paddingRight: '2.5rem',
              lineHeight: '1.4',
              flex: 1
            }}>
              {plainte.nom}
            </h3>
          </div>
          
          {/* Infos sp√©cialit√©s et documents */}
          {hasInfo && (
            <div style={{
              display: 'flex',
              gap: '0.5rem',
              fontSize: '0.7rem',
              color: '#94a3b8',
              fontWeight: 400,
              opacity: 0.85,
              alignItems: 'center'
            }}>
              {/* √âtoile jaune p√¢le discr√®te */}
              {plainte.starEnabled && (
                <span 
                  style={{ 
                    fontSize: '0.7rem',
                    opacity: 0.4
                  }}
                  title="Plainte marqu√©e"
                >
                  ‚≠ê
                </span>
              )}
              
              {nbSpecialites > 0 && (
                <span>{nbSpecialites} sp√©c{nbSpecialites > 1 ? 's' : ''}</span>
              )}
              {nbSpecialites > 0 && (nbDocuments > 0 || nbFichesConseils > 0) && (
                <span>‚Ä¢</span>
              )}
              {nbDocuments > 0 && (
                <span>{nbDocuments} doc{nbDocuments > 1 ? 's' : ''}</span>
              )}
              {nbDocuments > 0 && nbFichesConseils > 0 && (
                <span>‚Ä¢</span>
              )}
              {nbFichesConseils > 0 && (
                <span>{nbFichesConseils} fiche{nbFichesConseils > 1 ? 's' : ''}</span>
              )}
            </div>
          )}
          
          {/* Si seulement l'√©toile sans autre info */}
          {!hasInfo && plainte.starEnabled && (
            <div style={{
              display: 'flex',
              fontSize: '0.7rem',
              opacity: 0.85
            }}>
              <span 
                style={{ 
                  fontSize: '0.7rem',
                  opacity: 0.4
                }}
                title="Plainte marqu√©e"
              >
                ‚≠ê
              </span>
            </div>
          )}
          
          {/* Menu 3 points - appara√Æt au survol (uniquement si en ligne) */}
          {isOnline && (
          <div 
            style={{
              position: 'absolute',
              top: '50%',
              transform: 'translateY(-50%)',
              right: '1rem',
              opacity: isHovered || showMenu ? 1 : 0,
              transition: 'opacity 0.2s',
              pointerEvents: isHovered || showMenu ? 'auto' : 'none'
            }}
          >
            <button
              ref={buttonRef}
              onClick={handleMenuToggle}
              style={{
                background: '#f8fafc',
                border: '1px solid #e2e8f0',
                borderRadius: '6px',
                width: '32px',
                height: '32px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                cursor: 'pointer',
                color: '#64748b',
                fontSize: '1.1rem',
                fontWeight: 'bold',
                boxShadow: '0 2px 6px rgba(0,0,0,0.1)',
                padding: 0,
                transition: 'all 0.15s'
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.background = 'white';
                e.currentTarget.style.borderColor = '#cbd5e1';
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.background = '#f8fafc';
                e.currentTarget.style.borderColor = '#e2e8f0';
              }}
              title="Options"
            >
              ‚ãÆ
            </button>
          </div>
          )}
          
          {/* Dropdown menu - Rendu avec portal au niveau body (uniquement si en ligne) */}
          {isOnline && showMenu && ReactDOM.createPortal(
            <div
              onClick={(e) => e.stopPropagation()}
              style={{
                position: 'fixed',
                top: `${menuPosition.top}px`,
                left: `${menuPosition.left}px`,
                background: 'white',
                border: '1px solid #e2e8f0',
                borderRadius: '8px',
                boxShadow: '0 8px 24px rgba(0,0,0,0.25)',
                zIndex: 999999,
                minWidth: '180px',
                overflow: 'visible'
              }}
            >
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  setEditingPlainte(plainte);
                  setShowAddPlainte(true);
                  setShowMenu(false);
                }}
                style={{
                  width: '100%',
                  padding: '0.75rem 1rem',
                  border: 'none',
                  background: 'white',
                  textAlign: 'left',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.75rem',
                  fontSize: '0.875rem',
                  color: '#1e293b',
                  transition: 'background 0.15s',
                  fontWeight: 500
                }}
                onMouseEnter={(e) => e.currentTarget.style.background = '#f8fafc'}
                onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
              >
                <span style={{ fontSize: '1.1rem', opacity: 0.7 }}>‚úé</span>
                <span>Modifier</span>
              </button>
              
              <div style={{ height: '1px', background: '#f1f5f9', margin: '0 0.5rem' }} />
              
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  movePlainteUp(plainte.id, categorie);
                  setShowMenu(false);
                }}
                disabled={index === 0}
                style={{
                  width: '100%',
                  padding: '0.75rem 1rem',
                  border: 'none',
                  background: 'white',
                  textAlign: 'left',
                  cursor: index === 0 ? 'not-allowed' : 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.75rem',
                  fontSize: '0.875rem',
                  color: index === 0 ? '#cbd5e1' : '#1e293b',
                  transition: 'background 0.15s',
                  opacity: index === 0 ? 0.5 : 1,
                  fontWeight: 500
                }}
                onMouseEnter={(e) => index !== 0 && (e.currentTarget.style.background = '#f8fafc')}
                onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
              >
                <span style={{ fontSize: '1.1rem', opacity: 0.7 }}>‚Üë</span>
                <span>Monter</span>
              </button>
              
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  movePlainteDown(plainte.id, categorie);
                  setShowMenu(false);
                }}
                disabled={index === totalCount - 1}
                style={{
                  width: '100%',
                  padding: '0.75rem 1rem',
                  border: 'none',
                  background: 'white',
                  textAlign: 'left',
                  cursor: index === totalCount - 1 ? 'not-allowed' : 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.75rem',
                  fontSize: '0.875rem',
                  color: index === totalCount - 1 ? '#cbd5e1' : '#1e293b',
                  transition: 'background 0.15s',
                  opacity: index === totalCount - 1 ? 0.5 : 1,
                  fontWeight: 500
                }}
                onMouseEnter={(e) => index !== totalCount - 1 && (e.currentTarget.style.background = '#f8fafc')}
                onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
              >
                <span style={{ fontSize: '1.1rem', opacity: 0.7 }}>‚Üì</span>
                <span>Descendre</span>
              </button>
              
              <div style={{ height: '1px', background: '#f1f5f9', margin: '0 0.5rem' }} />
              
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  deletePlainte(plainte.id);
                  setShowMenu(false);
                }}
                style={{
                  width: '100%',
                  padding: '0.75rem 1rem',
                  border: 'none',
                  background: 'white',
                  textAlign: 'left',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.75rem',
                  fontSize: '0.875rem',
                  color: '#ef4444',
                  transition: 'background 0.15s',
                  fontWeight: 500
                }}
                onMouseEnter={(e) => e.currentTarget.style.background = '#fef2f2'}
                onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
              >
                <span style={{ fontSize: '1.1rem', opacity: 0.8 }}>‚úï</span>
                <span>Supprimer</span>
              </button>
            </div>,
            document.body
          )}
        </div>
      );
    }

    function ConseilsOfficine({ onReturnToMenu, medications, isOnline = true, handleOfflineAction = (action) => action() }) {
      const [categories, setCategories] = useState([]);
      const [plaintes, setPlaintes] = useState([]);
      const [plaintesRenderKey, setPlaintesRenderKey] = useState(0);
      const [selectedPlainteRaw, setSelectedPlainteRaw] = useState(null);
      
      // Wrapper pour normaliser automatiquement
      const setSelectedPlainte = (plainte) => {
        if (plainte === null) {
          setSelectedPlainteRaw(null);
        } else {
          setSelectedPlainteRaw({
            ...plainte,
            specialites: Array.isArray(plainte.specialites) ? plainte.specialites : []
          });
        }
      };
      
      const selectedPlainte = selectedPlainteRaw;
      const [searchTerm, setSearchTerm] = useState('');
      const [showCategoriesModal, setShowCategoriesModal] = useState(false);
      const [showAddPlainte, setShowAddPlainte] = useState(false);
      const [showImportMedModal, setShowImportMedModal] = useState(false);
      const [importSearchTerm, setImportSearchTerm] = useState('');
      const [editingPlainte, setEditingPlainte] = useState(null);
      const [showAddSpecialite, setShowAddSpecialite] = useState(false);
      const [editingSpecialite, setEditingSpecialite] = useState(null);
      const [imageModalUrl, setImageModalUrl] = useState(null);

      // DEBUG: V√©rifier selectedPlainte pour fiches probl√©matiques
      useEffect(() => {
        if (selectedPlainte && (selectedPlainte.nom === 'Antipalud√©ens' || selectedPlainte.nom === 'Antiparasiaires')) {
          console.group('üîç DEBUG Fiche: ' + selectedPlainte.nom);
          console.log('selectedPlainte:', selectedPlainte);
          console.log('specialites:', selectedPlainte.specialites);
          console.log('specialites type:', typeof selectedPlainte.specialites);
          console.log('specialites isArray:', Array.isArray(selectedPlainte.specialites));
          if (selectedPlainte.specialites) {
            selectedPlainte.specialites.forEach((spec, i) => {
              console.log('  Sp√©cialit√© ' + i + ':', spec);
              console.log('    - imageUrls:', spec.imageUrls, 'type:', typeof spec.imageUrls, 'isArray:', Array.isArray(spec.imageUrls));
              console.log('    - allImageUrls:', spec.allImageUrls, 'type:', typeof spec.allImageUrls, 'isArray:', Array.isArray(spec.allImageUrls));
            });
          }
          console.groupEnd();
        }
      }, [selectedPlainte]);

      useEffect(() => {
        const savedCat = localStorage.getItem('conseilsCategories');
        const savedPlaintes = localStorage.getItem('conseilsOfficine');
        
        if (savedCat) {
          setCategories(JSON.parse(savedCat));
        } else {
          setCategories(INITIAL_CATEGORIES);
          localStorage.setItem('conseilsCategories', JSON.stringify(INITIAL_CATEGORIES));
        }
        
        if (savedPlaintes) {
          const loadedPlaintes = JSON.parse(savedPlaintes);
          // Normaliser : s'assurer que chaque plainte a specialites
          const normalizedPlaintes = loadedPlaintes.map(p => ({
            ...p,
            specialites: Array.isArray(p.specialites) ? p.specialites : []
          }));
          setPlaintes(normalizedPlaintes);
        } else {
          setPlaintes(INITIAL_PLAINTES);
          localStorage.setItem('conseilsOfficine', JSON.stringify(INITIAL_PLAINTES));
        }
        
        // √âcouter Firebase pour les mises √† jour en temps r√©el
        if (firebaseEnabled) {
          const catRef = db.ref('conseilsCategories');
          catRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
              console.log('üî• Cat√©gories conseils mis √† jour depuis Firebase');
              setCategories(data);
              localStorage.setItem('conseilsCategories', JSON.stringify(data));
            }
          });
          
          const plaintesRef = db.ref('conseilsOfficine');
          plaintesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
              console.log('üî• Plaintes conseils mis √† jour depuis Firebase');
              setPlaintes(data);
              localStorage.setItem('conseilsOfficine', JSON.stringify(data));
              setPlaintesRenderKey(prev => prev + 1); // Forcer le re-render
              
              // D√©clencher l'√©v√©nement pour mettre √† jour le cache des flashcards
              window.dispatchEvent(new CustomEvent('plaintesUpdated'));
              console.log('üîÑ √âv√©nement plaintesUpdated dispatch√© (depuis Firebase)');
            }
          });
          
          return () => {
            catRef.off();
            plaintesRef.off();
          };
        }
      }, []);

      const saveCategories = (newCat) => {
        setCategories(newCat);
        localStorage.setItem('conseilsCategories', JSON.stringify(newCat));
        if (firebaseEnabled) {
          db.ref('conseilsCategories').set(newCat).catch(err => {
            console.error('‚ùå Erreur sauvegarde cat√©gories:', err);
          });
        }
      };

      const savePlaintes = (newPlaintes) => {
        // Normaliser : s'assurer que chaque plainte a un tableau specialites
        const normalizedPlaintes = newPlaintes.map(p => ({
          ...p,
          specialites: Array.isArray(p.specialites) ? p.specialites : []
        }));
        setPlaintes(normalizedPlaintes);
        localStorage.setItem('conseilsOfficine', JSON.stringify(newPlaintes));
        if (firebaseEnabled) {
          db.ref('conseilsOfficine').set(newPlaintes).catch(err => {
            console.error('‚ùå Erreur sauvegarde plaintes:', err);
          });
        }
        setPlaintesRenderKey(prev => prev + 1); // Forcer le re-render
        // Dispatcher un √©v√©nement pour notifier le composant flashcard
        window.dispatchEvent(new CustomEvent('plaintesUpdated'));
        console.log('üîÑ Plaintes sauvegard√©es, √©v√©nement dispatch√©');
      };

      const addCategory = (name) => {
        if (!name.trim()) return;
        if (categories.includes(name.trim())) {
          alert('Cette cat√©gorie existe d√©j√† !');
          return;
        }
        saveCategories([...categories, name.trim()]);
      };

      const editCategory = (oldName, newName) => {
        if (!newName.trim()) {
          alert('Le nom de la cat√©gorie ne peut pas √™tre vide');
          return;
        }
        if (oldName !== newName && categories.includes(newName.trim())) {
          alert('Cette cat√©gorie existe d√©j√† !');
          return;
        }
        
        // Mettre √† jour le nom de la cat√©gorie dans toutes les plaintes
        const updatedPlaintes = plaintes.map(plainte => 
          plainte.categorie === oldName ? { ...plainte, categorie: newName.trim() } : plainte
        );
        savePlaintes(updatedPlaintes);
        
        // Mettre √† jour la liste des cat√©gories
        const updatedCategories = categories.map(cat => cat === oldName ? newName.trim() : cat);
        saveCategories(updatedCategories);
        
        // Mettre √† jour selectedPlainte si n√©cessaire
        if (selectedPlainte && selectedPlainte.categorie === oldName) {
          setSelectedPlainte({ ...selectedPlainte, categorie: newName.trim() });
        }
      };

      const deleteCategory = (cat) => {
        const plaintesInCategory = plaintes.filter(p => p.categorie === cat);
        if (plaintesInCategory.length > 0) {
          if (!window.confirm(`La cat√©gorie "${cat}" contient ${plaintesInCategory.length} fiche(s).\n\nSupprimer quand m√™me ? (Les fiches seront d√©plac√©es vers la premi√®re cat√©gorie disponible)`)) {
            return;
          }
          // D√©placer les plaintes vers la premi√®re cat√©gorie disponible
          const newCategories = categories.filter(c => c !== cat);
          const firstCategory = newCategories[0] || 'G√©n√©ral';
          const updatedPlaintes = plaintes.map(plainte => 
            plainte.categorie === cat ? { ...plainte, categorie: firstCategory } : plainte
          );
          savePlaintes(updatedPlaintes);
          saveCategories(newCategories);
        } else {
          if (!window.confirm(`Supprimer la cat√©gorie "${cat}" ?`)) return;
          saveCategories(categories.filter(c => c !== cat));
        }
      };

      const moveCategoryUp = (index) => {
        if (index === 0) return;
        const newCategories = [...categories];
        [newCategories[index - 1], newCategories[index]] = [newCategories[index], newCategories[index - 1]];
        saveCategories(newCategories);
      };

      const moveCategoryDown = (index) => {
        if (index === categories.length - 1) return;
        const newCategories = [...categories];
        [newCategories[index], newCategories[index + 1]] = [newCategories[index + 1], newCategories[index]];
        saveCategories(newCategories);
      };

      const savePlainteData = (plainteData) => {
        if (editingPlainte) {
          const newPlaintes = plaintes.map(p => 
            p.id === editingPlainte.id ? { ...plainteData, id: p.id } : p
          );
          savePlaintes(newPlaintes);
          if (selectedPlainte?.id === editingPlainte.id) {
            setSelectedPlainte({ ...plainteData, id: editingPlainte.id });
          }
        } else {
          const newPlainte = { ...plainteData, id: Date.now().toString() };
          savePlaintes([...plaintes, newPlainte]);
        }
        setShowAddPlainte(false);
        setEditingPlainte(null);
      };

      const deletePlainte = (id) => {
        if (!window.confirm('Supprimer cette plainte ?')) return;
        savePlaintes(plaintes.filter(p => p.id !== id));
        if (selectedPlainte?.id === id) {
          setSelectedPlainte(null);
        }
      };

      const movePlainteUp = (plainteId, categorie) => {
        const plaintesInCategory = plaintes.filter(p => p.categorie === categorie);
        const currentIndex = plaintesInCategory.findIndex(p => p.id === plainteId);
        if (currentIndex <= 0) return; // D√©j√† en haut
        
        // √âchanger avec la plainte pr√©c√©dente
        const prevPlainte = plaintesInCategory[currentIndex - 1];
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) return { ...prevPlainte, id: p.id, nom: p.nom, emoji: p.emoji, couleur: p.couleur, description: p.description, specialites: p.specialites, informations: p.informations, documents: p.documents };
          if (p.id === prevPlainte.id) return { ...p, id: prevPlainte.id };
          return p;
        });
        
        // Solution plus simple : r√©organiser par index
        const allPlaintes = [...plaintes];
        const indexInAll = allPlaintes.findIndex(p => p.id === plainteId);
        const prevIndexInAll = allPlaintes.findIndex(p => p.id === prevPlainte.id);
        [allPlaintes[indexInAll], allPlaintes[prevIndexInAll]] = [allPlaintes[prevIndexInAll], allPlaintes[indexInAll]];
        savePlaintes(allPlaintes);
      };

      const movePlainteDown = (plainteId, categorie) => {
        const plaintesInCategory = plaintes.filter(p => p.categorie === categorie);
        const currentIndex = plaintesInCategory.findIndex(p => p.id === plainteId);
        if (currentIndex >= plaintesInCategory.length - 1) return; // D√©j√† en bas
        
        const nextPlainte = plaintesInCategory[currentIndex + 1];
        const allPlaintes = [...plaintes];
        const indexInAll = allPlaintes.findIndex(p => p.id === plainteId);
        const nextIndexInAll = allPlaintes.findIndex(p => p.id === nextPlainte.id);
        [allPlaintes[indexInAll], allPlaintes[nextIndexInAll]] = [allPlaintes[nextIndexInAll], allPlaintes[indexInAll]];
        savePlaintes(allPlaintes);
      };

      const changePlainteCategory = (plainteId, newCategorie) => {
        const newPlaintes = plaintes.map(p => 
          p.id === plainteId ? { ...p, categorie: newCategorie } : p
        );
        savePlaintes(newPlaintes);
        if (selectedPlainte?.id === plainteId) {
          setSelectedPlainte({ ...selectedPlainte, categorie: newCategorie });
        }
      };

      const saveSpecialite = (plainteId, specialite) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            if (editingSpecialite) {
              return {
                ...p,
                specialites: p.specialites.map(s => 
                  s.id === editingSpecialite.id ? { ...specialite, id: s.id } : s
                )
              };
            } else {
              return {
                ...p,
                specialites: [...p.specialites, { ...specialite, id: Date.now().toString() }]
              };
            }
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
        setShowAddSpecialite(false);
        setEditingSpecialite(null);
      };

      const deleteSpecialite = (plainteId, specialiteId) => {
        if (!window.confirm('Supprimer cette sp√©cialit√© ?')) return;
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            return { ...p, specialites: p.specialites.filter(s => s.id !== specialiteId) };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const moveSpecialiteUp = (plainteId, specialiteId) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            const specs = [...p.specialites];
            const index = specs.findIndex(s => s.id === specialiteId);
            if (index > 0) {
              [specs[index - 1], specs[index]] = [specs[index], specs[index - 1]];
            }
            return { ...p, specialites: specs };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const moveSpecialiteDown = (plainteId, specialiteId) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            const specs = [...p.specialites];
            const index = specs.findIndex(s => s.id === specialiteId);
            if (index < specs.length - 1) {
              [specs[index], specs[index + 1]] = [specs[index + 1], specs[index]];
            }
            return { ...p, specialites: specs };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const updatePlainteInfo = (plainteId, field, value) => {
        const newPlaintes = plaintes.map(p => 
          p.id === plainteId ? { ...p, [field]: value } : p
        );
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const addDocument = (plainteId, document) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            return { ...p, documents: [...(p.documents || []), { ...document, id: Date.now().toString() }] };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const deleteDocument = (plainteId, docId) => {
        if (!window.confirm('Supprimer ce lien ?')) return;
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            return { ...p, documents: (p.documents || []).filter(d => d.id !== docId) };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const editDocument = (plainteId, docId, newName, newUrl, newCategory) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            return {
              ...p,
              documents: (p.documents || []).map(d => 
                d.id === docId ? { ...d, nom: newName, data: newUrl, category: newCategory || 'Important' } : d
              )
            };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const renameCategoryInDocuments = (plainteId, oldCategoryName, newCategoryName) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            return {
              ...p,
              documents: (p.documents || []).map(d => 
                (d.category || 'Important') === oldCategoryName ? { ...d, category: newCategoryName } : d
              )
            };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const moveDocumentInPlainte = (plainteId, docId, direction, category) => {
        const plainte = plaintes.find(p => p.id === plainteId);
        if (!plainte) return;
        
        const docsInCategory = (plainte.documents || []).filter(doc => (doc.category || 'Important') === category);
        const currentIndex = docsInCategory.findIndex(doc => doc.id === docId);
        
        if (direction === 'up' && currentIndex <= 0) return;
        if (direction === 'down' && currentIndex >= docsInCategory.length - 1) return;
        
        const targetDoc = direction === 'up' ? docsInCategory[currentIndex - 1] : docsInCategory[currentIndex + 1];
        const allDocs = [...(plainte.documents || [])];
        const indexInAll = allDocs.findIndex(doc => doc.id === docId);
        const targetIndexInAll = allDocs.findIndex(doc => doc.id === targetDoc.id);
        
        [allDocs[indexInAll], allDocs[targetIndexInAll]] = [allDocs[targetIndexInAll], allDocs[indexInAll]];
        
        const newPlaintes = plaintes.map(p => 
          p.id === plainteId ? { ...p, documents: allDocs } : p
        );
        savePlaintes(newPlaintes);
        setSelectedPlainte(newPlaintes.find(p => p.id === plainteId));
      };

      // GESTION DES FICHES CONSEILS
      const addFicheConseil = (plainteId, fiche) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            const fiches = p.fichesConseils || [];
            return { ...p, fichesConseils: [...fiches, { ...fiche, id: Date.now() }] };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        setSelectedPlainte(newPlaintes.find(p => p.id === plainteId));
      };

      const updateFicheConseil = (plainteId, ficheId, updatedFiche) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            const fiches = (p.fichesConseils || []).map(f => 
              f.id === ficheId ? { ...f, ...updatedFiche } : f
            );
            return { ...p, fichesConseils: fiches };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        setSelectedPlainte(newPlaintes.find(p => p.id === plainteId));
      };

      const deleteFicheConseil = (plainteId, ficheId) => {
        if (!window.confirm('Supprimer cette fiche conseils ?')) return;
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            const fiches = (p.fichesConseils || []).filter(f => f.id !== ficheId);
            return { ...p, fichesConseils: fiches };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        setSelectedPlainte(newPlaintes.find(p => p.id === plainteId));
      };

      const togglePinFiche = (plainteId, ficheId) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            const fiches = (p.fichesConseils || []).map(f => ({
              ...f,
              isPinned: f.id === ficheId ? !f.isPinned : false // D√©s√©pingler les autres
            }));
            return { ...p, fichesConseils: fiches };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        setSelectedPlainte(newPlaintes.find(p => p.id === plainteId));
      };

      const handleImageUpload = (e, callback) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onloadend = () => callback(reader.result);
        reader.readAsDataURL(file);
      };

      const handleImageURL = (callback) => {
        let url = prompt("Collez l'URL de l'image :");
        if (!url) return;
        
        if (url.includes('imgur.com/a/')) {
          alert("‚ùå C'est une URL d'ALBUM !\n\nüìù Pour obtenir l'URL correcte :\n1. Ouvrez votre album\n2. Cliquez sur l'image\n3. Clic droit ‚Üí 'Copier l'adresse de l'image'\n4. Vous obtiendrez : https://i.imgur.com/abc123.jpg");
          return;
        }
        
        if (url.includes('imgur.com') && !url.includes('i.imgur.com')) {
          const match = url.match(/imgur\.com\/(?:gallery\/)?([a-zA-Z0-9]+)/);
          if (match && match[1]) {
            const imageId = match[1];
            const ext = prompt("Extension de l'image ?\n(jpg, png, gif, webp)", "jpg");
            if (ext) {
              url = `https://i.imgur.com/${imageId}.${ext}`;
              alert(`‚úÖ URL corrig√©e automatiquement :\n${url}`);
            } else {
              return;
            }
          }
        }
        
        if (!url.startsWith('http')) {
          alert("‚ùå L'URL doit commencer par http:// ou https://");
          return;
        }
        
        callback(url);
      };

      const filteredPlaintes = plaintes.filter(p => 
        p.nom.toLowerCase().includes(searchTerm.toLowerCase()) ||
        (p.description && p.description.toLowerCase().includes(searchTerm.toLowerCase())) ||
        p.specialites.some(s => s.nomCommercial?.toLowerCase().includes(searchTerm.toLowerCase()) || s.dci?.toLowerCase().includes(searchTerm.toLowerCase())) ||
        p.categorie.toLowerCase().includes(searchTerm.toLowerCase()) // Recherche par cat√©gorie
      );

      return (
        <>
          {showCategoriesModal && (
            <CategoriesModal 
              categories={categories}
              onClose={() => setShowCategoriesModal(false)}
              onAdd={addCategory}
              onEdit={editCategory}
              onDelete={deleteCategory}
              onMoveUp={moveCategoryUp}
              onMoveDown={moveCategoryDown}
            />
          )}
          
          {showAddPlainte && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.5)',
              backdropFilter: 'blur(4px)',
              zIndex: 1000,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              padding: '1rem'
            }} onClick={() => { setShowAddPlainte(false); setEditingPlainte(null); }}>
              <div onClick={(e) => e.stopPropagation()} style={{ width: '100%', maxWidth: '600px', maxHeight: '90vh', overflowY: 'auto' }}>
                <FormPlainte
                  plainte={editingPlainte}
                  categories={categories}
                  onSave={savePlainteData}
                  onCancel={() => { setShowAddPlainte(false); setEditingPlainte(null); }}
                />
              </div>
            </div>
          )}
          
          {selectedPlainte ? (
            <DetailPlainte 
              plainte={{
                ...selectedPlainte,
                specialites: Array.isArray(selectedPlainte.specialites) ? selectedPlainte.specialites : []
              }}
              onBack={() => { setSelectedPlainte(null); setShowAddSpecialite(false); setEditingSpecialite(null); }}
              onEdit={() => { setEditingPlainte(selectedPlainte); setShowAddPlainte(true); }}
              onDelete={() => deletePlainte(selectedPlainte.id)}
              onAddSpecialite={() => { setShowAddSpecialite(true); setEditingSpecialite(null); }}
              onEditSpecialite={(spec) => { setEditingSpecialite(spec); setShowAddSpecialite(true); }}
              onDeleteSpecialite={(specId) => deleteSpecialite(selectedPlainte.id, specId)}
              onMoveSpecialiteUp={(specId) => moveSpecialiteUp(selectedPlainte.id, specId)}
              onMoveSpecialiteDown={(specId) => moveSpecialiteDown(selectedPlainte.id, specId)}
              showAddSpecialite={showAddSpecialite}
              editingSpecialite={editingSpecialite}
              onSaveSpecialite={(spec) => saveSpecialite(selectedPlainte.id, spec)}
              onCancelSpecialite={() => { setShowAddSpecialite(false); setEditingSpecialite(null); }}
              handleImageUpload={handleImageUpload}
              handleImageURL={handleImageURL}
              onUpdatePlainteInfo={(field, value) => updatePlainteInfo(selectedPlainte.id, field, value)}
              onAddDocument={(doc) => addDocument(selectedPlainte.id, doc)}
              onDeleteDocument={(docId) => deleteDocument(selectedPlainte.id, docId)}
              onEditDocument={(docId, newName, newUrl, newCategory) => editDocument(selectedPlainte.id, docId, newName, newUrl, newCategory)}
              onRenameCategoryInDocuments={(oldName, newName) => renameCategoryInDocuments(selectedPlainte.id, oldName, newName)}
              onMoveDocument={(docId, direction, category) => moveDocumentInPlainte(selectedPlainte.id, docId, direction, category)}
              onAddFicheConseil={(fiche) => addFicheConseil(selectedPlainte.id, fiche)}
              onUpdateFicheConseil={(ficheId, fiche) => updateFicheConseil(selectedPlainte.id, ficheId, fiche)}
              onDeleteFicheConseil={(ficheId) => deleteFicheConseil(selectedPlainte.id, ficheId)}
              onTogglePinFiche={(ficheId) => togglePinFiche(selectedPlainte.id, ficheId)}
              onShowImportModal={() => setShowImportMedModal(true)}
              medications={medications}
              setImageModalUrl={setImageModalUrl}
            />
          ) : (
            <div style={{ maxWidth: 'none', margin: '0', padding: '0 2rem' }}>
          <div style={{
            background: 'linear-gradient(135deg, #1e293b 0%, #334155 100%)',
            padding: '1.5rem',
            color: 'white',
            textAlign: 'center',
            borderRadius: '20px 20px 0 0',
            position: 'relative'
          }}>
            {/* Bouton Menu en haut √† gauche */}
            <div style={{
              position: 'absolute',
              top: '1.5rem',
              left: '1.5rem'
            }}>
              <button
                onClick={onReturnToMenu}
                className="button-hover"
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  border: 'none',
                  color: 'white',
                  padding: '0.75rem 1.25rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontSize: '1rem',
                  fontWeight: 600,
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.5rem'
                }}
              >
                <span>‚Üê</span> Menu
              </button>
            </div>
            
            {/* Boutons en haut √† droite */}
            <div style={{
              position: 'absolute',
              top: '1.5rem',
              right: '1.5rem',
              display: 'flex',
              gap: '0.75rem'
            }}>
              <button
                onClick={() => handleOfflineAction(() => setShowCategoriesModal(true))}
                disabled={!isOnline}
                style={{
                  background: isOnline ? 'rgba(255,255,255,0.2)' : 'rgba(150,150,150,0.2)',
                  border: 'none',
                  color: 'white',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: isOnline ? 'pointer' : 'not-allowed',
                  fontSize: '0.9rem',
                  fontWeight: 600,
                  whiteSpace: 'nowrap',
                  opacity: isOnline ? 1 : 0.5
                }}
              >
                G√©rer cat√©gories
              </button>
              <button
                onClick={() => handleOfflineAction(() => setShowAddPlainte(true))}
                disabled={!isOnline}
                style={{
                  background: isOnline ? 'rgba(255,255,255,0.2)' : 'rgba(150,150,150,0.2)',
                  border: 'none',
                  color: 'white',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: isOnline ? 'pointer' : 'not-allowed',
                  fontSize: '0.9rem',
                  fontWeight: 600,
                  whiteSpace: 'nowrap',
                  opacity: isOnline ? 1 : 0.5
                }}
              >
                + Nouvelle plainte
              </button>
            </div>
            
            {/* Titre centr√© */}
            <h1 style={{ margin: 0, fontSize: '1.8rem', fontWeight: 700 }}>Conseils Officine</h1>
            <p style={{ margin: '0.5rem 0 0 0', opacity: 0.9, fontSize: '0.85rem' }}>Recommandations pour les plaintes courantes</p>
          </div>

          <div style={{
            background: 'white',
            borderRadius: '0 0 20px 20px',
            padding: '1.5rem',
            boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
            minHeight: '400px'
          }}>
            <div style={{ marginBottom: '2rem' }}>
              <input
                type="text"
                placeholder="Rechercher..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                style={{
                  width: '100%',
                  padding: '1rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '12px',
                  fontSize: '1rem',
                  outline: 'none'
                }}
              />
            </div>

            {categories.map(categorie => {
            const plaintesCategorie = filteredPlaintes.filter(p => p.categorie === categorie);
            
            // Ne pas afficher les cat√©gories vides lors d'une recherche
            if (searchTerm && plaintesCategorie.length === 0) {
              return null;
            }

            return (
              <div key={categorie} style={{ marginBottom: '2rem' }}>
                <h2 style={{
                  color: '#1e293b',
                  fontSize: '1.5rem',
                  marginBottom: '1rem',
                  fontWeight: 700
                }}>
                  {categorie}
                </h2>
                
                {plaintesCategorie.length === 0 ? (
                  <div style={{
                    background: '#F8FAFC',
                    padding: '2rem',
                    borderRadius: '12px',
                    textAlign: 'center',
                    color: '#64748b',
                    fontStyle: 'italic',
                    border: '2px dashed #E2E8F0'
                  }}>
                    Aucune plainte dans cette cat√©gorie
                  </div>
                ) : (
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))',
                    gap: '1rem'
                  }}>
                    {plaintesCategorie.map((plainte, index) => (
                      <PlainteCard
                        key={plainte.id}
                        plainte={plainte}
                        index={index}
                        totalCount={plaintesCategorie.length}
                        categorie={categorie}
                        setSelectedPlainte={setSelectedPlainte}
                        setEditingPlainte={setEditingPlainte}
                        setShowAddPlainte={setShowAddPlainte}
                        deletePlainte={deletePlainte}
                        movePlainteUp={movePlainteUp}
                        movePlainteDown={movePlainteDown}
                        isOnline={isOnline}
                      />
                    ))}
                  </div>
                )}
              </div>
            );
            })}
          </div>
            </div>
          )}

          {/* MODAL ZOOM IMAGE */}
          {imageModalUrl && (
            <div 
              onClick={() => setImageModalUrl(null)} 
              style={{ 
                position: 'fixed', 
                top: 0, 
                left: 0, 
                right: 0, 
                bottom: 0, 
                background: 'rgba(0, 0, 0, 0.7)', 
                backdropFilter: 'blur(8px)',
                zIndex: 9999, 
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'center', 
                padding: '2rem',
                cursor: 'pointer'
              }}
            >
              <div 
                style={{ 
                  background: 'white', 
                  borderRadius: '16px', 
                  padding: '1.5rem',
                  boxShadow: '0 25px 80px rgba(0, 0, 0, 0.3)',
                  maxWidth: '90%',
                  maxHeight: '90%',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}
                onClick={(e) => e.stopPropagation()}
              >
                <img 
                  src={imageModalUrl} 
                  alt="Image agrandie" 
                  style={{ 
                    maxWidth: '100%', 
                    maxHeight: '80vh', 
                    objectFit: 'contain', 
                    borderRadius: '8px'
                  }} 
                />
              </div>
            </div>
          )}
          
          {/* Modal Import Flashcards */}
          {showImportMedModal && selectedPlainte && (
<div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.75)',
            backdropFilter: 'blur(8px)',
            zIndex: 2000,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '1rem'
          }} onClick={() => { setShowImportMedModal(false); setImportSearchTerm(''); }}>
            <div onClick={(e) => e.stopPropagation()} style={{
              background: 'white',
              borderRadius: '20px',
              padding: '2rem',
              maxWidth: '600px',
              width: '100%',
              maxHeight: '80vh',
              overflowY: 'auto'
            }}>
              <h3 style={{ margin: '0 0 1rem 0', fontSize: '1.5rem', color: '#1e293b' }}>
                Importer depuis Flashcards
              </h3>
              
              <input
                type="text"
                placeholder="Rechercher par nom, DCI ou classe..."
                value={importSearchTerm}
                onChange={(e) => setImportSearchTerm(e.target.value)}
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px',
                  fontSize: '1rem',
                  marginBottom: '1rem'
                }}
              />
              
              <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                {(medications || []).filter(med => 
                  !importSearchTerm || 
                  med.commercial.some(c => c.toLowerCase().includes(importSearchTerm.toLowerCase())) ||
                  med.dci.toLowerCase().includes(importSearchTerm.toLowerCase()) ||
                  (med.category && med.category.toLowerCase().includes(importSearchTerm.toLowerCase()))
                ).map((med, index) => (
                  <div
                    key={`${med.dci}-${med.commercial[0]}-${med.category}-${index}`}
                    onClick={() => {
                      const newSpec = {
                        id: Date.now(),
                        dci: med.dci,
                        nomCommercial: med.commercial.join(', '),
                        formePharma: med.pharmaceuticalForm || '',
                        dosage: '',
                        contreIndications: '',
                        prix: '',
                        remboursement: '',
                        imageUrls: med.imageUrls || (med.imageUrl ? [med.imageUrl] : [])
                      };
                      
                      const updatedPlainte = {
                        ...selectedPlainte,
                        specialites: [...selectedPlainte.specialites, newSpec]
                      };
                      
                      const updatedPlaintes = plaintes.map(p =>
                        p.id === selectedPlainte.id ? updatedPlainte : p
                      );
                      
                      savePlaintes(updatedPlaintes);
                      setSelectedPlainte(updatedPlainte);
                      setShowImportMedModal(false);
                      setImportSearchTerm('');
                    }}
                    style={{
                      padding: '1rem',
                      border: '2px solid #e2e8f0',
                      borderRadius: '12px',
                      marginBottom: '0.5rem',
                      cursor: 'pointer',
                      transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.borderColor = '#3B82F6';
                      e.currentTarget.style.background = '#F0F9FF';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.borderColor = '#e2e8f0';
                      e.currentTarget.style.background = 'white';
                    }}
                  >
                    <div style={{ fontWeight: 700, color: '#1e293b', marginBottom: '0.25rem' }}>
                      {med.commercial.join(' ‚Ä¢ ')}
                    </div>
                    <div style={{ fontSize: '0.85rem', color: '#64748b' }}>
                      {med.dci}
                    </div>
                    {med.category && (
                      <div style={{ 
                        fontSize: '0.75rem', 
                        color: '#3B82F6',
                        marginTop: '0.25rem',
                        fontWeight: 600
                      }}>
                        üè∑Ô∏è {med.category}
                      </div>
                    )}
                    {(med.imageUrls || (med.imageUrl ? [med.imageUrl] : [])).length > 0 && (
                      <div style={{ marginTop: '0.5rem', fontSize: '0.75rem', color: '#3B82F6' }}>
                        üì∑ {(med.imageUrls || [med.imageUrl]).filter(Boolean).length} image(s)
                      </div>
                    )}
                  </div>
                ))}
              </div>
              
              <button
                onClick={() => { setShowImportMedModal(false); setImportSearchTerm(''); }}
                style={{
                  width: '100%',
                  marginTop: '1rem',
                  padding: '0.75rem',
                  background: '#e2e8f0',
                  border: 'none',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: 600,
                  color: '#64748b'
                }}
              >
                Annuler
              </button>
            </div>
          </div>
          )}
          
        </>
      );
    }

    function CategoriesModal({ categories, onClose, onAdd, onDelete, onEdit, onMoveUp, onMoveDown }) {
      const [newCat, setNewCat] = useState('');
      const [editingCat, setEditingCat] = useState(null);
      const [editValue, setEditValue] = useState('');

      return (
        <div 
          onClick={onClose}
          style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0,0,0,0.5)',
          backdropFilter: 'blur(4px)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '2rem',
          zIndex: 1000
        }}>
          <div 
            onClick={(e) => e.stopPropagation()}
            style={{
            background: 'white',
            borderRadius: '20px',
            padding: '2rem',
            maxWidth: '600px',
            width: '100%',
            maxHeight: '80vh',
            overflow: 'auto'
          }}>
            <h2 style={{ marginBottom: '1.5rem', color: '#1e293b' }}>G√©rer les cat√©gories</h2>

            <div style={{ marginBottom: '1.5rem' }}>
              <input
                type="text"
                value={newCat}
                onChange={(e) => setNewCat(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === 'Enter' && newCat.trim()) {
                    onAdd(newCat);
                    setNewCat('');
                  }
                }}
                placeholder="Nouvelle cat√©gorie..."
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px',
                  marginBottom: '0.75rem'
                }}
              />
              <button
                onClick={() => {
                  if (newCat.trim()) {
                    onAdd(newCat);
                    setNewCat('');
                  }
                }}
                style={{
                  background: '#667eea',
                  color: 'white',
                  border: 'none',
                  padding: '0.75rem 1.5rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: 600
                }}
              >
                + Ajouter
              </button>
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              {categories.map((cat, index) => (
                editingCat === cat ? (
                  <div key={cat} style={{
                    display: 'flex',
                    gap: '0.5rem',
                    padding: '0.75rem',
                    background: '#f8fafc',
                    borderRadius: '8px',
                    marginBottom: '0.5rem'
                  }}>
                    <input
                      type="text"
                      value={editValue}
                      onChange={(e) => setEditValue(e.target.value)}
                      onKeyPress={(e) => {
                        if (e.key === 'Enter' && editValue.trim()) {
                          onEdit(cat, editValue.trim());
                          setEditingCat(null);
                          setEditValue('');
                        }
                      }}
                      autoFocus
                      style={{
                        flex: 1,
                        padding: '0.5rem',
                        border: '2px solid #3B82F6',
                        borderRadius: '6px'
                      }}
                    />
                    <button
                      onClick={() => {
                        if (editValue.trim()) {
                          onEdit(cat, editValue.trim());
                          setEditingCat(null);
                          setEditValue('');
                        }
                      }}
                      style={{
                        background: '#10B981',
                        color: 'white',
                        border: 'none',
                        padding: '0.5rem 1rem',
                        borderRadius: '6px',
                        cursor: 'pointer'
                      }}
                    >
                      ‚úì
                    </button>
                    <button
                      onClick={() => {
                        setEditingCat(null);
                        setEditValue('');
                      }}
                      style={{
                        background: '#e2e8f0',
                        color: '#475569',
                        border: 'none',
                        padding: '0.5rem 1rem',
                        borderRadius: '6px',
                        cursor: 'pointer'
                      }}
                    >
                      ‚úï
                    </button>
                  </div>
                ) : (
                  <div key={cat} style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    padding: '0.75rem',
                    background: '#f8fafc',
                    borderRadius: '8px',
                    marginBottom: '0.5rem'
                  }}>
                    <span style={{ color: '#1e293b', fontWeight: 600 }}>{cat}</span>
                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                      <button
                        onClick={() => onMoveUp && onMoveUp(index)}
                        disabled={index === 0}
                        style={{
                          background: index === 0 ? '#e2e8f0' : '#8b5cf6',
                          color: index === 0 ? '#94a3b8' : 'white',
                          border: 'none',
                          padding: '0.5rem 0.75rem',
                          borderRadius: '6px',
                          cursor: index === 0 ? 'not-allowed' : 'pointer',
                          fontSize: '0.85rem',
                          fontWeight: 'bold'
                        }}
                        title="Monter"
                      >
                        ‚Üë
                      </button>
                      <button
                        onClick={() => onMoveDown && onMoveDown(index)}
                        disabled={index === categories.length - 1}
                        style={{
                          background: index === categories.length - 1 ? '#e2e8f0' : '#8b5cf6',
                          color: index === categories.length - 1 ? '#94a3b8' : 'white',
                          border: 'none',
                          padding: '0.5rem 0.75rem',
                          borderRadius: '6px',
                          cursor: index === categories.length - 1 ? 'not-allowed' : 'pointer',
                          fontSize: '0.85rem',
                          fontWeight: 'bold'
                        }}
                        title="Descendre"
                      >
                        ‚Üì
                      </button>
                      <button
                        onClick={() => {
                          setEditingCat(cat);
                          setEditValue(cat);
                        }}
                        style={{
                          background: '#3B82F6',
                          color: 'white',
                          border: 'none',
                          padding: '0.5rem 1rem',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontSize: '0.85rem'
                        }}
                      >
                        ‚úèÔ∏è Modifier
                      </button>
                      <button
                        onClick={() => onDelete(cat)}
                        style={{
                          background: '#ef4444',
                          color: 'white',
                          border: 'none',
                          padding: '0.5rem 1rem',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontSize: '0.85rem'
                        }}
                      >
                        üóëÔ∏è Supprimer
                      </button>
                    </div>
                  </div>
                )
              ))}
            </div>

            <button
              onClick={onClose}
              style={{
                background: '#e2e8f0',
                color: '#475569',
                border: 'none',
                padding: '0.75rem 1.5rem',
                borderRadius: '8px',
                cursor: 'pointer',
                fontWeight: 600,
                width: '100%'
              }}
            >
              Fermer
            </button>
          </div>
        </div>
      );
    }

    function FormPlainte({ plainte, categories, onSave, onCancel }) {
      const [formData, setFormData] = useState(plainte || {
        nom: '',
        categorie: categories[0] || '',
        couleur: '#667eea',
        imageUrl: '',
        specialites: [],
        informations: '',
        documents: [],
        starEnabled: false
      });

      return (
        <div style={{ maxWidth: 'none', margin: '0', padding: '0 2rem' }}>
          <div style={{
            background: 'white',
            borderRadius: '20px',
            padding: '2rem',
            boxShadow: '0 10px 40px rgba(0,0,0,0.1)',
            maxWidth: '700px',
            margin: '0 auto'
          }}>
            <h2 style={{ marginBottom: '2rem', color: '#1e293b' }}>
              {plainte ? 'Modifier la plainte' : 'Nouvelle plainte'}
            </h2>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Nom *</label>
              <input
                type="text"
                value={formData.nom}
                onChange={(e) => setFormData({ ...formData, nom: e.target.value })}
                placeholder="Ex: Maux de t√™te"
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px'
                }}
              />
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Image (URL)</label>
              <input
                type="text"
                value={formData.imageUrl || ''}
                onChange={(e) => setFormData({ ...formData, imageUrl: e.target.value })}
                placeholder="https://exemple.com/image.jpg"
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px'
                }}
              />
              {formData.imageUrl && (
                <div style={{ marginTop: '0.5rem' }}>
                  <img 
                    src={formData.imageUrl} 
                    alt="Aper√ßu" 
                    style={{ 
                      maxWidth: '100px', 
                      maxHeight: '100px', 
                      borderRadius: '8px',
                      border: '2px solid #e2e8f0'
                    }}
                    onError={(e) => e.target.style.display = 'none'}
                  />
                </div>
              )}
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Cat√©gorie *</label>
              <select
                value={formData.categorie}
                onChange={(e) => setFormData({ ...formData, categorie: e.target.value })}
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px'
                }}
              >
                {categories.map(cat => (
                  <option key={cat} value={cat}>{cat}</option>
                ))}
              </select>
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Couleur</label>
              <input
                type="color"
                value={formData.couleur}
                onChange={(e) => setFormData({ ...formData, couleur: e.target.value })}
                style={{
                  width: '100%',
                  height: '50px',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px',
                  cursor: 'pointer'
                }}
              />
            </div>

            {/* √âtoile */}
            <div style={{ marginBottom: '1.5rem', padding: '1rem', background: '#f8fafc', borderRadius: '8px', border: '2px solid #e2e8f0' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                <input
                  type="checkbox"
                  id="starEnabled"
                  checked={formData.starEnabled || false}
                  onChange={(e) => setFormData({ ...formData, starEnabled: e.target.checked })}
                  style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                />
                <label htmlFor="starEnabled" style={{ fontWeight: 600, cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '0.3rem' }}>
                  Afficher une √©toile 
                  <span style={{ fontSize: '0.85rem', opacity: 0.5 }}>‚≠ê</span>
                </label>
              </div>
            </div>

            <div style={{ display: 'flex', gap: '1rem' }}>
              <button
                onClick={() => {
                  if (!formData.nom.trim()) {
                    alert('Le nom est obligatoire');
                    return;
                  }
                  onSave(formData);
                }}
                style={{
                  flex: 1,
                  background: '#667eea',
                  color: 'white',
                  border: 'none',
                  padding: '1rem',
                  borderRadius: '12px',
                  fontWeight: 600,
                  cursor: 'pointer'
                }}
              >
                {plainte ? 'Enregistrer' : 'Cr√©er'}
              </button>
              <button
                onClick={onCancel}
                style={{
                  flex: 1,
                  background: '#e2e8f0',
                  color: '#475569',
                  border: 'none',
                  padding: '1rem',
                  borderRadius: '12px',
                  fontWeight: 600,
                  cursor: 'pointer'
                }}
              >
                Annuler
              </button>
            </div>
          </div>
        </div>
      );
    }

    function DetailPlainte({ 
      plainte, onBack, onEdit, onDelete, onAddSpecialite, onEditSpecialite, onDeleteSpecialite, onMoveSpecialiteUp, onMoveSpecialiteDown,
      showAddSpecialite, editingSpecialite, onSaveSpecialite, onCancelSpecialite,
      handleImageUpload, handleImageURL, onUpdatePlainteInfo, onAddDocument, onDeleteDocument, onEditDocument, onRenameCategoryInDocuments, onMoveDocument, 
      onAddFicheConseil, onUpdateFicheConseil, onDeleteFicheConseil, onTogglePinFiche,
      onShowImportModal, medications, setImageModalUrl}) {
      const [activeTab, setActiveTab] = useState('info');
      const [showFichesModal, setShowFichesModal] = useState(false);
      const [showAddFiche, setShowAddFiche] = useState(false);
      const [showViewFiche, setShowViewFiche] = useState(false);
      const [editingFiche, setEditingFiche] = useState(null);
      const [viewingFiche, setViewingFiche] = useState(null);
      const [ficheForm, setFicheForm] = useState({ nom: '', urls: '' });


      return (
        <div style={{ position: 'relative' }}>
          {showAddSpecialite && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.5)',
              backdropFilter: 'blur(4px)',
              zIndex: 1000,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              padding: '1rem'
            }} onClick={onCancelSpecialite}>
              <div onClick={(e) => e.stopPropagation()} style={{ width: '100%', maxWidth: '900px', maxHeight: '90vh', overflowY: 'auto' }}>
                <FormSpecialite
                  specialite={editingSpecialite}
                  onSave={onSaveSpecialite}
                  onCancel={onCancelSpecialite}
                  handleImageUpload={handleImageUpload}
                  handleImageURL={handleImageURL}
                  plainte={plainte}
                  medications={medications || []}
                />
              </div>
            </div>
          )}

          {/* Modal Liste des fiches conseils */}
          {showFichesModal && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.6)',
              backdropFilter: 'blur(8px)',
              zIndex: 2000,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              padding: '1rem'
            }} onClick={() => setShowFichesModal(false)}>
              <div onClick={(e) => e.stopPropagation()} style={{
                background: 'white',
                borderRadius: '16px',
                padding: '2rem',
                maxWidth: '800px',
                width: '100%',
                maxHeight: '80vh',
                overflowY: 'auto',
                boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
              }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                  <h2 style={{ margin: 0, color: '#1e293b', fontSize: '1.5rem' }}>Fiches conseils</h2>
                  <button onClick={() => setShowFichesModal(false)} style={{
                    background: 'none',
                    border: 'none',
                    fontSize: '1.5rem',
                    cursor: 'pointer',
                    color: '#64748b'
                  }}>‚úï</button>
                </div>

                {(!plainte.fichesConseils || plainte.fichesConseils.length === 0) ? (
                  <div style={{
                    padding: '3rem',
                    textAlign: 'center',
                    color: '#64748b',
                    background: '#f8fafc',
                    borderRadius: '12px',
                    marginBottom: '1rem'
                  }}>
                    <p style={{ margin: 0, fontSize: '1.1rem' }}>Aucune fiche conseils</p>
                    <p style={{ margin: '0.5rem 0 0 0', fontSize: '0.9rem' }}>Ajoutez des photos de vos fiches</p>
                  </div>
                ) : (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem', marginBottom: '1.5rem' }}>
                    {plainte.fichesConseils.map(fiche => (
                      <div key={fiche.id} style={{
                        padding: '1rem',
                        background: fiche.isPinned ? '#f0f9ff' : '#f8fafc',
                        borderRadius: '8px',
                        border: fiche.isPinned ? '2px solid #3b82f6' : '2px solid #e2e8f0',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center'
                      }}>
                        <div style={{ flex: 1, minWidth: 0 }}>
                          <div style={{ 
                            fontWeight: 600, 
                            color: '#1e293b', 
                            marginBottom: '0.25rem', 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: '0.5rem',
                            whiteSpace: 'nowrap',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis'
                          }}>
                            <span style={{ overflow: 'hidden', textOverflow: 'ellipsis' }}>{fiche.nom}</span>
                            {fiche.isPinned && (
                              <span style={{
                                background: '#3b82f6',
                                color: 'white',
                                fontSize: '0.7rem',
                                padding: '0.15rem 0.5rem',
                                borderRadius: '4px',
                                fontWeight: 600,
                                flexShrink: 0
                              }}>
                                √âPINGL√âE
                              </span>
                            )}
                          </div>
                          <div style={{ fontSize: '0.85rem', color: '#64748b' }}>
                            {fiche.urls.length} page{fiche.urls.length > 1 ? 's' : ''}
                          </div>
                        </div>
                        <div style={{ display: 'flex', gap: '0.5rem', flexShrink: 0 }}>
                          <button
                            onClick={() => onTogglePinFiche(fiche.id)}
                            style={{
                              padding: '0.5rem 1rem',
                              background: fiche.isPinned ? '#f1f5f9' : '#3b82f6',
                              color: fiche.isPinned ? '#64748b' : 'white',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontWeight: 600,
                              fontSize: '0.85rem'
                            }}
                            title={fiche.isPinned ? 'D√©s√©pingler' : '√âpingler comme fiche par d√©faut'}
                          >
                            {fiche.isPinned ? 'D√©s√©pingler' : '√âpingler'}
                          </button>
                          <button
                            onClick={() => {
                              setViewingFiche(fiche);
                              setShowViewFiche(true);
                              setShowFichesModal(false);
                            }}
                            style={{
                              padding: '0.5rem 1rem',
                              background: '#667eea',
                              color: 'white',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontWeight: 600,
                              fontSize: '0.85rem'
                            }}
                          >
                            Voir
                          </button>
                          <button
                            onClick={() => {
                              setEditingFiche(fiche);
                              setFicheForm({ nom: fiche.nom, urls: fiche.urls.join('\n') });
                              setShowAddFiche(true);
                              setShowFichesModal(false);
                            }}
                            style={{
                              padding: '0.5rem 1rem',
                              background: '#10b981',
                              color: 'white',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontWeight: 600,
                              fontSize: '0.85rem'
                            }}
                          >
                            Modifier
                          </button>
                          <button
                            onClick={() => {
                              onDeleteFicheConseil(fiche.id);
                            }}
                            style={{
                              padding: '0.5rem 1rem',
                              background: '#ef4444',
                              color: 'white',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontWeight: 600,
                              fontSize: '0.85rem'
                            }}
                          >
                            Supprimer
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                <button
                  onClick={() => {
                    setEditingFiche(null);
                    setFicheForm({ nom: '', urls: '' });
                    setShowAddFiche(true);
                    setShowFichesModal(false);
                  }}
                  style={{
                    width: '100%',
                    padding: '1rem',
                    background: plainte.couleur,
                    color: 'white',
                    border: 'none',
                    borderRadius: '12px',
                    cursor: 'pointer',
                    fontWeight: 600,
                    fontSize: '1rem'
                  }}
                >
                  + Ajouter une fiche
                </button>
              </div>
            </div>
          )}

          {/* Modal Ajouter/Modifier fiche */}
          {showAddFiche && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.6)',
              backdropFilter: 'blur(8px)',
              zIndex: 2000,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              padding: '1rem'
            }} onClick={() => { setShowAddFiche(false); setEditingFiche(null); }}>
              <div onClick={(e) => e.stopPropagation()} style={{
                background: 'white',
                borderRadius: '16px',
                padding: '2rem',
                maxWidth: '600px',
                width: '100%',
                maxHeight: '80vh',
                overflowY: 'auto',
                boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
              }}>
                <h2 style={{ marginBottom: '1.5rem', color: '#1e293b' }}>
                  {editingFiche ? 'Modifier la fiche' : 'Nouvelle fiche'}
                </h2>

                <div style={{ marginBottom: '1.5rem' }}>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, color: '#1e293b' }}>
                    Nom de la fiche *
                  </label>
                  <input
                    type="text"
                    value={ficheForm.nom}
                    onChange={(e) => setFicheForm({ ...ficheForm, nom: e.target.value })}
                    placeholder="Ex: Protocole diab√®te"
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      border: '2px solid #e2e8f0',
                      borderRadius: '8px',
                      fontSize: '1rem'
                    }}
                  />
                </div>

                <div style={{ marginBottom: '1.5rem' }}>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, color: '#1e293b' }}>
                    URLs des pages (une par ligne) *
                  </label>
                  <textarea
                    value={ficheForm.urls}
                    onChange={(e) => setFicheForm({ ...ficheForm, urls: e.target.value })}
                    placeholder={'https://i.imgur.com/page1.jpg\nhttps://i.imgur.com/page2.jpg\nhttps://i.imgur.com/page3.jpg'}
                    rows={8}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      border: '2px solid #e2e8f0',
                      borderRadius: '8px',
                      fontSize: '0.9rem',
                      fontFamily: 'monospace',
                      resize: 'vertical'
                    }}
                  />
                  <div style={{ fontSize: '0.85rem', color: '#64748b', marginTop: '0.5rem' }}>
                    Chaque ligne = une page de la fiche
                  </div>
                </div>

                <div style={{ display: 'flex', gap: '1rem' }}>
                  <button
                    onClick={() => { setShowAddFiche(false); setEditingFiche(null); }}
                    style={{
                      flex: 1,
                      padding: '0.75rem',
                      background: '#f1f5f9',
                      color: '#475569',
                      border: 'none',
                      borderRadius: '8px',
                      cursor: 'pointer',
                      fontWeight: 600
                    }}
                  >
                    Annuler
                  </button>
                  <button
                    onClick={() => {
                      if (!ficheForm.nom.trim() || !ficheForm.urls.trim()) {
                        alert('Veuillez remplir tous les champs');
                        return;
                      }
                      const urls = ficheForm.urls.split('\n').map(u => u.trim()).filter(u => u);
                      if (urls.length === 0) {
                        alert('Ajoutez au moins une URL');
                        return;
                      }
                      const ficheData = {
                        nom: ficheForm.nom.trim(),
                        urls: urls
                      };
                      if (editingFiche) {
                        onUpdateFicheConseil(editingFiche.id, ficheData);
                      } else {
                        onAddFicheConseil(ficheData);
                      }
                      setShowAddFiche(false);
                      setEditingFiche(null);
                      setFicheForm({ nom: '', urls: '' });
                      setShowFichesModal(true);
                    }}
                    style={{
                      flex: 1,
                      padding: '0.75rem',
                      background: plainte.couleur,
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      cursor: 'pointer',
                      fontWeight: 600
                    }}
                  >
                    {editingFiche ? 'Enregistrer' : 'Ajouter'}
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Modal Visualisation fiche (scroll vertical) */}
          {showViewFiche && viewingFiche && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.9)',
              zIndex: 2000,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              padding: '1rem'
            }} onClick={() => { setShowViewFiche(false); setViewingFiche(null); }}>
              <div onClick={(e) => e.stopPropagation()} style={{
                background: 'white',
                borderRadius: '16px',
                width: '100%',
                maxWidth: '900px',
                maxHeight: '90vh',
                display: 'flex',
                flexDirection: 'column'
              }}>
                <div style={{
                  padding: '1rem 1.5rem',
                  borderBottom: '2px solid #e2e8f0',
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  gap: '1rem'
                }}>
                  <button
                    onClick={() => { setShowViewFiche(false); setViewingFiche(null); }}
                    style={{
                      padding: '0.5rem 1rem',
                      background: '#f1f5f9',
                      color: '#475569',
                      border: 'none',
                      borderRadius: '6px',
                      cursor: 'pointer',
                      fontWeight: 600,
                      fontSize: '0.9rem',
                      flexShrink: 0
                    }}
                  >
                    ‚Üê Retour
                  </button>
                  
                  <h3 style={{ margin: 0, color: '#1e293b', textAlign: 'center', flex: '0 1 auto', minWidth: 0, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                    {viewingFiche.nom}
                  </h3>
                  
                  <div style={{ display: 'flex', gap: '0.5rem', flexShrink: 0, flexWrap: 'wrap', justifyContent: 'flex-end' }}>
                    {/* Boutons pour chaque fiche */}
                    {(plainte.fichesConseils || []).map((fiche, idx) => (
                      <button
                        key={fiche.id}
                        onClick={() => {
                          setViewingFiche(fiche);
                        }}
                        style={{
                          padding: '0.5rem 0.75rem',
                          background: fiche.id === viewingFiche.id ? plainte.couleur : '#f1f5f9',
                          color: fiche.id === viewingFiche.id ? 'white' : '#475569',
                          border: 'none',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontWeight: 600,
                          fontSize: '0.85rem',
                          transition: 'all 0.2s'
                        }}
                        onMouseEnter={(e) => {
                          if (fiche.id !== viewingFiche.id) {
                            e.currentTarget.style.background = '#e2e8f0';
                          }
                        }}
                        onMouseLeave={(e) => {
                          if (fiche.id !== viewingFiche.id) {
                            e.currentTarget.style.background = '#f1f5f9';
                          }
                        }}
                        title={fiche.nom}
                      >
                        {idx + 1}
                      </button>
                    ))}
                    
                    {/* Bouton G√©rer */}
                    <button
                      onClick={() => {
                        setShowViewFiche(false);
                        setShowFichesModal(true);
                      }}
                      style={{
                        padding: '0.5rem 1rem',
                        background: '#667eea',
                        color: 'white',
                        border: 'none',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        fontWeight: 600,
                        fontSize: '0.9rem'
                      }}
                    >
                      G√©rer
                    </button>
                  </div>
                </div>

                <div style={{
                  flex: 1,
                  overflowY: 'auto',
                  padding: '1.5rem',
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '1rem',
                  background: '#f8fafc'
                }}>
                  {viewingFiche.urls.map((url, index) => (
                    <div key={index} style={{
                      background: 'white',
                      borderRadius: '8px',
                      padding: '0.5rem',
                      boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                    }}>
                      <div style={{
                        fontSize: '0.85rem',
                        color: '#64748b',
                        marginBottom: '0.5rem',
                        fontWeight: 600
                      }}>
                        Page {index + 1} / {viewingFiche.urls.length}
                      </div>
                      <img
                        src={url}
                        alt={`Page ${index + 1}`}
                        style={{
                          width: '100%',
                          height: 'auto',
                          borderRadius: '4px',
                          cursor: 'pointer'
                        }}
                        onClick={() => setImageModalUrl(url)}
                        onError={(e) => {
                          e.target.style.display = 'none';
                          e.target.parentElement.innerHTML += '<div style="padding: 2rem; text-align: center; color: #ef4444;">Erreur de chargement</div>';
                        }}
                      />
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}
          
          <div style={{ maxWidth: 'none', margin: '0', padding: '0 2rem' }}>
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '1.25rem 1.5rem',
            marginBottom: '1.5rem',
            boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
            borderLeft: `4px solid ${plainte.couleur}`
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <div style={{ flex: 1, display: 'flex', alignItems: 'center', gap: '1.5rem' }}>
                <button
                  onClick={onBack}
                  style={{
                    background: '#f8fafc',
                    border: '1px solid #e2e8f0',
                    padding: '0.5rem 1rem',
                    borderRadius: '6px',
                    cursor: 'pointer',
                    color: '#64748b',
                    fontWeight: 600,
                    fontSize: '0.9rem',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem'
                  }}
                >
                  ‚Üê Retour
                </button>
                
                <h1 style={{ fontSize: '1.5rem', fontWeight: 700, color: '#0f172a', margin: 0 }}>{plainte.nom}</h1>
              </div>

              <div style={{ display: 'flex', gap: '0.5rem' }}>
                <button
                  onClick={onEdit}
                  style={{
                    background: plainte.couleur,
                    color: 'white',
                    border: 'none',
                    width: '36px',
                    height: '36px',
                    borderRadius: '6px',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}
                >
                  <EditIcon />
                </button>
                <button
                  onClick={onDelete}
                  style={{
                    background: '#ef4444',
                    color: 'white',
                    border: 'none',
                    width: '36px',
                    height: '36px',
                    borderRadius: '6px',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}
                >
                  <DeleteIcon />
                </button>
              </div>
            </div>
          </div>

          <div style={{
            display: 'flex',
            gap: '0.5rem',
            marginBottom: '1.5rem',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <div style={{ display: 'flex', gap: '0.5rem' }}>
              {['info', 'specialites', 'documents'].map(tab => (
                <button
                  key={tab}
                  onClick={() => setActiveTab(tab)}
                  style={{
                    background: activeTab === tab ? plainte.couleur : '#f1f5f9',
                    color: activeTab === tab ? 'white' : '#475569',
                    border: activeTab === tab ? 'none' : '2px solid #e2e8f0',
                    padding: '0.75rem 1.5rem',
                    borderRadius: '12px',
                    cursor: 'pointer',
                    fontWeight: 600,
                    transition: 'all 0.3s',
                    boxShadow: activeTab === tab ? '0 4px 20px rgba(0,0,0,0.15)' : 'none'
                  }}
                >
                  {tab === 'info' && 'Informations'}
                  {tab === 'specialites' && `Sp√©cialit√©s (${plainte.specialites ? plainte.specialites.length : 0})`}
                  {tab === 'documents' && `Documents (${(plainte.documents || []).length})`}
                </button>
              ))}
            </div>
            
            {/* Bouton Fiches conseils √† droite */}
            <button
              onClick={() => {
                const fiches = plainte.fichesConseils || [];
                if (fiches.length > 0) {
                  // Trouver la fiche √©pingl√©e ou prendre la premi√®re
                  const pinnedFiche = fiches.find(f => f.isPinned);
                  const ficheToOpen = pinnedFiche || fiches[0];
                  setViewingFiche(ficheToOpen);
                  setShowViewFiche(true);
                } else {
                  // Si aucune fiche, ouvrir le modal d'ajout
                  setEditingFiche(null);
                  setFicheForm({ nom: '', urls: '' });
                  setShowAddFiche(true);
                }
              }}
              style={{
                background: '#f1f5f9',
                color: '#475569',
                border: '2px solid #e2e8f0',
                padding: '0.75rem 1.5rem',
                borderRadius: '12px',
                cursor: 'pointer',
                fontWeight: 600,
                transition: 'all 0.3s',
                display: 'flex',
                alignItems: 'center',
                gap: '0.5rem'
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.background = plainte.couleur;
                e.currentTarget.style.color = 'white';
                e.currentTarget.style.border = 'none';
                e.currentTarget.style.boxShadow = '0 4px 20px rgba(0,0,0,0.15)';
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.background = '#f1f5f9';
                e.currentTarget.style.color = '#475569';
                e.currentTarget.style.border = '2px solid #e2e8f0';
                e.currentTarget.style.boxShadow = 'none';
              }}
            >
              Fiches conseils{(plainte.fichesConseils && plainte.fichesConseils.length > 0) ? ` (${plainte.fichesConseils.length})` : ''}
            </button>
          </div>

          {activeTab === 'info' && (
            <InformationsTab
              plainte={plainte}
              onUpdateInfo={(val) => onUpdatePlainteInfo('informations', val)}
              handleImageURL={handleImageURL}
              couleur={plainte.couleur}
            />
          )}

          {activeTab === 'specialites' && (
            <SpecialitesTab
              plainte={plainte}
              onAddSpecialite={onAddSpecialite}
              onEditSpecialite={onEditSpecialite}
              onDeleteSpecialite={onDeleteSpecialite}
              onMoveSpecialiteUp={onMoveSpecialiteUp}
              onMoveSpecialiteDown={onMoveSpecialiteDown}
              onShowImportModal={onShowImportModal}
              setImageModalUrl={setImageModalUrl}
            />
          )}

          {activeTab === 'documents' && (
            <DocumentsTab
              plainte={plainte}
              onAddDocument={onAddDocument}
              onDeleteDocument={onDeleteDocument}
              onEditDocument={onEditDocument}
              onRenameCategoryInDocuments={onRenameCategoryInDocuments}
              onMoveDocument={onMoveDocument}
            />
          )}
        </div>
        </div>
      );
    }

    function InformationsTab({ plainte, onUpdateInfo, handleImageURL, couleur }) {
      const [editing, setEditing] = useState(false);
      const [tempValue, setTempValue] = useState(plainte.informations || '');
      const [showHelp, setShowHelp] = useState(false);
      const [helpPinned, setHelpPinned] = useState(false);
      const editorRef = React.useRef(null);
      const blockInputUpdate = React.useRef(false); // Bloquer temporairement onInput
      const savedSelection = React.useRef(null); // Sauvegarder la position du curseur
      const editingImageContainer = React.useRef(null); // Container de l'image en cours d'√©dition
      const [showImageModal, setShowImageModal] = useState(false);
      const [imageUrls, setImageUrls] = useState('');
      const [imageSize, setImageSize] = useState('50');
      const [imageAlign, setImageAlign] = useState('left');

      // Fonction pour nettoyer le HTML des boutons d'√©dition avant affichage
      const cleanHTMLForDisplay = (html) => {
        if (!html) return '';
        // Cr√©er un √©l√©ment temporaire pour parser le HTML
        const temp = document.createElement('div');
        temp.innerHTML = html;
        
        // Supprimer tous les boutons d'√©dition d'images
        const imageBtns = temp.querySelectorAll('.image-btns');
        imageBtns.forEach(btn => btn.remove());
        
        return temp.innerHTML;
      };

      const attachImageButtonListeners = () => {
        if (!editorRef.current) return;
        
        console.log('üîó Attachement des listeners aux boutons d\'images');
        
        // Boutons Modifier
        const editBtns = editorRef.current.querySelectorAll('.img-btn.edit');
        console.log('‚úé Boutons Modifier trouv√©s:', editBtns.length);
        
        editBtns.forEach((btn, index) => {
          btn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('‚úé Clic sur modifier');
            
            const wrapper = btn.closest('.image-wrapper');
            const img = wrapper?.querySelector('img');
            
            if (wrapper && img) {
              // Sauvegarder le wrapper pour le remplacer plus tard
              editingImageContainer.current = wrapper;
              
              // Pr√©remplir le modal avec l'URL actuelle
              setImageUrls(img.src);
              
              // D√©tecter la taille approximative
              const wrapperStyle = wrapper.style.maxWidth;
              if (wrapperStyle && wrapperStyle.includes('%')) {
                setImageSize(wrapperStyle.replace('%', ''));
              } else {
                setImageSize('50');
              }
              
              setShowImageModal(true);
              console.log('‚úÖ Modal ouvert pour modification');
            }
          };
        });
        
        // Boutons Supprimer
        const deleteBtns = editorRef.current.querySelectorAll('.img-btn.delete');
        console.log('‚úï Boutons Supprimer trouv√©s:', deleteBtns.length);
        
        deleteBtns.forEach((btn, index) => {
          btn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('üóëÔ∏è Clic sur supprimer');
            
            if (confirm('Supprimer cette image ?')) {
              const wrapper = btn.closest('.image-wrapper');
              
              if (wrapper) {
                // Cr√©er un √©l√©ment de remplacement √©ditable
                const placeholder = document.createElement('div');
                placeholder.innerHTML = '<br>';
                
                // Remplacer le wrapper par le placeholder
                wrapper.replaceWith(placeholder);
                
                // Mettre √† jour tempValue
                blockInputUpdate.current = true;
                setTempValue(editorRef.current.innerHTML);
                setTimeout(() => {
                  blockInputUpdate.current = false;
                }, 100);
                
                console.log('‚úÖ Image supprim√©e');
              }
            }
          };
        });
      };

      useEffect(() => {
        // Initialiser seulement au passage en mode √©dition, pas √† chaque changement
        if (editing && editorRef.current) {
          editorRef.current.innerHTML = tempValue || plainte.informations || '';
          // Attacher les listeners apr√®s l'initialisation
          setTimeout(() => attachImageButtonListeners(), 100);
        }
      }, [editing]); // Seulement quand editing change, pas plainte.informations

      useEffect(() => {
        // Attacher les listeners chaque fois que tempValue change (nouvelle image ajout√©e)
        if (editing && editorRef.current) {
          setTimeout(() => attachImageButtonListeners(), 100);
        }
      }, [tempValue, editing]);

      useEffect(() => {
        // Mettre √† jour tempValue quand plainte.informations change ET qu'on n'est PAS en √©dition
        if (!editing) {
          setTempValue(plainte.informations || '');
        }
      }, [plainte.informations, editing]);

      if (editing) {
        return (
          <>
            <style>{`
              [contenteditable="true"]:empty:before {
                content: attr(placeholder);
                color: #9ca3af;
                pointer-events: none;
              }
              [contenteditable="true"]:focus {
                outline: none;
              }
              
              /* Container pour les images */
              [contenteditable="true"] .image-wrapper {
                position: relative;
                display: inline-block;
                margin: 1rem 0;
                vertical-align: top;
              }
              
              /* Boutons cach√©s par d√©faut */
              [contenteditable="true"] .image-btns {
                position: absolute;
                top: 8px;
                right: 8px;
                display: none;
                gap: 4px;
                z-index: 10;
              }
              
              /* Afficher les boutons au survol */
              [contenteditable="true"] .image-wrapper:hover .image-btns {
                display: flex !important;
              }
              
              /* Style des boutons */
              [contenteditable="true"] .img-btn {
                color: white;
                border: none;
                width: 32px;
                height: 32px;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
                font-weight: bold;
                transition: all 0.2s;
                line-height: 1;
              }
              
              [contenteditable="true"] .img-btn.edit {
                background: rgba(59, 130, 246, 0.9);
              }
              
              [contenteditable="true"] .img-btn.edit:hover {
                background: rgba(37, 99, 235, 1);
                transform: scale(1.1);
              }
              
              [contenteditable="true"] .img-btn.delete {
                background: rgba(239, 68, 68, 0.9);
              }
              
              [contenteditable="true"] .img-btn.delete:hover {
                background: rgba(220, 38, 38, 1);
                transform: scale(1.1);
              }
            `}</style>
            <div style={{ background: 'white', borderRadius: '20px', padding: '2rem', paddingBottom: '4rem', boxShadow: '0 4px 20px rgba(0,0,0,0.1)' }}>
            {/* BARRE D'OUTILS DE FORMATAGE */}
            <div style={{
              display: 'flex',
              flexWrap: 'wrap',
              gap: '0.5rem',
              marginBottom: '1rem',
              padding: '1rem',
              background: '#f8fafc',
              borderRadius: '12px',
              border: '2px solid #e2e8f0'
            }}>
              <button
                onClick={() => {
                  document.execCommand('bold', false, null);
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: 'white',
                  border: '2px solid #e2e8f0',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: 'bold',
                  fontSize: '0.9rem'
                }}
                title="Gras"
              >
                <strong>B</strong>
              </button>

              <button
                onClick={() => {
                  document.execCommand('italic', false, null);
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: 'white',
                  border: '2px solid #e2e8f0',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontStyle: 'italic',
                  fontSize: '0.9rem'
                }}
                title="Italique"
              >
                <em>I</em>
              </button>

              <button
                onClick={() => {
                  document.execCommand('underline', false, null);
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: 'white',
                  border: '2px solid #e2e8f0',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  textDecoration: 'underline',
                  fontSize: '0.9rem'
                }}
                title="Soulign√©"
              >
                <u>U</u>
              </button>

              <button
                onClick={() => {
                  document.execCommand('strikeThrough', false, null);
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: 'white',
                  border: '2px solid #e2e8f0',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  textDecoration: 'line-through',
                  fontSize: '0.9rem'
                }}
                title="Barr√©"
              >
                <s>S</s>
              </button>

              <div style={{ width: '2px', background: '#cbd5e1' }}></div>

              <button
                onClick={() => {
                  document.execCommand('foreColor', false, '#dc2626');
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: '#fecaca',
                  border: '2px solid #ef4444',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  color: '#dc2626',
                  fontWeight: 600,
                  fontSize: '0.85rem'
                }}
                title="Rouge"
              >
                üî¥
              </button>

              <button
                onClick={() => {
                  document.execCommand('foreColor', false, '#1e293b');
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: '#f1f5f9',
                  border: '2px solid #64748b',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  color: '#1e293b',
                  fontWeight: 600,
                  fontSize: '0.85rem'
                }}
                title="Noir"
              >
                ‚ö´
              </button>

              <button
                onClick={() => {
                  document.execCommand('foreColor', false, '#1d4ed8');
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: '#bfdbfe',
                  border: '2px solid #3b82f6',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  color: '#1d4ed8',
                  fontWeight: 600,
                  fontSize: '0.85rem'
                }}
                title="Bleu"
              >
                üîµ
              </button>

              <button
                onClick={() => {
                  document.execCommand('foreColor', false, '#047857');
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: '#bbf7d0',
                  border: '2px solid #10b981',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  color: '#047857',
                  fontWeight: 600,
                  fontSize: '0.85rem'
                }}
                title="Vert"
              >
                üü¢
              </button>

              <button
                onClick={() => {
                  document.execCommand('foreColor', false, '#c2410c');
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: '#fed7aa',
                  border: '2px solid #f97316',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  color: '#c2410c',
                  fontWeight: 600,
                  fontSize: '0.85rem'
                }}
                title="Orange"
              >
                üü†
              </button>

              <div style={{ width: '2px', background: '#cbd5e1' }}></div>

              <button
                onClick={() => {
                  document.execCommand('hiliteColor', false, '#fef08a');
                  document.querySelector('[contenteditable="true"]').focus();
                }}
                style={{
                  background: '#fef08a',
                  border: '2px solid #fbbf24',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  color: '#854d0e',
                  fontWeight: 600,
                  fontSize: '0.85rem'
                }}
                title="Surligner jaune"
              >
                üñçÔ∏è
              </button>
            </div>

            <div
              ref={editorRef}
              contentEditable="true"
              onInput={(e) => {
                if (!blockInputUpdate.current) {
                  setTempValue(e.currentTarget.innerHTML);
                }
              }}
              placeholder="D√©marche √† suivre, questions √† poser, sch√©ma, notes de cours..."
              style={{
                width: '100%',
                minHeight: '300px',
                padding: '1rem',
                border: `2px solid ${couleur}`,
                borderRadius: '12px',
                fontSize: '1rem',
                fontFamily: 'inherit',
                marginBottom: '1rem',
                overflowY: 'auto',
                background: 'white'
              }}
            />

            <div style={{ display: 'flex', gap: '0.75rem', marginBottom: '1rem' }}>
              <button
                onClick={() => {
                  // Sauvegarder la position du curseur AVANT d'ouvrir le modal
                  const selection = window.getSelection();
                  if (selection.rangeCount > 0) {
                    savedSelection.current = selection.getRangeAt(0).cloneRange();
                    console.log('üíæ Position du curseur sauvegard√©e');
                  }
                  setShowImageModal(true);
                }}
                style={{
                  background: '#f8fafc',
                  border: '2px solid #e2e8f0',
                  padding: '0.75rem 1.5rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: 600,
                  color: '#475569'
                }}
              >
                üñºÔ∏è Ajouter image(s)
              </button>
            </div>

            {/* Modal d'ajout d'images */}
            {showImageModal && (
              <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.6)',
                backdropFilter: 'blur(8px)',
                zIndex: 3000,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                padding: '1rem'
              }} onClick={() => setShowImageModal(false)}>
                <div onClick={(e) => e.stopPropagation()} style={{
                  background: 'white',
                  borderRadius: '16px',
                  padding: '2rem',
                  maxWidth: '600px',
                  width: '100%',
                  boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
                }}>
                  <h3 style={{ margin: '0 0 1.5rem 0', color: '#1e293b' }}>Ajouter des images</h3>

                  <div style={{ marginBottom: '1.5rem' }}>
                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, color: '#1e293b' }}>
                      URLs des images (une par ligne)
                    </label>
                    <textarea
                      value={imageUrls}
                      onChange={(e) => setImageUrls(e.target.value)}
                      placeholder={'https://i.imgur.com/image1.jpg\nhttps://i.imgur.com/image2.jpg'}
                      rows={4}
                      style={{
                        width: '100%',
                        padding: '0.75rem',
                        border: '2px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '0.9rem',
                        fontFamily: 'monospace',
                        resize: 'vertical'
                      }}
                    />
                  </div>

                  <div style={{ marginBottom: '1.5rem' }}>
                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, color: '#1e293b' }}>
                      Taille : {imageSize}%
                    </label>
                    <input
                      type="range"
                      min="20"
                      max="100"
                      step="10"
                      value={imageSize}
                      onChange={(e) => setImageSize(e.target.value)}
                      style={{ width: '100%' }}
                    />
                    <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.8rem', color: '#64748b', marginTop: '0.25rem' }}>
                      <span>Petite (20%)</span>
                      <span>Moyenne (50%)</span>
                      <span>Grande (100%)</span>
                    </div>
                  </div>

                  <div style={{ marginBottom: '1.5rem' }}>
                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, color: '#1e293b' }}>
                      Alignement
                    </label>
                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                      <button
                        onClick={() => setImageAlign('left')}
                        style={{
                          flex: 1,
                          padding: '0.75rem',
                          background: imageAlign === 'left' ? couleur : '#f1f5f9',
                          color: imageAlign === 'left' ? 'white' : '#475569',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontWeight: 600
                        }}
                      >
                        ‚Üê Gauche
                      </button>
                      <button
                        onClick={() => setImageAlign('center')}
                        style={{
                          flex: 1,
                          padding: '0.75rem',
                          background: imageAlign === 'center' ? couleur : '#f1f5f9',
                          color: imageAlign === 'center' ? 'white' : '#475569',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontWeight: 600
                        }}
                      >
                        ‚Üî Centre
                      </button>
                      <button
                        onClick={() => setImageAlign('row')}
                        style={{
                          flex: 1,
                          padding: '0.75rem',
                          background: imageAlign === 'row' ? couleur : '#f1f5f9',
                          color: imageAlign === 'row' ? 'white' : '#475569',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontWeight: 600
                        }}
                      >
                        ‚áÑ C√¥te √† c√¥te
                      </button>
                    </div>
                  </div>

                  <div style={{ display: 'flex', gap: '1rem' }}>
                    <button
                      onClick={() => {
                        setShowImageModal(false);
                        setImageUrls('');
                      }}
                      style={{
                        flex: 1,
                        padding: '0.75rem',
                        background: '#f1f5f9',
                        color: '#475569',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontWeight: 600
                      }}
                    >
                      Annuler
                    </button>
                    <button
                      onClick={() => {
                        console.log('üîç Clic sur Ins√©rer');
                        const urls = imageUrls.split('\n').map(u => u.trim()).filter(u => u);
                        console.log('üìã URLs:', urls);
                        
                        if (urls.length === 0) {
                          alert('Ajoutez au moins une URL');
                          return;
                        }

                        let htmlToInsert = '';
                        
                        if (imageAlign === 'row') {
                          // Images c√¥te √† c√¥te
                          htmlToInsert = '<div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 1rem 0;">';
                          urls.forEach(url => {
                            const width = Math.floor(100 / urls.length) - 2;
                            htmlToInsert += `
                              <span class="image-wrapper" contenteditable="false" style="position: relative; flex: 1; min-width: ${width}%;">
                                <img src="${url}" style="width: 100%; height: auto; border-radius: 8px; object-fit: contain; display: block;" />
                                <span class="image-btns">
                                  <button class="img-btn edit" contenteditable="false" title="Modifier">‚úé</button>
                                  <button class="img-btn delete" contenteditable="false" title="Supprimer">‚úï</button>
                                </span>
                              </span>
                            `;
                          });
                          htmlToInsert += '</div>';
                        } else {
                          // Images align√©es gauche ou centre
                          urls.forEach(url => {
                            if (imageAlign === 'center') {
                              // Centre : utiliser margin auto
                              htmlToInsert += `
                                <div style="margin: 1rem 0; text-align: center;">
                                  <span class="image-wrapper" contenteditable="false" style="position: relative; display: inline-block; max-width: ${imageSize}%;">
                                    <img src="${url}" style="width: 100%; height: auto; border-radius: 8px; display: block;" />
                                    <span class="image-btns">
                                      <button class="img-btn edit" contenteditable="false" title="Modifier">‚úé</button>
                                      <button class="img-btn delete" contenteditable="false" title="Supprimer">‚úï</button>
                                    </span>
                                  </span>
                                </div>
                              `;
                            } else {
                              // Gauche : alignement normal
                              htmlToInsert += `
                                <span class="image-wrapper" contenteditable="false" style="position: relative; display: inline-block; max-width: ${imageSize}%;">
                                  <img src="${url}" style="width: 100%; height: auto; border-radius: 8px; display: block;" />
                                  <span class="image-btns">
                                    <button class="img-btn edit" contenteditable="false" title="Modifier">‚úé</button>
                                    <button class="img-btn delete" contenteditable="false" title="Supprimer">‚úï</button>
                                  </span>
                                </span>
                              `;
                            }
                          });
                        }

                        console.log('üñºÔ∏è HTML √† ins√©rer:', htmlToInsert);
                        
                        const editor = document.querySelector('[contenteditable="true"]');
                        console.log('üìù √âditeur trouv√©:', editor);
                        
                        if (editor) {
                          blockInputUpdate.current = true;
                          
                          // Si on modifie une image existante
                          if (editingImageContainer.current) {
                            console.log('üîÑ Mode modification d\'image');
                            // Remplacer le container existant
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = htmlToInsert;
                            const newContainer = tempDiv.firstElementChild;
                            
                            editingImageContainer.current.replaceWith(newContainer);
                            editingImageContainer.current = null;
                            
                            console.log('‚úÖ Image modifi√©e');
                          } else {
                            // Mode ajout normal
                            console.log('‚ûï Mode ajout d\'image');
                            
                            // Restaurer la position du curseur sauvegard√©e
                            if (savedSelection.current) {
                              const selection = window.getSelection();
                              selection.removeAllRanges();
                              selection.addRange(savedSelection.current);
                              console.log('üîÑ Position du curseur restaur√©e');
                            }
                            
                            // S'assurer que l'√©diteur a le focus
                            editor.focus();
                            
                            // Utiliser execCommand qui respecte la position du curseur
                            document.execCommand('insertHTML', false, htmlToInsert);
                            
                            console.log('‚úÖ Image ins√©r√©e avec execCommand');
                          }
                          
                          // Attendre que le DOM soit mis √† jour
                          setTimeout(() => {
                            console.log('üìÑ Contenu apr√®s insertion:', editor.innerHTML);
                            
                            // Mettre √† jour tempValue avec le nouveau contenu
                            setTempValue(editor.innerHTML);
                            
                            // R√©activer les updates onInput
                            setTimeout(() => {
                              blockInputUpdate.current = false;
                              console.log('üîì Updates r√©activ√©s');
                              
                              // R√©attacher les listeners sur les nouveaux boutons
                              attachImageButtonListeners();
                            }, 100);
                          }, 50);
                        } else {
                          console.error('‚ùå √âditeur non trouv√© !');
                        }
                        
                        setShowImageModal(false);
                        setImageUrls('');
                        setImageSize('50');
                        setImageAlign('left');
                      }}
                      style={{
                        flex: 1,
                        padding: '0.75rem',
                        background: couleur,
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontWeight: 600
                      }}
                    >
                      Ins√©rer
                    </button>
                  </div>
                </div>
              </div>
            )}

            <div style={{ display: 'flex', gap: '0.75rem' }}>
              <button
                onClick={() => {
                  onUpdateInfo(tempValue);
                  setEditing(false);
                }}
                style={{
                  background: couleur,
                  color: 'white',
                  border: 'none',
                  padding: '0.75rem 1.5rem',
                  borderRadius: '12px',
                  fontWeight: 600,
                  cursor: 'pointer'
                }}
              >
                Enregistrer
              </button>
              <button
                onClick={() => {
                  setTempValue(plainte.informations || '');
                  setEditing(false);
                }}
                style={{
                  background: '#e2e8f0',
                  color: '#475569',
                  border: 'none',
                  padding: '0.75rem 1.5rem',
                  borderRadius: '12px',
                  fontWeight: 600,
                  cursor: 'pointer'
                }}
              >
                Annuler
              </button>
            </div>
          </div>
          </>
        );
      }

      return (
        <div style={{ background: 'white', borderRadius: '20px', padding: '2rem', paddingBottom: '4rem', boxShadow: '0 4px 20px rgba(0,0,0,0.1)', position: 'relative' }}>
          <button
            onClick={() => setEditing(true)}
            style={{
              position: 'absolute',
              top: '1.5rem',
              right: '1.5rem',
              background: couleur,
              color: 'white',
              border: 'none',
              width: '40px',
              height: '40px',
              borderRadius: '8px',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center'
            }}
          >
            <EditIcon />
          </button>

          {plainte.informations ? (
            <div 
              style={{ color: '#1e293b', fontSize: '1rem', lineHeight: '1.8', paddingRight: '3rem' }}
              dangerouslySetInnerHTML={{ __html: cleanHTMLForDisplay(plainte.informations) }}
            />
          ) : (
            <p style={{ color: '#94a3b8', fontStyle: 'italic' }}>Cliquez sur l'ic√¥ne pour ajouter du contenu</p>
          )}
        </div>
      );
    }

    function SpecialitesTab({ plainte, onAddSpecialite, onEditSpecialite, onDeleteSpecialite, onMoveSpecialiteUp, onMoveSpecialiteDown, onShowImportModal, setImageModalUrl }) {
      return (
        <div style={{ paddingBottom: '2rem' }}>
          <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1.5rem', justifyContent: 'flex-end' }}>
            <button
              onClick={onAddSpecialite}
              style={{
                background: plainte.couleur,
                color: 'white',
                border: 'none',
                padding: '0.6rem 1.2rem',
                borderRadius: '8px',
                fontWeight: 600,
                cursor: 'pointer',
                fontSize: '0.9rem',
                boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
              }}
            >
              + Ajouter une sp√©cialit√©
            </button>
            {onShowImportModal && (
              <button
                onClick={onShowImportModal}
                style={{
                  background: '#64748b',
                  color: 'white',
                  border: 'none',
                  padding: '0.6rem 1rem',
                  borderRadius: '8px',
                  fontWeight: 600,
                  cursor: 'pointer',
                  fontSize: '0.9rem',
                  boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                  whiteSpace: 'nowrap'
                }}
                title="Importer depuis Flashcards"
              >
                Import
              </button>
            )}
          </div>

          {(!plainte.specialites || plainte.specialites.length === 0) ? (
            <div style={{
              background: 'white',
              padding: '3rem',
              borderRadius: '16px',
              textAlign: 'center',
              color: '#64748b'
            }}>
              <p>Aucune sp√©cialit√© ajout√©e</p>
            </div>
          ) : (
            <div style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))',
              gap: '1.5rem'
            }}>
              {plainte.specialites.map((spec, index) => (
                <SpecialiteCard
                  key={spec.id}
                  specialite={spec}
                  couleur={plainte.couleur}
                  plainte={plainte}
                  onEdit={() => onEditSpecialite(spec)}
                  onDelete={() => onDeleteSpecialite(spec.id)}
                  onMoveUp={() => onMoveSpecialiteUp(spec.id)}
                  onMoveDown={() => onMoveSpecialiteDown(spec.id)}
                  canMoveUp={index > 0}
                  canMoveDown={index < plainte.specialites.length - 1}
                  setImageModalUrl={setImageModalUrl}
                />
              ))}
            </div>
          )}
        </div>
      );
    }

    function DocumentsTab({ plainte, onAddDocument, onDeleteDocument, onEditDocument, onRenameCategoryInDocuments, onMoveDocument }) {
      const [showAddModal, setShowAddModal] = useState(false);
      const [editingDoc, setEditingDoc] = useState(null);
      const [editName, setEditName] = useState('');
      const [editUrl, setEditUrl] = useState('');
      const [editCategory, setEditCategory] = useState('');
      const [linkName, setLinkName] = useState('');
      const [linkUrl, setLinkUrl] = useState('');
      const [linkCategory, setLinkCategory] = useState('');
      const [showCategoryManager, setShowCategoryManager] = useState(false);
      const [docCategories, setDocCategories] = useState(() => {
        // D'abord essayer de charger depuis l'objet plainte
        if (plainte.docCategories && plainte.docCategories.length > 0) {
          return plainte.docCategories;
        }
        // Sinon essayer localStorage
        const saved = localStorage.getItem('docCategories_' + plainte.id);
        return saved ? JSON.parse(saved) : ['Important'];
      });
      const [newCategory, setNewCategory] = useState('');
      const [editingCategory, setEditingCategory] = useState(null);
      const [editCategoryName, setEditCategoryName] = useState('');

      // Initialiser linkCategory avec la premi√®re cat√©gorie quand le modal s'ouvre
      React.useEffect(() => {
        if (showAddModal && docCategories.length > 0) {
          setLinkCategory(docCategories[0]);
        }
      }, [showAddModal, docCategories]);

      // Sauvegarder les cat√©gories dans localStorage, Firebase ET dans l'objet plainte
      React.useEffect(() => {
        // Sauvegarder les cat√©gories sp√©cifiques √† cette plainte
        localStorage.setItem('docCategories_' + plainte.id, JSON.stringify(docCategories));
        
        // Sauvegarder aussi sur Firebase
        if (firebaseEnabled) {
          db.ref('docCategories/' + plainte.id).set(docCategories).catch(err => {
            console.error('‚ùå Erreur sauvegarde docCategories:', err);
          });
        }
      }, [docCategories, plainte.id]);

      const handleAddLink = () => {
        if (!linkName.trim() || !linkUrl.trim()) {
          alert('Nom et URL sont obligatoires');
          return;
        }
        if (!linkUrl.startsWith('http')) {
          alert("L'URL doit commencer par http:// ou https://");
          return;
        }

        onAddDocument({
          type: 'link',
          nom: linkName,
          data: linkUrl,
          category: linkCategory || docCategories[0] || 'Important'
        });

        setLinkName('');
        setLinkUrl('');
        setLinkCategory('');
        setShowAddModal(false);
      };

      const handleAddCategory = () => {
        if (!newCategory.trim()) {
          alert('Le nom de la cat√©gorie ne peut pas √™tre vide');
          return;
        }
        if (docCategories.includes(newCategory.trim())) {
          alert('Cette cat√©gorie existe d√©j√†');
          return;
        }
        setDocCategories([...docCategories, newCategory.trim()]);
        setNewCategory('');
      };

      const handleEditCategory = (oldName, newName) => {
        if (!newName.trim()) {
          alert('Le nom de la cat√©gorie ne peut pas √™tre vide');
          return;
        }
        if (oldName !== newName && docCategories.includes(newName)) {
          alert('Cette cat√©gorie existe d√©j√†');
          return;
        }
        // Mettre √† jour la liste des cat√©gories
        setDocCategories(docCategories.map(cat => cat === oldName ? newName : cat));
        // Mettre √† jour tous les documents qui ont cette cat√©gorie
        if (onRenameCategoryInDocuments) {
          onRenameCategoryInDocuments(oldName, newName);
        }
        setEditingCategory(null);
        setEditCategoryName('');
      };

      const handleDeleteCategory = (categoryName) => {
        // Emp√™cher la suppression de "Important"
        if (categoryName === 'Important') {
          alert('La cat√©gorie "Important" ne peut pas √™tre supprim√©e car elle est obligatoire.');
          return;
        }
        
        const docsInCategory = (plainte.documents || []).filter(doc => (doc.category || 'Important') === categoryName).length;
        if (docsInCategory > 0) {
          if (!confirm(`‚ö†Ô∏è ${docsInCategory} document(s) sont dans cette cat√©gorie.\n\nSupprimer quand m√™me ?\n(Les documents seront d√©plac√©s vers "Important")`)) {
            return;
          }
        } else {
          if (!confirm(`Supprimer la cat√©gorie "${categoryName}" ?`)) {
            return;
          }
        }
        setDocCategories(docCategories.filter(cat => cat !== categoryName));
      };

      const handleMoveCategoryUp = (index) => {
        if (index === 0) return;
        const newCategories = [...docCategories];
        [newCategories[index - 1], newCategories[index]] = [newCategories[index], newCategories[index - 1]];
        setDocCategories(newCategories);
      };

      const handleMoveCategoryDown = (index) => {
        if (index === docCategories.length - 1) return;
        const newCategories = [...docCategories];
        [newCategories[index], newCategories[index + 1]] = [newCategories[index + 1], newCategories[index]];
        setDocCategories(newCategories);
      };

      const openDocument = (doc) => {
        window.open(doc.data, '_blank');
      };

      // Grouper les documents par cat√©gorie (recalcul√© quand plainte.documents ou docCategories changent)
      const groupedDocs = React.useMemo(() => {
        const grouped = {};
        docCategories.forEach(cat => {
          grouped[cat] = (plainte.documents || []).filter(doc => (doc.category || 'Important') === cat);
        });
        // Ajouter les documents sans cat√©gorie ou avec cat√©gorie supprim√©e
        const uncategorized = (plainte.documents || []).filter(doc => !docCategories.includes(doc.category || 'Important'));
        if (uncategorized.length > 0) {
          grouped['Important'] = [...(grouped['Important'] || []), ...uncategorized];
        }
        return grouped;
      }, [plainte.documents, docCategories]);

      // Cr√©er une liste de cat√©gories √† afficher (inclut "Important" si des documents y sont)
      const categoriesToDisplay = React.useMemo(() => {
        const cats = [...docCategories];
        // Si des documents sont dans "Important" et que "Important" n'est pas dans la liste, l'ajouter
        if (groupedDocs['Important'] && groupedDocs['Important'].length > 0 && !cats.includes('Important')) {
          cats.unshift('Important'); // Ajouter en premier
        }
        return cats;
      }, [docCategories, groupedDocs]);

      return (
        <div style={{ paddingBottom: '2rem' }}>
          <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1.5rem', justifyContent: 'flex-end' }}>
            <button
              onClick={() => setShowAddModal(true)}
              style={{
                background: plainte.couleur,
                color: 'white',
                border: 'none',
                padding: '0.6rem 1.2rem',
                borderRadius: '8px',
                fontWeight: 600,
                cursor: 'pointer',
                fontSize: '0.9rem',
                boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
              }}
            >
              + Ajouter un lien
            </button>
            <button
              onClick={() => setShowCategoryManager(true)}
              style={{
                background: '#64748b',
                color: 'white',
                border: 'none',
                padding: '0.6rem 1rem',
                borderRadius: '8px',
                fontWeight: 600,
                cursor: 'pointer',
                fontSize: '0.9rem',
                boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
              }}
            >
              Cat√©gories
            </button>
          </div>

          {/* MODAL GESTIONNAIRE DE CAT√âGORIES */}
          {showCategoryManager && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.5)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 1000
            }}>
              <div 
                onClick={(e) => e.stopPropagation()}
                style={{
                  background: 'white',
                  borderRadius: '20px',
                  padding: '2rem',
                  maxWidth: '500px',
                  width: '90%',
                  maxHeight: '80vh',
                  overflow: 'auto'
                }}>
                <h3 style={{ marginBottom: '1.5rem', color: '#1e293b' }}>G√©rer les cat√©gories</h3>

                {/* Ajouter nouvelle cat√©gorie */}
                <div style={{ marginBottom: '1.5rem', padding: '1rem', background: '#f8fafc', borderRadius: '12px' }}>
                  <h4 style={{ marginBottom: '0.75rem', color: '#475569', fontSize: '0.9rem' }}>Ajouter une cat√©gorie</h4>
                  <div style={{ display: 'flex', gap: '0.5rem' }}>
                    <input
                      type="text"
                      placeholder="Nom de la cat√©gorie"
                      value={newCategory}
                      onChange={(e) => setNewCategory(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && handleAddCategory()}
                      style={{
                        flex: 1,
                        padding: '0.75rem',
                        border: '2px solid #e2e8f0',
                        borderRadius: '8px'
                      }}
                    />
                    <button
                      onClick={handleAddCategory}
                      style={{
                        background: '#10B981',
                        color: 'white',
                        border: 'none',
                        padding: '0.75rem 1.5rem',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontWeight: 600
                      }}
                    >
                      Ajouter
                    </button>
                  </div>
                </div>

                {/* Liste des cat√©gories */}
                <div style={{ marginBottom: '1rem' }}>
                  <h4 style={{ marginBottom: '0.75rem', color: '#475569', fontSize: '0.9rem' }}>Cat√©gories existantes</h4>
                  {(docCategories || []).map((cat, index) => {
                    const docsCount = (plainte.documents || []).filter(doc => (doc.category || 'Important') === cat).length;
                    return editingCategory === cat ? (
                      <div key={cat} style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.5rem' }}>
                        <input
                          type="text"
                          value={editCategoryName}
                          onChange={(e) => setEditCategoryName(e.target.value)}
                          onKeyPress={(e) => e.key === 'Enter' && handleEditCategory(cat, editCategoryName)}
                          style={{
                            flex: 1,
                            padding: '0.5rem',
                            border: '2px solid #3B82F6',
                            borderRadius: '6px'
                          }}
                          autoFocus
                        />
                        <button
                          onClick={() => handleEditCategory(cat, editCategoryName)}
                          style={{
                            background: '#3B82F6',
                            color: 'white',
                            border: 'none',
                            padding: '0.5rem 1rem',
                            borderRadius: '6px',
                            cursor: 'pointer'
                          }}
                        >
                          ‚úì
                        </button>
                        <button
                          onClick={() => {
                            setEditingCategory(null);
                            setEditCategoryName('');
                          }}
                          style={{
                            background: '#e2e8f0',
                            color: '#475569',
                            border: 'none',
                            padding: '0.5rem 1rem',
                            borderRadius: '6px',
                            cursor: 'pointer'
                          }}
                        >
                          ‚úï
                        </button>
                      </div>
                    ) : (
                      <div key={cat} style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between',
                        padding: '0.75rem',
                        background: 'white',
                        border: '2px solid #e2e8f0',
                        borderRadius: '8px',
                        marginBottom: '0.5rem'
                      }}>
                        <span style={{ fontWeight: 500 }}>
                          {cat} <span style={{ color: '#94a3b8', fontSize: '0.85rem' }}>({docsCount})</span>
                        </span>
                        <div style={{ display: 'flex', gap: '0.5rem' }}>
                          <button
                            onClick={() => handleMoveCategoryUp(index)}
                            disabled={index === 0}
                            style={{
                              background: index === 0 ? '#e2e8f0' : '#8b5cf6',
                              color: index === 0 ? '#94a3b8' : 'white',
                              border: 'none',
                              padding: '0.4rem 0.6rem',
                              borderRadius: '6px',
                              cursor: index === 0 ? 'not-allowed' : 'pointer',
                              fontSize: '0.85rem',
                              fontWeight: 'bold'
                            }}
                            title="Monter"
                          >
                            ‚Üë
                          </button>
                          <button
                            onClick={() => handleMoveCategoryDown(index)}
                            disabled={index === docCategories.length - 1}
                            style={{
                              background: index === docCategories.length - 1 ? '#e2e8f0' : '#8b5cf6',
                              color: index === docCategories.length - 1 ? '#94a3b8' : 'white',
                              border: 'none',
                              padding: '0.4rem 0.6rem',
                              borderRadius: '6px',
                              cursor: index === docCategories.length - 1 ? 'not-allowed' : 'pointer',
                              fontSize: '0.85rem',
                              fontWeight: 'bold'
                            }}
                            title="Descendre"
                          >
                            ‚Üì
                          </button>
                          <button
                            onClick={() => {
                              setEditingCategory(cat);
                              setEditCategoryName(cat);
                            }}
                            style={{
                              background: '#f1f5f9',
                              color: '#475569',
                              border: 'none',
                              padding: '0.4rem 0.8rem',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontSize: '0.85rem'
                            }}
                          >
                            ‚úèÔ∏è
                          </button>
                          <button
                            onClick={() => handleDeleteCategory(cat)}
                            style={{
                              background: '#fee2e2',
                              color: '#dc2626',
                              border: 'none',
                              padding: '0.4rem 0.8rem',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontSize: '0.85rem'
                            }}
                          >
                            üóëÔ∏è
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>

                <button
                  onClick={() => setShowCategoryManager(false)}
                  style={{
                    width: '100%',
                    background: '#e2e8f0',
                    color: '#475569',
                    border: 'none',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontWeight: 600
                  }}
                >
                  Fermer
                </button>
              </div>
            </div>
          )}

          {showAddModal && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.5)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 1000
            }}>
              <div 
                onClick={(e) => e.stopPropagation()}
                style={{
                  background: 'white',
                  borderRadius: '20px',
                  padding: '2rem',
                  maxWidth: '500px',
                  width: '90%'
                }}>
                <h3 style={{ marginBottom: '1.5rem', color: '#1e293b' }}>Ajouter un lien</h3>

                <input
                  type="text"
                  placeholder="Nom du lien"
                  value={linkName}
                  onChange={(e) => setLinkName(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid #e2e8f0',
                    borderRadius: '8px',
                    marginBottom: '1rem'
                  }}
                />
                <input
                  type="text"
                  placeholder="https://drive.google.com/..."
                  value={linkUrl}
                  onChange={(e) => setLinkUrl(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid #e2e8f0',
                    borderRadius: '8px',
                    marginBottom: '1rem'
                  }}
                />
                <select
                  value={linkCategory}
                  onChange={(e) => setLinkCategory(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid #e2e8f0',
                    borderRadius: '8px',
                    marginBottom: '1rem',
                    cursor: 'pointer'
                  }}
                >
                  {(docCategories || []).map(cat => (
                    <option key={cat} value={cat}>{cat}</option>
                  ))}
                </select>
                <button
                  onClick={handleAddLink}
                  style={{
                    width: '100%',
                    background: plainte.couleur,
                    color: 'white',
                    border: 'none',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontWeight: 600,
                    marginBottom: '0.75rem'
                  }}
                >
                  Ajouter le lien
                </button>

                <button
                  onClick={() => setShowAddModal(false)}
                  style={{
                    width: '100%',
                    background: '#e2e8f0',
                    color: '#475569',
                    border: 'none',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontWeight: 600
                  }}
                >
                  Annuler
                </button>
              </div>
            </div>
          )}

          {/* MODAL √âDITION */}
          {editingDoc && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.5)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 1000
            }}>
              <div 
                onClick={(e) => e.stopPropagation()}
                style={{
                  background: 'white',
                  borderRadius: '20px',
                  padding: '2rem',
                  maxWidth: '500px',
                  width: '90%'
                }}>
                <h3 style={{ marginBottom: '1.5rem', color: '#1e293b' }}>Modifier le lien</h3>

                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, fontSize: '0.9rem', color: '#64748b' }}>
                  Nom du lien
                </label>
                <input
                  type="text"
                  placeholder="Nom du lien"
                  value={editName}
                  onChange={(e) => setEditName(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid #e2e8f0',
                    borderRadius: '8px',
                    marginBottom: '1rem'
                  }}
                />

                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, fontSize: '0.9rem', color: '#64748b' }}>
                  URL du lien
                </label>
                <input
                  type="text"
                  placeholder="https://..."
                  value={editUrl}
                  onChange={(e) => setEditUrl(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid #e2e8f0',
                    borderRadius: '8px',
                    marginBottom: '1rem'
                  }}
                />

                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, fontSize: '0.9rem', color: '#64748b' }}>
                  Cat√©gorie
                </label>
                <select
                  value={editCategory}
                  onChange={(e) => setEditCategory(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid #e2e8f0',
                    borderRadius: '8px',
                    marginBottom: '1rem',
                    cursor: 'pointer'
                  }}
                >
                  {(docCategories || []).map(cat => (
                    <option key={cat} value={cat}>{cat}</option>
                  ))}
                </select>

                <button
                  onClick={() => {
                    if (!editName.trim()) {
                      alert('Le nom ne peut pas √™tre vide');
                      return;
                    }
                    if (!editUrl.trim() || !editUrl.startsWith('http')) {
                      alert('L\'URL doit commencer par http:// ou https://');
                      return;
                    }
                    onEditDocument(editingDoc.id, editName, editUrl, editCategory);
                    setEditingDoc(null);
                    setEditName('');
                    setEditUrl('');
                    setEditCategory('');
                  }}
                  style={{
                    width: '100%',
                    background: plainte.couleur,
                    color: 'white',
                    border: 'none',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontWeight: 600,
                    marginBottom: '0.75rem'
                  }}
                >
                  Enregistrer
                </button>

                <button
                  onClick={() => {
                    setEditingDoc(null);
                    setEditName('');
                    setEditUrl('');
                    setEditCategory('');
                  }}
                  style={{
                    width: '100%',
                    background: '#e2e8f0',
                    color: '#475569',
                    border: 'none',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontWeight: 600
                  }}
                >
                  Annuler
                </button>
              </div>
            </div>
          )}

          {(plainte.documents || []).length === 0 ? (
            <div style={{
              background: 'white',
              padding: '3rem',
              borderRadius: '16px',
              textAlign: 'center',
              color: '#64748b'
            }}>
              <p>Aucun lien ajout√©</p>
            </div>
          ) : (
            <div>
              {categoriesToDisplay.map(category => {
                const docsInCategory = groupedDocs[category] || [];
                if (docsInCategory.length === 0) return null;
                
                return (
                  <div key={category} style={{ marginBottom: '2rem' }}>
                    <h3 style={{
                      color: category === 'Important' ? plainte.couleur : '#64748b',
                      fontSize: category === 'Important' ? '1.2rem' : '1.05rem',
                      fontWeight: category === 'Important' ? 700 : 600,
                      marginBottom: '1rem',
                      paddingBottom: '0.5rem',
                      paddingLeft: category === 'Important' ? '0.75rem' : '0',
                      borderLeft: category === 'Important' ? `4px solid ${plainte.couleur}` : 'none',
                      borderBottom: `2px solid ${category === 'Important' ? plainte.couleur : '#e2e8f0'}`,
                      background: category === 'Important' ? `${plainte.couleur}08` : 'transparent',
                      padding: category === 'Important' ? '0.75rem' : '0 0 0.5rem 0',
                      borderRadius: category === 'Important' ? '8px' : '0'
                    }}>
                      {category} <span style={{ color: '#94a3b8', fontSize: '0.8rem', fontWeight: 400 }}>({docsInCategory.length})</span>
                    </h3>
                    <div style={{
                      display: 'grid',
                      gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))',
                      gap: '0.75rem'
                    }}>
                      {docsInCategory.map((doc, index) => (
                        <div
                          key={doc.id}
                          style={{
                            background: 'white',
                            borderRadius: '8px',
                            overflow: 'hidden',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                            border: category === 'Important' ? `2px solid ${plainte.couleur}` : '1px solid #e2e8f0',
                            transition: 'all 0.2s',
                            display: 'flex',
                            flexDirection: 'column'
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.transform = 'translateY(-2px)';
                            e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.12)';
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.transform = 'translateY(0)';
                            e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                          }}
                        >
                          {/* CONTENU CLIQUABLE */}
                          <div
                            onClick={() => openDocument(doc)}
                            style={{
                              padding: '0.75rem',
                              cursor: 'pointer',
                              flex: 1,
                              display: 'flex',
                              flexDirection: 'column',
                              gap: '0.5rem'
                            }}
                          >
                            {/* Layout principal: ic√¥ne + titre √† gauche, boutons √† droite */}
                            <div style={{ display: 'flex', alignItems: 'flex-start', gap: '0.5rem' }}>
                              {/* Ic√¥ne circulaire */}
                              <div style={{
                                width: '32px',
                                height: '32px',
                                borderRadius: '50%',
                                background: category === 'Important' ? `${plainte.couleur}15` : '#f1f5f9',
                                border: `2px solid ${category === 'Important' ? plainte.couleur : '#cbd5e1'}`,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '0.9rem',
                                flexShrink: 0
                              }}>
                                {doc.data.includes('youtube.com') || doc.data.includes('youtu.be') || doc.data.includes('vimeo.com') ? 'üé•' : 'üìÑ'}
                              </div>
                              
                              {/* Titre */}
                              <div style={{ flex: 1, minWidth: 0 }}>
                                <div style={{
                                  fontSize: 'clamp(0.7rem, 0.85rem, 1rem)',
                                  fontWeight: 600,
                                  color: '#1e293b',
                                  wordBreak: 'break-word',
                                  lineHeight: '1.2',
                                  display: '-webkit-box',
                                  WebkitLineClamp: 3,
                                  WebkitBoxOrient: 'vertical',
                                  overflow: 'hidden'
                                }}>
                                  {doc.nom}
                                </div>
                              </div>
                              
                              {/* Boutons en grille 2x2 */}
                              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 18px)', gap: '0.2rem' }}>
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setEditingDoc(doc);
                                    setEditName(doc.nom);
                                    setEditUrl(doc.data);
                                    setEditCategory(doc.category || 'Important');
                                  }}
                                  style={{
                                    background: '#e2e8f0',
                                    color: '#64748b',
                                    border: 'none',
                                    width: '18px',
                                    height: '18px',
                                    borderRadius: '3px',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: '0.65rem',
                                    padding: 0,
                                    opacity: 0.7,
                                    transition: 'opacity 0.2s'
                                  }}
                                  onMouseEnter={(e) => e.currentTarget.style.opacity = '1'}
                                  onMouseLeave={(e) => e.currentTarget.style.opacity = '0.7'}
                                  title="Modifier"
                                >
                                  ‚úé
                                </button>
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    onDeleteDocument(doc.id);
                                  }}
                                  style={{
                                    background: '#e2e8f0',
                                    color: '#64748b',
                                    border: 'none',
                                    width: '18px',
                                    height: '18px',
                                    borderRadius: '3px',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: '0.65rem',
                                    padding: 0,
                                    opacity: 0.7,
                                    transition: 'opacity 0.2s'
                                  }}
                                  onMouseEnter={(e) => e.currentTarget.style.opacity = '1'}
                                  onMouseLeave={(e) => e.currentTarget.style.opacity = '0.7'}
                                  title="Supprimer"
                                >
                                  ‚úï
                                </button>
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    onMoveDocument && onMoveDocument(doc.id, 'up', category);
                                  }}
                                  disabled={index === 0}
                                  style={{
                                    background: '#e2e8f0',
                                    color: index === 0 ? '#cbd5e1' : '#64748b',
                                    border: 'none',
                                    width: '18px',
                                    height: '18px',
                                    borderRadius: '3px',
                                    cursor: index === 0 ? 'not-allowed' : 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: '0.65rem',
                                    padding: 0,
                                    opacity: 0.7,
                                    transition: 'opacity 0.2s'
                                  }}
                                  onMouseEnter={(e) => index !== 0 && (e.currentTarget.style.opacity = '1')}
                                  onMouseLeave={(e) => index !== 0 && (e.currentTarget.style.opacity = '0.7')}
                                  title="Monter"
                                >
                                  ‚Üê
                                </button>
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    onMoveDocument && onMoveDocument(doc.id, 'down', category);
                                  }}
                                  disabled={index === docsInCategory.length - 1}
                                  style={{
                                    background: '#e2e8f0',
                                    color: index === docsInCategory.length - 1 ? '#cbd5e1' : '#64748b',
                                    border: 'none',
                                    width: '18px',
                                    height: '18px',
                                    borderRadius: '3px',
                                    cursor: index === docsInCategory.length - 1 ? 'not-allowed' : 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: '0.65rem',
                                    padding: 0,
                                    opacity: 0.7,
                                    transition: 'opacity 0.2s'
                                  }}
                                  onMouseEnter={(e) => index !== docsInCategory.length - 1 && (e.currentTarget.style.opacity = '1')}
                                  onMouseLeave={(e) => index !== docsInCategory.length - 1 && (e.currentTarget.style.opacity = '0.7')}
                                  title="Descendre"
                                >
                                  ‚Üí
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    }

    function SpecialiteCard({ specialite, couleur, plainte, onEdit, onDelete, onMoveUp, onMoveDown, canMoveUp, canMoveDown, setImageModalUrl }) {
      const [showMenu, setShowMenu] = React.useState(false);
      const [menuPosition, setMenuPosition] = React.useState({ top: 0, left: 0 });
      const buttonRef = React.useRef(null);
      const pharmaData = getPharmaQuizzMed(specialite.dci, specialite.nomCommercial);
      
      // DEBUG COMPLET
      console.group('üîç SpecialiteCard: ' + (specialite.nomCommercial || specialite.dci));
      console.log('üìã Nom commercial:', specialite.nomCommercial);
      console.log('üíä DCI:', specialite.dci);
      console.log('üéØ pharmaData:', pharmaData);
      if (pharmaData) {
        console.log('   ‚úÖ Classe:', pharmaData.classe);
        console.log('   ‚úÖ Cat√©gorie:', pharmaData.category);
        console.log('   ‚úÖ Couleur:', pharmaData.couleur);
      } else {
        console.log('   ‚ùå AUCUNE correspondance trouv√©e');
        // Chercher manuellement dans les flashcards
        try {
          const flashcards = JSON.parse(localStorage.getItem('pharmaspace_medications') || '[]');
          console.log('   üìä Nombre de flashcards:', flashcards.length);
          if (flashcards.length > 0) {
            console.log('   üîé Recherche manuelle...');
            const byDCI = flashcards.filter(f => 
              f.dci && specialite.dci && f.dci.toLowerCase().includes(specialite.dci.toLowerCase().split(/[+,]/)[0].trim())
            );
            console.log('   - Par DCI:', byDCI.length > 0 ? byDCI[0] : 'aucun');
            const byName = flashcards.filter(f => 
              f.commercial && specialite.nomCommercial && 
              f.commercial.some(c => c.toLowerCase().includes(specialite.nomCommercial.toLowerCase()))
            );
            console.log('   - Par nom:', byName.length > 0 ? byName[0] : 'aucun');
          }
        } catch(e) {
          console.error('   ‚ö†Ô∏è Erreur recherche:', e);
        }
      }
      console.groupEnd();
      
      const handleMenuClick = (e) => {
        e.stopPropagation();
        if (!showMenu && buttonRef.current) {
          const rect = buttonRef.current.getBoundingClientRect();
          setMenuPosition({
            top: rect.top,
            left: rect.left - 190
          });
        }
        setShowMenu(!showMenu);
      };

      return (
        <div style={{
          background: 'white',
          borderRadius: '12px',
          padding: '1.25rem',
          boxShadow: '0 4px 20px rgba(0,0,0,0.1)',
          border: `2px solid ${couleur}40`,
          position: 'relative'
        }}>
          {/* Menu 3 points cach√© */}
          <div style={{
            position: 'absolute',
            top: '0.75rem',
            right: '0.75rem',
            opacity: showMenu ? 1 : 0,
            transition: 'opacity 0.2s',
            zIndex: 99999
          }}
          onMouseEnter={(e) => {
            e.currentTarget.style.opacity = '1';
          }}
          onMouseLeave={(e) => {
            if (!showMenu) e.currentTarget.style.opacity = '0';
          }}>
            <button
              ref={buttonRef}
              onClick={handleMenuClick}
              style={{
                background: '#f8fafc',
                border: '1px solid #e2e8f0',
                borderRadius: '6px',
                width: '32px',
                height: '32px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                cursor: 'pointer',
                color: '#64748b',
                fontSize: '1.1rem',
                fontWeight: 'bold',
                boxShadow: '0 2px 6px rgba(0,0,0,0.1)',
                padding: 0,
                transition: 'all 0.15s'
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.background = 'white';
                e.currentTarget.style.borderColor = '#cbd5e1';
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.background = '#f8fafc';
                e.currentTarget.style.borderColor = '#e2e8f0';
              }}
              title="Options"
            >
              ‚ãÆ
            </button>
          </div>
          
          {/* Dropdown menu avec portal */}
          {showMenu && ReactDOM.createPortal(
            <div
              onClick={(e) => e.stopPropagation()}
              style={{
                position: 'fixed',
                top: `${menuPosition.top}px`,
                left: `${menuPosition.left}px`,
                background: 'white',
                border: '1px solid #e2e8f0',
                borderRadius: '8px',
                boxShadow: '0 8px 24px rgba(0,0,0,0.25)',
                zIndex: 999999,
                minWidth: '180px',
                overflow: 'visible'
              }}
            >
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  onEdit();
                  setShowMenu(false);
                }}
                style={{
                  width: '100%',
                  padding: '0.75rem 1rem',
                  border: 'none',
                  background: 'white',
                  textAlign: 'left',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.75rem',
                  fontSize: '0.875rem',
                  color: '#1e293b',
                  transition: 'background 0.15s',
                  fontWeight: 500
                }}
                onMouseEnter={(e) => e.currentTarget.style.background = '#f8fafc'}
                onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
              >
                <span style={{ fontSize: '1.1rem', opacity: 0.7 }}>‚úé</span>
                <span>Modifier</span>
              </button>
              
              <div style={{ height: '1px', background: '#f1f5f9', margin: '0 0.5rem' }} />
              
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  onMoveUp();
                  setShowMenu(false);
                }}
                disabled={!canMoveUp}
                style={{
                  width: '100%',
                  padding: '0.75rem 1rem',
                  border: 'none',
                  background: 'white',
                  textAlign: 'left',
                  cursor: !canMoveUp ? 'not-allowed' : 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.75rem',
                  fontSize: '0.875rem',
                  color: !canMoveUp ? '#cbd5e1' : '#1e293b',
                  transition: 'background 0.15s',
                  opacity: !canMoveUp ? 0.5 : 1,
                  fontWeight: 500
                }}
                onMouseEnter={(e) => canMoveUp && (e.currentTarget.style.background = '#f8fafc')}
                onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
              >
                <span style={{ fontSize: '1.1rem', opacity: 0.7 }}>‚Üë</span>
                <span>Monter</span>
              </button>
              
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  onMoveDown();
                  setShowMenu(false);
                }}
                disabled={!canMoveDown}
                style={{
                  width: '100%',
                  padding: '0.75rem 1rem',
                  border: 'none',
                  background: 'white',
                  textAlign: 'left',
                  cursor: !canMoveDown ? 'not-allowed' : 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.75rem',
                  fontSize: '0.875rem',
                  color: !canMoveDown ? '#cbd5e1' : '#1e293b',
                  transition: 'background 0.15s',
                  opacity: !canMoveDown ? 0.5 : 1,
                  fontWeight: 500
                }}
                onMouseEnter={(e) => canMoveDown && (e.currentTarget.style.background = '#f8fafc')}
                onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
              >
                <span style={{ fontSize: '1.1rem', opacity: 0.7 }}>‚Üì</span>
                <span>Descendre</span>
              </button>
              
              <div style={{ height: '1px', background: '#f1f5f9', margin: '0 0.5rem' }} />
              
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  onDelete();
                  setShowMenu(false);
                }}
                style={{
                  width: '100%',
                  padding: '0.75rem 1rem',
                  border: 'none',
                  background: 'white',
                  textAlign: 'left',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.75rem',
                  fontSize: '0.875rem',
                  color: '#ef4444',
                  transition: 'background 0.15s',
                  fontWeight: 500
                }}
                onMouseEnter={(e) => e.currentTarget.style.background = '#fef2f2'}
                onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
              >
                <span style={{ fontSize: '1.1rem', opacity: 0.8 }}>‚úï</span>
                <span>Supprimer</span>
              </button>
            </div>,
            document.body
          )}

          {(() => {
            const images = specialite.imageUrls && specialite.imageUrls.length > 0 
              ? specialite.imageUrls.filter(img => img && img.trim() !== '')
              : (specialite.image ? [specialite.image] : []);
            
            return images.length > 0 ? (
              <div style={{
                display: 'flex',
                gap: '0.5rem',
                marginBottom: '1rem',
                flexWrap: 'wrap'
              }}>
                {images.map((img, idx) => (
                  <div key={idx} style={{
                    width: images.length === 1 ? '100%' : 'calc(50% - 0.25rem)',
                    height: '140px',
                    borderRadius: '8px',
                    overflow: 'hidden',
                    border: `2px solid ${couleur}`,
                    background: '#f8fafc'
                  }}>
                    <img 
                      src={img} 
                      alt={`${specialite.nomCommercial} ${idx + 1}`} 
                      style={{
                        width: '100%',
                        height: '100%',
                        objectFit: 'contain',
                        cursor: 'pointer'
                      }} 
                      onClick={() => setImageModalUrl(img)}
                      onError={(e) => e.target.style.display = 'none'} 
                    />
                  </div>
                ))}
              </div>
            ) : null;
          })()}

          <h4 style={{
            color: '#1e293b',
            fontSize: '1.2rem',
            marginBottom: '0.5rem',
            fontWeight: 600,
            paddingRight: '4rem',
            display: 'flex',
            alignItems: 'center',
            gap: '0.5rem',
            flexWrap: 'wrap'
          }}>
            <span>{specialite.nomCommercial || specialite.dci}</span>
            {/* Classe th√©rapeutique de la sp√©cialit√© uniquement */}
            {pharmaData && (pharmaData.classe || pharmaData.category) && (
              <span style={{
                padding: '0.25rem 0.6rem',
                background: '#f1f5f9',
                border: '1px solid #e2e8f0',
                borderRadius: '12px',
                fontSize: '0.7rem',
                color: '#64748b',
                fontWeight: 600
              }}>
                {pharmaData.classe || pharmaData.category}
              </span>
            )}
            {/* Si pas de nom commercial, afficher forme pharma √† c√¥t√© du titre */}
            {!specialite.nomCommercial && specialite.formePharma && (
              <span style={{
                padding: '0.25rem 0.6rem',
                background: '#f1f5f9',
                border: '1px solid #e2e8f0',
                borderRadius: '12px',
                fontSize: '0.75rem',
                color: '#64748b',
                fontWeight: 500
              }}>
                {[...new Set(specialite.formePharma.split(',').map(f => f.trim()))].join(', ')}
              </span>
            )}
          </h4>

          {specialite.dci && specialite.nomCommercial && (
            <div style={{ 
              marginBottom: '0.75rem', 
              fontSize: '0.9rem', 
              color: '#64748b',
              display: 'flex',
              alignItems: 'center',
              gap: '0.5rem',
              flexWrap: 'wrap'
            }}>
              <span>{specialite.dci}</span>
              {specialite.formePharma && (
                <span style={{
                  padding: '0.25rem 0.6rem',
                  background: '#f1f5f9',
                  border: '1px solid #e2e8f0',
                  borderRadius: '12px',
                  fontSize: '0.75rem',
                  color: '#64748b',
                  fontWeight: 500
                }}>
                  {[...new Set(specialite.formePharma.split(',').map(f => f.trim()))].join(', ')}
                </span>
              )}
            </div>
          )}



          {specialite.posologie && (
            <div style={{
              padding: '0.75rem',
              background: '#f0fdf4',
              borderRadius: '6px',
              marginBottom: '0.5rem',
              fontSize: '0.85rem',
              color: '#065f46',
              whiteSpace: 'pre-wrap'
            }}>
              <strong>Posologie</strong> {specialite.posologie}
            </div>
          )}

          {specialite.conseils && (
            <div style={{
              padding: '0.75rem',
              background: '#eff6ff',
              borderRadius: '6px',
              marginBottom: '0.5rem',
              fontSize: '0.85rem',
              color: '#1e40af',
              whiteSpace: 'pre-wrap'
            }}>
              <strong>Conseils</strong> {specialite.conseils}
            </div>
          )}

          {specialite.contreIndications && (
            <div style={{
              padding: '0.75rem',
              background: '#fef2f2',
              borderRadius: '6px',
              marginBottom: '0.5rem',
              fontSize: '0.85rem',
              color: '#991b1b',
              whiteSpace: 'pre-wrap'
            }}>
              <strong>CI</strong> {specialite.contreIndications}
            </div>
          )}

          {specialite.notes && (
            <div style={{
              padding: '0.75rem',
              background: '#fefce8',
              borderRadius: '6px',
              fontSize: '0.85rem',
              color: '#854d0e',
              whiteSpace: 'pre-wrap'
            }}>
              <strong>Notes</strong> {specialite.notes}
            </div>
          )}
        </div>
      );
    }

    function FormSpecialite({ specialite, onSave, onCancel, handleImageUpload, handleImageURL, plainte, medications }) {
      // DEBUG
      console.group('üîç FormSpecialite - Initialisation');
      console.log('medications:', medications);
      console.log('medications est un tableau?', Array.isArray(medications));
      console.log('specialite:', specialite);
      console.groupEnd();
      
      // Initialisation des images pour le mode √©dition
      // Utiliser allImageUrls (toutes les images) plut√¥t que imageUrls (seulement les s√©lectionn√©es)
      const initImages = specialite && specialite.allImageUrls && specialite.allImageUrls.length > 0
        ? specialite.allImageUrls.filter(img => img && img.trim() !== '')
        : (specialite && specialite.imageUrls ? specialite.imageUrls.filter(img => img && img.trim() !== '') : []);
      const initForms = specialite && specialite.formePharma ? specialite.formePharma.split(',').map(f => f.trim()) : [];
      
      // Calculer les index des images actuellement s√©lectionn√©es
      const initSelectedIndexes = specialite && specialite.imageUrls && initImages.length > 0
        ? specialite.imageUrls
            .filter(img => img && img.trim() !== '')
            .map(selectedImg => initImages.findIndex(img => img === selectedImg))
            .filter(idx => idx !== -1)
        : initImages.map((_, i) => i);
      
      const [formData, setFormData] = useState(specialite ? {
        nomCommercial: specialite.nomCommercial || '',
        dci: specialite.dci || '',
        image: specialite.image || null,
        imageUrls: Array.isArray(specialite.imageUrls) ? specialite.imageUrls : [],
        allImageUrls: Array.isArray(specialite.allImageUrls) ? specialite.allImageUrls : (Array.isArray(specialite.imageUrls) ? specialite.imageUrls : []),
        selectedImages: initSelectedIndexes,
        posologie: specialite.posologie || '',
        conseils: specialite.conseils || '',
        contreIndications: specialite.contreIndications || '',
        notes: specialite.notes || '',
        formePharma: specialite.formePharma || ''
      } : {
        nomCommercial: '',
        dci: '',
        image: null,
        imageUrls: [],
        allImageUrls: [],
        selectedImages: [],
        posologie: '',
        conseils: '',
        contreIndications: '',
        notes: '',
        formePharma: ''
      });

      const [originalImages, setOriginalImages] = useState(initImages);
      const [originalForms, setOriginalForms] = useState(initForms);

      return (
        <div style={{ maxWidth: 'none', margin: '0', padding: '0 2rem' }}>
          <div style={{
            background: 'white',
            borderRadius: '20px',
            padding: '2rem',
            boxShadow: '0 10px 40px rgba(0,0,0,0.1)',
            maxWidth: '800px',
            margin: '0 auto'
          }}>
            <h2 style={{ marginBottom: '1rem', color: '#1e293b' }}>
              {specialite ? 'Modifier' : 'Ajouter une sp√©cialit√©'}
            </h2>

            {/* IMPORT DEPUIS FLASHCARD */}
            <div style={{ marginBottom: '1.5rem', padding: '1rem', background: '#F0F9FF', borderRadius: '12px', border: '2px solid #3B82F6' }}>
              <label style={{ display: 'block', marginBottom: '0.75rem', fontWeight: 600, color: '#1e293b' }}>
                üìö Importer depuis mes flashcards
              </label>
              <select
                value=""
                onChange={(e) => {
                  console.group('üîç Import depuis flashcard');
                  console.log('e.target.value:', e.target.value);
                  if (e.target.value !== '') {
                    const selectedIndex = parseInt(e.target.value);
                    console.log('selectedIndex:', selectedIndex);
                    console.log('medications:', medications);
                    console.log('medications type:', typeof medications);
                    console.log('medications est array?', Array.isArray(medications));
                    const sortedMeds = (medications || []).sort((a, b) => a.dci.localeCompare(b.dci));
                    console.log('sortedMeds:', sortedMeds);
                    console.log('sortedMeds length:', sortedMeds.length);
                    const med = sortedMeds[selectedIndex];
                    console.log('med s√©lectionn√©:', med);
                    
                    if (med) {
                      console.log('‚úÖ M√©dicament trouv√©, import en cours...');
                      // R√©cup√©rer TOUTES les images et formes (avec v√©rifications)
                      const allImages = (med.imageUrls && Array.isArray(med.imageUrls)) 
                        ? med.imageUrls 
                        : (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []));
                      
                      const allForms = med.pharmaceuticalForm 
                        ? (typeof med.pharmaceuticalForm === 'string' 
                            ? med.pharmaceuticalForm.split(',').map(f => f.trim()) 
                            : (Array.isArray(med.pharmaceuticalForm) ? med.pharmaceuticalForm : []))
                        : [];
                      
                      setOriginalImages(allImages);
                      setOriginalForms(allForms);
                      setFormData({
                        nomCommercial: (med.commercial && Array.isArray(med.commercial) && med.commercial.length > 0) 
                          ? med.commercial[0] 
                          : (typeof med.commercial === 'string' ? med.commercial : ''),
                        dci: med.dci || '',
                        image: allImages.length > 0 ? allImages[0] : null,
                        imageUrls: allImages,
                        allImageUrls: allImages, // Sauvegarder TOUTES les images
                        selectedImages: allImages.map((_, i) => i),
                        formePharma: allForms.join(', '),
                        posologie: '',
                        conseils: '',
                        contreIndications: '',
                        notes: ''
                      });
                      console.log('‚úÖ FormData mis √† jour:', formData);
                    } else {
                      console.error('‚ùå M√©dicament non trouv√© √† l\'index', selectedIndex);
                    }
                  }
                  console.groupEnd();
                }}
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #3B82F6',
                  borderRadius: '8px',
                  fontSize: '0.9rem',
                  cursor: 'pointer',
                  background: 'white'
                }}
              >
                <option value="">-- S√©lectionner un m√©dicament --</option>
                {(medications || []).sort((a, b) => a.dci.localeCompare(b.dci)).map((med, idx) => (
                  <option key={idx} value={idx}>
                    {med.dci} ({med.commercial && Array.isArray(med.commercial) ? med.commercial.join(', ') : (med.commercial || 'Sans nom')})
                  </option>
                ))}
              </select>
              <div style={{ fontSize: '0.75rem', color: '#64748b', marginTop: '0.5rem', fontStyle: 'italic' }}>
                üí° Cliquer ici pour importer les infos d'un m√©dicament de vos flashcards
              </div>

              {/* S√âLECTION DES IMAGES */}
              {originalImages && originalImages.length > 0 && (
                <div style={{ marginTop: '1rem', padding: '1rem', background: 'white', borderRadius: '8px', border: '2px solid #e2e8f0' }}>
                  <div style={{ fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.75rem', color: '#1e293b' }}>
                    ‚úì S√©lectionnez les images √† afficher ({formData.selectedImages?.length || 0}/{originalImages.length})
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))', gap: '0.75rem' }}>
                    {originalImages.map((url, idx) => {
                      const isSelected = formData.selectedImages?.includes(idx);
                      return (
                        <div
                          key={idx}
                          onClick={(e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            const selected = formData.selectedImages || [];
                            const newSelected = isSelected
                              ? selected.filter(i => i !== idx)
                              : [...selected, idx];
                            
                            // R√©cup√©rer les images et formes correspondantes
                            const selectedImages = newSelected.map(i => originalImages[i]);
                            const selectedForms = newSelected
                              .map(i => originalForms[i])
                              .filter(f => f)
                              .join(', ');
                            
                            setFormData({
                              ...formData,
                              selectedImages: newSelected,
                              imageUrls: selectedImages,
                              image: selectedImages.length > 0 ? selectedImages[0] : null,
                              formePharma: selectedForms
                            });
                          }}
                          style={{
                            position: 'relative',
                            cursor: 'pointer',
                            border: `3px solid ${isSelected ? '#10B981' : '#e2e8f0'}`,
                            borderRadius: '8px',
                            overflow: 'hidden',
                            background: isSelected ? '#D1FAE5' : '#f8fafc',
                            transition: 'all 0.2s'
                          }}
                        >
                          <img
                            src={url}
                            alt={`Image ${idx + 1}`}
                            style={{
                              width: '100%',
                              height: '120px',
                              objectFit: 'cover',
                              opacity: isSelected ? 1 : 0.5
                            }}
                          />
                          <div style={{
                            position: 'absolute',
                            top: '0.5rem',
                            right: '0.5rem',
                            width: '24px',
                            height: '24px',
                            borderRadius: '50%',
                            background: isSelected ? '#10B981' : 'white',
                            border: `2px solid ${isSelected ? '#10B981' : '#cbd5e1'}`,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: 'white',
                            fontSize: '0.75rem',
                            fontWeight: 700
                          }}>
                            {isSelected ? '‚úì' : ''}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' }}>
              <div>
                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Nom commercial</label>
                <input
                  type="text"
                  value={formData.nomCommercial}
                  onChange={(e) => setFormData({ ...formData, nomCommercial: e.target.value })}
                  placeholder="Ex: Dafalgan"
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid #e2e8f0',
                    borderRadius: '8px'
                  }}
                />
              </div>
              <div>
                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>DCI *</label>
                <input
                  type="text"
                  value={formData.dci}
                  onChange={(e) => setFormData({ ...formData, dci: e.target.value })}
                  placeholder="Ex: Parac√©tamol"
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid #e2e8f0',
                    borderRadius: '8px'
                  }}
                />
              </div>
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>üíä Forme pharmaceutique</label>
              <input
                type="text"
                value={formData.formePharma}
                onChange={(e) => setFormData({ ...formData, formePharma: e.target.value })}
                placeholder="Ex: Comprim√©, Sirop, Spray..."
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px'
                }}
              />
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Images de la bo√Æte</label>
              
              <button
                type="button"
                onClick={() => {
                  handleImageURL((url) => {
                    const currentImages = formData.imageUrls || [];
                    setFormData({ 
                      ...formData, 
                      imageUrls: [...currentImages, url],
                      image: currentImages.length === 0 ? url : formData.image
                    });
                  });
                }}
                style={{
                  width: '100%',
                  padding: '1rem',
                  border: '2px dashed #3B82F6',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  background: '#EFF6FF',
                  color: '#3B82F6',
                  fontWeight: 600,
                  marginBottom: '1rem'
                }}
              >
                + Ajouter une image par URL
              </button>

              {formData.imageUrls && formData.imageUrls.length > 0 && (
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(120px, 1fr))', gap: '0.75rem' }}>
                  {formData.imageUrls.filter(img => img && img.trim() !== '').map((img, idx) => (
                    <div key={idx} style={{ position: 'relative' }}>
                      <img
                        src={img}
                        alt={`Image ${idx + 1}`}
                        style={{
                          width: '100%',
                          height: '120px',
                          objectFit: 'cover',
                          borderRadius: '8px',
                          border: '2px solid #e2e8f0',
                          cursor: 'pointer'
                        }}
                        onClick={() => setFormData({ ...formData, zoomedImage: img })}
                      />
                      <button
                        type="button"
                        onClick={() => {
                          const newImages = formData.imageUrls.filter((_, i) => i !== idx);
                          setFormData({ 
                            ...formData, 
                            imageUrls: newImages,
                            image: newImages.length > 0 ? newImages[0] : null
                          });
                        }}
                        style={{
                          position: 'absolute',
                          top: '-8px',
                          right: '-8px',
                          background: '#ef4444',
                          color: 'white',
                          border: 'none',
                          width: '24px',
                          height: '24px',
                          borderRadius: '50%',
                          cursor: 'pointer',
                          fontSize: '0.7rem'
                        }}
                      >
                        ‚úï
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Posologie</label>
              <textarea
                value={formData.posologie}
                onChange={(e) => setFormData({ ...formData, posologie: e.target.value })}
                placeholder="Ex: Adultes: 1 cp toutes les 6h&#10;Enfants: 15mg/kg/6h"
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px',
                  minHeight: '100px',
                  fontFamily: 'inherit'
                }}
              />
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Conseils</label>
              <textarea
                value={formData.conseils}
                onChange={(e) => setFormData({ ...formData, conseils: e.target.value })}
                placeholder="Ex: Avec de l'eau, pendant les repas"
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px',
                  minHeight: '60px',
                  fontFamily: 'inherit'
                }}
              />
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Contre-indications</label>
              <textarea
                value={formData.contreIndications}
                onChange={(e) => setFormData({ ...formData, contreIndications: e.target.value })}
                placeholder="Ex: Insuffisance h√©patique"
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px',
                  minHeight: '60px',
                  fontFamily: 'inherit'
                }}
              />
            </div>

            <div style={{ marginBottom: '2rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Notes</label>
              <textarea
                value={formData.notes}
                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                placeholder="Ex: Rayon 3, tr√®s demand√©"
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px',
                  minHeight: '60px',
                  fontFamily: 'inherit'
                }}
              />
            </div>

            <div style={{ display: 'flex', gap: '1rem' }}>
              <button
                onClick={() => {
                  if (!formData.dci?.trim()) {
                    alert('La DCI est obligatoire');
                    return;
                  }
                  // Filtrer les images selon la s√©lection
                  // formData.imageUrls contient d√©j√† les images s√©lectionn√©es (mises √† jour dans le onChange)
                  const filteredData = {
                    ...formData,
                    imageUrls: (formData.imageUrls || []).filter(img => img && img.trim() !== ''),
                    allImageUrls: originalImages.length > 0 ? originalImages : (formData.allImageUrls || []), // Garder TOUTES les images
                    image: formData.imageUrls && formData.imageUrls.length > 0
                      ? formData.imageUrls[0]
                      : formData.image
                  };
                  onSave(filteredData);
                }}
                style={{
                  flex: 1,
                  background: plainte.couleur,
                  color: 'white',
                  border: 'none',
                  padding: '1rem',
                  borderRadius: '12px',
                  fontWeight: 600,
                  cursor: 'pointer'
                }}
              >
                {specialite ? 'Enregistrer' : 'Ajouter'}
              </button>
              <button
                onClick={onCancel}
                style={{
                  flex: 1,
                  background: '#e2e8f0',
                  color: '#475569',
                  border: 'none',
                  padding: '1rem',
                  borderRadius: '12px',
                  fontWeight: 600,
                  cursor: 'pointer'
                }}
              >
                Annuler
              </button>
            </div>
          </div>
        </div>
      );
    }
    // ========== FIN CODE CONSEILS OFFICINE ==========



    // IC√îNES SVG
    const BookOpen = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
      </svg>
    );
    const Brain = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/>
        <path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/>
      </svg>
    );
    const ChevronLeft = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="15 18 9 12 15 6"/>
      </svg>
    );
    const ChevronRight = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="9 18 15 12 9 6"/>
      </svg>
    );
    const Settings = ({ size = 24, style }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={style}>
        <circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6"/>
      </svg>
    );
    const Plus = ({ size = 24, style }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={style}>
        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
    );
    const Trash2 = ({ size = 24, color }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
      </svg>
    );
    const Edit = ({ size = 24, color }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
      </svg>
    );
    const Camera = ({ size = 24, color }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/>
      </svg>
    );
    const Check = ({ size = 24, style }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={style}>
        <polyline points="20 6 9 17 4 12"/>
      </svg>
    );
    const X = ({ size = 24, style }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={style}>
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    );

    
// ========================================
    // LISTE DES M√âDICAMENTS DE D√âPART
    // ========================================
    // Cette liste sera charg√©e automatiquement pour tous les utilisateurs
    // Pour ajouter vos 272 m√©dicaments, remplacez simplement ce tableau
    // Format : { dci: "...", commercial: ["..."], category: "...", image: null }
    
    const INITIAL_MEDS = [];

const INITIAL_CLASSES = {};

function PharmaSpace() {
  
  const [mode, setMode] = useState('menu');
    
    // DEBUG: V√©rifier les flashcards au chargement
    React.useEffect(() => {
      console.group('üöÄ PharmaSpace - Diagnostic au chargement');
      try {
        // V√©rifier TOUTES les cl√©s localStorage
        console.log('üîë Cl√©s localStorage disponibles:');
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.includes('flash') || key.includes('card') || key.includes('med') || key.includes('pharma')) {
            try {
              const value = localStorage.getItem(key);
              const parsed = JSON.parse(value || '[]');
              const count = Array.isArray(parsed) ? parsed.length : (parsed ? 'objet' : 'vide');
              console.log(`  - ${key}: ${count} √©l√©ments`);
              if (Array.isArray(parsed) && parsed.length > 0) {
                console.log('    Exemple:', parsed[0].dci || parsed[0].commercial || parsed[0].nom || Object.keys(parsed[0]).slice(0, 3));
              }
            } catch(e) {
              console.log(`  - ${key}: non-JSON`);
            }
          }
        }
        
        // Sp√©cifiquement flashcards
        const flashcards = JSON.parse(localStorage.getItem('pharmaspace_medications') || '[]');
        console.log('\nüìä localStorage["pharmaspace_medications"]:', flashcards.length, '√©l√©ments');
        
        // Essayer pharmaspace_medications
        const meds = localStorage.getItem('pharmaspace_medications');
        if (meds) {
          try {
            const parsed = JSON.parse(meds);
            console.log('üìä localStorage["pharmaspace_medications"]:', Array.isArray(parsed) ? parsed.length : 'objet', '√©l√©ments');
            if (Array.isArray(parsed) && parsed.length > 0) {
              console.log('  Exemple:', parsed[0]);
            }
          } catch(e) {
            console.log('üìä localStorage["pharmaspace_medications"]: erreur parsing');
          }
        }
        
        if (flashcards.length > 0) {
          console.log('\n‚úÖ Exemples de flashcards:');
          flashcards.slice(0, 5).forEach(f => {
            console.log('  -', f.dci, '(', f.commercial?.join(', ') || 'sans nom', ')', '‚Üí', f.classe || f.category);
          });
        } else {
          console.warn('\n‚ö†Ô∏è AUCUNE flashcard dans localStorage["flashcards"] !');
        }
        
        const conseils = JSON.parse(localStorage.getItem('conseilsOfficine') || '[]');
        console.log('\nüìã Nombre de fiches conseils:', conseils.length);
        if (conseils.length > 0) {
          const firstPlainte = conseils[0];
          console.log('‚úÖ Exemple de fiche:', firstPlainte.nom);
          if (firstPlainte.specialites && firstPlainte.specialites.length > 0) {
            console.log('  Sp√©cialit√©s:', firstPlainte.specialites.length);
            console.log('  Exemple:', firstPlainte.specialites[0].nomCommercial || firstPlainte.specialites[0].dci);
          }
        }
      } catch(e) {
        console.error('‚ùå Erreur diagnostic:', e);
      }
      console.groupEnd();
    }, []);
  const [imageModalUrl, setImageModalUrl] = useState(null);
  const [firebaseStatus, setFirebaseStatus] = useState(firebaseEnabled ? 'üü¢ Connect√©' : 'üü° Local');
  const [isOnline, setIsOnline] = useState(navigator.onLine && firebaseEnabled);
  const [showOfflineWarning, setShowOfflineWarning] = useState(false);
  
  // D√©tecter les changements de connexion
  useEffect(() => {
    const updateOnlineStatus = () => {
      const online = navigator.onLine && firebaseEnabled;
      setIsOnline(online);
      setFirebaseStatus(online ? 'üü¢ Connect√©' : 'üî¥ Hors ligne');
    };

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);

    return () => {
      window.removeEventListener('online', updateOnlineStatus);
      window.removeEventListener('offline', updateOnlineStatus);
    };
  }, []);
  
  // Handler pour les actions n√©cessitant une connexion
  const handleOfflineAction = (action) => {
    if (!isOnline) {
      alert('‚ö†Ô∏è Connexion Internet requise\n\nVous devez √™tre connect√© √† Internet pour modifier les donn√©es.\n\nVos donn√©es sont consultables hors ligne, mais toute modification n√©cessite une synchronisation avec Firebase.');
      return false;
    }
    action();
    return true;
  };
  
  const [medications, setMedications] = useState(() => {
    // Si Firebase est activ√©, on attend Firebase (pas de localStorage)
    if (firebaseEnabled) {
      return INITIAL_MEDS; // Temporaire, sera remplac√© par Firebase
    }
    // Si Firebase d√©sactiv√©, charger depuis localStorage
    const saved = localStorage.getItem('pharmaspace_medications');
    return saved ? JSON.parse(saved) : INITIAL_MEDS;
  });
  
  // √âcouter les changements Firebase pour medications
  useEffect(() => {
    if (firebaseEnabled) {
      const medsRef = db.ref('medications');
      medsRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          console.log('üî• Medications mis √† jour depuis Firebase');
          setMedications(data);
          localStorage.setItem('pharmaspace_medications', JSON.stringify(data));
        }
      });
      
      return () => medsRef.off();
    }
  }, []);
  
  const [therapeuticClasses, setTherapeuticClasses] = useState(() => {
    if (firebaseEnabled) {
      return INITIAL_CLASSES; // Temporaire, sera remplac√© par Firebase
    }
    const saved = localStorage.getItem('pharmaspace_classes');
    return saved ? JSON.parse(saved) : INITIAL_CLASSES;
  });
  
  // √âcouter les changements Firebase pour classes
  useEffect(() => {
    if (firebaseEnabled) {
      const classesRef = db.ref('classes');
      classesRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          console.log('üî• Classes mis √† jour depuis Firebase');
          setTherapeuticClasses(data);
          localStorage.setItem('pharmaspace_classes', JSON.stringify(data));
        }
      });
      
      return () => classesRef.off();
    }
  }, []);
  
  // √âcouter les changements Firebase pour forms
  useEffect(() => {
    if (firebaseEnabled) {
      const formsRef = db.ref('forms');
      formsRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          console.log('üî• Forms mis √† jour depuis Firebase');
          setPharmaceuticalForms(data);
          localStorage.setItem('pharmaspace_forms', JSON.stringify(data));
        }
      });
      
      return () => formsRef.off();
    }
  }, []);
  
  // Wrapper pour sauvegarder medications sur Firebase
  const saveMedications = (newMedications) => {
    setMedications(newMedications);
    localStorage.setItem('pharmaspace_medications', JSON.stringify(newMedications));
    if (firebaseEnabled) {
      // Nettoyer les propri√©t√©s undefined avant d'envoyer √† Firebase
      const cleanedMedications = newMedications.map(med => {
        const cleaned = { ...med };
        // Supprimer les propri√©t√©s undefined
        Object.keys(cleaned).forEach(key => {
          if (cleaned[key] === undefined) {
            delete cleaned[key];
          }
        });
        // S'assurer que nextReview et interval existent (null si pas d√©fini)
        if (!('nextReview' in cleaned)) cleaned.nextReview = null;
        if (!('interval' in cleaned)) cleaned.interval = null;
        return cleaned;
      });
      
      db.ref('medications').set(cleanedMedications).catch(err => {
        console.error('‚ùå Erreur sauvegarde medications:', err);
      });
    }
  };
  
  // Wrapper pour sauvegarder classes sur Firebase
  const saveClasses = (newClasses) => {
    setTherapeuticClasses(newClasses);
    localStorage.setItem('pharmaspace_classes', JSON.stringify(newClasses));
    if (firebaseEnabled) {
      db.ref('classes').set(newClasses).catch(err => {
        console.error('‚ùå Erreur sauvegarde classes:', err);
      });
    }
  };
  
  // Wrapper pour sauvegarder forms sur Firebase  
  const saveForms = (newForms) => {
    setPharmaceuticalForms(newForms);
    localStorage.setItem('pharmaspace_forms', JSON.stringify(newForms));
    if (firebaseEnabled) {
      db.ref('forms').set(newForms).catch(err => {
        console.error('‚ùå Erreur sauvegarde forms:', err);
      });
    }
  };
  
  const [pharmaceuticalForms, setPharmaceuticalForms] = useState(() => {
    if (firebaseEnabled) {
      // Si Firebase activ√©, liste par d√©faut (sera remplac√© par Firebase)
      return [
        'A√©rosol-doseur',
        'Autre',
        'Bain de bouche',
        'Capsule',
        'Capsule P√©dia.',
        'Capsules molles',
        'Collyre',
        'Comprim√©',
      'Comprim√© effervescent',
      'Comprim√© orodispersible',
      'Comprim√© sublingual',
      'Comprim√©s √† croquer',
      'Cr√®me',
      'Gel',
      'Globules',
      'Gouttes',
      'Gouttes auriculaires',
      'Gouttes auriculaires et collyre',
      'Gouttes nasal',
      'Granule effervescent',
      'Granul√©s',
      'G√©lule',
      'Lotion',
      'Lyophilisat',
      'Ovule',
      'Pastille',
      'Patch',
      'Pommade',
      'Pommade nasal',
      'Pommade ophtalmique',
      'Poudre pour inhalation',
      'Poudre pour sirop',
      'Poudre pour solution',
      'Poudre pour solution injectable',
      'Poudre pour suspension',
      'Poudre pour suspension buvable',
      'Poudre pour suspension injectable',
      'Sachet',
      'Sachet P√©dia.',
      'Sachet pour sirop',
      'Shampoing',
      'Sirop',
      'Sirop P√©dia.',
      'Solution',
      'Solution buvable',
      'Solution buvable en gouttes',
      'Solution cutan√©e',
      'Solution injectable',
      'Solution nasal',
      'Solution pour inhalation',
      'Solution pour inhalation/n√©bulisation',
      'Solution pour n√©bulisation',
      'Solution pour n√©bulisation/inhalation',
      'Solution rectale',
      'Spray',
      'Spray buccal',
      'Spray nasal',
      'Spray nasal Baby',
      'Spray nasal P√©dia.',
      'Suppo P√©dia',
      'Suppositoire',
      'Suppositoire P√©dia.',
      'Suspension',
      'Suspension buvable',
      'Suspension injectable',
      'Suspension pour inhalation'
    ];
    }
    // Si Firebase d√©sactiv√©, charger depuis localStorage
    const saved = localStorage.getItem('pharmaspace_forms');
    return saved ? JSON.parse(saved) : [
      'A√©rosol-doseur',
      'Autre',
      'Bain de bouche',
      'Capsule',
      'Capsule P√©dia.',
      'Capsules molles',
      'Collyre',
      'Comprim√©',
      'Comprim√© effervescent',
      'Comprim√© orodispersible',
      'Comprim√© sublingual',
      'Comprim√©s √† croquer',
      'Cr√®me',
      'Gel',
      'Globules',
      'Gouttes',
      'Gouttes auriculaires',
      'Gouttes auriculaires et collyre',
      'Gouttes nasal',
      'Granule effervescent',
      'Granul√©s',
      'G√©lule',
      'Lotion',
      'Lyophilisat',
      'Ovule',
      'Pastille',
      'Patch',
      'Pommade',
      'Pommade nasal',
      'Pommade ophtalmique',
      'Poudre pour inhalation',
      'Poudre pour sirop',
      'Poudre pour solution',
      'Poudre pour solution injectable',
      'Poudre pour suspension',
      'Poudre pour suspension buvable',
      'Poudre pour suspension injectable',
      'Sachet',
      'Sachet P√©dia.',
      'Sachet pour sirop',
      'Shampoing',
      'Sirop',
      'Sirop P√©dia.',
      'Solution',
      'Solution buvable',
      'Solution buvable en gouttes',
      'Solution cutan√©e',
      'Solution injectable',
      'Solution nasal',
      'Solution pour inhalation',
      'Solution pour inhalation/n√©bulisation',
      'Solution pour n√©bulisation',
      'Solution pour n√©bulisation/inhalation',
      'Solution rectale',
      'Spray',
      'Spray buccal',
      'Spray nasal',
      'Spray nasal Baby',
      'Spray nasal P√©dia.',
      'Suppo P√©dia',
      'Suppositoire',
      'Suppositoire P√©dia.',
      'Suspension',
      'Suspension buvable',
      'Suspension injectable',
      'Suspension pour inhalation'
    ];
  });
    const [currentIndex, setCurrentIndex] = useState(0);
  const [currentMedDCI, setCurrentMedDCI] = useState(null);
  const [showAnswer, setShowAnswer] = useState(false);
  
  // M√©moriser le DCI du m√©dicament actuel
  useEffect(() => {
    const currentMed = getFlashcardListMedications[currentIndex];
    if (currentMed) {
      setCurrentMedDCI(currentMed.dci);
    }
  }, [currentIndex, getFlashcardListMedications]);
  
  // Restaurer la position quand la liste change (apr√®s ajout de note)
  useEffect(() => {
    console.log('üîç useEffect restauration - currentMedDCI:', currentMedDCI, 'currentIndex:', currentIndex, 'isForceRepositioning:', isForceRepositioning);
    if (isForceRepositioning) {
      console.log('‚è∏Ô∏è  Restauration d√©sactiv√©e (repositionnement forc√© en cours)');
      return;
    }
    if (currentMedDCI && getFlashcardListMedications) {
      console.log('üîç Recherche de', currentMedDCI, 'dans la liste de', getFlashcardListMedications.length, 'm√©dicaments');
      const newIndex = getFlashcardListMedications.findIndex(med => med.dci === currentMedDCI);
      console.log('üîç Trouv√© √† l\'index:', newIndex, 'vs currentIndex:', currentIndex);
      if (newIndex !== -1 && newIndex !== currentIndex) {
        console.log('üìç REPOSITIONNEMENT:', currentMedDCI, 'de l\'index', currentIndex, '‚Üí', newIndex);
        setCurrentIndex(newIndex);
      } else if (newIndex === -1) {
        console.error('‚ùå M√©dicament', currentMedDCI, 'non trouv√© dans la liste!');
      } else {
        console.log('‚úÖ D√©j√† au bon index');
      }
    } else {
      console.log('‚è≠Ô∏è  Skip restauration - currentMedDCI:', currentMedDCI, 'liste:', !!getFlashcardListMedications);
    }
  }, [getFlashcardListMedications, currentMedDCI]);
  const [flashcardView, setFlashcardView] = useState('list');
  const [showSettings, setShowSettings] = useState(false);
  const [showManagement, setShowManagement] = useState(false);
  
  const [selectionMode, setSelectionMode] = useState('all');
  const [selectedClasses, setSelectedClasses] = useState([]);
  const [selectedMeds, setSelectedMeds] = useState([]);
    const [stats, setStats] = useState({ correct: 0, total: 0 });
  const [userAnswer, setUserAnswer] = useState('');
          const [sortBy, setSortBy] = useState('commercial');
  const [filterCategory, setFilterCategory] = useState('all');
  const [editingIndex, setEditingIndex] = useState(null);
  const [customMed, setCustomMed] = useState({ dci: '', commercial: '', category: '', imageUrls: '', pharmaceuticalForm: '' });
  const [imageUpdated, setImageUpdated] = useState(false);
  const [listUpdateKey, setListUpdateKey] = useState(0);
  const [searchQuery, setSearchQuery] = useState('');
  const [errorMessage, setErrorMessage] = useState('');
  const [showClassManager, setShowClassManager] = useState(false);
  const [newClassName, setNewClassName] = useState('');
  const [newClassColor, setNewClassColor] = useState('#64748b');
  const [editingClass, setEditingClass] = useState(null);
  const [showFormManager, setShowFormManager] = useState(false);
  const [newFormName, setNewFormName] = useState('');
  const [editingForm, setEditingForm] = useState(null);
  const [flashcardListSort, setFlashcardListSort] = useState('commercial');
  const [notesCountCache, setNotesCountCache] = useState({});
  const [expandedCard, setExpandedCard] = useState(null);
  const [editingItemId, setEditingItemId] = useState(null);
  const [editingText, setEditingText] = useState('');
  const [refreshKey, setRefreshKey] = useState(0);
  const [showNotesModal, setShowNotesModal] = useState(false);
      const [modalMedication, setModalMedication] = useState(null);
      const [pendingCacheUpdate, setPendingCacheUpdate] = useState(false);
      const [isForceRepositioning, setIsForceRepositioning] = useState(false);
      const [medicationToReposition, setMedicationToReposition] = useState(null);
      
  // Recalculer le cache quand la modale se ferme
  useEffect(() => {
    console.log('üîç useEffect fermeture - showNotesModal:', showNotesModal, 'pendingCacheUpdate:', pendingCacheUpdate, 'modalMedication:', modalMedication?.dci);
    if (!showNotesModal && pendingCacheUpdate && modalMedication) {
      console.log('üîÑ Recalcul du cache apr√®s fermeture modale');
      const medName = modalMedication.commercial?.[0] || modalMedication.dci;
      console.log('üìù M√©dicament √† repositionner:', medName);
      
      // Sauvegarder le m√©dicament √† repositionner (utiliser le NOM pas le DCI)
      setMedicationToReposition(medName);
      
      // Bloquer le useEffect de restauration
      setIsForceRepositioning(true);
      
      // Recalculer le cache
      setRefreshKey(prev => prev + 1);
      setPendingCacheUpdate(false);
    }
  }, [showNotesModal, pendingCacheUpdate, modalMedication]);
  
  // useEffect s√©par√© pour le repositionnement apr√®s recalcul du cache
  useEffect(() => {
    if (medicationToReposition && !pendingCacheUpdate && !showNotesModal) {
      console.log('üéØ D√©but repositionnement sur:', medicationToReposition);
      
      setTimeout(() => {
        // Chercher avec le NOM (pas le DCI) car le cache utilise maintenant le nom
        const newIndex = getFlashcardListMedications.findIndex(med => {
          const medName = med.commercial[0] || med.dci;
          return medName === medicationToReposition;
        });
        console.log('üîç Index trouv√©:', newIndex, 'pour', medicationToReposition);
        
        if (newIndex !== -1 && newIndex !== currentIndex) {
          console.log('%cüìç CHANGEMENT D\'INDEX: ' + currentIndex + ' ‚Üí ' + newIndex, 'background: #00ff00; color: #000; font-size: 20px; font-weight: bold; padding: 10px;');
          console.log('%cM√©dicament: ' + medicationToReposition, 'background: #00ff00; color: #000; font-size: 16px; padding: 5px;');
          console.log('AVANT setCurrentIndex - currentIndex:', currentIndex);
          setCurrentIndex(newIndex);
          console.log('APR√àS setCurrentIndex - devrait √™tre:', newIndex);
          setCurrentMedDCI(medicationToReposition);
        } else if (newIndex === currentIndex) {
          console.log('%c‚úÖ D√©j√† au bon index: ' + currentIndex, 'background: #ffff00; color: #000; font-size: 16px; padding: 5px;');
        } else {
          console.error('%c‚ùå M√©dicament non trouv√©!', 'background: #ff0000; color: #fff; font-size: 20px; font-weight: bold; padding: 10px;');
        }
        
        // Nettoyer
        setMedicationToReposition(null);
        setIsForceRepositioning(false);
        console.log('‚úÖ Repositionnement termin√©');
      }, 300);
    }
  }, [medicationToReposition, pendingCacheUpdate, showNotesModal, getFlashcardListMedications]);
  const [addingNoteType, setAddingNoteType] = useState(null);
  const [newNoteText, setNewNoteText] = useState('');
  const [showDataManagement, setShowDataManagement] = useState(false);
  
  // Calculer le cache des notes/conseils UNE SEULE FOIS
  useEffect(() => {
    // Ne pas recalculer si la modale de notes est ouverte (pour √©viter de changer de m√©dicament)
    if (showNotesModal) {
      console.log('‚è∏Ô∏è  Cache en attente (modale ouverte)');
      return;
    }
    
    if (medications && medications.length > 0) {
      console.log('üîÑ Calcul du cache notes/conseils...');
      const cache = {};
      medications.forEach(med => {
        const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
        const name = (med.commercial && Array.isArray(med.commercial) && med.commercial.length > 0) ? med.commercial[0] : med.dci;
        
        // CORRECTION: Utiliser le nom commercial comme cl√© (plus unique que le DCI)
        const key = name; // Utiliser le nom pour identifier de fa√ßon unique
        const count = getConsolidatedNotesConseils(name, images).length;
        cache[key] = count;
        
        // Log pour Plantspray ou autres avec "plant" dans le nom
        if (name.toLowerCase().includes('plant') || med.dci.toLowerCase().includes('plant')) {
          console.log('üìä Cache: nom="' + name + '", dci="' + med.dci + '", cl√©="' + key + '" ‚Üí ' + count + ' notes/conseils');
          console.log('   getConsolidatedNotesConseils("' + name + '") retourne:', getConsolidatedNotesConseils(name, images));
        }
      });
      setNotesCountCache(cache);
      console.log('‚úÖ Cache calcul√©:', Object.keys(cache).length, 'm√©dicaments');
    }
  }, [medications, notesParSpecialite, refreshKey, showNotesModal]);
  
  // Force update quand on ajoute/supprime des notes standalone
  useEffect(() => {
    const standaloneKey = 'notesConseils_standalone';
    const handleStorageChange = () => {
      if (!showNotesModal) {
        console.log('üîÑ Mise √† jour d√©tect√©e dans notes standalone');
        setRefreshKey(prev => prev + 1);
      }
    };
    
    const handlePlaintesUpdate = () => {
      console.log('üîÑ Mise √† jour d√©tect√©e dans les plaintes');
      console.log('   ‚Üí refreshKey va √™tre incr√©ment√©');
      console.log('   ‚Üí Cache va √™tre recalcul√©');
      setRefreshKey(prev => {
        console.log('   ‚Üí refreshKey:', prev, '‚Üí', prev + 1);
        return prev + 1;
      });
    };
    
    window.addEventListener('storage', handleStorageChange);
    window.addEventListener('plaintesUpdated', handlePlaintesUpdate);
    
    return () => {
      window.removeEventListener('storage', handleStorageChange);
      window.removeEventListener('plaintesUpdated', handlePlaintesUpdate);
    };
  }, [showNotesModal]);

  // Notes et Conseils par sp√©cialit√© (nom commercial)
  const [notesParSpecialite, setNotesParSpecialite] = useState(() => {
    if (firebaseEnabled) {
      return {}; // Temporaire, sera remplac√© par Firebase
    }
    const saved = localStorage.getItem('pharmaspace_notes');
    return saved ? JSON.parse(saved) : {};
  });
  
  // √âcouter les changements Firebase pour notes
  useEffect(() => {
    if (firebaseEnabled) {
      const notesRef = db.ref('notesParSpecialite');
      notesRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          console.log('üî• Notes mis √† jour depuis Firebase');
          setNotesParSpecialite(data);
          localStorage.setItem('pharmaspace_notes', JSON.stringify(data));
        }
      });
      
      // √âcouter aussi les notes standalone
      const standaloneRef = db.ref('notesConseils_standalone');
      standaloneRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          console.log('üî• Notes standalone mises √† jour depuis Firebase');
          
          // Nettoyer les donn√©es corrompues
          const cleanedData = {};
          Object.keys(data).forEach(key => {
            if (data[key] && typeof data[key] === 'object') {
              cleanedData[key] = {
                notes: Array.isArray(data[key].notes) ? data[key].notes : [],
                conseils: Array.isArray(data[key].conseils) ? data[key].conseils : [],
                images: data[key].images || [],
                dci: data[key].dci || '',
                nomCommercial: data[key].nomCommercial || ''
              };
            }
          });
          
          localStorage.setItem('notesConseils_standalone', JSON.stringify(cleanedData));
          setRefreshKey(prev => prev + 1); // Forcer le recalcul du cache
        }
      });
      
      return () => {
        notesRef.off();
        standaloneRef.off();
      };
    }
  }, []);
  
  // Wrapper pour sauvegarder notes sur Firebase
  const saveNotesParSpecialite = (newNotes) => {
    setNotesParSpecialite(newNotes);
    localStorage.setItem('pharmaspace_notes', JSON.stringify(newNotes));
    if (firebaseEnabled) {
      db.ref('notesParSpecialite').set(newNotes).catch(err => {
        console.error('‚ùå Erreur sauvegarde notes:', err);
      });
    }
  };
  
  // Fonctions pour g√©rer les notes et conseils
  const normalizeSpecialiteName = (name) => {
    return name.toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Enlever accents
      .replace(/[^a-z0-9]/g, ''); // Garder seulement lettres et chiffres
  };
  
  const ajouterNote = (nomCommercial, texte) => {
    const key = normalizeSpecialiteName(nomCommercial);
    const newNotes = { ...notesParSpecialite };
    if (!newNotes[key]) {
      newNotes[key] = { notes: [], conseils: [] };
    }
    const newNote = {
      id: Date.now().toString(),
      texte: texte.trim(),
      date: new Date().toISOString()
    };
    newNotes[key].notes = [...(newNotes[key].notes || []), newNote];
    saveNotesParSpecialite(newNotes);
  };
  
  const modifierNote = (nomCommercial, noteId, nouveauTexte) => {
    const key = normalizeSpecialiteName(nomCommercial);
    const newNotes = { ...notesParSpecialite };
    if (newNotes[key] && newNotes[key].notes) {
      newNotes[key].notes = newNotes[key].notes.map(note =>
        note.id === noteId ? { ...note, texte: nouveauTexte.trim() } : note
      );
      saveNotesParSpecialite(newNotes);
    }
  };
  
  const supprimerNote = (nomCommercial, noteId) => {
    const key = normalizeSpecialiteName(nomCommercial);
    const newNotes = { ...notesParSpecialite };
    if (newNotes[key] && newNotes[key].notes) {
      newNotes[key].notes = newNotes[key].notes.filter(note => note.id !== noteId);
      saveNotesParSpecialite(newNotes);
    }
  };
  
  const ajouterConseil = (nomCommercial, texte) => {
    const key = normalizeSpecialiteName(nomCommercial);
    const newNotes = { ...notesParSpecialite };
    if (!newNotes[key]) {
      newNotes[key] = { notes: [], conseils: [] };
    }
    const newConseil = {
      id: Date.now().toString(),
      texte: texte.trim(),
      date: new Date().toISOString()
    };
    newNotes[key].conseils = [...(newNotes[key].conseils || []), newConseil];
    saveNotesParSpecialite(newNotes);
  };
  
  const modifierConseil = (nomCommercial, conseilId, nouveauTexte) => {
    const key = normalizeSpecialiteName(nomCommercial);
    const newNotes = { ...notesParSpecialite };
    if (newNotes[key] && newNotes[key].conseils) {
      newNotes[key].conseils = newNotes[key].conseils.map(conseil =>
        conseil.id === conseilId ? { ...conseil, texte: nouveauTexte.trim() } : conseil
      );
      saveNotesParSpecialite(newNotes);
    }
  };
  
  const supprimerConseil = (nomCommercial, conseilId) => {
    const key = normalizeSpecialiteName(nomCommercial);
    const newNotes = { ...notesParSpecialite };
    if (newNotes[key] && newNotes[key].conseils) {
      newNotes[key].conseils = newNotes[key].conseils.filter(conseil => conseil.id !== conseilId);
      saveNotesParSpecialite(newNotes);
    }
  };
  
  const getNotesConseils = (nomCommercial) => {
    const key = normalizeSpecialiteName(nomCommercial);
    return notesParSpecialite[key] || { notes: [], conseils: [] };
  };
  
  // Collecter notes/conseils avec association aux images + formes + standalone
  const getConsolidatedNotesConseils = (nomCommercialOuDCI, imageUrls = []) => {
    const searchTerm = nomCommercialOuDCI.toLowerCase();
    const allItems = [];
    
    // 1. Notes/conseils depuis les plaintes
    const conseilsData = localStorage.getItem('conseilsOfficine');
    if (conseilsData) {
      try {
        const plaintes = JSON.parse(conseilsData);
        if (!Array.isArray(plaintes)) {
          console.warn('‚ö†Ô∏è  conseilsOfficine n\'est pas un tableau:', plaintes);
          return [];
        }
        plaintes.forEach(plainte => {
          if (plainte.specialites && Array.isArray(plainte.specialites)) {
            plainte.specialites.forEach(spec => {
              const specNom = (spec.nomCommercial || '').toLowerCase();
              const specDCI = (spec.dci || '').toLowerCase();
              
              if (specNom.includes(searchTerm) || searchTerm.includes(specNom) ||
                  specDCI.includes(searchTerm) || searchTerm.includes(specDCI)) {
                
                const specImages = spec.imageUrls || (spec.imageUrl ? [spec.imageUrl] : []);
                let matchesImages = imageUrls.length === 0 || specImages.length === 0;
                if (!matchesImages && imageUrls.length > 0 && specImages.length > 0) {
                  matchesImages = imageUrls.some(url => specImages.includes(url));
                }
                
                if (matchesImages) {
                  const formes = spec.formePharma ? spec.formePharma.split(',').map(f => f.trim()).filter(Boolean) : [];
                  
                  if (spec.notes && spec.notes.trim()) {
                    allItems.push({
                      type: 'note',
                      texte: spec.notes,
                      plainteId: plainte.id,
                      plainteName: plainte.nom,
                      specId: spec.id,
                      formes: formes,
                      isStandalone: false,
                      id: `${plainte.id}_${spec.id || Date.now()}_note`
                    });
                  }
                  
                  if (spec.conseils && spec.conseils.trim()) {
                    allItems.push({
                      type: 'conseil',
                      texte: spec.conseils,
                      plainteId: plainte.id,
                      plainteName: plainte.nom,
                      specId: spec.id,
                      formes: formes,
                      isStandalone: false,
                      id: `${plainte.id}_${spec.id || Date.now()}_conseil`
                    });
                  }
                }
              }
            });
          }
        });
      } catch (e) {
        console.error('Erreur consolidation:', e);
      }
    }
    
    // 2. Notes/conseils standalone (non li√©es √† une plainte)
    try {
      const standaloneKey = 'notesConseils_standalone';
      const stored = localStorage.getItem(standaloneKey);
      if (stored) {
        const standalone = JSON.parse(stored);
        const key = normalizeSpecialiteName(nomCommercialOuDCI);
        
        if (standalone[key]) {
          // V√©rifier que notes et conseils sont des tableaux
          const notes = Array.isArray(standalone[key].notes) ? standalone[key].notes : [];
          const conseils = Array.isArray(standalone[key].conseils) ? standalone[key].conseils : [];
          
          notes.forEach(note => {
            allItems.push({
              type: 'note',
              texte: note.texte,
              isStandalone: true,
              formes: [],
              id: note.id
            });
          });
          
          conseils.forEach(conseil => {
            allItems.push({
              type: 'conseil',
              texte: conseil.texte,
              isStandalone: true,
              formes: [],
              id: conseil.id
            });
          });
        }
      }
    } catch (e) {
      console.error('Erreur standalone:', e);
    }
    
    return allItems;
  };
  
  // Mettre √† jour une note/conseil
  const updateNoteConseilInPlainte = (item, newText) => {
    const conseilsData = localStorage.getItem('conseilsOfficine');
    if (conseilsData) {
      try {
        const plaintes = JSON.parse(conseilsData);
        const newPlaintes = plaintes.map(plainte => {
          if (plainte.id === item.plainteId) {
            const newSpecs = plainte.specialites.map(spec => {
              if (spec.id === item.specId) {
                if (item.type === 'note') {
                  return { ...spec, notes: newText };
                } else {
                  return { ...spec, conseils: newText };
                }
              }
              return spec;
            });
            return { ...plainte, specialites: newSpecs };
          }
          return plainte;
        });
        
        localStorage.setItem('conseilsOfficine', JSON.stringify(newPlaintes));
        if (firebaseEnabled) {
          saveToFirebase('conseilsOfficine', newPlaintes);
        }
        setRefreshKey(prev => prev + 1); // Forcer la mise √† jour du cache
        return true;
      } catch (e) {
        console.error('Erreur update:', e);
      }
    }
    return false;
  };
  
  // Supprimer une note/conseil
  const deleteNoteConseilInPlainte = (item) => {
    const conseilsData = localStorage.getItem('conseilsOfficine');
    if (conseilsData) {
      try {
        const plaintes = JSON.parse(conseilsData);
        const newPlaintes = plaintes.map(plainte => {
          if (plainte.id === item.plainteId) {
            const newSpecs = plainte.specialites.map(spec => {
              if (spec.id === item.specId) {
                if (item.type === 'note') {
                  return { ...spec, notes: '' };
                } else {
                  return { ...spec, conseils: '' };
                }
              }
              return spec;
            });
            return { ...plainte, specialites: newSpecs };
          }
          return plainte;
        });
        
        localStorage.setItem('conseilsOfficine', JSON.stringify(newPlaintes));
        if (firebaseEnabled) {
          saveToFirebase('conseilsOfficine', newPlaintes);
        }
        setRefreshKey(prev => prev + 1); // Forcer la mise √† jour du cache
        return true;
      } catch (e) {
        console.error('Erreur delete:', e);
      }
    }
    return false;
  };
  
  // Cr√©er une note/conseil pour une sp√©cialit√© non li√©e √† une plainte
  const createStandaloneNoteConseil = (nomCommercial, dci, type, texte, imageUrls = []) => {
    // Stocker dans un objet s√©par√© pour les notes "standalone"
    const standaloneKey = 'notesConseils_standalone';
    let standalone = {};
    try {
      const stored = localStorage.getItem(standaloneKey);
      if (stored) standalone = JSON.parse(stored);
    } catch (e) {}
    
    const key = normalizeSpecialiteName(nomCommercial || dci);
    if (!standalone[key]) {
      standalone[key] = { notes: [], conseils: [], images: imageUrls, dci: dci, nomCommercial: nomCommercial };
    }
    
    const newItem = {
      id: Date.now() + '_' + Math.random(),
      texte: texte,
      type: type,
      images: imageUrls
    };
    
    if (type === 'note') {
      standalone[key].notes.push(newItem);
    } else {
      standalone[key].conseils.push(newItem);
    }
    
    localStorage.setItem(standaloneKey, JSON.stringify(standalone));
    
    // Synchroniser avec Firebase
    if (firebaseEnabled) {
      db.ref('notesConseils_standalone').set(standalone).catch(err => {
        console.error('‚ùå Erreur sauvegarde Firebase standalone:', err);
      });
    }
    
    console.log('üíæ Note ajout√©e');
    if (showNotesModal) {
      console.log('‚è∏Ô∏è  Mise √† jour du cache diff√©r√©e (modale ouverte)');
      setPendingCacheUpdate(true);
    } else {
      console.log('üîÑ Mise √† jour du cache imm√©diate');
      setRefreshKey(prev => prev + 1);
    }
    return true;
  };
  
  // Mettre √† jour une note standalone
  const updateStandaloneNoteConseil = (itemId, newText) => {
    const standaloneKey = 'notesConseils_standalone';
    try {
      const stored = localStorage.getItem(standaloneKey);
      if (stored) {
        const standalone = JSON.parse(stored);
        let updated = false;
        
        Object.keys(standalone).forEach(key => {
          ['notes', 'conseils'].forEach(type => {
            // V√©rifier que c'est un tableau avant de findIndex
            if (Array.isArray(standalone[key][type])) {
              const idx = standalone[key][type].findIndex(item => item.id === itemId);
              if (idx !== -1) {
                standalone[key][type][idx].texte = newText;
                updated = true;
              }
            }
          });
        });
        
        if (updated) {
          localStorage.setItem(standaloneKey, JSON.stringify(standalone));
          
          // Synchroniser avec Firebase
          if (firebaseEnabled) {
            db.ref('notesConseils_standalone').set(standalone).catch(err => {
              console.error('‚ùå Erreur mise √† jour Firebase standalone:', err);
            });
          }
          
          setRefreshKey(prev => prev + 1); // Forcer la mise √† jour du cache
          return true;
        }
      }
    } catch (e) {
      console.error('Erreur update standalone:', e);
    }
    return false;
  };
  
  // Supprimer une note standalone
  const deleteStandaloneNoteConseil = (itemId) => {
    const standaloneKey = 'notesConseils_standalone';
    try {
      const stored = localStorage.getItem(standaloneKey);
      if (stored) {
        const standalone = JSON.parse(stored);
        
        Object.keys(standalone).forEach(key => {
          ['notes', 'conseils'].forEach(type => {
            // V√©rifier que c'est un tableau avant de filter
            if (Array.isArray(standalone[key][type])) {
              standalone[key][type] = standalone[key][type].filter(item => item.id !== itemId);
            }
          });
        });
        
        localStorage.setItem(standaloneKey, JSON.stringify(standalone));
        
        // Synchroniser avec Firebase
        if (firebaseEnabled) {
          db.ref('notesConseils_standalone').set(standalone).catch(err => {
            console.error('‚ùå Erreur suppression Firebase standalone:', err);
          });
        }
        
        console.log('üóëÔ∏è  Note supprim√©e');
        if (showNotesModal) {
          console.log('‚è∏Ô∏è  Mise √† jour du cache diff√©r√©e (modale ouverte)');
          setPendingCacheUpdate(true);
        } else {
          console.log('üîÑ Mise √† jour du cache imm√©diate');
          setRefreshKey(prev => prev + 1);
        }
        return true;
      }
    } catch (e) {
      console.error('Erreur delete standalone:', e);
    }
    return false;
  };
  const [showImgurGuide, setShowImgurGuide] = useState(false);



  // Chargement des donn√©es depuis data.json au d√©marrage
  React.useEffect(() => {
    // V√©rifier si les donn√©es sont d√©j√† dans localStorage
    const hasMeds = localStorage.getItem('pharmaspace_medications');
    const hasClasses = localStorage.getItem('pharmaspace_classes');
    const hasForms = localStorage.getItem('pharmaspace_forms');
    
    // Si aucune donn√©e dans localStorage, charger depuis data.json
    if (!hasMeds || !hasClasses) {
      fetch('./data.json')
        .then(response => {
          if (!response.ok) {
            console.warn('‚ö†Ô∏è data.json non trouv√©, utilisation des donn√©es par d√©faut');
            return null;
          }
          return response.json();
        })
        .then(data => {
          if (data) {
            console.log('‚úÖ Donn√©es charg√©es depuis data.json');
            // Charger medications si absent de localStorage
            if (!hasMeds && data.medications) {
              setMedications(data.medications);
              localStorage.setItem('pharmaspace_medications', JSON.stringify(data.medications));
            }
            // Charger classes si absent de localStorage
            if (!hasClasses && data.therapeuticClasses) {
              setTherapeuticClasses(data.therapeuticClasses);
              localStorage.setItem('pharmaspace_classes', JSON.stringify(data.therapeuticClasses));
            }
            // Charger formes si absent de localStorage
            if (!hasForms && data.pharmaceuticalForms) {
              setPharmaceuticalForms(data.pharmaceuticalForms);
              localStorage.setItem('pharmaspace_forms', JSON.stringify(data.pharmaceuticalForms));
            }
            // Charger conseils si pr√©sents et absents de localStorage
            if (data.conseilsCategories && !localStorage.getItem('conseilsCategories')) {
              localStorage.setItem('conseilsCategories', JSON.stringify(data.conseilsCategories));
            }
            if (data.conseilsOfficine && !localStorage.getItem('conseilsOfficine')) {
              localStorage.setItem('conseilsOfficine', JSON.stringify(data.conseilsOfficine));
            }
          }
        })
        .catch(error => {
          console.error('‚ùå Erreur chargement data.json:', error);
        });
    } else {
      console.log('‚úÖ Donn√©es charg√©es depuis localStorage');
    }
  }, []); // Ex√©cut√© une seule fois au d√©marrage

  // Sauvegarde automatique
  React.useEffect(() => {
    localStorage.setItem('pharmaspace_medications', JSON.stringify(medications));
  }, [medications]);

  React.useEffect(() => {
    localStorage.setItem('pharmaspace_classes', JSON.stringify(therapeuticClasses));
  }, [therapeuticClasses]);

  React.useEffect(() => {
    localStorage.setItem('pharmaspace_forms', JSON.stringify(pharmaceuticalForms));
  }, [pharmaceuticalForms]);

  // R√©initialiser l'index quand la recherche change
  React.useEffect(() => {
    if (mode === 'flashcard') {
      setCurrentIndex(0);
    }
  }, [searchQuery]);

  // ========== ALGORITHME SRS ==========
  

  

  

  // ========== STATISTIQUES ==========
  

  // ========== FONCTIONS UTILITAIRES ==========
  const normalizeString = (str) => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "");

  const levenshteinDistance = (str1, str2) => {
    const matrix = [];
    for (let i = 0; i <= str2.length; i++) matrix[i] = [i];
    for (let j = 0; j <= str1.length; j++) matrix[0][j] = j;
    for (let i = 1; i <= str2.length; i++) {
      for (let j = 1; j <= str1.length; j++) {
        matrix[i][j] = str2.charAt(i - 1) === str1.charAt(j - 1) ? matrix[i - 1][j - 1] : Math.min(matrix[i - 1][j - 1] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1);
      }
    }
    return matrix[str2.length][str1.length];
  };

  const checkAnswer = (userAns, correctAns) => {
    const normalized1 = normalizeString(userAns);
    const normalized2 = normalizeString(correctAns);
    return levenshteinDistance(normalized1, normalized2) <= Math.floor(normalized2.length * 0.2);
  };

  const getCategories = () => {
    // R√©cup√©rer les classes des m√©dicaments
    const medsCategories = medications.map(med => med.category);
    // R√©cup√©rer toutes les classes de therapeuticClasses
    const allClasses = Object.keys(therapeuticClasses);
    // Combiner et d√©dupliquer
    return [...new Set([...medsCategories, ...allClasses])].sort();
  };
  const getClassColor = (className) => therapeuticClasses[className] || '#64748b';

  const getSortedMedications = () => {
    let sorted = [...medications];
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase();
      sorted = sorted.filter(med => 
        med.dci.toLowerCase().includes(query) ||
        med.commercial.some(name => name.toLowerCase().includes(query)) ||
        med.category.toLowerCase().includes(query) ||
        (med.pharmaceuticalForm && med.pharmaceuticalForm.toLowerCase().includes(query))
      );
    }
    if (filterCategory !== 'all') sorted = sorted.filter(med => med.category === filterCategory);
    switch(sortBy) {
      case 'dci': sorted.sort((a, b) => a.dci.localeCompare(b.dci)); break;
      case 'commercial': sorted.sort((a, b) => a.commercial[0].localeCompare(b.commercial[0])); break;
      case 'category': sorted.sort((a, b) => a.category.localeCompare(b.category)); break;
      case 'form': sorted.sort((a, b) => (a.pharmaceuticalForm || '').localeCompare(b.pharmaceuticalForm || '')); break;
    }
    return sorted;
  };

  const getFlashcardListMedications = useMemo(() => {
    let sorted = [...medications];
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase();
      sorted = sorted.filter(med => 
        med.dci.toLowerCase().includes(query) ||
        med.commercial.some(name => name.toLowerCase().includes(query)) ||
        med.category.toLowerCase().includes(query) ||
        (med.pharmaceuticalForm && med.pharmaceuticalForm.toLowerCase().includes(query))
      );
    }
    switch(flashcardListSort) {
      case 'dci': sorted.sort((a, b) => a.dci.localeCompare(b.dci)); break;
      case 'commercial': sorted.sort((a, b) => a.commercial[0].localeCompare(b.commercial[0])); break;
      case 'category': sorted.sort((a, b) => a.category.localeCompare(b.category)); break;
      case 'form': sorted.sort((a, b) => (a.pharmaceuticalForm || '').localeCompare(b.pharmaceuticalForm || '')); break;
      case 'notes': 
        // ULTRA OPTIMISATION: Utiliser le cache pr√©-calcul√©
        const medsWithCount = sorted.map(med => {
          const name = med.commercial[0] || med.dci;
          // CORRECTION: Chercher dans le cache avec le nom, pas le DCI
          const count = notesCountCache[name] || 0;
          
          // Log pour Plantspray
          if (name.toLowerCase().includes('plant') || med.dci.toLowerCase().includes('plant')) {
            console.log('üîç Tri: nom="' + name + '", dci="' + med.dci + '", cl√©="' + name + '" ‚Üí cache[nom]=' + count);
          }
          
          return {
            med: med,
            notesCount: count
          };
        });
        
        // Maintenant trier par le nombre pr√©-calcul√© (ultra rapide)
        medsWithCount.sort((a, b) => {
          // Ceux avec notes en premier
          if (a.notesCount > 0 && b.notesCount === 0) return -1;
          if (a.notesCount === 0 && b.notesCount > 0) return 1;
          
          // Si les deux ont des notes, trier par nombre
          if (a.notesCount > 0 && b.notesCount > 0) {
            if (a.notesCount !== b.notesCount) {
              return b.notesCount - a.notesCount; // Plus de notes en premier
            }
          }
          
          // Si √©gaux, trier par DCI
          return a.med.dci.localeCompare(b.med.dci);
        });
        
        // Log des premiers pour v√©rifier le tri
        console.log('üìã Top 10 apr√®s tri par notes:');
        medsWithCount.slice(0, 10).forEach((item, i) => {
          const name = item.med.commercial[0] || item.med.dci;
          console.log(`  ${i+1}. ${name} (${item.notesCount} notes)`);
        });
        
        // Extraire juste les m√©dicaments tri√©s
        sorted = medsWithCount.map(item => item.med);
        break;
    }
    return sorted;
  }, [medications, searchQuery, flashcardListSort, notesCountCache]);

  const handleQuizSubmit = (e) => {
    e.preventDefault();
    if (!userAnswer.trim()) return;
    const isCorrect = checkAnswer(userAnswer, getFlashcardListMedications[currentIndex].dci);
    setShowQuizFeedback(true);
    setStats({ correct: stats.correct + (isCorrect ? 1 : 0), total: stats.total + 1 });
  };

  const handleNext = () => {
    if (currentIndex < getFlashcardListMedications.length - 1) {
      setCurrentIndex(currentIndex + 1);
      setShowAnswer(false);
    } else {
      // Quiz supprim√©
      setMode('menu');
      // setShuffledMeds([]);
    }
  };

  const applySelection = () => {
    let medsToUse = [];
    
    if (selectionMode === 'all') {
      medsToUse = [...medications];
    } else if (selectionMode === 'class') {
      medsToUse = medications.filter(med => selectedClasses.includes(med.category));
    } else if (selectionMode === 'custom') {
      medsToUse = selectedMeds.map(i => medications[i]);
    }
    
    if (medsToUse.length === 0) {
      alert('Aucun m√©dicament s√©lectionn√©');
      return;
    }
    
    // M√©langer les m√©dicaments
    
    // shuffledMeds non utilis√©
    setCurrentIndex(0);
    setShowAnswer(false);
    setStats({ correct: 0, total: 0 });
    setShowSettings(false);
  };

  const startMode = (newMode) => {
    setMode(newMode);
    setSelectionMode('all');
    setSelectedClasses([]);
    setSelectedMeds([]);
    
    // Initialiser le mode
    const medsToUse = [...medications];
    setCurrentIndex(0);
    setShowAnswer(false);
    setStats({ correct: 0, total: 0 });
    setSearchQuery('');
    
    if (newMode === 'flashcard') {
      setFlashcardView('card');
    }
  };

  

  const startEditMedication = (index) => {
    const med = medications[index];
    const imageText = med.imageUrls ? med.imageUrls.join('\n') : (med.imageUrl ? med.imageUrl : (med.image || ''));
    setCustomMed({ 
      dci: med.dci, 
      commercial: med.commercial.join(', '), 
      category: med.category, 
      imageUrls: imageText,
      pharmaceuticalForm: med.pharmaceuticalForm || ''
    });
    setEditingIndex(index);
  };

  const cancelEdit = () => {
    setEditingIndex(null);
    setCustomMed({ dci: '', commercial: '', category: '', imageUrls: '', pharmaceuticalForm: '' });
    setErrorMessage('');
    setShowClassManager(false);
    setEditingClass(null);
  };

  const saveMedication = () => {
    if (!customMed.dci || !customMed.commercial || !customMed.category) {
      setErrorMessage('‚ö†Ô∏è Veuillez remplir tous les champs obligatoires (DCI, Nom commercial, Classe)');
      setTimeout(() => setErrorMessage(''), 3000);
      return;
    }
    
    const newMed = {
      dci: customMed.dci,
      commercial: customMed.commercial.split(',').map(s => s.trim()).filter(s => s),
      category: customMed.category,
      imageUrls: customMed.imageUrls.split('\n').map(s => s.trim()).filter(s => s),
      pharmaceuticalForm: customMed.pharmaceuticalForm.trim(),
      nextReview: null,  // Valeur par d√©faut pour Firebase
      interval: null     // Valeur par d√©faut pour Firebase
    };
    
    if (editingIndex !== null) {
      const updated = [...medications];
      newMed.nextReview = medications[editingIndex].nextReview;
      newMed.interval = medications[editingIndex].interval;
      updated[editingIndex] = newMed;
      saveMedications(updated);
      setEditingIndex(null);
      
      // SYNCHRONISATION: Mettre √† jour les sp√©cialit√©s dans Conseils qui ont le m√™me DCI
      const conseilsData = JSON.parse(localStorage.getItem('conseilsOfficine') || '[]');
      let hasChanges = false;
      const updatedConseils = conseilsData.map(plainte => {
        // V√©rifier que specialites existe
        if (!plainte.specialites || !Array.isArray(plainte.specialites)) {
          return plainte;
        }
        
        const updatedSpecs = plainte.specialites.map(spec => {
          if (spec.dci && spec.dci.toLowerCase() === newMed.dci.toLowerCase()) {
            hasChanges = true;
            return {
              ...spec,
              nomCommercial: newMed.commercial.join(', '),
              imageUrls: newMed.imageUrls,
              formePharma: newMed.pharmaceuticalForm
            };
          }
          return spec;
        });
        return { ...plainte, specialites: updatedSpecs };
      });
      
      if (hasChanges) {
        // Sauvegarder sur Firebase aussi
        if (firebaseEnabled) {
          db.ref('conseilsOfficine').set(updatedConseils).catch(err => {
            console.error('‚ùå Erreur sync conseils:', err);
          });
        }
        localStorage.setItem('conseilsOfficine', JSON.stringify(updatedConseils));
        console.log(`‚úÖ Synchronisation: ${newMed.dci} mis √† jour dans Conseils`);
      }
    } else {
      saveMedications([...medications, newMed]);
    }
    setCustomMed({ dci: '', commercial: '', category: '', imageUrls: '', pharmaceuticalForm: '' });
    setErrorMessage('');
    // Forcer le re-render de la liste
    setListUpdateKey(prev => prev + 1);
  };

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onloadend = () => {
      // Ancien code d'upload supprim√©
    };
    reader.readAsDataURL(file);
  };
  
  // NOUVELLE : Fonction pour ajouter une image par URL
  const handleImageURL = () => {
    let url = prompt("üåê Collez l'URL de votre image\n\nüìç Services recommand√©s :\n‚Ä¢ Imgur.com (gratuit, rapide)\n‚Ä¢ imgbb.com\n‚Ä¢ Google Photos\n\nüí° L'URL doit finir par .jpg, .png, .gif ou .webp\n\nExemple :\nhttps://i.imgur.com/abc123.jpg");
    if (!url) return;
    
    // Valider que c'est une URL
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
      alert("‚ùå L'URL doit commencer par http:// ou https://");
      return;
    }
    
    // D√âTECTION D'ALBUM IMGUR
    if (url.includes('imgur.com/a/')) {
      alert("‚ùå C'est une URL d'ALBUM !\n\n" +
            "Vous avez coll√© : " + url + "\n\n" +
            "üìç Comment obtenir la bonne URL :\n\n" +
            "1. Ouvrez votre album\n" +
            "2. Cliquez sur l'image que vous voulez\n" +
            "3. Faites clic droit sur l'image\n" +
            "4. 'Copier l'adresse de l'image'\n\n" +
            "‚úÖ Vous obtiendrez une URL comme :\n" +
            "https://i.imgur.com/abc123.jpg");
      return;
    }
    
    // AUTO-CORRECTION DES URLs IMGUR
    // Si c'est une URL Imgur sans "i." au d√©but, la corriger
    if (url.includes('imgur.com') && !url.includes('i.imgur.com')) {
      // Extraire l'ID de l'image
      const match = url.match(/imgur\.com\/(?:gallery\/)?([a-zA-Z0-9]+)/);
      if (match && match[1]) {
        const imageId = match[1];
        // Demander l'extension
        const ext = prompt("üîß Auto-correction Imgur\n\nQuelle est l'extension de votre image ?\n\nTapez : jpg, png, gif ou webp", "jpg");
        if (ext) {
          url = `https://i.imgur.com/${imageId}.${ext}`;
          alert(`‚úÖ URL corrig√©e automatiquement :\n${url}`);
        }
      }
    }
    
    // V√©rifier que c'est une image
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];
    const hasImageExtension = imageExtensions.some(ext => url.toLowerCase().includes(ext));
    
    if (!hasImageExtension && !url.includes('imgur.com') && !url.includes('googleusercontent.com') && !url.includes('ibb.co')) {
      const confirm = window.confirm("‚ö†Ô∏è Cette URL ne semble pas √™tre une image.\nVoulez-vous quand m√™me l'utiliser ?");
      if (!confirm) return;
    }
    
    // Mettre √† jour l'image directement
    // Ancien code URL supprim√©
  }
  
  // Nouvelle fonction pour valider l'image
  const validateImage = () => {
    if (!tempImageUrl) return;
    // Ancien code temp image supprim√©
    setImageUpdated(true);
    setTimeout(() => setImageUpdated(false), 100);
    alert('‚úÖ Image ajout√©e avec succ√®s !\n\nVous pouvez maintenant modifier le m√©dicament.');
  }

  const addNewClass = () => {
    if (!newClassName.trim()) {
      setErrorMessage('‚ö†Ô∏è Veuillez entrer un nom de classe');
      setTimeout(() => setErrorMessage(''), 3000);
      return;
    }
    if (getCategories().includes(newClassName.trim())) {
      setErrorMessage('‚ö†Ô∏è Cette classe existe d√©j√†');
      setTimeout(() => setErrorMessage(''), 3000);
      return;
    }
    saveClasses({...therapeuticClasses, [newClassName.trim()]: newClassColor});
    setCustomMed({...customMed, category: newClassName.trim()});
    setNewClassName('');
    setNewClassColor('#64748b');
    setShowClassManager(false);
    setErrorMessage('');
  };

  const updateClass = (oldName, newName, newColor) => {
    if (!newName.trim()) {
      setErrorMessage('‚ö†Ô∏è Veuillez entrer un nom de classe');
      setTimeout(() => setErrorMessage(''), 3000);
      return;
    }
    if (newName !== oldName && getCategories().includes(newName.trim())) {
      setErrorMessage('‚ö†Ô∏è Cette classe existe d√©j√†');
      setTimeout(() => setErrorMessage(''), 3000);
      return;
    }
    const updatedClasses = {...therapeuticClasses};
    delete updatedClasses[oldName];
    updatedClasses[newName.trim()] = newColor;
    saveClasses(updatedClasses);
    const updatedMeds = medications.map(med => 
      med.category === oldName ? {...med, category: newName.trim()} : med
    );
    saveMedications(updatedMeds);
    setEditingClass(null);
    setErrorMessage('');
  };

  
  const resetToDefault = () => {
    if (window.confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir r√©initialiser TOUTES vos donn√©es ? Cette action est irr√©versible.')) {
      localStorage.removeItem('pharmaspace_medications');
      localStorage.removeItem('pharmaspace_classes');
      saveMedications(INITIAL_MEDS);
      saveClasses(INITIAL_CLASSES);
      alert('‚úÖ R√©initialisation termin√©e !\n\nüîÑ Retour aux 7 m√©dicaments par d√©faut\nüí° Pensez √† exporter avant de r√©initialiser la prochaine fois !');
    }
  };

  // Fonction pour recharger intelligemment sans perdre les personnalisations
  const smartReload = () => {
    if (confirm('üîÑ Recharger les donn√©es depuis data.json ?\n\n‚úÖ TOUT sera recharg√© depuis data.json (cache vid√©)\n‚ö†Ô∏è Vos modifications locales seront perdues\n\nContinuer ?')) {
      // Vider compl√®tement le localStorage
      localStorage.clear();
      
      // Recharger la page
      alert('‚úÖ Cache vid√© et rechargement en cours...\n\nüíä Toutes les donn√©es seront recharg√©es depuis data.json');
      location.reload(true);
    }
  };

  const exportData = () => {
    // R√©cup√©rer les donn√©es conseils depuis localStorage
    const conseilsCategories = localStorage.getItem('conseilsCategories');
    const conseilsOfficine = localStorage.getItem('conseilsOfficine');
    
    // R√©cup√©rer toutes les cat√©gories de documents pour chaque fiche
    const docCategories = {};
    const plaintes = conseilsOfficine ? JSON.parse(conseilsOfficine) : [];
    plaintes.forEach(plainte => {
      const savedCategories = localStorage.getItem('docCategories_' + plainte.id);
      if (savedCategories) {
        docCategories[plainte.id] = JSON.parse(savedCategories);
      }
    });
    
    const data = { 
      medications, 
      therapeuticClasses,
      pharmaceuticalForms,
      conseilsCategories: conseilsCategories ? JSON.parse(conseilsCategories) : null,
      conseilsOfficine: conseilsOfficine ? JSON.parse(conseilsOfficine) : null,
      docCategories: Object.keys(docCategories).length > 0 ? docCategories : null,
      exportDate: new Date().toISOString() 
    };
    
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pharmaspace_backup_${new Date().toISOString().split('T')[0]}.json`;
    const categoriesCount = Object.keys(docCategories).length;
    alert('‚úÖ Sauvegarde compl√®te t√©l√©charg√©e !\n\nüìÅ Fichier : pharmaspace_backup_' + new Date().toISOString().split('T')[0] + '.json\nüíä Flashcards: ' + medications.length + ' m√©dicaments\nüé® Classes th√©rapeutiques: ' + Object.keys(therapeuticClasses).length + '\nüíä Formes pharmaceutiques: ' + pharmaceuticalForms.length + '\nüìã Conseils: ' + (conseilsOfficine ? JSON.parse(conseilsOfficine).length : 0) + ' fiches' + (categoriesCount > 0 ? '\nüìÅ Cat√©gories documents: ' + categoriesCount + ' fiches avec cat√©gories' : '') + '\nüíæ Gardez ce fichier pr√©cieusement !\nüì§ Vous pouvez le partager avec vos coll√®gues.');
    a.click();
    URL.revokeObjectURL(url);
  };

  const importData = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          // D√âTECTION D'IMPORT AUTOMATIQUE D'IMAGES
          if (data.urlsMap && data.metadata) {
            const urlsMap = data.urlsMap;
            const count = Object.keys(urlsMap).length;
            
            if (!window.confirm('üéâ Import automatique d\'images d√©tect√© !\n\n' + count + ' images √† importer.\n\nVoulez-vous appliquer ces images aux m√©dicaments correspondants ?')) {
              return;
            }
            
            // Appliquer les URLs aux m√©dicaments existants
            let applied = 0;
            let notFound = [];
            
            const updatedMeds = medications.map(med => {
              // Chercher par nom commercial (premier de la liste)
              const medName = med.commercial[0];
              
              if (urlsMap[medName]) {
                applied++;
                return { ...med, image: urlsMap[medName] };
              }
              
              notFound.push(medName);
              return med;
            });
            
            saveMedications(updatedMeds);
            
            alert('‚úÖ Import r√©ussi !\n\n' + applied + ' images appliqu√©es\n' + notFound.length + ' m√©dicaments sans correspondance\n\n' + (notFound.length > 0 ? 'M√©dicaments non trouv√©s : ' + notFound.slice(0, 5).join(', ') + (notFound.length > 5 ? '...' : '') : ''));
            return;
          }
          
          // IMPORT NORMAL (donn√©es compl√®tes)
          if (data.medications && data.therapeuticClasses) {
            saveMedications(data.medications);
            saveClasses(data.therapeuticClasses);
            
            // Importer les formes pharmaceutiques intelligemment
            if (data.pharmaceuticalForms) {
              // R√©cup√©rer les formes actuelles (avec suppressions)
              const currentForms = pharmaceuticalForms;
              // Trouver les nouvelles formes du fichier (pas dans les formes actuelles)
              const newForms = data.pharmaceuticalForms.filter(form => !currentForms.includes(form));
              // Ajouter seulement les nouvelles formes (garder les suppressions)
              if (newForms.length > 0) {
                saveForms([...currentForms, ...newForms].sort());
              }
              // Si pas de nouvelles formes, garder les formes actuelles (avec suppressions)
            }
            
            // Restaurer les conseils si pr√©sents
            if (data.conseilsCategories) {
              localStorage.setItem('conseilsCategories', JSON.stringify(data.conseilsCategories));
            }
            if (data.conseilsOfficine) {
              localStorage.setItem('conseilsOfficine', JSON.stringify(data.conseilsOfficine));
            }
            
            // Restaurer les cat√©gories de documents si pr√©sentes
            if (data.docCategories) {
              Object.keys(data.docCategories).forEach(plainteId => {
                localStorage.setItem('docCategories_' + plainteId, JSON.stringify(data.docCategories[plainteId]));
              });
            }
            
            const conseilsCount = data.conseilsOfficine ? data.conseilsOfficine.length : 0;
            const formsCount = data.pharmaceuticalForms ? data.pharmaceuticalForms.length : 0;
            const categoriesCount = data.docCategories ? Object.keys(data.docCategories).length : 0;
            alert('‚úÖ Donn√©es import√©es avec succ√®s !\n\nüíä ' + data.medications.length + ' m√©dicaments charg√©s\nüé® ' + Object.keys(data.therapeuticClasses).length + ' classes th√©rapeutiques' + (formsCount > 0 ? '\nüíä ' + formsCount + ' formes pharmaceutiques' : '') + '\nüìã ' + conseilsCount + ' fiches conseils' + (categoriesCount > 0 ? '\nüìÅ ' + categoriesCount + ' fiches avec cat√©gories documents' : '') + (conseilsCount > 0 ? '\n\n‚ö†Ô∏è Rechargez la page pour voir les conseils' : ''));
          } else {
            alert('‚ùå Fichier invalide');
          }
        } catch (err) {
          alert('‚ùå Erreur lors de l\'import : ' + err.message);
        }
      };
      reader.readAsText(file);
    }
  };

  const ImagePlaceholder = () => (
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
      <circle cx="8.5" cy="8.5" r="1.5"/>
      <polyline points="21 15 16 10 5 21"/>
    </svg>
  );

  

  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #f8fafc 0%, #e2e8f0 100%)', padding: '1rem' }}>
      <style>{`.button-hover { transition: all 0.3s; } .button-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); }`}</style>

      {/* INDICATEUR DE CONNEXION - Version discr√®te */}
      {firebaseEnabled && (
        <div style={{
          position: 'fixed',
          bottom: '1.5rem',
          right: '1.5rem',
          zIndex: 9999,
          padding: '0.5rem 0.75rem',
          background: isOnline 
            ? 'rgba(16, 185, 129, 0.95)' 
            : 'rgba(239, 68, 68, 0.95)',
          backdropFilter: 'blur(8px)',
          color: 'white',
          borderRadius: '8px',
          boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
          display: 'flex',
          alignItems: 'center',
          gap: '0.4rem',
          fontSize: '0.75rem',
          fontWeight: 500,
          transition: 'all 0.3s ease'
        }}>
          <span style={{ fontSize: '0.65rem' }}>{isOnline ? '‚óè' : '‚óè'}</span>
          <span>{isOnline ? 'Connect√©' : 'Hors ligne'}</span>
        </div>
      )}

      <div style={{ maxWidth: 'none', margin: '0', padding: '0 2rem' }}>
        {mode !== 'conseils' ? (
          <>
          <div style={{ background: 'linear-gradient(135deg, #1e293b 0%, #334155 100%)', padding: '1.5rem', color: 'white', textAlign: 'center', borderRadius: '20px 20px 0 0', position: 'relative' }}>
            {/* BOUTON MENU EN HAUT √Ä GAUCHE */}
            {mode === 'flashcard' && (
              <div style={{ position: 'absolute', top: '1.5rem', left: '1.5rem' }}>
                <button 
                  onClick={() => setMode('menu')}
                  className="button-hover" 
                  style={{ 
                    background: 'rgba(255,255,255,0.2)',
                    border: 'none',
                    color: 'white',
                    padding: '0.75rem 1.25rem',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontSize: '1rem',
                    fontWeight: 600,
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem'
                  }}
                >
                  <span>‚Üê</span> Menu
                </button>
              </div>
            )}
            
            <h1 style={{ margin: 0, fontSize: '1.8rem', fontWeight: 700 }}>PharmaSpace</h1>
            <p style={{ margin: '0.5rem 0 0 0', opacity: 0.9, fontSize: '0.85rem' }}>
              {medications.length} m√©dicaments
            </p>

            
            {stats.total > 0 && (
              <div style={{ marginTop: '1rem', padding: '0.75rem', background: 'rgba(255, 255, 255, 0.1)', borderRadius: '12px' }}>
                <div style={{ fontSize: '0.85rem', opacity: 0.8 }}>Score</div>
                <div style={{ fontSize: '1.5rem', fontWeight: 700 }}>{Math.round((stats.correct / stats.total) * 100)}% ({stats.correct}/{stats.total})</div>
              </div>
            )}
          </div>

          <div style={{ background: 'white', borderRadius: '0 0 20px 20px', padding: '1.5rem', boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)', minHeight: '400px' }}>
          
          {mode === 'menu' && (
            <div>
              <h2 style={{ textAlign: 'center', marginBottom: '2rem', color: '#1e293b', fontSize: '1.8rem' }}>Choisissez votre mode</h2>
              
              <div style={{ display: 'grid', gap: '1rem', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', marginBottom: '1rem' }}>
                <button onClick={() => startMode('flashcard')} className="button-hover" style={{ background: 'linear-gradient(135deg, #3B82F6 0%, #2563EB 100%)', border: 'none', borderRadius: '16px', padding: '2rem', color: 'white', cursor: 'pointer', position: 'relative', textAlign: 'center' }}>
                  <div style={{ position: 'absolute', top: '2rem', left: '2rem' }}><BookOpen size={24} /></div>
                  <div>
                    <div style={{ fontSize: '1.3rem', fontWeight: 700, marginBottom: '0.5rem' }}>Flashcards</div>
                    <div style={{ fontSize: '0.9rem', opacity: 0.9 }}>Apprentissage</div>
                  </div>
                </button>
                
                <button onClick={() => startMode('conseils')} className="button-hover" style={{ background: 'linear-gradient(135deg, #10B981 0%, #059669 100%)', border: 'none', borderRadius: '16px', padding: '2rem', color: 'white', cursor: 'pointer', position: 'relative', textAlign: 'center' }}>
                  <div style={{ position: 'absolute', top: '2rem', left: '2rem' }}>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                      <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                  </div>
                  <div>
                    <div style={{ fontSize: '1.3rem', fontWeight: 700, marginBottom: '0.5rem' }}>Conseils Officine</div>
                    <div style={{ fontSize: '0.9rem', opacity: 0.9 }}>Plaintes courantes</div>
                  </div>
                </button>

              </div>

              {/* BOUTON GESTION DES DONN√âES */}
              <div style={{ marginTop: '2rem', display: 'flex', justifyContent: 'center' }}>
                <button 
                  onClick={() => setShowDataManagement(true)}
                  className="button-hover"
                  style={{ 
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', 
                    border: 'none', 
                    borderRadius: '12px', 
                    padding: '0.75rem 1.5rem', 
                    cursor: 'pointer',
                    transition: 'all 0.3s',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.75rem',
                    boxShadow: '0 4px 16px rgba(102, 126, 234, 0.4)',
                    color: 'white'
                  }}
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/>
                    <polyline points="7 3 7 8 15 8"/>
                  </svg>
                  <span style={{ fontSize: '0.95rem', fontWeight: 600 }}>Gestion des donn√©es</span>
                </button>
              </div>
              
            </div>
          )}



          {/* MODE FLASHCARD */}
          {mode === 'flashcard' && (
            <div>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', flexWrap: 'wrap', gap: '1rem' }}>
                <div style={{ fontSize: '0.9rem', color: '#64748b', fontWeight: 600 }}>{currentIndex + 1} / {getFlashcardListMedications.length}</div>
                <div style={{ display: 'flex', gap: '0.5rem' }}>
                  <button onClick={() => setShowSettings(true)} className="button-hover" style={{ padding: '0.6rem', background: '#f1f5f9', border: '2px solid #e2e8f0', borderRadius: '8px', cursor: 'pointer' }}>
                    <Settings size={20} style={{ color: '#64748b' }} />
                  </button>
                  <button onClick={() => setShowManagement(true)} className="button-hover" style={{ padding: '0.6rem', background: '#D1FAE5', border: '2px solid #10B981', borderRadius: '8px', cursor: 'pointer' }}>
                    <Plus size={20} style={{ color: '#10B981' }} />
                  </button>
                  <button onClick={() => setFlashcardView('card')} className="button-hover" style={{ padding: '0.5rem 1rem', background: flashcardView === 'card' ? '#334155' : '#e2e8f0', border: 'none', borderRadius: '8px', color: flashcardView === 'card' ? 'white' : '#64748b', cursor: 'pointer', fontSize: '0.9rem', fontWeight: 600 }}>
                    Carte
                  </button>
                  <button onClick={() => setFlashcardView('list')} className="button-hover" style={{ padding: '0.5rem 1rem', background: flashcardView === 'list' ? '#334155' : '#e2e8f0', border: 'none', borderRadius: '8px', color: flashcardView === 'list' ? 'white' : '#64748b', cursor: 'pointer', fontSize: '0.9rem', fontWeight: 600 }}>
                    Liste
                  </button>
                </div>
              </div>

              {/* BARRE DE RECHERCHE ET TRI MODE CARTE */}
              {flashcardView === 'card' && (
                <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem' }}>
                  <input
                    type="text"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    placeholder="üîç Rechercher un m√©dicament..."
                    style={{
                      flex: 1,
                      padding: '0.75rem',
                      border: '2px solid #e2e8f0',
                      borderRadius: '8px',
                      fontSize: '0.9rem'
                    }}
                  />
                  <select value={flashcardListSort} onChange={(e) => setFlashcardListSort(e.target.value)} style={{ padding: '0.75rem', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '0.9rem', cursor: 'pointer', background: 'white' }}>
                    <option value="dci">DCI (A-Z)</option>
                    <option value="commercial">Commercial (A-Z)</option>
                    <option value="category">Par classe</option>
                    <option value="form">Par forme</option>
                    <option value="notes">Par notes/conseils</option>
                  </select>
                </div>
              )}

              {flashcardView === 'card' ? (
                <>
                  {getFlashcardListMedications[currentIndex] ? (
                  <div 
                    onClick={() => setShowAnswer(!showAnswer)} 
                    style={{ 
                      background: showAnswer ? getClassColor(getFlashcardListMedications[currentIndex].category) : 'white', 
                      borderRadius: '20px', 
                      padding: '3rem 2rem', 
                      cursor: 'pointer', 
                      minHeight: '300px', 
                      display: 'flex', 
                      flexDirection: 'column', 
                      alignItems: 'center', 
                      justifyContent: 'center', 
                      transition: 'all 0.4s', 
                      boxShadow: '0 10px 40px rgba(0, 0, 0, 0.1)', 
                      border: showAnswer ? 'none' : '3px solid #334155',
                      position: 'relative'
                    }}
                  >
                    <div style={{ fontSize: '0.85rem', color: showAnswer ? 'rgba(255, 255, 255, 0.9)' : '#334155', marginBottom: '1rem', textTransform: 'uppercase', letterSpacing: '0.1em', fontWeight: 700 }}>
                      {showAnswer ? 'DCI' : 'Nom Commercial'}
                    </div>
                    <div style={{ fontSize: showAnswer ? '2.5rem' : '1.8rem', fontWeight: 700, color: showAnswer ? 'white' : '#1e293b', marginBottom: '1rem', textAlign: 'center' }}>
                      {showAnswer ? getFlashcardListMedications[currentIndex].dci : getFlashcardListMedications[currentIndex].commercial.join(' ‚Ä¢ ')}
                    </div>
                    <div style={{ display: showAnswer ? 'inline-block' : 'none', padding: '0.5rem 1.5rem', background: showAnswer ? 'rgba(255, 255, 255, 0.2)' : `${getClassColor(getFlashcardListMedications[currentIndex].category)}20`, borderRadius: '20px', color: showAnswer ? 'white' : getClassColor(getFlashcardListMedications[currentIndex].category), fontSize: '0.85rem', fontWeight: 600, marginBottom: '1rem' }}>
                      {getFlashcardListMedications[currentIndex].category}
                    </div>
                    {showAnswer && (() => {
                      const med = getFlashcardListMedications[currentIndex];
                      const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
                      const forms = med.pharmaceuticalForm ? med.pharmaceuticalForm.split(',').map(f => f.trim()) : [];
                      
                      return images.length > 0 ? (
                        <div style={{ display: 'flex', gap: '1.5rem', justifyContent: 'center', marginTop: '1rem', flexWrap: 'wrap' }}>
                          {images.map((url, idx) => (
                            <div key={idx} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '0.5rem' }}>
                              <img 
                                src={url} 
                                alt={`${med.dci} ${idx + 1}`}
                                style={{ 
                                  maxWidth: images.length > 1 ? '180px' : '280px',
                                  maxHeight: images.length > 1 ? '180px' : '280px',
                                  borderRadius: '12px',
                                  cursor: 'pointer',
                                  transition: 'transform 0.2s'
                                }}
                                onClick={(e) => { e.stopPropagation(); setImageModalUrl(url); }}
                                onMouseEnter={(e) => e.target.style.transform = 'scale(1.05)'}
                                onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                              />
                              {forms[idx] && (
                                <div style={{ fontSize: '0.85rem', color: 'rgba(255,255,255,0.9)', fontStyle: 'italic', fontWeight: 600 }}>
                                  {forms[idx]}
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      ) : null;
                    })()}

                    
                    {/* BOUTON NOTES/CONSEILS en haut √† droite - TOUJOURS VISIBLE */}
                    {(() => {
                      const med = getFlashcardListMedications[currentIndex];
                      const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
                      const items = getConsolidatedNotesConseils(med.commercial[0] || med.dci, images);
                      
                      const notesCount = items.filter(it => it.type === 'note').length;
                      const conseilsCount = items.filter(it => it.type === 'conseil').length;
                      const totalCount = notesCount + conseilsCount;
                      
                      return (
                        <>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setModalMedication(getFlashcardListMedications[currentIndex]);
                              setShowNotesModal(true);
                            }}
                            style={{
                              position: 'absolute',
                              top: '1rem',
                              right: '1rem',
                              width: '50px',
                              height: '50px',
                              borderRadius: '50%',
                              background: totalCount > 0 ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)',
                              border: '3px solid white',
                              boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
                              cursor: 'pointer',
                              display: 'flex',
                              flexDirection: 'column',
                              alignItems: 'center',
                              justifyContent: 'center',
                              color: 'white',
                              fontWeight: 700,
                              fontSize: '0.7rem',
                              zIndex: 100,
                              transition: 'transform 0.2s'
                            }}
                            onMouseEnter={(e) => e.target.style.transform = 'scale(1.1)'}
                            onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                          >
                            <div style={{ fontSize: '1.2rem', lineHeight: 1 }}>üìã</div>
                            {totalCount > 0 && <div style={{ fontSize: '0.65rem' }}>{totalCount}</div>}
                          </button>
                          
                          {/* MODAL NOTES/CONSEILS */}
                          {showNotesModal && (
                            <div
                              style={{
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                background: 'rgba(0,0,0,0.7)',
                                backdropFilter: 'blur(4px)',
                                zIndex: 10000,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                padding: '1rem'
                              }}
                              onClick={(e) => {
                                e.stopPropagation();
                                console.log('üîí Fermeture modale - modalMedication:', modalMedication, 'pendingCacheUpdate:', pendingCacheUpdate);
                              setShowNotesModal(false);
                                setEditingItemId(null);
                              }}
                            >
                              <div
                                onClick={(e) => e.stopPropagation()}
                                style={{
                                  background: 'white',
                                  borderRadius: '20px',
                                  padding: '2rem',
                                  maxWidth: '600px',
                                  width: '100%',
                                  maxHeight: '80vh',
                                  overflowY: 'auto',
                                  boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
                                }}
                              >
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                                  <h3 style={{ fontSize: '1.5rem', fontWeight: 700, color: '#1e293b', margin: 0 }}>
                                    Notes & Conseils
                                  </h3>
                                  <button
                                    onClick={() => {
                                      setShowNotesModal(false);
                                      setEditingItemId(null);
                                    }}
                                    style={{
                                      background: '#f1f5f9',
                                      border: 'none',
                                      width: '32px',
                                      height: '32px',
                                      borderRadius: '50%',
                                      cursor: 'pointer',
                                      display: 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'center',
                                      fontSize: '1.2rem',
                                      color: '#64748b'
                                    }}
                                  >
                                    ‚úï
                                  </button>
                                </div>
                                
                                <div key={refreshKey}>
                                  {(() => {
                                    const med = getFlashcardListMedications[currentIndex];
                                    const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
                                    const items = getConsolidatedNotesConseils(med.commercial[0] || med.dci, images);
                                    return items.map((item) => (
                                    <div
                                      key={item.id}
                                      style={{
                                        marginBottom: '1rem',
                                        padding: '1rem',
                                        background: item.type === 'note' ? '#fefce8' : '#eff6ff',
                                        borderRadius: '12px',
                                        borderLeft: `4px solid ${item.type === 'note' ? '#fbbf24' : '#3b82f6'}`,
                                        boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
                                      }}
                                    >
                                      {editingItemId === item.id ? (
                                        <div>
                                          <textarea
                                            value={editingText}
                                            onChange={(e) => setEditingText(e.target.value)}
                                            style={{
                                              width: '100%',
                                              minHeight: '80px',
                                              padding: '0.75rem',
                                              background: 'white',
                                              border: '2px solid ' + (item.type === 'note' ? '#fbbf24' : '#3b82f6'),
                                              borderRadius: '8px',
                                              fontSize: '0.9rem',
                                              color: '#1e293b',
                                              resize: 'vertical',
                                              fontFamily: 'inherit'
                                            }}
                                            autoFocus
                                          />
                                          <div style={{ display: 'flex', gap: '0.5rem', marginTop: '0.75rem' }}>
                                            <button
                                              onClick={() => {
                                                const success = item.isStandalone 
                                                  ? updateStandaloneNoteConseil(item.id, editingText)
                                                  : updateNoteConseilInPlainte(item, editingText);
                                                if (success) {
                                                  setRefreshKey(prev => prev + 1);
                                                  setEditingItemId(null);
                                                }
                                              }}
                                              style={{
                                                flex: 1,
                                                padding: '0.75rem',
                                                background: '#10B981',
                                                border: 'none',
                                                borderRadius: '8px',
                                                color: 'white',
                                                cursor: 'pointer',
                                                fontWeight: 600,
                                                fontSize: '0.9rem'
                                              }}
                                            >
                                              ‚úì Enregistrer
                                            </button>
                                            <button
                                              onClick={() => setEditingItemId(null)}
                                              style={{
                                                flex: 1,
                                                padding: '0.75rem',
                                                background: '#64748b',
                                                border: 'none',
                                                borderRadius: '8px',
                                                color: 'white',
                                                cursor: 'pointer',
                                                fontWeight: 600,
                                                fontSize: '0.9rem'
                                              }}
                                            >
                                              ‚úï Annuler
                                            </button>
                                          </div>
                                        </div>
                                      ) : (
                                        <div>
                                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                                            <span style={{
                                              fontSize: '0.75rem',
                                              fontWeight: 700,
                                              color: item.type === 'note' ? '#854d0e' : '#1e40af',
                                              textTransform: 'uppercase',
                                              letterSpacing: '0.05em'
                                            }}>
                                              {item.type === 'note' ? 'Note' : 'Conseil'}
                                            </span>
                                            <div style={{ position: 'relative' }}>
                                              <button
                                                onClick={(e) => {
                                                  e.stopPropagation();
                                                  setExpandedCard(expandedCard === item.id ? null : item.id);
                                                }}
                                                style={{
                                                  background: 'transparent',
                                                  border: 'none',
                                                  cursor: 'pointer',
                                                  fontSize: '1.2rem',
                                                  color: '#64748b',
                                                  padding: '0.25rem 0.5rem'
                                                }}
                                              >
                                                ‚ãÆ
                                              </button>
                                              {expandedCard === item.id && (
                                                <div style={{
                                                  position: 'absolute',
                                                  top: '100%',
                                                  right: 0,
                                                  background: 'white',
                                                  border: '1px solid #e2e8f0',
                                                  borderRadius: '8px',
                                                  boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                                                  minWidth: '120px',
                                                  zIndex: 1000,
                                                  overflow: 'hidden'
                                                }}>
                                                  <button
                                                    onClick={(e) => {
                                                      e.stopPropagation();
                                                      setEditingItemId(item.id);
                                                      setEditingText(item.texte);
                                                      setExpandedCard(null);
                                                    }}
                                                    style={{
                                                      width: '100%',
                                                      padding: '0.75rem 1rem',
                                                      background: 'white',
                                                      border: 'none',
                                                      borderBottom: '1px solid #e2e8f0',
                                                      cursor: 'pointer',
                                                      textAlign: 'left',
                                                      fontSize: '0.85rem',
                                                      color: '#1e293b'
                                                    }}
                                                    onMouseEnter={(e) => e.target.style.background = '#f8fafc'}
                                                    onMouseLeave={(e) => e.target.style.background = 'white'}
                                                  >
                                                    Modifier
                                                  </button>
                                                  <button
                                                    onClick={(e) => {
                                                      e.stopPropagation();
                                                      if (confirm('Supprimer ' + (item.type === 'note' ? 'cette note' : 'ce conseil') + ' ?')) {
                                                        const success = item.isStandalone
                                                          ? deleteStandaloneNoteConseil(item.id)
                                                          : deleteNoteConseilInPlainte(item);
                                                        if (success) {
                                                          setRefreshKey(prev => prev + 1);
                                                        }
                                                      }
                                                      setExpandedCard(null);
                                                    }}
                                                    style={{
                                                      width: '100%',
                                                      padding: '0.75rem 1rem',
                                                      background: 'white',
                                                      border: 'none',
                                                      cursor: 'pointer',
                                                      textAlign: 'left',
                                                      fontSize: '0.85rem',
                                                      color: '#ef4444'
                                                    }}
                                                    onMouseEnter={(e) => e.target.style.background = '#fef2f2'}
                                                    onMouseLeave={(e) => e.target.style.background = 'white'}
                                                  >
                                                    Supprimer
                                                  </button>
                                                </div>
                                              )}
                                            </div>
                                          </div>
                                          <div style={{
                                            fontSize: '0.95rem',
                                            color: '#1e293b',
                                            lineHeight: 1.6,
                                            marginBottom: '0.5rem',
                                            whiteSpace: 'pre-wrap'
                                          }}>
                                            {item.texte}
                                          </div>
                                          <div style={{
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'flex-end'
                                          }}>
                                            <div style={{
                                              fontSize: '0.75rem',
                                              color: '#64748b',
                                              fontStyle: 'italic'
                                            }}>
                                              {item.isStandalone ? (
                                                <span>Note personnelle (non li√©e √† une fiche)</span>
                                              ) : (
                                                <span>Fiche: {item.plainteName}</span>
                                              )}
                                            </div>
                                            {!item.isStandalone && item.formes && item.formes.length > 0 && (
                                              <div style={{
                                                fontSize: '0.7rem',
                                                color: '#94a3b8',
                                                fontStyle: 'italic'
                                              }}>
                                                {[...new Set(item.formes)].join(', ')}
                                              </div>
                                            )}
                                          </div>
                                        </div>
                                      )}
                                    </div>
                                  ));
                                  })()}
                                </div>
                                
                                {/* Boutons pour ajouter une note ou un conseil */}
                                {addingNoteType === null ? (
                                  <div style={{ marginTop: '1.5rem', display: 'flex', gap: '0.75rem' }}>
                                    <button
                                      onClick={() => {
                                        setAddingNoteType('note');
                                        setNewNoteText('');
                                      }}
                                      style={{
                                        flex: 1,
                                        padding: '0.75rem',
                                        background: '#fef3c7',
                                        border: '2px solid #fbbf24',
                                        borderRadius: '10px',
                                        color: '#854d0e',
                                        cursor: 'pointer',
                                        fontWeight: 600,
                                        fontSize: '0.9rem'
                                      }}
                                    >
                                      + Ajouter une note
                                    </button>
                                    <button
                                      onClick={() => {
                                        setAddingNoteType('conseil');
                                        setNewNoteText('');
                                      }}
                                      style={{
                                        flex: 1,
                                        padding: '0.75rem',
                                        background: '#dbeafe',
                                        border: '2px solid #3b82f6',
                                        borderRadius: '10px',
                                        color: '#1e40af',
                                        cursor: 'pointer',
                                        fontWeight: 600,
                                        fontSize: '0.9rem'
                                      }}
                                    >
                                      + Ajouter un conseil
                                    </button>
                                  </div>
                                ) : (
                                  <div style={{ marginTop: '1.5rem', padding: '1rem', background: addingNoteType === 'note' ? '#fefce8' : '#eff6ff', borderRadius: '12px', border: `2px solid ${addingNoteType === 'note' ? '#fbbf24' : '#3b82f6'}` }}>
                                    <div style={{ fontSize: '0.85rem', fontWeight: 700, color: addingNoteType === 'note' ? '#854d0e' : '#1e40af', marginBottom: '0.5rem' }}>
                                      {addingNoteType === 'note' ? 'Nouvelle note' : 'Nouveau conseil'}
                                    </div>
                                    <textarea
                                      value={newNoteText}
                                      onChange={(e) => setNewNoteText(e.target.value)}
                                      placeholder="Tapez votre texte ici..."
                                      style={{
                                        width: '100%',
                                        minHeight: '80px',
                                        padding: '0.75rem',
                                        background: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        fontSize: '0.9rem',
                                        color: '#1e293b',
                                        resize: 'vertical',
                                        fontFamily: 'inherit'
                                      }}
                                      autoFocus
                                    />
                                    <div style={{ display: 'flex', gap: '0.5rem', marginTop: '0.75rem' }}>
                                      <button
                                        onClick={() => {
                                          if (newNoteText.trim()) {
                                            const med = getFlashcardListMedications[currentIndex];
                                            const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
                                            createStandaloneNoteConseil(med.commercial[0], med.dci, addingNoteType, newNoteText, images);
                                            setRefreshKey(prev => prev + 1);
                                            setAddingNoteType(null);
                                            setNewNoteText('');
                                          }
                                        }}
                                        style={{
                                          flex: 1,
                                          padding: '0.75rem',
                                          background: '#10B981',
                                          border: 'none',
                                          borderRadius: '8px',
                                          color: 'white',
                                          cursor: 'pointer',
                                          fontWeight: 600,
                                          fontSize: '0.9rem'
                                        }}
                                      >
                                        ‚úì Enregistrer
                                      </button>
                                      <button
                                        onClick={() => {
                                          setAddingNoteType(null);
                                          setNewNoteText('');
                                        }}
                                        style={{
                                          flex: 1,
                                          padding: '0.75rem',
                                          background: '#64748b',
                                          border: 'none',
                                          borderRadius: '8px',
                                          color: 'white',
                                          cursor: 'pointer',
                                          fontWeight: 600,
                                          fontSize: '0.9rem'
                                        }}
                                      >
                                        ‚úï Annuler
                                      </button>
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>
                          )}
                        </>
                      );
                    })()}
                  </div>
                  ) : (
                  <div style={{
                    textAlign: 'center',
                    padding: '3rem 2rem',
                    color: '#64748b'
                  }}>
                    <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üîç</div>
                    <div style={{ fontSize: '1.2rem', fontWeight: 600, marginBottom: '0.5rem' }}>Aucun r√©sultat</div>
                    <div style={{ fontSize: '0.9rem' }}>Essayez une autre recherche ou revenez au menu</div>
                  </div>
                  )}
                  
                  <div style={{ display: 'flex', gap: '1rem', marginTop: '2rem' }}>
                    <button onClick={() => currentIndex > 0 && (setCurrentIndex(currentIndex - 1), setShowAnswer(false))} disabled={currentIndex === 0} className="button-hover" style={{ flex: 1, padding: '1rem', background: currentIndex === 0 ? '#f1f5f9' : '#e2e8f0', border: 'none', borderRadius: '12px', color: currentIndex === 0 ? '#cbd5e1' : '#1e293b', cursor: currentIndex === 0 ? 'not-allowed' : 'pointer', fontWeight: 600, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.5rem' }}>
                      <ChevronLeft size={20} />
                      <span>Pr√©c√©dent</span>
                    </button>
                    <button 
                      onClick={() => getFlashcardListMedications.length > 1 && handleNext()} 
                      disabled={getFlashcardListMedications.length === 1}
                      className="button-hover" 
                      style={{ 
                        flex: 1, 
                        padding: '1rem', 
                        background: getFlashcardListMedications.length === 1 ? '#f1f5f9' : '#334155', 
                        border: 'none', 
                        borderRadius: '12px', 
                        color: getFlashcardListMedications.length === 1 ? '#cbd5e1' : 'white', 
                        cursor: getFlashcardListMedications.length === 1 ? 'not-allowed' : 'pointer', 
                        fontWeight: 600, 
                        display: 'flex', 
                        alignItems: 'center', 
                        justifyContent: 'center', 
                        gap: '0.5rem' 
                      }}
                    >
                      <span>Suivant</span>
                      <ChevronRight size={20} />
                    </button>
                  </div>
                </>
              ) : (
                <div>
                  <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem' }}>
                    <input type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} placeholder="üîç Rechercher..." style={{ flex: 1, padding: '0.75rem', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '0.9rem' }} />
                    <select value={flashcardListSort} onChange={(e) => setFlashcardListSort(e.target.value)} style={{ padding: '0.75rem', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '0.9rem', cursor: 'pointer', background: 'white' }}>
                      <option value="dci">DCI (A-Z)</option>
                      <option value="commercial">Commercial (A-Z)</option>
                      <option value="category">Par classe</option>
                      <option value="form">Par forme</option>
                      <option value="notes">Par notes/conseils</option>
                    </select>
                  </div>
                  <div style={{ maxHeight: '75vh', overflowY: 'auto' }}>
                    {getFlashcardListMedications.length === 0 ? (
                      <div style={{ textAlign: 'center', padding: '3rem', color: '#64748b' }}>
                        <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üîç</div>
                        <div style={{ fontSize: '1.2rem', fontWeight: 600, marginBottom: '0.5rem' }}>Aucun r√©sultat</div>
                        <div style={{ fontSize: '0.9rem' }}>Essayez une autre recherche ou revenez au menu</div>
                      </div>
                    ) : (
                    getFlashcardListMedications.map((med, i) => {
                      // D√©finir les variables pour ce m√©dicament
                      const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
                      const items = getConsolidatedNotesConseils(med.commercial[0] || med.dci, images);
                      const hasContent = items.length > 0;
                      const notesCount = items.filter(it => it.type === 'note').length;
                      const conseilsCount = items.filter(it => it.type === 'conseil').length;
                      
                      return (
                        <div key={`${med.dci}-${listUpdateKey}-${i}`} style={{ position: 'relative', padding: '1rem', background: 'white', border: `3px solid ${getClassColor(med.category)}`, borderRadius: '12px', marginBottom: '0.75rem', display: 'flex', gap: '1rem' }}>
                          {/* Cercle notes/conseils - comme mode carte mais 35px */}
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setModalMedication(med);
                                console.log('üîì Modale ouverte pour:', med.dci, 'index:', i);
                              setShowNotesModal(true);
                            }}
                            style={{
                              position: 'absolute',
                              top: '0.5rem',
                              right: '0.5rem',
                              width: '35px',
                              height: '35px',
                              borderRadius: '50%',
                              background: hasContent ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)',
                              border: '2px solid white',
                              boxShadow: '0 2px 6px rgba(0,0,0,0.2)',
                              cursor: 'pointer',
                              display: 'flex',
                              flexDirection: 'column',
                              alignItems: 'center',
                              justifyContent: 'center',
                              color: 'white',
                              fontWeight: 700,
                              fontSize: '0.6rem',
                              zIndex: 10,
                              transition: 'transform 0.2s'
                            }}
                            onMouseEnter={(e) => e.target.style.transform = 'scale(1.1)'}
                            onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                          >
                            <div style={{ fontSize: '0.9rem', lineHeight: 1 }}>üìã</div>
                            {(notesCount + conseilsCount) > 0 && <div style={{ fontSize: '0.55rem' }}>{notesCount + conseilsCount}</div>}
                          </button>
                        {(() => {
                          const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
                          return images.length > 0 ? (
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.25rem', width: '60px' }}>
                              {images.map((img, idx) => (
                                <img 
                                  key={idx}
                                  src={img} 
                                  alt={`${med.dci} ${idx+1}`} 
                                  style={{ 
                                    width: images.length === 1 ? '60px' : '28px', 
                                    height: images.length === 1 ? '60px' : '28px', 
                                    objectFit: 'cover', 
                                    borderRadius: '6px', 
                                    border: `2px solid ${getClassColor(med.category)}`, 
                                    cursor: 'pointer' 
                                  }} 
                                  onClick={() => setImageModalUrl(img)} 
                                />
                              ))}
                            </div>
                          ) : (
                            <div style={{ width: '60px', height: '60px', background: '#f1f5f9', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#cbd5e1' }}>
                              <ImagePlaceholder />
                            </div>
                          );
                        })()}
                        <div style={{ flex: 1 }}>
                          <div style={{ fontSize: '1rem', fontWeight: 700, color: '#1e293b' }}>{med.commercial.join(' ‚Ä¢ ')}</div>
                          <div style={{ fontSize: '0.9rem', color: '#64748b' }}>{med.dci}</div>
                          <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center', marginTop: '0.5rem', flexWrap: 'wrap' }}>
                            <div style={{ display: 'inline-block', padding: '0.25rem 0.75rem', background: `${getClassColor(med.category)}20`, borderRadius: '12px', color: getClassColor(med.category), fontSize: '0.75rem', fontWeight: 600 }}>
                              {med.category}
                            </div>
                            {med.pharmaceuticalForm && (
                              <div style={{ fontSize: '0.75rem', color: '#64748b', fontStyle: 'italic', display: 'flex', gap: '0.25rem', flexWrap: 'wrap' }}>
                                {[...new Set(med.pharmaceuticalForm.split(',').map(f => f.trim()))].map((form, i) => (
                                  <span key={i} style={{ background: '#f1f5f9', padding: '0.2rem 0.5rem', borderRadius: '6px' }}>
                                    {form}
                                  </span>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                    })
                    )}
                  </div>


                  {/* MODAL NOTES/CONSEILS - Accessible depuis tous les modes */}
                  {showNotesModal && modalMedication && (
                    <div
                      style={{
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        background: 'rgba(0,0,0,0.7)',
                        backdropFilter: 'blur(4px)',
                        zIndex: 10000,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        padding: '1rem'
                      }}
                      onClick={(e) => {
                        e.stopPropagation();
                        setShowNotesModal(false);
                        setModalMedication(null);
                        setEditingItemId(null);
                        setAddingNoteType(null);
                      }}
                    >
                      <div
                        onClick={(e) => e.stopPropagation()}
                        style={{
                          background: 'white',
                          borderRadius: '20px',
                          padding: '2rem',
                          maxWidth: '600px',
                          width: '100%',
                          maxHeight: '80vh',
                          overflowY: 'auto',
                          boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
                        }}
                      >
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                          <h3 style={{ fontSize: '1.5rem', fontWeight: 700, color: '#1e293b', margin: 0 }}>
                            Notes & Conseils
                          </h3>
                          <button
                            onClick={() => {
                              setShowNotesModal(false);
                              setModalMedication(null);
                              setEditingItemId(null);
                              setAddingNoteType(null);
                            }}
                            style={{
                              background: '#f1f5f9',
                              border: 'none',
                              width: '32px',
                              height: '32px',
                              borderRadius: '50%',
                              cursor: 'pointer',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              fontSize: '1.2rem',
                              color: '#64748b'
                            }}
                          >
                            ‚úï
                          </button>
                        </div>
                        
                        {(() => {
                          const med = modalMedication;
                          const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
                          const items = getConsolidatedNotesConseils(med.commercial[0] || med.dci, images);
                          
                          return (
                            <>
                              <div key={refreshKey}>
                                {items.map((item) => (
                                  <div
                                    key={item.id}
                                    style={{
                                      marginBottom: '1rem',
                                      padding: '1rem',
                                      background: item.type === 'note' ? '#fefce8' : '#eff6ff',
                                      borderRadius: '12px',
                                      borderLeft: `4px solid ${item.type === 'note' ? '#fbbf24' : '#3b82f6'}`,
                                      boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
                                    }}
                                  >
                                    {editingItemId === item.id ? (
                                      <div>
                                        <textarea
                                          value={editingText}
                                          onChange={(e) => setEditingText(e.target.value)}
                                          style={{
                                            width: '100%',
                                            minHeight: '80px',
                                            padding: '0.75rem',
                                            background: 'white',
                                            border: '2px solid ' + (item.type === 'note' ? '#fbbf24' : '#3b82f6'),
                                            borderRadius: '8px',
                                            fontSize: '0.9rem',
                                            color: '#1e293b',
                                            resize: 'vertical',
                                            fontFamily: 'inherit'
                                          }}
                                          autoFocus
                                        />
                                        <div style={{ display: 'flex', gap: '0.5rem', marginTop: '0.75rem' }}>
                                          <button
                                            onClick={() => {
                                              const success = item.isStandalone 
                                                ? updateStandaloneNoteConseil(item.id, editingText)
                                                : updateNoteConseilInPlainte(item, editingText);
                                              if (success) {
                                                setRefreshKey(prev => prev + 1);
                                                setEditingItemId(null);
                                              }
                                            }}
                                            style={{
                                              flex: 1,
                                              padding: '0.75rem',
                                              background: '#10B981',
                                              border: 'none',
                                              borderRadius: '8px',
                                              color: 'white',
                                              cursor: 'pointer',
                                              fontWeight: 600,
                                              fontSize: '0.9rem'
                                            }}
                                          >
                                            ‚úì Enregistrer
                                          </button>
                                          <button
                                            onClick={() => setEditingItemId(null)}
                                            style={{
                                              flex: 1,
                                              padding: '0.75rem',
                                              background: '#64748b',
                                              border: 'none',
                                              borderRadius: '8px',
                                              color: 'white',
                                              cursor: 'pointer',
                                              fontWeight: 600,
                                              fontSize: '0.9rem'
                                            }}
                                          >
                                            ‚úï Annuler
                                          </button>
                                        </div>
                                      </div>
                                    ) : (
                                      <div>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                                          <span style={{
                                            fontSize: '0.75rem',
                                            fontWeight: 700,
                                            color: item.type === 'note' ? '#854d0e' : '#1e40af',
                                            textTransform: 'uppercase',
                                            letterSpacing: '0.05em'
                                          }}>
                                            {item.type === 'note' ? 'Note' : 'Conseil'}
                                          </span>
                                          <div style={{ position: 'relative' }}>
                                            <button
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                setExpandedCard(expandedCard === item.id ? null : item.id);
                                              }}
                                              style={{
                                                background: 'transparent',
                                                border: 'none',
                                                cursor: 'pointer',
                                                fontSize: '1.2rem',
                                                color: '#64748b',
                                                padding: '0.25rem 0.5rem'
                                              }}
                                            >
                                              ‚ãÆ
                                            </button>
                                            {expandedCard === item.id && (
                                              <div style={{
                                                position: 'absolute',
                                                top: '100%',
                                                right: 0,
                                                background: 'white',
                                                border: '1px solid #e2e8f0',
                                                borderRadius: '8px',
                                                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                                                minWidth: '120px',
                                                zIndex: 1000,
                                                overflow: 'hidden'
                                              }}>
                                                <button
                                                  onClick={(e) => {
                                                    e.stopPropagation();
                                                    setEditingItemId(item.id);
                                                    setEditingText(item.texte);
                                                    setExpandedCard(null);
                                                  }}
                                                  style={{
                                                    width: '100%',
                                                    padding: '0.75rem 1rem',
                                                    background: 'white',
                                                    border: 'none',
                                                    borderBottom: '1px solid #e2e8f0',
                                                    cursor: 'pointer',
                                                    textAlign: 'left',
                                                    fontSize: '0.85rem',
                                                    color: '#1e293b'
                                                  }}
                                                  onMouseEnter={(e) => e.target.style.background = '#f8fafc'}
                                                  onMouseLeave={(e) => e.target.style.background = 'white'}
                                                >
                                                  Modifier
                                                </button>
                                                <button
                                                  onClick={(e) => {
                                                    e.stopPropagation();
                                                    if (confirm('Supprimer ' + (item.type === 'note' ? 'cette note' : 'ce conseil') + ' ?')) {
                                                      const success = item.isStandalone
                                                        ? deleteStandaloneNoteConseil(item.id)
                                                        : deleteNoteConseilInPlainte(item);
                                                      if (success) {
                                                        setRefreshKey(prev => prev + 1);
                                                      }
                                                    }
                                                    setExpandedCard(null);
                                                  }}
                                                  style={{
                                                    width: '100%',
                                                    padding: '0.75rem 1rem',
                                                    background: 'white',
                                                    border: 'none',
                                                    cursor: 'pointer',
                                                    textAlign: 'left',
                                                    fontSize: '0.85rem',
                                                    color: '#ef4444'
                                                  }}
                                                  onMouseEnter={(e) => e.target.style.background = '#fef2f2'}
                                                  onMouseLeave={(e) => e.target.style.background = 'white'}
                                                >
                                                  Supprimer
                                                </button>
                                              </div>
                                            )}
                                          </div>
                                        </div>
                                        <div style={{
                                          fontSize: '0.95rem',
                                          color: '#1e293b',
                                          lineHeight: 1.6,
                                          marginBottom: '0.5rem',
                                          whiteSpace: 'pre-wrap'
                                        }}>
                                          {item.texte}
                                        </div>
                                        <div style={{
                                          display: 'flex',
                                          justifyContent: 'space-between',
                                          alignItems: 'flex-end'
                                        }}>
                                          <div style={{
                                            fontSize: '0.75rem',
                                            color: '#64748b',
                                            fontStyle: 'italic'
                                          }}>
                                            {item.isStandalone ? (
                                              <span>Note personnelle (non li√©e √† une fiche)</span>
                                            ) : (
                                              <span>Fiche: {item.plainteName}</span>
                                            )}
                                          </div>
                                          {!item.isStandalone && item.formes && item.formes.length > 0 && (
                                            <div style={{
                                              fontSize: '0.7rem',
                                              color: '#94a3b8',
                                              fontStyle: 'italic'
                                            }}>
                                              {[...new Set(item.formes)].join(', ')}
                                            </div>
                                          )}
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                ))}
                              </div>
                              
                              {/* Boutons ajout */}
                              {addingNoteType === null ? (
                                <div style={{ marginTop: '1.5rem', display: 'flex', gap: '0.75rem' }}>
                                  <button
                                    onClick={() => {
                                      setAddingNoteType('note');
                                      setNewNoteText('');
                                    }}
                                    style={{
                                      flex: 1,
                                      padding: '0.75rem',
                                      background: '#fef3c7',
                                      border: '2px solid #fbbf24',
                                      borderRadius: '10px',
                                      color: '#854d0e',
                                      cursor: 'pointer',
                                      fontWeight: 600,
                                      fontSize: '0.9rem'
                                    }}
                                  >
                                    + Ajouter une note
                                  </button>
                                  <button
                                    onClick={() => {
                                      setAddingNoteType('conseil');
                                      setNewNoteText('');
                                    }}
                                    style={{
                                      flex: 1,
                                      padding: '0.75rem',
                                      background: '#dbeafe',
                                      border: '2px solid #3b82f6',
                                      borderRadius: '10px',
                                      color: '#1e40af',
                                      cursor: 'pointer',
                                      fontWeight: 600,
                                      fontSize: '0.9rem'
                                    }}
                                  >
                                    + Ajouter un conseil
                                  </button>
                                </div>
                              ) : (
                                <div style={{ marginTop: '1.5rem', padding: '1rem', background: addingNoteType === 'note' ? '#fefce8' : '#eff6ff', borderRadius: '12px', border: `2px solid ${addingNoteType === 'note' ? '#fbbf24' : '#3b82f6'}` }}>
                                  <div style={{ fontSize: '0.85rem', fontWeight: 700, color: addingNoteType === 'note' ? '#854d0e' : '#1e40af', marginBottom: '0.5rem' }}>
                                    {addingNoteType === 'note' ? 'Nouvelle note' : 'Nouveau conseil'}
                                  </div>
                                  <textarea
                                    value={newNoteText}
                                    onChange={(e) => setNewNoteText(e.target.value)}
                                    placeholder="Tapez votre texte ici..."
                                    style={{
                                      width: '100%',
                                      minHeight: '80px',
                                      padding: '0.75rem',
                                      background: 'white',
                                      border: 'none',
                                      borderRadius: '8px',
                                      fontSize: '0.9rem',
                                      color: '#1e293b',
                                      resize: 'vertical',
                                      fontFamily: 'inherit'
                                    }}
                                    autoFocus
                                  />
                                  <div style={{ display: 'flex', gap: '0.5rem', marginTop: '0.75rem' }}>
                                    <button
                                      onClick={() => {
                                        if (newNoteText.trim()) {
                                          createStandaloneNoteConseil(med.commercial[0], med.dci, addingNoteType, newNoteText, images);
                                          setRefreshKey(prev => prev + 1);
                                          setAddingNoteType(null);
                                          setNewNoteText('');
                                        }
                                      }}
                                      style={{
                                        flex: 1,
                                        padding: '0.75rem',
                                        background: '#10B981',
                                        border: 'none',
                                        borderRadius: '8px',
                                        color: 'white',
                                        cursor: 'pointer',
                                        fontWeight: 600,
                                        fontSize: '0.9rem'
                                      }}
                                    >
                                      ‚úì Enregistrer
                                    </button>
                                    <button
                                      onClick={() => {
                                        setAddingNoteType(null);
                                        setNewNoteText('');
                                      }}
                                      style={{
                                        flex: 1,
                                        padding: '0.75rem',
                                        background: '#64748b',
                                        border: 'none',
                                        borderRadius: '8px',
                                        color: 'white',
                                        cursor: 'pointer',
                                        fontWeight: 600,
                                        fontSize: '0.9rem'
                                      }}
                                    >
                                      ‚úï Annuler
                                    </button>
                                  </div>
                                </div>
                              )}
                            </>
                          );
                        })()}
                      </div>
                    </div>
                  )}

                  <button onClick={() => setMode('menu')} className="button-hover" style={{ width: '100%', marginTop: '1rem', padding: '1rem', background: '#e2e8f0', border: 'none', borderRadius: '12px', color: '#1e293b', cursor: 'pointer', fontWeight: 600 }}>
                    Menu
                  </button>
                </div>
              )}
            </div>
          )}


          {/* MODAL IMAGE AGRANDIE */}
          {imageModalUrl && (
            <div 
              onClick={() => setImageModalUrl(null)} 
              style={{ 
                position: 'fixed', 
                top: 0, 
                left: 0, 
                right: 0, 
                bottom: 0, 
                background: 'rgba(0, 0, 0, 0.7)', 
                backdropFilter: 'blur(8px)',
                zIndex: 9999, 
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'center', 
                padding: '2rem',
                cursor: 'pointer'
              }}
            >
              <div 
                style={{ 
                  background: 'white', 
                  borderRadius: '16px', 
                  padding: '1.5rem',
                  boxShadow: '0 25px 80px rgba(0, 0, 0, 0.3)',
                  maxWidth: '90%',
                  maxHeight: '90%',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}
                onClick={(e) => e.stopPropagation()}
              >
                <img 
                  src={imageModalUrl} 
                  alt="Image agrandie" 
                  style={{ 
                    maxWidth: '100%', 
                    maxHeight: '80vh', 
                    objectFit: 'contain', 
                    borderRadius: '8px'
                  }} 
                />


              </div>
            </div>
          )}

          {/* MODE QUIZ */}

          
          {/* MODAL GESTION DES DONN√âES */}
          {showDataManagement && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', zIndex: 2000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '1rem' }} onClick={() => setShowDataManagement(false)}>
              <div onClick={(e) => e.stopPropagation()} style={{ background: 'white', borderRadius: '20px', padding: '2rem', maxWidth: '500px', width: '100%' }}>
                <h2 style={{ fontSize: '1.5rem', marginBottom: '1.5rem', color: '#1e293b', display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#3B82F6" strokeWidth="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/>
                    <polyline points="7 3 7 8 15 8"/>
                  </svg>
                  Gestion des donn√©es
                </h2>

                <div style={{ display: 'grid', gap: '0.75rem', marginBottom: '1.5rem' }}>
                  {/* SECTION FIREBASE - D√©plac√©e en premier */}
                  <div style={{ padding: '1.5rem', background: 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)', borderRadius: '12px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '1rem' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                        <span style={{ fontSize: '1.5rem' }}>üî•</span>
                        <div>
                          <div style={{ fontWeight: 700, fontSize: '1.1rem', color: 'white' }}>Firebase Sync</div>
                          <div style={{ fontSize: '0.85rem', color: 'rgba(255,255,255,0.9)' }}>Synchronisation temps r√©el</div>
                        </div>
                      </div>
                      <div style={{ 
                        padding: '0.5rem 1rem', 
                        background: 'rgba(255,255,255,0.2)', 
                        borderRadius: '8px',
                        fontSize: '0.9rem',
                        fontWeight: 600,
                        color: 'white'
                      }}>
                        {firebaseStatus}
                      </div>
                    </div>
                    
                    {isOnline ? (
                      <div style={{ fontSize: '0.85rem', color: 'rgba(255,255,255,0.95)', lineHeight: '1.4' }}>
                        ‚úÖ <strong>Connect√© !</strong> Toutes vos modifications sont automatiquement synchronis√©es sur tous vos appareils en temps r√©el.
                      </div>
                    ) : (
                      <div style={{ fontSize: '0.85rem', color: 'rgba(255,255,255,0.95)', lineHeight: '1.4' }}>
                        ‚ö†Ô∏è <strong>Mode lecture seule.</strong> La modification des donn√©es n√©cessite une connexion Internet.
                      </div>
                    )}
                  </div>
                  
                  {/* EXPORT */}
                  <button onClick={() => { exportData(); setShowDataManagement(false); }} className="button-hover" style={{ padding: '1rem', background: '#10B981', border: 'none', borderRadius: '12px', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '1rem', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.75rem' }}>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7 10 12 15 17 10"/>
                      <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Exporter mes donn√©es
                  </button>
                  
                  {/* IMPORT */}
                  <label style={{ padding: '1rem', background: '#3B82F6', border: 'none', borderRadius: '12px', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '1rem', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.75rem', transition: 'all 0.3s' }} className="button-hover">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="17 8 12 3 7 8"/>
                      <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Importer des donn√©es
                    <input type="file" accept=".json" onChange={(e) => { 
                      if (confirm('‚ö†Ô∏è ATTENTION\n\nEn important ce fichier, vous allez :\n‚Ä¢ √âcraser TOUTES vos donn√©es actuelles\n‚Ä¢ Remplacer Firebase par ce fichier\n‚Ä¢ Synchroniser le changement sur tous vos appareils\n\nVoulez-vous vraiment continuer ?')) {
                        importData(e); 
                        setShowDataManagement(false);
                      } else {
                        e.target.value = ''; // Reset input
                      }
                    }} style={{ display: 'none' }} />
                  </label>
                  
                  {/* RESET */}
                  <button onClick={() => { 
                    const confirmation = prompt('üö® R√âINITIALISATION TOTALE\n\nVous √™tes sur le point de :\n‚Ä¢ Supprimer TOUS vos m√©dicaments\n‚Ä¢ Supprimer TOUTES vos plaintes conseils\n‚Ä¢ Revenir aux donn√©es par d√©faut\n‚Ä¢ Synchroniser sur tous vos appareils\n\nCette action est IRR√âVERSIBLE !\n\nTapez "SUPPRIMER" pour confirmer :');
                    if (confirmation === 'SUPPRIMER') {
                      resetToDefault(); 
                      setShowDataManagement(false);
                    }
                  }} className="button-hover" style={{ padding: '1rem', background: '#EF4444', border: 'none', borderRadius: '12px', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '1rem', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.75rem' }}>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <polyline points="1 4 1 10 7 10"/>
                      <polyline points="23 20 23 14 17 14"/>
                      <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                    </svg>
                    R√©initialiser tout
                  </button>
                </div>

                {/* INFO BACKUP */}
                <div style={{ padding: '1rem', background: '#DBEAFE', borderRadius: '10px', fontSize: '0.85rem', color: '#1e40af', lineHeight: '1.5', marginBottom: '1.5rem' }}>
                  <strong>üí° Backup de s√©curit√© :</strong> Avec Firebase, vos donn√©es sont automatiquement synchronis√©es. L'export sert uniquement de sauvegarde locale en cas de besoin.
                </div>

                <button onClick={() => setShowDataManagement(false)} className="button-hover" style={{ width: '100%', padding: '1rem', background: '#e2e8f0', border: 'none', borderRadius: '12px', color: '#1e293b', cursor: 'pointer', fontWeight: 600, fontSize: '1rem' }}>
                  Fermer
                </button>
              </div>
            </div>
          )}

          {/* MODAL GUIDE IMGUR */}
          {showImgurGuide && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.7)', zIndex: 3000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '1rem' }} onClick={() => setShowImgurGuide(false)}>
              <div onClick={(e) => e.stopPropagation()} style={{ background: 'white', borderRadius: '20px', padding: '2rem', maxWidth: '600px', width: '100%', maxHeight: '90vh', overflowY: 'auto' }}>
                <h2 style={{ fontSize: '1.5rem', marginBottom: '1.5rem', color: '#1e293b', display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#3B82F6" strokeWidth="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                  </svg>
                  Comment obtenir une URL d'image ?
                </h2>
                
                <div style={{ marginBottom: '1.5rem' }}>
                  <h3 style={{ fontSize: '1.1rem', color: '#3B82F6', marginBottom: '0.75rem', fontWeight: 700 }}>
                    üåê M√©thode 1 : Imgur (Recommand√©)
                  </h3>
                  
                  <div style={{ background: '#F0F9FF', padding: '1rem', borderRadius: '12px', marginBottom: '1rem' }}>
                    <div style={{ fontSize: '0.9rem', lineHeight: '1.6', color: '#1e293b' }}>
                      <strong style={{ color: '#3B82F6' }}>√âtape 1 :</strong> Allez sur <a href="https://imgur.com/upload" target="_blank" style={{ color: '#3B82F6', fontWeight: 600 }}>imgur.com/upload</a>
                    </div>
                  </div>
                  
                  <div style={{ background: '#F0F9FF', padding: '1rem', borderRadius: '12px', marginBottom: '1rem' }}>
                    <div style={{ fontSize: '0.9rem', lineHeight: '1.6', color: '#1e293b' }}>
                      <strong style={{ color: '#3B82F6' }}>√âtape 2 :</strong> Cliquez sur "New post" ou glissez votre image
                    </div>
                  </div>
                  
                  <div style={{ background: '#F0F9FF', padding: '1rem', borderRadius: '12px', marginBottom: '1rem' }}>
                    <div style={{ fontSize: '0.9rem', lineHeight: '1.6', color: '#1e293b' }}>
                      <strong style={{ color: '#3B82F6' }}>√âtape 3 :</strong> Une fois upload√©e, faites <strong>clic droit</strong> sur l'image ‚Üí "Copier l'adresse de l'image"
                    </div>
                  </div>
                  
                  <div style={{ padding: '1rem', background: '#FEE', borderRadius: '10px', fontSize: '0.85rem', lineHeight: '1.5', marginBottom: '1rem', border: '2px solid #EF4444' }}>
                    <strong style={{ color: '#C00' }}>‚ö†Ô∏è IMPORTANT - Diff√©rence d'URL :</strong><br/><br/>
                    <div style={{ fontFamily: 'monospace', fontSize: '0.8rem' }}>
                      ‚ùå <span style={{ color: '#C00', fontWeight: 'bold' }}>MAUVAISE</span> (URL de la page) :<br/>
                      <code style={{ background: 'white', padding: '0.2rem 0.4rem', borderRadius: '4px' }}>https://imgur.com/abc123</code><br/><br/>
                      
                      ‚úÖ <span style={{ color: '#10B981', fontWeight: 'bold' }}>BONNE</span> (URL directe) :<br/>
                      <code style={{ background: 'white', padding: '0.2rem 0.4rem', borderRadius: '4px' }}>https://i.imgur.com/abc123.jpg</code>
                    </div>
                    <div style={{ marginTop: '0.75rem', fontSize: '0.85rem', color: '#92400E' }}>
                      üí° Notez le <strong>"i."</strong> au d√©but et <strong>".jpg"</strong> √† la fin !
                    </div>
                  </div>
                  
                  <div style={{ background: '#F0F9FF', padding: '1rem', borderRadius: '12px', marginBottom: '1rem' }}>
                    <div style={{ fontSize: '0.9rem', lineHeight: '1.6', color: '#1e293b' }}>
                      <strong style={{ color: '#3B82F6' }}>√âtape 4 :</strong> Collez l'URL dans PharmaSpace !
                    </div>
                  </div>
                  
                  <div style={{ padding: '0.75rem', background: '#DBEAFE', borderRadius: '8px', fontSize: '0.85rem', color: '#1e40af', marginTop: '0.75rem' }}>
                    ‚úÖ L'URL ressemble √† : <code style={{ background: 'white', padding: '0.2rem 0.4rem', borderRadius: '4px', fontFamily: 'monospace' }}>https://i.imgur.com/abc123.jpg</code>
                  </div>
                </div>
                
                <div style={{ marginBottom: '1.5rem' }}>
                  <h3 style={{ fontSize: '1.1rem', color: '#10B981', marginBottom: '0.75rem', fontWeight: 700 }}>
                    üñºÔ∏è M√©thode 2 : Autres services
                  </h3>
                  
                  <div style={{ fontSize: '0.9rem', lineHeight: '1.6', color: '#64748b' }}>
                    ‚Ä¢ <strong>imgbb.com</strong> - Gratuit, sans compte<br/>
                    ‚Ä¢ <strong>Google Photos</strong> - Si vous avez un compte Google<br/>
                    ‚Ä¢ <strong>Cloudinary</strong> - Pour usage avanc√©<br/>
                  </div>
                </div>
                
                <div style={{ padding: '1rem', background: '#FEF3C7', borderRadius: '10px', fontSize: '0.85rem', color: '#92400E', lineHeight: '1.5', marginBottom: '1.5rem' }}>
                  <strong>üí° Astuce :</strong> Avec des URLs, vous pouvez avoir <strong>272 images</strong> sans limite de stockage ! Une seule image est charg√©e √† la fois depuis internet.
                </div>
                
                <div style={{ padding: '1rem', background: '#FEE', borderRadius: '10px', fontSize: '0.85rem', color: '#C00', lineHeight: '1.5', marginBottom: '1.5rem' }}>
                  <strong>‚ö†Ô∏è Important :</strong> Vous aurez besoin d'une connexion internet pour voir les images. Les images upload√©es via "üìÅ Fichier" fonctionnent hors ligne.
                </div>
                
                <button onClick={() => setShowImgurGuide(false)} className="button-hover" style={{ width: '100%', padding: '1rem', background: '#3B82F6', border: 'none', borderRadius: '12px', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '1rem' }}>
                  J'ai compris !
                </button>
              </div>
            </div>
          )}

          {/* MODAL SETTINGS */}
          {showSettings && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', zIndex: 1000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '1rem' }} onClick={() => { setShowSettings(false); setSelectionMode('all'); }}>
              <div onClick={(e) => e.stopPropagation()} style={{ background: 'white', borderRadius: '20px', padding: '2rem', maxWidth: '600px', width: '100%', maxHeight: '90vh', overflowY: 'auto' }}>
                <h2 style={{ fontSize: '1.5rem', marginBottom: '1.5rem', color: '#1e293b' }}>
                  S√©lection
                </h2>
                
                <div style={{ marginBottom: '1.5rem' }}>
                  
                  <div style={{ marginBottom: '1rem' }}>
                    <label style={{ display: 'flex', alignItems: 'center', padding: '1rem', background: selectionMode === 'all' ? '#EFF6FF' : 'white', border: `2px solid ${selectionMode === 'all' ? '#3B82F6' : '#e2e8f0'}`, borderRadius: '12px', cursor: 'pointer', marginBottom: '0.5rem' }}>
                      <input type="radio" name="mode" value="all" checked={selectionMode === 'all'} onChange={(e) => setSelectionMode(e.target.value)} style={{ marginRight: '0.75rem' }} />
                      <span style={{ fontWeight: 600, color: '#1e293b' }}>
                        Tous les m√©dicaments ({medications.length})
                      </span>
                    </label>
                    
                    <label style={{ display: 'flex', alignItems: 'center', padding: '1rem', background: selectionMode === 'class' ? '#EFF6FF' : 'white', border: `2px solid ${selectionMode === 'class' ? '#3B82F6' : '#e2e8f0'}`, borderRadius: '12px', cursor: 'pointer', marginBottom: '0.5rem' }}>
                      <input type="radio" name="mode" value="class" checked={selectionMode === 'class'} onChange={(e) => setSelectionMode(e.target.value)} style={{ marginRight: '0.75rem' }} />
                      <span style={{ fontWeight: 600, color: '#1e293b' }}>S√©lection par classe</span>
                    </label>
                    
                    <label style={{ display: 'flex', alignItems: 'center', padding: '1rem', background: selectionMode === 'custom' ? '#EFF6FF' : 'white', border: `2px solid ${selectionMode === 'custom' ? '#3B82F6' : '#e2e8f0'}`, borderRadius: '12px', cursor: 'pointer' }}>
                      <input type="radio" name="mode" value="custom" checked={selectionMode === 'custom'} onChange={(e) => setSelectionMode(e.target.value)} style={{ marginRight: '0.75rem' }} />
                      <span style={{ fontWeight: 600, color: '#1e293b' }}>S√©lection personnalis√©e</span>
                    </label>
                  </div>

                  {selectionMode === 'class' && (
                    <div style={{ padding: '1rem', background: '#f8fafc', borderRadius: '12px', border: '2px solid #e2e8f0' }}>
                      <div style={{ fontSize: '0.85rem', color: '#64748b', marginBottom: '0.75rem', fontWeight: 600 }}>Classes th√©rapeutiques :</div>
                      <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                        {getCategories().map(cat => {
                          const count = medications.filter(m => m.category === cat).length;
                          const isSelected = selectedClasses.includes(cat);
                          return (
                            <button 
                              key={cat}
                              onClick={() => setSelectedClasses(
                                isSelected 
                                  ? selectedClasses.filter(c => c !== cat) 
                                  : [...selectedClasses, cat]
                              )}
                              style={{ 
                                padding: '0.5rem 1rem', 
                                background: isSelected ? getClassColor(cat) : 'white', 
                                border: `2px solid ${getClassColor(cat)}`, 
                                borderRadius: '8px', 
                                color: isSelected ? 'white' : getClassColor(cat), 
                                cursor: 'pointer', 
                                fontWeight: 600, 
                                fontSize: '0.85rem',
                                transition: 'all 0.2s'
                              }}
                            >
                              {cat} ({count})
                            </button>
                          );
                        })}
                      </div>
                    </div>
                  )}
                  
                  {selectionMode === 'custom' && mode === 'flashcard' && (
                    <div style={{ padding: '1rem', background: '#f8fafc', borderRadius: '12px', border: '2px solid #e2e8f0', maxHeight: '300px', overflowY: 'auto' }}>
                      <div style={{ fontSize: '0.85rem', color: '#64748b', marginBottom: '0.75rem', fontWeight: 600 }}>
                        S√©lectionnez les m√©dicaments ({selectedMeds.length} s√©lectionn√©{selectedMeds.length > 1 ? 's' : ''}) :
                      </div>
                      {medications.map((med, idx) => {
                        const isSelected = selectedMeds.includes(idx);
                        return (
                          <label 
                            key={idx} 
                            style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              padding: '0.75rem', 
                              background: isSelected ? `${getClassColor(med.category)}20` : 'white', 
                              border: `2px solid ${isSelected ? getClassColor(med.category) : '#e2e8f0'}`,
                              borderRadius: '8px', 
                              marginBottom: '0.5rem', 
                              cursor: 'pointer',
                              transition: 'all 0.2s'
                            }}
                          >
                            <input 
                              type="checkbox" 
                              checked={isSelected}
                              onChange={() => setSelectedMeds(
                                isSelected 
                                  ? selectedMeds.filter(i => i !== idx)
                                  : [...selectedMeds, idx]
                              )}
                              style={{ marginRight: '0.75rem', width: '18px', height: '18px', cursor: 'pointer' }}
                            />
                            <div style={{ flex: 1 }}>
                              <div style={{ fontWeight: 600, color: '#1e293b', fontSize: '0.9rem' }}>{med.commercial.join(' ‚Ä¢ ')}</div>
                              <div style={{ fontSize: '0.8rem', color: '#64748b' }}>{med.dci}</div>
                            </div>
                            
                          </label>
                        );
                      })}
                    </div>
                  )}
                </div>

                <div style={{ display: 'flex', gap: '1rem' }}>
                  <button onClick={() => { setShowSettings(false); setSelectionMode('all'); }} className="button-hover" style={{ flex: 1, padding: '1rem', background: '#e2e8f0', border: 'none', borderRadius: '12px', color: '#1e293b', cursor: 'pointer', fontWeight: 600 }}>
                    Annuler
                  </button>
                  <button onClick={applySelection} className="button-hover" style={{ flex: 1, padding: '1rem', background: '#334155', border: 'none', borderRadius: '12px', color: 'white', cursor: 'pointer', fontWeight: 600 }}>
                    'Appliquer'
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* MODAL GESTION */}
          {showManagement && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', zIndex: 1000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '1rem' }} onClick={() => { setShowManagement(false); cancelEdit(); setErrorMessage(''); setShowClassManager(false); setEditingClass(null); }}>
              <div onClick={(e) => e.stopPropagation()} style={{ background: 'white', borderRadius: '20px', padding: '2rem', maxWidth: '700px', width: '100%', maxHeight: '90vh', overflowY: 'auto' }}>
                <h2 style={{ fontSize: '1.5rem', marginBottom: '1.5rem', color: '#1e293b' }}>Gestion des cartes</h2>

                <div style={{ marginBottom: '1rem' }}>
                  <input type="text" placeholder="üîç Rechercher un m√©dicament..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} style={{ width: '100%', padding: '0.75rem', border: '2px solid #3B82F6', borderRadius: '8px', fontSize: '0.9rem', outline: 'none' }} />
                </div>

                {errorMessage && (
                  <div style={{ padding: '1rem', background: '#FEE2E2', border: '2px solid #DC2626', borderRadius: '8px', color: '#991B1B', marginBottom: '1rem', fontSize: '0.9rem' }}>
                    {errorMessage}
                  </div>
                )}

                <div style={{ padding: '1.5rem', background: editingIndex !== null ? '#FEF3C7' : '#f8fafc', borderRadius: '12px', marginBottom: '1.5rem', border: editingIndex !== null ? '2px solid #F59E0B' : 'none' }}>
                  <h3 style={{ fontSize: '1rem', marginBottom: '1rem', color: '#1e293b' }}>
                    {editingIndex !== null ? '‚úèÔ∏è Modifier' : '‚ûï Ajouter'}
                  </h3>
                  
                  <input type="text" placeholder="DCI *" value={customMed.dci} onChange={(e) => setCustomMed({...customMed, dci: e.target.value})} style={{ width: '100%', padding: '0.75rem', border: '2px solid #e2e8f0', borderRadius: '8px', marginBottom: '0.75rem', fontSize: '0.9rem' }} />
                  
                  <input type="text" placeholder="Nom(s) commercial(aux) s√©par√©s par des virgules *" value={customMed.commercial} onChange={(e) => setCustomMed({...customMed, commercial: e.target.value})} style={{ width: '100%', padding: '0.75rem', border: '2px solid #e2e8f0', borderRadius: '8px', marginBottom: '0.75rem', fontSize: '0.9rem' }} />
                  
                  <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.75rem' }}>
                    <select value={customMed.category} onChange={(e) => setCustomMed({...customMed, category: e.target.value})} style={{ flex: 1, padding: '0.75rem', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '0.9rem', cursor: 'pointer' }}>
                      <option value="">-- S√©lectionner --</option>
                      {getCategories().map(cat => (
                        <option key={cat} value={cat}>{cat}</option>
                      ))}
                    </select>
                    <button onClick={() => setShowClassManager(!showClassManager)} className="button-hover" style={{ padding: '0.75rem', background: showClassManager ? '#3B82F6' : '#e2e8f0', border: 'none', borderRadius: '8px', color: showClassManager ? 'white' : '#64748b', cursor: 'pointer', fontWeight: 600, fontSize: '0.85rem' }}>
                      Modifier
                    </button>
                  </div>
                  
                  {showClassManager && (
                    <div style={{ padding: '1rem', background: 'white', borderRadius: '8px', marginBottom: '0.75rem', border: '2px solid #3B82F6' }}>
                      <div style={{ fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem', color: '#1e293b' }}>Ajouter une nouvelle classe</div>
                      <input type="text" placeholder="Nom de la classe" value={newClassName} onChange={(e) => setNewClassName(e.target.value)} style={{ width: '100%', padding: '0.5rem', border: '2px solid #e2e8f0', borderRadius: '6px', marginBottom: '0.5rem', fontSize: '0.85rem' }} />
                      <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem' }}>
                        <input type="color" value={newClassColor} onChange={(e) => setNewClassColor(e.target.value)} style={{ width: '40px', height: '40px', border: 'none', borderRadius: '6px', cursor: 'pointer' }} />
                        <div style={{ flex: 1, padding: '0.5rem', background: newClassColor, borderRadius: '6px', color: 'white', textAlign: 'center', fontWeight: 600, fontSize: '0.85rem' }}>
                          Aper√ßu
                        </div>
                      </div>
                      <button onClick={addNewClass} className="button-hover" style={{ width: '100%', padding: '0.5rem', background: '#10B981', border: 'none', borderRadius: '6px', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '0.85rem' }}>
                        Ajouter
                      </button>
                      
                      <div style={{ marginTop: '1rem', paddingTop: '1rem', borderTop: '1px solid #e2e8f0' }}>
                        <div style={{ fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem', color: '#1e293b' }}>G√©rer les classes existantes</div>
                        {Object.entries(therapeuticClasses).map(([className, color]) => {
                          const isEditing = editingClass === className;
                          const medsInClass = medications.filter(m => m.category === className).length;
                          return (
                            <div key={className} style={{ padding: '0.5rem', background: isEditing ? '#FEF3C7' : '#f8fafc', borderRadius: '6px', marginBottom: '0.5rem', border: isEditing ? '2px solid #F59E0B' : '1px solid #e2e8f0' }}>
                              {isEditing ? (
                                <div>
                                  <input type="text" defaultValue={className} id={`edit-${className}`} style={{ width: '100%', padding: '0.4rem', border: '1px solid #e2e8f0', borderRadius: '4px', marginBottom: '0.3rem', fontSize: '0.8rem' }} />
                                  <div style={{ display: 'flex', gap: '0.3rem', marginBottom: '0.3rem' }}>
                                    <input type="color" defaultValue={color} id={`color-${className}`} style={{ width: '30px', height: '30px', border: 'none', borderRadius: '4px' }} />
                                    <div style={{ flex: 1, padding: '0.3rem', background: color, borderRadius: '4px', color: 'white', textAlign: 'center', fontSize: '0.75rem', fontWeight: '600' }}>
                                      Aper√ßu
                                    </div>
                                  </div>
                                  <div style={{ display: 'flex', gap: '0.3rem' }}>
                                    <button onClick={() => { const newName = document.getElementById(`edit-${className}`).value; const newColor = document.getElementById(`color-${className}`).value; updateClass(className, newName, newColor); }} className="button-hover" style={{ flex: 1, padding: '0.4rem', background: '#10B981', border: 'none', borderRadius: '4px', color: 'white', cursor: 'pointer', fontSize: '0.75rem', fontWeight: 600 }}>
                                      Valider
                                    </button>
                                    <button onClick={() => setEditingClass(null)} className="button-hover" style={{ flex: 1, padding: '0.4rem', background: '#e2e8f0', border: 'none', borderRadius: '4px', color: '#64748b', cursor: 'pointer', fontSize: '0.75rem', fontWeight: 600 }}>
                                      Annuler
                                    </button>
                                  </div>
                                </div>
                              ) : (
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                  <div style={{ width: '20px', height: '20px', background: color, borderRadius: '4px' }} />
                                  <span style={{ flex: 1, fontSize: '0.85rem', fontWeight: 600, color: '#1e293b' }}>{className} ({medsInClass})</span>
                                  <button onClick={() => setEditingClass(className)} className="button-hover" style={{ padding: '0.3rem', background: '#DBEAFE', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                                    <Edit size={12} color="#1E40AF" />
                                  </button>
                                  <button type="button" onClick={() => {
                                    console.log('className:', className);
                                    const medsCount = medications.filter(m => m.category === className).length;
                                    console.log('Nombre de m√©dicaments avec cette classe:', medsCount);
                                    if (medsCount > 0) {
                                      const updatedMeds = medications.map(med => 
                                        med.category === className ? {...med, category: 'Non attribu√©e'} : med
                                      );
                                      saveMedications(updatedMeds);
                                      if (!therapeuticClasses['Non attribu√©e']) {
                                        saveClasses({...therapeuticClasses, 'Non attribu√©e': '#9CA3AF'});
                                      }
                                    }
                                    console.log('Suppression directe');
                                    const updated = {...therapeuticClasses};
                                    delete updated[className];
                                    console.log('Nouveau dictionnaire de classes:', updated);
                                    saveClasses(updated);
                                    console.log('Suppression classe termin√©e');
                                  }} className="button-hover" style={{ padding: '0.3rem', background: '#FEE2E2', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                                    <Trash2 size={12} color="#DC2626" />
                                  </button>
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                  
                  <div style={{ marginBottom: '1rem' }}>
                    <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.85rem', fontWeight: 600, color: '#64748b' }}>
                      üì∏ URLs des images (optionnel)
                    </label>
                    <textarea 
                      placeholder="Une URL par ligne&#10;https://example.com/image1.jpg&#10;https://example.com/image2.jpg"
                      value={customMed.imageUrls}
                      onChange={(e) => setCustomMed({...customMed, imageUrls: e.target.value})}
                      style={{ width: '100%', padding: '0.75rem', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '0.9rem', minHeight: '80px', fontFamily: 'monospace' }}
                    />
                    {customMed.imageUrls && customMed.imageUrls.split('\n').filter(s => s.trim()).length > 0 && (
                      <div style={{ marginTop: '0.5rem', padding: '0.75rem', background: '#F0F9FF', borderRadius: '8px', border: '2px solid #3B82F6' }}>
                        <div style={{ fontSize: '0.75rem', color: '#64748b', marginBottom: '0.5rem', fontWeight: 600 }}>
                          üì∏ Aper√ßu ({customMed.imageUrls.split('\n').filter(s => s.trim()).length} image(s))
                        </div>
                        <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                          {customMed.imageUrls.split('\n').filter(s => s.trim()).map((url, idx) => (
                            <img 
                              key={idx}
                              src={url.trim()} 
                              alt={`Aper√ßu ${idx+1}`}
                              style={{ maxWidth: '80px', maxHeight: '80px', objectFit: 'contain', borderRadius: '4px', background: 'white', border: '1px solid #e2e8f0' }}
                              onError={(e) => { e.target.style.border = '2px solid #EF4444'; }}
                            />
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                  
                  <div style={{ marginBottom: '1rem' }}>
                    <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.85rem', fontWeight: 600, color: '#64748b' }}>
                      üíä Forme(s) pharmaceutique(s) (optionnel)
                    </label>
                    
                    {/* FORMES S√âLECTIONN√âES DANS L'ORDRE */}
                    {customMed.pharmaceuticalForm && (
                      <div style={{ marginBottom: '0.75rem', padding: '0.75rem', background: '#f8fafc', borderRadius: '8px', border: '2px solid #3B82F6' }}>
                        <div style={{ fontSize: '0.75rem', fontWeight: 600, color: '#64748b', marginBottom: '0.5rem' }}>
                          Formes s√©lectionn√©es (ordre = ordre des images):
                        </div>
                        <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap', alignItems: 'center' }}>
                          {customMed.pharmaceuticalForm.split(',').map((form, idx) => (
                            <div key={idx} style={{ display: 'flex', alignItems: 'center', gap: '0.25rem', padding: '0.5rem 0.75rem', background: '#3B82F6', color: 'white', borderRadius: '8px', fontSize: '0.85rem', fontWeight: 600 }}>
                              <span style={{ fontSize: '0.7rem', opacity: 0.8 }}>#{idx + 1}</span>
                              <span>{form.trim()}</span>
                              <button
                                type="button"
                                onClick={() => {
                                  const forms = customMed.pharmaceuticalForm.split(',').map(f => f.trim());
                                  forms.splice(idx, 1);
                                  setCustomMed({...customMed, pharmaceuticalForm: forms.join(', ')});
                                }}
                                style={{ marginLeft: '0.25rem', background: 'transparent', border: 'none', color: 'white', cursor: 'pointer', padding: '0.1rem', lineHeight: 1 }}
                              >
                                ‚úï
                              </button>
                            </div>
                          ))}
                          <button
                            type="button"
                            onClick={() => setCustomMed({...customMed, pharmaceuticalForm: ''})}
                            className="button-hover"
                            style={{ padding: '0.5rem 0.75rem', background: '#FEE2E2', border: 'none', borderRadius: '8px', color: '#DC2626', cursor: 'pointer', fontSize: '0.75rem', fontWeight: 600 }}
                          >
                            Tout effacer
                          </button>
                        </div>
                      </div>
                    )}
                    
                    {/* DROPDOWN COMPACT POUR AJOUTER DES FORMES */}
                    <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.75rem' }}>
                      <select
                        value=""
                        onChange={(e) => {
                          if (e.target.value) {
                            const currentForms = customMed.pharmaceuticalForm ? customMed.pharmaceuticalForm.split(',').map(f => f.trim()) : [];
                            currentForms.push(e.target.value);
                            setCustomMed({...customMed, pharmaceuticalForm: currentForms.join(', ')});
                            e.target.value = ''; // Reset
                          }
                        }}
                        style={{ 
                          flex: 1, 
                          padding: '0.75rem', 
                          border: '2px solid #e2e8f0', 
                          borderRadius: '8px', 
                          fontSize: '0.9rem',
                          cursor: 'pointer',
                          background: 'white'
                        }}
                      >
                        <option value="">‚ûï Ajouter une forme...</option>
                        {pharmaceuticalForms.sort().map(form => {
                          const isSelected = customMed.pharmaceuticalForm && customMed.pharmaceuticalForm.split(',').map(f => f.trim()).includes(form);
                          return (
                            <option key={form} value={form}>
                              {isSelected ? '‚úì ' : ''}{form}
                            </option>
                          );
                        })}
                      </select>
                      <button 
                        onClick={() => setShowFormManager(!showFormManager)} 
                        className="button-hover" 
                        style={{ 
                          padding: '0.75rem', 
                          background: showFormManager ? '#3B82F6' : '#e2e8f0', 
                          border: 'none', 
                          borderRadius: '8px', 
                          color: showFormManager ? 'white' : '#64748b', 
                          cursor: 'pointer', 
                          fontWeight: 600, 
                          fontSize: '0.85rem' 
                        }}
                      >
                        G√©rer
                      </button>
                    </div>
                    <div style={{ fontSize: '0.75rem', color: '#64748b', fontStyle: 'italic' }}>
                      üí° S√©lectionnez les formes dans l'ordre de vos images. #1 = 1√®re image, #2 = 2√®me image, etc.
                    </div>
                    
                    {showFormManager && (
                      <div style={{ padding: '1rem', background: 'white', borderRadius: '8px', marginTop: '0.75rem', border: '2px solid #3B82F6' }}>
                        <div style={{ fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem', color: '#1e293b' }}>Ajouter une nouvelle forme</div>
                        <input 
                          type="text" 
                          placeholder="Nom de la forme" 
                          value={newFormName} 
                          onChange={(e) => setNewFormName(e.target.value)} 
                          style={{ width: '100%', padding: '0.5rem', border: '2px solid #e2e8f0', borderRadius: '6px', marginBottom: '0.5rem', fontSize: '0.85rem' }} 
                        />
                        <button 
                          onClick={() => {
                            if (!newFormName.trim()) {
                              alert('Le nom de la forme est obligatoire');
                              return;
                            }
                            if (pharmaceuticalForms.includes(newFormName.trim())) {
                              alert('Cette forme existe d√©j√†');
                              return;
                            }
                            saveForms([...pharmaceuticalForms, newFormName.trim()]);
                            setNewFormName('');
                          }} 
                          className="button-hover" 
                          style={{ width: '100%', padding: '0.5rem', background: '#10B981', border: 'none', borderRadius: '6px', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '0.85rem' }}
                        >
                          Ajouter
                        </button>
                        
                        <div style={{ marginTop: '1rem', paddingTop: '1rem', borderTop: '1px solid #e2e8f0' }}>
                          <div style={{ fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem', color: '#1e293b' }}>G√©rer les formes existantes</div>
                          <div style={{ maxHeight: '200px', overflowY: 'auto' }}>
                            {pharmaceuticalForms.sort().map((form) => {
                              const isEditing = editingForm === form;
                              const medsWithForm = medications.filter(m => m.pharmaceuticalForm && m.pharmaceuticalForm.includes(form)).length;
                              return (
                                <div key={form} style={{ padding: '0.5rem', background: isEditing ? '#FEF3C7' : '#f8fafc', borderRadius: '6px', marginBottom: '0.5rem', border: isEditing ? '2px solid #F59E0B' : '1px solid #e2e8f0' }}>
                                  {isEditing ? (
                                    <div>
                                      <input 
                                        type="text" 
                                        defaultValue={form} 
                                        id={`edit-form-${form}`} 
                                        style={{ width: '100%', padding: '0.4rem', border: '1px solid #e2e8f0', borderRadius: '4px', marginBottom: '0.3rem', fontSize: '0.8rem' }} 
                                      />
                                      <div style={{ display: 'flex', gap: '0.3rem' }}>
                                        <button 
                                          onClick={() => {
                                            const newName = document.getElementById(`edit-form-${form}`).value.trim();
                                            if (!newName) {
                                              alert('Le nom ne peut pas √™tre vide');
                                              return;
                                            }
                                            if (newName !== form && pharmaceuticalForms.includes(newName)) {
                                              alert('Cette forme existe d√©j√†');
                                              return;
                                            }
                                            // Mettre √† jour la forme dans les m√©dicaments
                                            const updatedMeds = medications.map(med => {
                                              if (med.pharmaceuticalForm && med.pharmaceuticalForm.includes(form)) {
                                                const forms = med.pharmaceuticalForm.split(',').map(f => f.trim());
                                                const newForms = forms.map(f => f === form ? newName : f);
                                                return {...med, pharmaceuticalForm: newForms.join(', ')};
                                              }
                                              return med;
                                            });
                                            saveMedications(updatedMeds);
                                            // Mettre √† jour la liste des formes
                                            const updatedForms = pharmaceuticalForms.map(f => f === form ? newName : f);
                                            saveForms(updatedForms);
                                            setEditingForm(null);
                                          }} 
                                          className="button-hover" 
                                          style={{ flex: 1, padding: '0.4rem', background: '#10B981', border: 'none', borderRadius: '4px', color: 'white', cursor: 'pointer', fontSize: '0.75rem', fontWeight: 600 }}
                                        >
                                          Valider
                                        </button>
                                        <button 
                                          onClick={() => setEditingForm(null)} 
                                          className="button-hover" 
                                          style={{ flex: 1, padding: '0.4rem', background: '#e2e8f0', border: 'none', borderRadius: '4px', color: '#64748b', cursor: 'pointer', fontSize: '0.75rem', fontWeight: 600 }}
                                        >
                                          Annuler
                                        </button>
                                      </div>
                                    </div>
                                  ) : (
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                      <span style={{ flex: 1, fontSize: '0.85rem', fontWeight: 600, color: '#1e293b' }}>{form} ({medsWithForm})</span>
                                      <button 
                                        onClick={() => setEditingForm(form)} 
                                        className="button-hover" 
                                        style={{ padding: '0.3rem', background: '#DBEAFE', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
                                      >
                                        <Edit size={12} color="#1E40AF" />
                                      </button>
                                      <button 
                                        type="button" 
                                        onClick={() => {
                                          if (medsWithForm > 0 && !confirm(`${medsWithForm} m√©dicament(s) utilisent cette forme. Voulez-vous vraiment la supprimer ?`)) {
                                            return;
                                          }
                                          // Supprimer la forme de tous les m√©dicaments
                                          const updatedMeds = medications.map(med => {
                                            if (med.pharmaceuticalForm && med.pharmaceuticalForm.includes(form)) {
                                              const forms = med.pharmaceuticalForm.split(',').map(f => f.trim()).filter(f => f !== form);
                                              return {...med, pharmaceuticalForm: forms.join(', ')};
                                            }
                                            return med;
                                          });
                                          saveMedications(updatedMeds);
                                          // Supprimer de la liste
                                          saveForms(pharmaceuticalForms.filter(f => f !== form));
                                        }} 
                                        className="button-hover" 
                                        style={{ padding: '0.3rem', background: '#FEE2E2', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
                                      >
                                        <Trash2 size={12} color="#DC2626" />
                                      </button>
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                  
                  <div style={{ display: 'flex', gap: '0.5rem' }}>
                    {editingIndex !== null && (
                      <button onClick={cancelEdit} className="button-hover" style={{ flex: 1, padding: '0.75rem', background: '#e2e8f0', border: 'none', borderRadius: '8px', color: '#64748b', cursor: 'pointer', fontWeight: 600, fontSize: '0.9rem' }}>
                        Annuler
                      </button>
                    )}
                    <button  onClick={saveMedication} className="button-hover" style={{ flex: 1, padding: '0.75rem', background: '#10B981', border: 'none', borderRadius: '8px', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '0.9rem' }}>
                      {editingIndex !== null ? 'Modifier' : 'Ajouter'}
                    </button>
                  </div>
                </div>

                <div style={{ marginBottom: '1rem' }}>
                  <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.75rem' }}>
                    <select value={sortBy} onChange={(e) => setSortBy(e.target.value)} style={{ flex: 1, padding: '0.5rem', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '0.85rem', cursor: 'pointer' }}>
                      <option value="dci">Trier par: DCI</option>
                      <option value="commercial">Trier par: Nom commercial</option>
                      <option value="category">Trier par: Classe</option>
                      <option value="form">Trier par: Forme</option>
                    </select>
                    <select value={filterCategory} onChange={(e) => setFilterCategory(e.target.value)} style={{ flex: 1, padding: '0.5rem', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '0.85rem', cursor: 'pointer' }}>
                      <option value="all">Toutes les classes</option>
                      {getCategories().map(cat => (
                        <option key={cat} value={cat}>{cat}</option>
                      ))}
                    </select>
                  </div>
                </div>

                <div style={{ maxHeight: '300px', overflowY: 'auto', marginBottom: '1rem' }}>
                  {getSortedMedications().map((med, i) => {
                    const originalIndex = medications.indexOf(med);
                    const isEditing = editingIndex === originalIndex;
                    return (
                      <div key={i} style={{ padding: '1rem', background: isEditing ? '#FEF3C7' : 'white', border: `2px solid ${getClassColor(med.category)}`, borderRadius: '8px', marginBottom: '0.5rem', display: 'flex', gap: '1rem', alignItems: 'center' }}>
                        {(() => {
                          const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
                          return images.length > 0 ? (
                            <div style={{ position: 'relative' }}>
                              <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.25rem', width: '50px' }}>
                                {images.map((img, idx) => (
                                  <img 
                                    key={idx}
                                    src={img} 
                                    alt={`${med.dci} ${idx+1}`}
                                    style={{ 
                                      width: images.length === 1 ? '50px' : '24px', 
                                      height: images.length === 1 ? '50px' : '24px', 
                                      objectFit: 'cover', 
                                      borderRadius: '6px', 
                                      border: `2px solid ${getClassColor(med.category)}` 
                                    }} 
                                  />
                                ))}
                              </div>
                              <div style={{ position: 'absolute', bottom: -4, right: -4, width: '20px', height: '20px', background: '#10B981', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                <Camera size={12} color="white" />
                              </div>
                            </div>
                          ) : (
                            <div style={{ width: '50px', height: '50px', background: '#f1f5f9', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#cbd5e1' }}>
                              <ImagePlaceholder />
                            </div>
                          );
                        })()}
                        <div style={{ flex: 1 }}>
                          <div style={{ fontSize: '0.9rem', fontWeight: 700, color: '#1e293b' }}>{med.commercial.join(' ‚Ä¢ ')}</div>
                          <div style={{ fontSize: '0.8rem', color: '#64748b' }}>{med.dci}</div>
                          <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center', marginTop: '0.25rem', flexWrap: 'wrap' }}>
                            <div style={{ display: 'inline-block', padding: '0.2rem 0.5rem', background: `${getClassColor(med.category)}20`, borderRadius: '8px', color: getClassColor(med.category), fontSize: '0.7rem', fontWeight: 600 }}>
                              {med.category}
                            </div>
                            {med.pharmaceuticalForm && (
                              <div style={{ fontSize: '0.7rem', color: '#64748b', fontStyle: 'italic' }}>
                                {[...new Set(med.pharmaceuticalForm.split(',').map(f => f.trim()))].join(', ')}
                              </div>
                            )}
                          </div>
                          
                        </div>
                        <div style={{ display: 'flex', gap: '0.5rem' }}>
                          <button type="button" onClick={() => startEditMedication(originalIndex)} className="button-hover" style={{ padding: '0.5rem', background: isEditing ? '#F59E0B' : '#DBEAFE', border: 'none', borderRadius: '6px', color: isEditing ? 'white' : '#1E40AF', cursor: 'pointer' }}>
                            <Edit size={16} />
                          </button>
                          <button type="button" onClick={() => {
                            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer ${med.commercial.join(', ')} (${med.dci}) ?\n\nCette action est irr√©versible.`)) {
                              return;
                            }
                            console.log('originalIndex:', originalIndex);
                            console.log('med:', med);
                            console.log('medications actuel:', medications);
                            console.log('medications.length:', medications.length);
                            console.log('Suppression confirm√©e');
                            const newMeds = medications.filter((_, idx) => idx !== originalIndex);
                            console.log('Nouveau tableau:', newMeds);
                            console.log('Nouvelle longueur:', newMeds.length);
                            saveMedications(newMeds);
                            if (editingIndex === originalIndex) cancelEdit();
                            console.log('Suppression termin√©e');
                          }} className="button-hover" style={{ padding: '0.5rem', background: '#FEE2E2', border: 'none', borderRadius: '6px', color: '#DC2626', cursor: 'pointer' }}>
                            <Trash2 size={16} />
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>

                <button onClick={() => { setShowManagement(false); cancelEdit(); setErrorMessage(''); setShowClassManager(false); setEditingClass(null); }} className="button-hover" style={{ width: '100%', marginTop: '1rem', padding: '1rem', background: '#e2e8f0', border: 'none', borderRadius: '12px', color: '#1e293b', cursor: 'pointer', fontWeight: 600 }}>
                  Fermer
                </button>
              </div>
            </div>
          )}
          </div>
          
        </>
        ) : (
          <ConseilsOfficine 
            onReturnToMenu={() => setMode('menu')} 
            medications={medications} 
            isOnline={isOnline}
            handleOfflineAction={handleOfflineAction}
          />
        )}
      </div>
    </div>
  );
}


    ReactDOM.createRoot(document.getElementById('root')).render(<PharmaSpace />);
  </script>
</body>
</html>