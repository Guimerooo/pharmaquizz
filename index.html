<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PharmaSpace</title>
  <style>
    * {showAnswer &&  margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    </style>
</head>
<body>
  <div id="root"></div>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    // ========== CODE CONSEILS OFFICINE ==========

    const INITIAL_CATEGORIES = [
      "Syst√®me respiratoire",
      "Douleurs & Fi√®vre",
      "Syst√®me digestif",
      "Bouche & Peau"
    ];

    const INITIAL_PLAINTES = [
      { id: "rhume", nom: "Rhume", categorie: "Syst√®me respiratoire", emoji: "ü§ß", couleur: "#3B82F6", description: "√âcoulement nasal, congestion", specialites: [], informations: "", documents: [] },
      { id: "toux", nom: "Toux", categorie: "Syst√®me respiratoire", emoji: "üò∑", couleur: "#06B6D4", description: "Toux s√®che ou grasse", specialites: [], informations: "", documents: [] },
      { id: "gorge", nom: "Maux de gorge", categorie: "Syst√®me respiratoire", emoji: "ü§í", couleur: "#0EA5E9", description: "Irritation, douleur", specialites: [], informations: "", documents: [] },
      { id: "tete", nom: "Maux de t√™te", categorie: "Douleurs & Fi√®vre", emoji: "ü§ï", couleur: "#EF4444", description: "C√©phal√©es, migraines", specialites: [], informations: "", documents: [] },
      { id: "fievre", nom: "Fi√®vre", categorie: "Douleurs & Fi√®vre", emoji: "üå°Ô∏è", couleur: "#F97316", description: "Temp√©rature > 38¬∞C", specialites: [], informations: "", documents: [] },
      { id: "nausees", nom: "Naus√©es", categorie: "Syst√®me digestif", emoji: "ü§¢", couleur: "#10B981", description: "Envie de vomir", specialites: [], informations: "", documents: [] },
      { id: "estomac", nom: "Br√ªlures d'estomac", categorie: "Syst√®me digestif", emoji: "üî•", couleur: "#F59E0B", description: "Reflux gastrique", specialites: [], informations: "", documents: [] },
      { id: "constipation", nom: "Constipation", categorie: "Syst√®me digestif", emoji: "üí©", couleur: "#84CC16", description: "Difficult√© √† aller √† la selle", specialites: [], informations: "", documents: [] },
      { id: "diarrhee", nom: "Diarrh√©e", categorie: "Syst√®me digestif", emoji: "üöΩ", couleur: "#14B8A6", description: "Selles liquides", specialites: [], informations: "", documents: [] },
      { id: "aphte", nom: "Aphte", categorie: "Bouche & Peau", emoji: "üò£", couleur: "#EC4899", description: "Ulc√©ration buccale", specialites: [], informations: "", documents: [] },
      { id: "herpes", nom: "Boutons de fi√®vre", categorie: "Bouche & Peau", emoji: "üòñ", couleur: "#F43F5E", description: "Herp√®s labial", specialites: [], informations: "", documents: [] },
      { id: "ampoules", nom: "Cloche aux pieds", categorie: "Bouche & Peau", emoji: "ü¶∂", couleur: "#8B5CF6", description: "Ampoules", specialites: [], informations: "", documents: [] },
      { id: "piercing", nom: "Piercing aux oreilles", categorie: "Bouche & Peau", emoji: "üëÇ", couleur: "#A855F7", description: "Soins post-piercing", specialites: [], informations: "", documents: [] }
    ];

    const EditIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
        <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
      </svg>
    );

    const DeleteIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
      </svg>
    );

    const LinkIcon = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/>
        <path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/>
      </svg>
    );

    function parseContent(content, couleur) {
      if (!content) return [];

      const lines = content.split('\n');
      const elements = [];
      let i = 0;

      while (i < lines.length) {
        const line = lines[i];

        if (line.trim() === '[row]') {
          const rowContent = [];
          i++;
          while (i < lines.length && lines[i].trim() !== '[/row]') {
            rowContent.push(lines[i]);
            i++;
          }
          
          const rowElements = [];
          rowContent.forEach(rowLine => {
            const imgMatch = rowLine.match(/\[img-(small|medium|large)\](https?:\/\/[^\[]+)\[\/img-(small|medium|large)\]/) ||
                            rowLine.match(/\[img\](https?:\/\/[^\[]+)\[\/img\]/);
            
            if (imgMatch) {
              const size = imgMatch[1] || 'full';
              const url = imgMatch[2] || imgMatch[1];
              rowElements.push({ type: 'image', url, size });
            }
          });

          if (rowElements.length > 0) {
            elements.push({ type: 'row', items: rowElements });
          }
          i++;
          continue;
        }

        const imgCenterSmall = line.match(/\[img-center-small\](https?:\/\/[^\[]+)\[\/img-center-small\]/);
        const imgCenterMedium = line.match(/\[img-center-medium\](https?:\/\/[^\[]+)\[\/img-center-medium\]/);
        const imgCenterLarge = line.match(/\[img-center-large\](https?:\/\/[^\[]+)\[\/img-center-large\]/);
        const imgCenterFull = line.match(/\[img-center\](https?:\/\/[^\[]+)\[\/img-center\]/);

        const imgSmall = line.match(/\[img-small\](https?:\/\/[^\[]+)\[\/img-small\]/);
        const imgMedium = line.match(/\[img-medium\](https?:\/\/[^\[]+)\[\/img-medium\]/);
        const imgLarge = line.match(/\[img-large\](https?:\/\/[^\[]+)\[\/img-large\]/);
        const imgFull = line.match(/\[img\](https?:\/\/[^\[]+)\[\/img\]/);

        if (imgCenterSmall) {
          elements.push({ type: 'image', url: imgCenterSmall[1], size: 'small', centered: true });
        } else if (imgCenterMedium) {
          elements.push({ type: 'image', url: imgCenterMedium[1], size: 'medium', centered: true });
        } else if (imgCenterLarge) {
          elements.push({ type: 'image', url: imgCenterLarge[1], size: 'large', centered: true });
        } else if (imgCenterFull) {
          elements.push({ type: 'image', url: imgCenterFull[1], size: 'full', centered: true });
        } else if (imgSmall) {
          elements.push({ type: 'image', url: imgSmall[1], size: 'small' });
        } else if (imgMedium) {
          elements.push({ type: 'image', url: imgMedium[1], size: 'medium' });
        } else if (imgLarge) {
          elements.push({ type: 'image', url: imgLarge[1], size: 'large' });
        } else if (imgFull) {
          elements.push({ type: 'image', url: imgFull[1], size: 'full' });
        } else if (line.startsWith('http') && (line.match(/\.(jpg|jpeg|png|gif|webp)$/i) || line.includes('imgur') || line.includes('ibb.co'))) {
          elements.push({ type: 'image', url: line, size: 'full' });
        } else if (line.startsWith('http')) {
          elements.push({ type: 'link', url: line });
        } else {
          elements.push({ type: 'text', content: line });
        }

        i++;
      }

      return elements;
    }

    function renderParsedContent(elements, couleur) {
      return elements.map((el, idx) => {
        if (el.type === 'row') {
          return (
            <div key={idx} style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap', margin: '1rem 0' }}>
              {el.items.map((item, itemIdx) => {
                const width = item.size === 'small' ? '30%' : item.size === 'medium' ? '48%' : item.size === 'large' ? '70%' : '100%';
                return (
                  <img
                    key={itemIdx}
                    src={item.url}
                    alt="Image"
                    style={{
                      width: width,
                      minWidth: '150px',
                      borderRadius: '8px',
                      boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                      objectFit: 'cover'
                    }}
                  />
                );
              })}
            </div>
          );
        } else if (el.type === 'image') {
          const sizeMap = {
            'small': '30%',
            'medium': '50%',
            'large': '70%',
            'full': '100%'
          };
          const width = sizeMap[el.size] || '100%';
          const isInline = el.size === 'small' || el.size === 'medium';

          if (el.centered) {
            return (
              <div key={idx} style={{ textAlign: 'center', margin: '1rem 0' }}>
                <img
                  src={el.url}
                  alt="Image"
                  style={{
                    width: width,
                    maxWidth: '100%',
                    borderRadius: '8px',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                    display: 'inline-block'
                  }}
                />
              </div>
            );
          }

          return (
            <img
              key={idx}
              src={el.url}
              alt="Image"
              style={{
                width: width,
                maxWidth: '100%',
                borderRadius: '8px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                margin: '0.5rem 0',
                display: isInline ? 'inline-block' : 'block',
                marginRight: isInline ? '1rem' : '0',
                verticalAlign: 'top'
              }}
            />
          );
        } else if (el.type === 'link') {
          return (
            <div key={idx}>
              <a href={el.url} target="_blank" style={{ color: couleur, textDecoration: 'underline' }}>
                {el.url}
              </a>
            </div>
          );
        } else {
          // Parser le formatage du texte
          return <div key={idx}>{parseFormattedText(el.content || '\u00A0')}</div>;
        }
      });
    }

    function parseFormattedText(text) {
      if (!text || text === '\u00A0') return text;
      
      // Titres
      if (text.startsWith('### ')) {
        return <h3 style={{ fontSize: '1.1rem', fontWeight: 'bold', marginTop: '1rem', marginBottom: '0.5rem', color: '#1e293b' }}>{text.substring(4)}</h3>;
      }
      if (text.startsWith('## ')) {
        return <h2 style={{ fontSize: '1.3rem', fontWeight: 'bold', marginTop: '1.2rem', marginBottom: '0.6rem', color: '#1e293b' }}>{text.substring(3)}</h2>;
      }
      if (text.startsWith('# ')) {
        return <h1 style={{ fontSize: '1.5rem', fontWeight: 'bold', marginTop: '1.5rem', marginBottom: '0.7rem', color: '#1e293b' }}>{text.substring(2)}</h1>;
      }
      
      // Listes
      if (text.startsWith('- ') || text.startsWith('‚Ä¢ ')) {
        return <li style={{ marginLeft: '1.5rem' }}>{parseInlineFormatting(text.substring(2))}</li>;
      }
      if (/^\d+\.\s/.test(text)) {
        const content = text.replace(/^\d+\.\s/, '');
        return <li style={{ marginLeft: '1.5rem', listStyleType: 'decimal' }}>{parseInlineFormatting(content)}</li>;
      }
      
      // Texte normal avec formatage inline
      return parseInlineFormatting(text);
    }

    function parseInlineFormatting(text) {
      const parts = [];
      let remaining = text;
      let key = 0;

      while (remaining.length > 0) {
        // Couleurs
        const colorRedMatch = remaining.match(/^\[color-red\](.*?)\[\/color-red\]/);
        const colorBlueMatch = remaining.match(/^\[color-blue\](.*?)\[\/color-blue\]/);
        const colorGreenMatch = remaining.match(/^\[color-green\](.*?)\[\/color-green\]/);
        const colorOrangeMatch = remaining.match(/^\[color-orange\](.*?)\[\/color-orange\]/);
        
        // Gras
        const boldMatch = remaining.match(/^\*\*(.*?)\*\*/);
        
        // Italique
        const italicMatch = remaining.match(/^\*(.*?)\*/);
        
        // Soulign√©
        const underlineMatch = remaining.match(/^__(.*?)__/);
        
        // Barr√©
        const strikeMatch = remaining.match(/^~~(.*?)~~/);
        
        if (colorRedMatch) {
          parts.push(<span key={key++} style={{ color: '#dc2626', fontWeight: 600 }}>{colorRedMatch[1]}</span>);
          remaining = remaining.substring(colorRedMatch[0].length);
        } else if (colorBlueMatch) {
          parts.push(<span key={key++} style={{ color: '#1d4ed8', fontWeight: 600 }}>{colorBlueMatch[1]}</span>);
          remaining = remaining.substring(colorBlueMatch[0].length);
        } else if (colorGreenMatch) {
          parts.push(<span key={key++} style={{ color: '#047857', fontWeight: 600 }}>{colorGreenMatch[1]}</span>);
          remaining = remaining.substring(colorGreenMatch[0].length);
        } else if (colorOrangeMatch) {
          parts.push(<span key={key++} style={{ color: '#c2410c', fontWeight: 600 }}>{colorOrangeMatch[1]}</span>);
          remaining = remaining.substring(colorOrangeMatch[0].length);
        } else if (boldMatch) {
          parts.push(<strong key={key++}>{boldMatch[1]}</strong>);
          remaining = remaining.substring(boldMatch[0].length);
        } else if (underlineMatch) {
          parts.push(<u key={key++}>{underlineMatch[1]}</u>);
          remaining = remaining.substring(underlineMatch[0].length);
        } else if (strikeMatch) {
          parts.push(<s key={key++}>{strikeMatch[1]}</s>);
          remaining = remaining.substring(strikeMatch[0].length);
        } else if (italicMatch && !remaining.startsWith('**')) {
          parts.push(<em key={key++}>{italicMatch[1]}</em>);
          remaining = remaining.substring(italicMatch[0].length);
        } else {
          parts.push(remaining[0]);
          remaining = remaining.substring(1);
        }
      }

      return parts.length > 0 ? <>{parts}</> : text;
    }

    function getPharmaQuizzMed(dci) {
      if (!dci) return null;
      try {
        const flashcards = JSON.parse(localStorage.getItem('flashcards') || '[]');
        const med = flashcards.find(f => f.dci.toLowerCase() === dci.toLowerCase());
        return med;
      } catch (e) {
        return null;
      }
    }

    function ConseilsOfficine({ onReturnToMenu, medications }) {
      const [categories, setCategories] = useState([]);
      const [plaintes, setPlaintes] = useState([]);
      const [selectedPlainte, setSelectedPlainte] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [showCategoriesModal, setShowCategoriesModal] = useState(false);
      const [showAddPlainte, setShowAddPlainte] = useState(false);
      const [showImportMedModal, setShowImportMedModal] = useState(false);
      const [importSearchTerm, setImportSearchTerm] = useState('');
      const [editingPlainte, setEditingPlainte] = useState(null);
      const [showAddSpecialite, setShowAddSpecialite] = useState(false);
      const [editingSpecialite, setEditingSpecialite] = useState(null);
      const [imageModalUrl, setImageModalUrl] = useState(null);

      useEffect(() => {
        const savedCat = localStorage.getItem('conseilsCategories');
        const savedPlaintes = localStorage.getItem('conseilsOfficine');
        
        if (savedCat) {
          setCategories(JSON.parse(savedCat));
        } else {
          setCategories(INITIAL_CATEGORIES);
          localStorage.setItem('conseilsCategories', JSON.stringify(INITIAL_CATEGORIES));
        }
        
        if (savedPlaintes) {
          setPlaintes(JSON.parse(savedPlaintes));
        } else {
          setPlaintes(INITIAL_PLAINTES);
          localStorage.setItem('conseilsOfficine', JSON.stringify(INITIAL_PLAINTES));
        }
      }, []);

      const saveCategories = (newCat) => {
        setCategories(newCat);
        localStorage.setItem('conseilsCategories', JSON.stringify(newCat));
      };

      const savePlaintes = (newPlaintes) => {
        setPlaintes(newPlaintes);
        localStorage.setItem('conseilsOfficine', JSON.stringify(newPlaintes));
      };

      const addCategory = (name) => {
        if (!name.trim()) return;
        if (categories.includes(name.trim())) {
          alert('Cette cat√©gorie existe d√©j√† !');
          return;
        }
        saveCategories([...categories, name.trim()]);
      };

      const editCategory = (oldName, newName) => {
        if (!newName.trim()) {
          alert('Le nom de la cat√©gorie ne peut pas √™tre vide');
          return;
        }
        if (oldName !== newName && categories.includes(newName.trim())) {
          alert('Cette cat√©gorie existe d√©j√† !');
          return;
        }
        
        // Mettre √† jour le nom de la cat√©gorie dans toutes les plaintes
        const updatedPlaintes = plaintes.map(plainte => 
          plainte.categorie === oldName ? { ...plainte, categorie: newName.trim() } : plainte
        );
        savePlaintes(updatedPlaintes);
        
        // Mettre √† jour la liste des cat√©gories
        const updatedCategories = categories.map(cat => cat === oldName ? newName.trim() : cat);
        saveCategories(updatedCategories);
        
        // Mettre √† jour selectedPlainte si n√©cessaire
        if (selectedPlainte && selectedPlainte.categorie === oldName) {
          setSelectedPlainte({ ...selectedPlainte, categorie: newName.trim() });
        }
      };

      const deleteCategory = (cat) => {
        const plaintesInCategory = plaintes.filter(p => p.categorie === cat);
        if (plaintesInCategory.length > 0) {
          if (!window.confirm(`La cat√©gorie "${cat}" contient ${plaintesInCategory.length} fiche(s).\n\nSupprimer quand m√™me ? (Les fiches seront d√©plac√©es vers la premi√®re cat√©gorie disponible)`)) {
            return;
          }
          // D√©placer les plaintes vers la premi√®re cat√©gorie disponible
          const newCategories = categories.filter(c => c !== cat);
          const firstCategory = newCategories[0] || 'G√©n√©ral';
          const updatedPlaintes = plaintes.map(plainte => 
            plainte.categorie === cat ? { ...plainte, categorie: firstCategory } : plainte
          );
          savePlaintes(updatedPlaintes);
          saveCategories(newCategories);
        } else {
          if (!window.confirm(`Supprimer la cat√©gorie "${cat}" ?`)) return;
          saveCategories(categories.filter(c => c !== cat));
        }
      };

      const savePlainteData = (plainteData) => {
        if (editingPlainte) {
          const newPlaintes = plaintes.map(p => 
            p.id === editingPlainte.id ? { ...plainteData, id: p.id } : p
          );
          savePlaintes(newPlaintes);
          if (selectedPlainte?.id === editingPlainte.id) {
            setSelectedPlainte({ ...plainteData, id: editingPlainte.id });
          }
        } else {
          const newPlainte = { ...plainteData, id: Date.now().toString() };
          savePlaintes([...plaintes, newPlainte]);
        }
        setShowAddPlainte(false);
        setEditingPlainte(null);
      };

      const deletePlainte = (id) => {
        if (!window.confirm('Supprimer cette plainte ?')) return;
        savePlaintes(plaintes.filter(p => p.id !== id));
        if (selectedPlainte?.id === id) {
          setSelectedPlainte(null);
        }
      };

      const saveSpecialite = (plainteId, specialite) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            if (editingSpecialite) {
              return {
                ...p,
                specialites: p.specialites.map(s => 
                  s.id === editingSpecialite.id ? { ...specialite, id: s.id } : s
                )
              };
            } else {
              return {
                ...p,
                specialites: [...p.specialites, { ...specialite, id: Date.now().toString() }]
              };
            }
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
        setShowAddSpecialite(false);
        setEditingSpecialite(null);
      };

      const deleteSpecialite = (plainteId, specialiteId) => {
        if (!window.confirm('Supprimer cette sp√©cialit√© ?')) return;
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            return { ...p, specialites: p.specialites.filter(s => s.id !== specialiteId) };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const updatePlainteInfo = (plainteId, field, value) => {
        const newPlaintes = plaintes.map(p => 
          p.id === plainteId ? { ...p, [field]: value } : p
        );
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const addDocument = (plainteId, document) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            return { ...p, documents: [...(p.documents || []), { ...document, id: Date.now().toString() }] };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const deleteDocument = (plainteId, docId) => {
        if (!window.confirm('Supprimer ce lien ?')) return;
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            return { ...p, documents: (p.documents || []).filter(d => d.id !== docId) };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const editDocument = (plainteId, docId, newName, newUrl, newCategory) => {
        const newPlaintes = plaintes.map(p => {
          if (p.id === plainteId) {
            return {
              ...p,
              documents: (p.documents || []).map(d => 
                d.id === docId ? { ...d, nom: newName, data: newUrl, category: newCategory || 'G√©n√©raux' } : d
              )
            };
          }
          return p;
        });
        savePlaintes(newPlaintes);
        const updatedPlainte = newPlaintes.find(p => p.id === plainteId);
        setSelectedPlainte(updatedPlainte);
      };

      const handleImageUpload = (e, callback) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onloadend = () => callback(reader.result);
        reader.readAsDataURL(file);
      };

      const handleImageURL = (callback) => {
        let url = prompt("Collez l'URL de l'image :");
        if (!url) return;
        
        if (url.includes('imgur.com/a/')) {
          alert("‚ùå C'est une URL d'ALBUM !\n\nüìù Pour obtenir l'URL correcte :\n1. Ouvrez votre album\n2. Cliquez sur l'image\n3. Clic droit ‚Üí 'Copier l'adresse de l'image'\n4. Vous obtiendrez : https://i.imgur.com/abc123.jpg");
          return;
        }
        
        if (url.includes('imgur.com') && !url.includes('i.imgur.com')) {
          const match = url.match(/imgur\.com\/(?:gallery\/)?([a-zA-Z0-9]+)/);
          if (match && match[1]) {
            const imageId = match[1];
            const ext = prompt("Extension de l'image ?\n(jpg, png, gif, webp)", "jpg");
            if (ext) {
              url = `https://i.imgur.com/${imageId}.${ext}`;
              alert(`‚úÖ URL corrig√©e automatiquement :\n${url}`);
            } else {
              return;
            }
          }
        }
        
        if (!url.startsWith('http')) {
          alert("‚ùå L'URL doit commencer par http:// ou https://");
          return;
        }
        
        callback(url);
      };

      const filteredPlaintes = plaintes.filter(p => 
        p.nom.toLowerCase().includes(searchTerm.toLowerCase()) ||
        p.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
        p.specialites.some(s => s.nomCommercial?.toLowerCase().includes(searchTerm.toLowerCase()) || s.dci?.toLowerCase().includes(searchTerm.toLowerCase()))
      );

      if (showCategoriesModal) {
        return <CategoriesModal 
          categories={categories}
          onClose={() => setShowCategoriesModal(false)}
          onAdd={addCategory}
          onEdit={editCategory}
          onDelete={deleteCategory}
        />;
      }

      if (showAddPlainte) {
        return <FormPlainte
          plainte={editingPlainte}
          categories={categories}
          onSave={savePlainteData}
          onCancel={() => { setShowAddPlainte(false); setEditingPlainte(null); }}
        />;
      }

      if (showImportMedModal && selectedPlainte) {
        return (
          <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0,0,0,0.75)',
            backdropFilter: 'blur(8px)',
            zIndex: 2000,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '1rem'
          }} onClick={() => { setShowImportMedModal(false); setImportSearchTerm(''); }}>
            <div onClick={(e) => e.stopPropagation()} style={{
              background: 'white',
              borderRadius: '20px',
              padding: '2rem',
              maxWidth: '600px',
              width: '100%',
              maxHeight: '80vh',
              overflowY: 'auto'
            }}>
              <h3 style={{ margin: '0 0 1rem 0', fontSize: '1.5rem', color: '#1e293b' }}>
                Importer depuis Flashcards
              </h3>
              
              <input
                type="text"
                placeholder="Rechercher un m√©dicament..."
                value={importSearchTerm}
                onChange={(e) => setImportSearchTerm(e.target.value)}
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px',
                  fontSize: '1rem',
                  marginBottom: '1rem'
                }}
              />
              
              <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                {(medications || []).filter(med => 
                  !importSearchTerm || 
                  med.commercial.some(c => c.toLowerCase().includes(importSearchTerm.toLowerCase())) ||
                  med.dci.toLowerCase().includes(importSearchTerm.toLowerCase())
                ).map(med => (
                  <div
                    key={med.commercial[0]}
                    onClick={() => {
                      const newSpec = {
                        id: Date.now(),
                        dci: med.dci,
                        nomCommercial: med.commercial.join(', '),
                        dosage: '',
                        contreIndications: '',
                        prix: '',
                        remboursement: '',
                        imageUrls: med.imageUrls || (med.imageUrl ? [med.imageUrl] : [])
                      };
                      
                      const updatedPlainte = {
                        ...selectedPlainte,
                        specialites: [...selectedPlainte.specialites, newSpec]
                      };
                      
                      const updatedPlaintes = plaintes.map(p =>
                        p.id === selectedPlainte.id ? updatedPlainte : p
                      );
                      
                      localStorage.setItem('conseilsOfficine', JSON.stringify(updatedPlaintes));
                      setPlaintes(updatedPlaintes);
                      setSelectedPlainte(updatedPlainte);
                      setShowImportMedModal(false);
                      setImportSearchTerm('');
                    }}
                    style={{
                      padding: '1rem',
                      border: '2px solid #e2e8f0',
                      borderRadius: '12px',
                      marginBottom: '0.5rem',
                      cursor: 'pointer',
                      transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.borderColor = '#3B82F6';
                      e.currentTarget.style.background = '#F0F9FF';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.borderColor = '#e2e8f0';
                      e.currentTarget.style.background = 'white';
                    }}
                  >
                    <div style={{ fontWeight: 700, color: '#1e293b', marginBottom: '0.25rem' }}>
                      {med.commercial.join(' ‚Ä¢ ')}
                    </div>
                    <div style={{ fontSize: '0.85rem', color: '#64748b' }}>
                      {med.dci}
                    </div>
                    {(med.imageUrls || (med.imageUrl ? [med.imageUrl] : [])).length > 0 && (
                      <div style={{ marginTop: '0.5rem', fontSize: '0.75rem', color: '#3B82F6' }}>
                        üì∑ {(med.imageUrls || [med.imageUrl]).filter(Boolean).length} image(s)
                      </div>
                    )}
                  </div>
                ))}
              </div>
              
              <button
                onClick={() => { setShowImportMedModal(false); setImportSearchTerm(''); }}
                style={{
                  width: '100%',
                  marginTop: '1rem',
                  padding: '0.75rem',
                  background: '#e2e8f0',
                  border: 'none',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: 600,
                  color: '#64748b'
                }}
              >
                Annuler
              </button>
            </div>
          </div>
        );
      }

      return (
        <>
          {selectedPlainte ? (
            <DetailPlainte 
              plainte={selectedPlainte}
              onBack={() => { setSelectedPlainte(null); setShowAddSpecialite(false); setEditingSpecialite(null); }}
              onEdit={() => { setEditingPlainte(selectedPlainte); setShowAddPlainte(true); }}
              onDelete={() => deletePlainte(selectedPlainte.id)}
              onAddSpecialite={() => { setShowAddSpecialite(true); setEditingSpecialite(null); }}
              onEditSpecialite={(spec) => { setEditingSpecialite(spec); setShowAddSpecialite(true); }}
              onDeleteSpecialite={(specId) => deleteSpecialite(selectedPlainte.id, specId)}
              showAddSpecialite={showAddSpecialite}
              editingSpecialite={editingSpecialite}
              onSaveSpecialite={(spec) => saveSpecialite(selectedPlainte.id, spec)}
              onCancelSpecialite={() => { setShowAddSpecialite(false); setEditingSpecialite(null); }}
              handleImageUpload={handleImageUpload}
              handleImageURL={handleImageURL}
              onUpdatePlainteInfo={(field, value) => updatePlainteInfo(selectedPlainte.id, field, value)}
              onAddDocument={(doc) => addDocument(selectedPlainte.id, doc)}
              onDeleteDocument={(docId) => deleteDocument(selectedPlainte.id, docId)}
              onEditDocument={(docId, newName, newUrl) => editDocument(selectedPlainte.id, docId, newName, newUrl)}
              onShowImportModal={() => setShowImportMedModal(true)}
              medications={medications}
              setImageModalUrl={setImageModalUrl}
            />
          ) : (
            <div style={{ maxWidth: 'none', margin: '0', padding: '0 2rem' }}>
          <div style={{
            background: 'linear-gradient(135deg, #1e293b 0%, #334155 100%)',
            padding: '1.5rem',
            color: 'white',
            textAlign: 'center',
            borderRadius: '20px 20px 0 0',
            position: 'relative'
          }}>
            <div style={{
              position: 'absolute',
              top: '1.5rem',
              left: '1.5rem'
            }}>
              <button
                onClick={onReturnToMenu}
                className="button-hover"
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  border: 'none',
                  color: 'white',
                  padding: '0.75rem 1.25rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontSize: '1rem',
                  fontWeight: 600,
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.5rem'
                }}
              >
                <span>‚Üê</span> Menu
              </button>
            </div>
            
            <h1 style={{ margin: 0, fontSize: '1.8rem', fontWeight: 700 }}>Conseils Officine</h1>
            <p style={{ margin: '0.5rem 0 0 0', opacity: 0.9, fontSize: '0.85rem' }}>Recommandations pour les plaintes courantes</p>
            
            <div style={{
              position: 'absolute',
              top: '1.5rem',
              right: '1.5rem',
              display: 'flex',
              gap: '0.75rem'
            }}>
              <button
                onClick={() => setShowCategoriesModal(true)}
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  border: 'none',
                  color: 'white',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontSize: '0.9rem',
                  fontWeight: 600
                }}
              >
                G√©rer cat√©gories
              </button>
              <button
                onClick={() => setShowAddPlainte(true)}
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  border: 'none',
                  color: 'white',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontSize: '0.9rem',
                  fontWeight: 600
                }}
              >
                + Nouvelle plainte
              </button>
            </div>
          </div>

          <div style={{
            background: 'white',
            borderRadius: '0 0 20px 20px',
            padding: '1.5rem',
            boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
            minHeight: '400px'
          }}>
            <div style={{ marginBottom: '2rem' }}>
              <input
                type="text"
                placeholder="Rechercher..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                style={{
                  width: '100%',
                  padding: '1rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '12px',
                  fontSize: '1rem',
                  outline: 'none'
                }}
              />
            </div>

            {categories.map(categorie => {
            const plaintesCategorie = filteredPlaintes.filter(p => p.categorie === categorie);

            return (
              <div key={categorie} style={{ marginBottom: '2rem' }}>
                <h2 style={{
                  color: '#1e293b',
                  fontSize: '1.5rem',
                  marginBottom: '1rem',
                  fontWeight: 700
                }}>
                  {categorie}
                </h2>
                
                {plaintesCategorie.length === 0 ? (
                  <div style={{
                    background: '#F8FAFC',
                    padding: '2rem',
                    borderRadius: '12px',
                    textAlign: 'center',
                    color: '#64748b',
                    fontStyle: 'italic',
                    border: '2px dashed #E2E8F0'
                  }}>
                    Aucune plainte dans cette cat√©gorie
                  </div>
                ) : (
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fill, 260px)',
                    gap: '1.5rem'
                  }}>
                    {plaintesCategorie.map(plainte => (
                      <div
                        key={plainte.id}
                        style={{
                          background: 'white',
                          border: '1px solid #334155',
                          borderRadius: '12px',
                          padding: '0.75rem 1rem',
                          cursor: 'pointer',
                          transition: 'all 0.3s',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.75rem',
                          height: '60px'
                        }}
                        onClick={() => setSelectedPlainte(plainte)}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.transform = 'translateY(-2px)';
                          e.currentTarget.style.boxShadow = '0 8px 20px rgba(0,0,0,0.1)';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.transform = 'translateY(0)';
                          e.currentTarget.style.boxShadow = 'none';
                        }}
                      >
                        <div style={{
                          width: '40px',
                          height: '40px',
                          background: plainte.couleur,
                          borderRadius: '50%',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          fontSize: '1.3rem',
                          flexShrink: 0
                        }}>
                          {plainte.emoji}
                        </div>
                        
                        <div style={{ flex: 1, minWidth: 0 }}>
                          <h3 style={{
                            margin: 0,
                            fontSize: '0.95rem',
                            fontWeight: 700,
                            color: '#1e293b',
                            whiteSpace: 'nowrap',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis'
                          }}>
                            {plainte.nom}
                          </h3>
                          <div style={{
                            fontSize: '0.7rem',
                            color: '#64748b',
                            fontWeight: 600,
                            marginTop: '0.2rem'
                          }}>
                            {plainte.specialites.length} sp√©cialit√©{plainte.specialites.length > 1 ? 's' : ''}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            );
            })}
          </div>
            </div>
          )}

          {/* MODAL ZOOM IMAGE */}
          {imageModalUrl && (
            <div 
              onClick={() => setImageModalUrl(null)} 
              style={{ 
                position: 'fixed', 
                top: 0, 
                left: 0, 
                right: 0, 
                bottom: 0, 
                background: 'rgba(0, 0, 0, 0.7)', 
                backdropFilter: 'blur(8px)',
                zIndex: 9999, 
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'center', 
                padding: '2rem',
                cursor: 'pointer'
              }}
            >
              <div 
                style={{ 
                  background: 'white', 
                  borderRadius: '16px', 
                  padding: '1.5rem',
                  boxShadow: '0 25px 80px rgba(0, 0, 0, 0.3)',
                  maxWidth: '90%',
                  maxHeight: '90%',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}
                onClick={(e) => e.stopPropagation()}
              >
                <img 
                  src={imageModalUrl} 
                  alt="Image agrandie" 
                  style={{ 
                    maxWidth: '100%', 
                    maxHeight: '80vh', 
                    objectFit: 'contain', 
                    borderRadius: '8px'
                  }} 
                />
              </div>
            </div>
          )}
        </>
      );
    }

    function CategoriesModal({ categories, onClose, onAdd, onDelete, onEdit }) {
      const [newCat, setNewCat] = useState('');
      const [editingCat, setEditingCat] = useState(null);
      const [editValue, setEditValue] = useState('');

      return (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0,0,0,0.75)',
          backdropFilter: 'blur(8px)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '2rem',
          zIndex: 1000
        }}>
          <div style={{
            background: 'white',
            borderRadius: '20px',
            padding: '2rem',
            maxWidth: '600px',
            width: '100%',
            maxHeight: '80vh',
            overflow: 'auto'
          }}>
            <h2 style={{ marginBottom: '1.5rem', color: '#1e293b' }}>G√©rer les cat√©gories</h2>

            <div style={{ marginBottom: '1.5rem' }}>
              <input
                type="text"
                value={newCat}
                onChange={(e) => setNewCat(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === 'Enter' && newCat.trim()) {
                    onAdd(newCat);
                    setNewCat('');
                  }
                }}
                placeholder="Nouvelle cat√©gorie..."
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px',
                  marginBottom: '0.75rem'
                }}
              />
              <button
                onClick={() => {
                  if (newCat.trim()) {
                    onAdd(newCat);
                    setNewCat('');
                  }
                }}
                style={{
                  background: '#667eea',
                  color: 'white',
                  border: 'none',
                  padding: '0.75rem 1.5rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: 600
                }}
              >
                + Ajouter
              </button>
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              {categories.map(cat => (
                editingCat === cat ? (
                  <div key={cat} style={{
                    display: 'flex',
                    gap: '0.5rem',
                    padding: '0.75rem',
                    background: '#f8fafc',
                    borderRadius: '8px',
                    marginBottom: '0.5rem'
                  }}>
                    <input
                      type="text"
                      value={editValue}
                      onChange={(e) => setEditValue(e.target.value)}
                      onKeyPress={(e) => {
                        if (e.key === 'Enter' && editValue.trim()) {
                          onEdit(cat, editValue.trim());
                          setEditingCat(null);
                          setEditValue('');
                        }
                      }}
                      autoFocus
                      style={{
                        flex: 1,
                        padding: '0.5rem',
                        border: '2px solid #3B82F6',
                        borderRadius: '6px'
                      }}
                    />
                    <button
                      onClick={() => {
                        if (editValue.trim()) {
                          onEdit(cat, editValue.trim());
                          setEditingCat(null);
                          setEditValue('');
                        }
                      }}
                      style={{
                        background: '#10B981',
                        color: 'white',
                        border: 'none',
                        padding: '0.5rem 1rem',
                        borderRadius: '6px',
                        cursor: 'pointer'
                      }}
                    >
                      ‚úì
                    </button>
                    <button
                      onClick={() => {
                        setEditingCat(null);
                        setEditValue('');
                      }}
                      style={{
                        background: '#e2e8f0',
                        color: '#475569',
                        border: 'none',
                        padding: '0.5rem 1rem',
                        borderRadius: '6px',
                        cursor: 'pointer'
                      }}
                    >
                      ‚úï
                    </button>
                  </div>
                ) : (
                  <div key={cat} style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    padding: '0.75rem',
                    background: '#f8fafc',
                    borderRadius: '8px',
                    marginBottom: '0.5rem'
                  }}>
                    <span style={{ color: '#1e293b', fontWeight: 600 }}>{cat}</span>
                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                      <button
                        onClick={() => {
                          setEditingCat(cat);
                          setEditValue(cat);
                        }}
                        style={{
                          background: '#3B82F6',
                          color: 'white',
                          border: 'none',
                          padding: '0.5rem 1rem',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontSize: '0.85rem'
                        }}
                      >
                        ‚úèÔ∏è Modifier
                      </button>
                      <button
                        onClick={() => onDelete(cat)}
                        style={{
                          background: '#ef4444',
                          color: 'white',
                          border: 'none',
                          padding: '0.5rem 1rem',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontSize: '0.85rem'
                        }}
                      >
                        üóëÔ∏è Supprimer
                      </button>
                    </div>
                  </div>
                )
              ))}
            </div>

            <button
              onClick={onClose}
              style={{
                background: '#e2e8f0',
                color: '#475569',
                border: 'none',
                padding: '0.75rem 1.5rem',
                borderRadius: '8px',
                cursor: 'pointer',
                fontWeight: 600,
                width: '100%'
              }}
            >
              Fermer
            </button>
          </div>
        </div>
      );
    }

    function FormPlainte({ plainte, categories, onSave, onCancel }) {
      const [formData, setFormData] = useState(plainte || {
        nom: '',
        description: '',
        categorie: categories[0] || '',
        emoji: 'üíä',
        couleur: '#667eea',
        specialites: [],
        informations: '',
        documents: []
      });

      return (
        <div style={{ maxWidth: 'none', margin: '0', padding: '0 2rem' }}>
          <div style={{
            background: 'white',
            borderRadius: '20px',
            padding: '2rem',
            boxShadow: '0 10px 40px rgba(0,0,0,0.1)',
            maxWidth: '700px',
            margin: '0 auto'
          }}>
            <h2 style={{ marginBottom: '2rem', color: '#1e293b' }}>
              {plainte ? 'Modifier la plainte' : 'Nouvelle plainte'}
            </h2>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Nom *</label>
              <input
                type="text"
                value={formData.nom}
                onChange={(e) => setFormData({ ...formData, nom: e.target.value })}
                placeholder="Ex: Maux de t√™te"
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px'
                }}
              />
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Description</label>
              <input
                type="text"
                value={formData.description}
                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                placeholder="Ex: C√©phal√©es, migraines"
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px'
                }}
              />
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Cat√©gorie *</label>
              <select
                value={formData.categorie}
                onChange={(e) => setFormData({ ...formData, categorie: e.target.value })}
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px'
                }}
              >
                {categories.map(cat => (
                  <option key={cat} value={cat}>{cat}</option>
                ))}
              </select>
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' }}>
              <div>
                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Emoji</label>
                <input
                  type="text"
                  value={formData.emoji}
                  onChange={(e) => setFormData({ ...formData, emoji: e.target.value })}
                  placeholder="Ex: ü§ï"
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid #e2e8f0',
                    borderRadius: '8px',
                    fontSize: '1.5rem',
                    textAlign: 'center'
                  }}
                />
              </div>
              <div>
                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Couleur</label>
                <input
                  type="color"
                  value={formData.couleur}
                  onChange={(e) => setFormData({ ...formData, couleur: e.target.value })}
                  style={{
                    width: '100%',
                    height: '50px',
                    border: '2px solid #e2e8f0',
                    borderRadius: '8px',
                    cursor: 'pointer'
                  }}
                />
              </div>
            </div>

            <div style={{ display: 'flex', gap: '1rem' }}>
              <button
                onClick={() => {
                  if (!formData.nom.trim()) {
                    alert('Le nom est obligatoire');
                    return;
                  }
                  onSave(formData);
                }}
                style={{
                  flex: 1,
                  background: '#667eea',
                  color: 'white',
                  border: 'none',
                  padding: '1rem',
                  borderRadius: '12px',
                  fontWeight: 600,
                  cursor: 'pointer'
                }}
              >
                {plainte ? 'Enregistrer' : 'Cr√©er'}
              </button>
              <button
                onClick={onCancel}
                style={{
                  flex: 1,
                  background: '#e2e8f0',
                  color: '#475569',
                  border: 'none',
                  padding: '1rem',
                  borderRadius: '12px',
                  fontWeight: 600,
                  cursor: 'pointer'
                }}
              >
                Annuler
              </button>
            </div>
          </div>
        </div>
      );
    }

    function DetailPlainte({ 
      plainte, onBack, onEdit, onDelete, onAddSpecialite, onEditSpecialite, onDeleteSpecialite,
      showAddSpecialite, editingSpecialite, onSaveSpecialite, onCancelSpecialite,
      handleImageUpload, handleImageURL, onUpdatePlainteInfo, onAddDocument, onDeleteDocument, onEditDocument, onShowImportModal, medications, setImageModalUrl}) {
      const [activeTab, setActiveTab] = useState('info');

      if (showAddSpecialite) {
        return <FormSpecialite
          specialite={editingSpecialite}
          onSave={onSaveSpecialite}
          onCancel={onCancelSpecialite}
          handleImageUpload={handleImageUpload}
          handleImageURL={handleImageURL}
          plainte={plainte}
          medications={medications}
        />;
      }

      return (
        <div style={{ maxWidth: 'none', margin: '0', padding: '0 2rem' }}>
          <div style={{
            background: 'white',
            borderRadius: '20px',
            padding: '2rem',
            marginBottom: '1.5rem',
            boxShadow: '0 4px 20px rgba(0,0,0,0.1)',
            borderLeft: `6px solid ${plainte.couleur}`
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
              <div style={{ flex: 1 }}>
                <button
                  onClick={onBack}
                  style={{
                    background: '#f8fafc',
                    border: 'none',
                    padding: '0.5rem 1rem',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    marginBottom: '1rem',
                    color: '#64748b',
                    fontWeight: 600
                  }}
                >
                  ‚Üê Retour
                </button>
                
                <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: '0.5rem' }}>
                  <span style={{ fontSize: '3rem' }}>{plainte.emoji}</span>
                  <h1 style={{ fontSize: '2.5rem', fontWeight: 700, color: '#1e293b' }}>{plainte.nom}</h1>
                </div>
                
                <p style={{ color: '#64748b', fontSize: '1.1rem' }}>{plainte.description}</p>
              </div>

              <div style={{ display: 'flex', gap: '0.5rem' }}>
                <button
                  onClick={onEdit}
                  style={{
                    background: plainte.couleur,
                    color: 'white',
                    border: 'none',
                    width: '40px',
                    height: '40px',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}
                >
                  <EditIcon />
                </button>
                <button
                  onClick={onDelete}
                  style={{
                    background: '#ef4444',
                    color: 'white',
                    border: 'none',
                    width: '40px',
                    height: '40px',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}
                >
                  <DeleteIcon />
                </button>
              </div>
            </div>
          </div>

          <div style={{
            display: 'flex',
            gap: '0.5rem',
            marginBottom: '1.5rem'
          }}>
            {['info', 'specialites', 'documents'].map(tab => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab)}
                style={{
                  background: activeTab === tab ? plainte.couleur : '#f1f5f9',
                  color: activeTab === tab ? 'white' : '#475569',
                  border: activeTab === tab ? 'none' : '2px solid #e2e8f0',
                  padding: '0.75rem 1.5rem',
                  borderRadius: '12px',
                  cursor: 'pointer',
                  fontWeight: 600,
                  transition: 'all 0.3s',
                  boxShadow: activeTab === tab ? '0 4px 20px rgba(0,0,0,0.15)' : 'none'
                }}
              >
                {tab === 'info' && 'Informations'}
                {tab === 'specialites' && `Sp√©cialit√©s (${plainte.specialites.length})`}
                {tab === 'documents' && `Documents (${(plainte.documents || []).length})`}
              </button>
            ))}
          </div>

          {activeTab === 'info' && (
            <InformationsTab
              plainte={plainte}
              onUpdateInfo={(val) => onUpdatePlainteInfo('informations', val)}
              handleImageURL={handleImageURL}
              couleur={plainte.couleur}
            />
          )}

          {activeTab === 'specialites' && (
            <SpecialitesTab
              plainte={plainte}
              onAddSpecialite={onAddSpecialite}
              onEditSpecialite={onEditSpecialite}
              onDeleteSpecialite={onDeleteSpecialite}
              onShowImportModal={onShowImportModal}
              setImageModalUrl={setImageModalUrl}
            />
          )}

          {activeTab === 'documents' && (
            <DocumentsTab
              plainte={plainte}
              onAddDocument={onAddDocument}
              onDeleteDocument={onDeleteDocument}
              onEditDocument={onEditDocument}
            />
          )}
        </div>
      );
    }

    function InformationsTab({ plainte, onUpdateInfo, handleImageURL, couleur }) {
      const [editing, setEditing] = useState(false);
      const [tempValue, setTempValue] = useState(plainte.informations || '');
      const [showHelp, setShowHelp] = useState(false);
      const [helpPinned, setHelpPinned] = useState(false);

      useEffect(() => {
        setTempValue(plainte.informations || '');
      }, [plainte.informations]);

      if (editing) {
        return (
          <div style={{ background: 'white', borderRadius: '20px', padding: '2rem', boxShadow: '0 4px 20px rgba(0,0,0,0.1)' }}>
            {/* NOUVEAU : Bouton d'aide avec tooltip au survol ET au clic */}
            <div style={{ position: 'relative', marginBottom: '1rem' }}>
              <div 
                onMouseEnter={() => !helpPinned && setShowHelp(true)}
                onMouseLeave={() => !helpPinned && setShowHelp(false)}
                onClick={() => {
                  setHelpPinned(!helpPinned);
                  setShowHelp(!helpPinned || showHelp);
                }}
                style={{
                  display: 'inline-flex',
                  alignItems: 'center',
                  gap: '0.5rem',
                  background: helpPinned ? '#3b82f6' : '#eff6ff',
                  border: '2px solid #3b82f6',
                  borderRadius: '8px',
                  padding: '0.5rem 1rem',
                  cursor: 'pointer',
                  fontSize: '0.9rem',
                  fontWeight: 600,
                  color: helpPinned ? 'white' : '#1e40af',
                  userSelect: 'none',
                  transition: 'all 0.2s'
                }}
              >
                üí° Aide pour les images {helpPinned && '(√âpingl√©)'}
              </div>

              {showHelp && (
                <div 
                  onMouseEnter={() => setShowHelp(true)}
                  onClick={(e) => e.stopPropagation()}
                  style={{
                    position: 'absolute',
                    top: '100%',
                    left: 0,
                    marginTop: '0.5rem',
                    background: '#eff6ff',
                    border: '2px solid #3b82f6',
                    borderRadius: '12px',
                    padding: '1.25rem',
                    fontSize: '0.85rem',
                    color: '#1e40af',
                    zIndex: 1000,
                    boxShadow: '0 8px 24px rgba(0,0,0,0.15)',
                    minWidth: '450px',
                    maxWidth: '550px',
                    lineHeight: '1.6',
                    userSelect: 'text',
                    cursor: 'default'
                  }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                    <strong style={{fontSize: '1rem'}}>üí° Contr√¥lez vos images !</strong>
                    {helpPinned && (
                      <button
                        onClick={() => {
                          setHelpPinned(false);
                          setShowHelp(false);
                        }}
                        style={{
                          background: '#ef4444',
                          color: 'white',
                          border: 'none',
                          width: '24px',
                          height: '24px',
                          borderRadius: '50%',
                          cursor: 'pointer',
                          fontSize: '0.8rem',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center'
                        }}
                      >
                        ‚úï
                      </button>
                    )}
                  </div>
                  <br/>
                  
                  <strong>Tailles :</strong><br/>
                  <code style={{background: 'rgba(255,255,255,0.6)', padding: '2px 6px', borderRadius: '4px', fontSize: '0.8rem'}}>[img-small]URL[/img-small]</code> ‚Üí 30%<br/>
                  <code style={{background: 'rgba(255,255,255,0.6)', padding: '2px 6px', borderRadius: '4px', fontSize: '0.8rem'}}>[img-medium]URL[/img-medium]</code> ‚Üí 50%<br/>
                  <code style={{background: 'rgba(255,255,255,0.6)', padding: '2px 6px', borderRadius: '4px', fontSize: '0.8rem'}}>[img-large]URL[/img-large]</code> ‚Üí 70%<br/>
                  <code style={{background: 'rgba(255,255,255,0.6)', padding: '2px 6px', borderRadius: '4px', fontSize: '0.8rem'}}>[img]URL[/img]</code> ‚Üí 100%<br/><br/>
                  
                  <strong>Images centr√©es :</strong><br/>
                  <code style={{background: 'rgba(255,255,255,0.6)', padding: '2px 6px', borderRadius: '4px', fontSize: '0.8rem'}}>[img-center-small]URL[/img-center-small]</code> ‚Üí 30% centr√©<br/>
                  <code style={{background: 'rgba(255,255,255,0.6)', padding: '2px 6px', borderRadius: '4px', fontSize: '0.8rem'}}>[img-center-medium]URL[/img-center-medium]</code> ‚Üí 50% centr√©<br/>
                  <code style={{background: 'rgba(255,255,255,0.6)', padding: '2px 6px', borderRadius: '4px', fontSize: '0.8rem'}}>[img-center-large]URL[/img-center-large]</code> ‚Üí 70% centr√©<br/>
                  <code style={{background: 'rgba(255,255,255,0.6)', padding: '2px 6px', borderRadius: '4px', fontSize: '0.8rem'}}>[img-center]URL[/img-center]</code> ‚Üí 100% centr√©<br/><br/>
                  
                  <strong>Plusieurs images c√¥te √† c√¥te :</strong><br/>
                  <code style={{background: 'rgba(255,255,255,0.6)', padding: '2px 6px', borderRadius: '4px', fontSize: '0.8rem', display: 'block', marginTop: '0.25rem'}}>
                    [row]<br/>
                    &nbsp;&nbsp;[img-small]URL1[/img-small]<br/>
                    &nbsp;&nbsp;[img-small]URL2[/img-small]<br/>
                    [/row]
                  </code>
                </div>
              )}
            </div>

            {/* BARRE D'OUTILS DE FORMATAGE */}
            <div style={{
              display: 'flex',
              flexWrap: 'wrap',
              gap: '0.5rem',
              marginBottom: '1rem',
              padding: '1rem',
              background: '#f8fafc',
              borderRadius: '12px',
              border: '2px solid #e2e8f0'
            }}>
              <button
                onClick={() => {
                  const textarea = document.querySelector('textarea');
                  const start = textarea.selectionStart;
                  const end = textarea.selectionEnd;
                  const selectedText = tempValue.substring(start, end);
                  if (selectedText) {
                    const newText = tempValue.substring(0, start) + '**' + selectedText + '**' + tempValue.substring(end);
                    setTempValue(newText);
                    setTimeout(() => {
                      textarea.focus();
                      textarea.setSelectionRange(start + 2, end + 2);
                    }, 0);
                  } else {
                    setTempValue(tempValue + '**texte en gras**');
                  }
                }}
                style={{
                  background: 'white',
                  border: '2px solid #e2e8f0',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: 'bold',
                  fontSize: '0.9rem'
                }}
                title="Gras"
              >
                <strong>B</strong>
              </button>

              <button
                onClick={() => {
                  const textarea = document.querySelector('textarea');
                  const start = textarea.selectionStart;
                  const end = textarea.selectionEnd;
                  const selectedText = tempValue.substring(start, end);
                  if (selectedText) {
                    const newText = tempValue.substring(0, start) + '*' + selectedText + '*' + tempValue.substring(end);
                    setTempValue(newText);
                    setTimeout(() => {
                      textarea.focus();
                      textarea.setSelectionRange(start + 1, end + 1);
                    }, 0);
                  } else {
                    setTempValue(tempValue + '*texte en italique*');
                  }
                }}
                style={{
                  background: 'white',
                  border: '2px solid #e2e8f0',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontStyle: 'italic',
                  fontSize: '0.9rem'
                }}
                title="Italique"
              >
                <em>I</em>
              </button>

              <button
                onClick={() => {
                  const textarea = document.querySelector('textarea');
                  const start = textarea.selectionStart;
                  const end = textarea.selectionEnd;
                  const selectedText = tempValue.substring(start, end);
                  if (selectedText) {
                    const newText = tempValue.substring(0, start) + '__' + selectedText + '__' + tempValue.substring(end);
                    setTempValue(newText);
                    setTimeout(() => {
                      textarea.focus();
                      textarea.setSelectionRange(start + 2, end + 2);
                    }, 0);
                  } else {
                    setTempValue(tempValue + '__texte soulign√©__');
                  }
                }}
                style={{
                  background: 'white',
                  border: '2px solid #e2e8f0',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  textDecoration: 'underline',
                  fontSize: '0.9rem'
                }}
                title="Soulign√©"
              >
                <u>U</u>
              </button>

              <button
                onClick={() => {
                  const textarea = document.querySelector('textarea');
                  const start = textarea.selectionStart;
                  const end = textarea.selectionEnd;
                  const selectedText = tempValue.substring(start, end);
                  if (selectedText) {
                    const newText = tempValue.substring(0, start) + '~~' + selectedText + '~~' + tempValue.substring(end);
                    setTempValue(newText);
                    setTimeout(() => {
                      textarea.focus();
                      textarea.setSelectionRange(start + 2, end + 2);
                    }, 0);
                  } else {
                    setTempValue(tempValue + '~~texte barr√©~~');
                  }
                }}
                style={{
                  background: 'white',
                  border: '2px solid #e2e8f0',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  textDecoration: 'line-through',
                  fontSize: '0.9rem'
                }}
                title="Barr√©"
              >
                <s>S</s>
              </button>

              <div style={{ width: '2px', background: '#cbd5e1' }}></div>

              <button
                onClick={() => {
                  const textarea = document.querySelector('textarea');
                  const start = textarea.selectionStart;
                  const end = textarea.selectionEnd;
                  const selectedText = tempValue.substring(start, end);
                  if (selectedText) {
                    const newText = tempValue.substring(0, start) + '[color-red]' + selectedText + '[/color-red]' + tempValue.substring(end);
                    setTempValue(newText);
                  } else {
                    setTempValue(tempValue + '[color-red]texte rouge[/color-red]');
                  }
                }}
                style={{
                  background: '#fecaca',
                  border: '2px solid #ef4444',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  color: '#dc2626',
                  fontWeight: 600,
                  fontSize: '0.85rem'
                }}
                title="Rouge"
              >
                üî¥
              </button>

              <button
                onClick={() => {
                  const textarea = document.querySelector('textarea');
                  const start = textarea.selectionStart;
                  const end = textarea.selectionEnd;
                  const selectedText = tempValue.substring(start, end);
                  if (selectedText) {
                    const newText = tempValue.substring(0, start) + '[color-blue]' + selectedText + '[/color-blue]' + tempValue.substring(end);
                    setTempValue(newText);
                  } else {
                    setTempValue(tempValue + '[color-blue]texte bleu[/color-blue]');
                  }
                }}
                style={{
                  background: '#bfdbfe',
                  border: '2px solid #3b82f6',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  color: '#1d4ed8',
                  fontWeight: 600,
                  fontSize: '0.85rem'
                }}
                title="Bleu"
              >
                üîµ
              </button>

              <button
                onClick={() => {
                  const textarea = document.querySelector('textarea');
                  const start = textarea.selectionStart;
                  const end = textarea.selectionEnd;
                  const selectedText = tempValue.substring(start, end);
                  if (selectedText) {
                    const newText = tempValue.substring(0, start) + '[color-green]' + selectedText + '[/color-green]' + tempValue.substring(end);
                    setTempValue(newText);
                  } else {
                    setTempValue(tempValue + '[color-green]texte vert[/color-green]');
                  }
                }}
                style={{
                  background: '#bbf7d0',
                  border: '2px solid #10b981',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  color: '#047857',
                  fontWeight: 600,
                  fontSize: '0.85rem'
                }}
                title="Vert"
              >
                üü¢
              </button>

              <button
                onClick={() => {
                  const textarea = document.querySelector('textarea');
                  const start = textarea.selectionStart;
                  const end = textarea.selectionEnd;
                  const selectedText = tempValue.substring(start, end);
                  if (selectedText) {
                    const newText = tempValue.substring(0, start) + '[color-orange]' + selectedText + '[/color-orange]' + tempValue.substring(end);
                    setTempValue(newText);
                  } else {
                    setTempValue(tempValue + '[color-orange]texte orange[/color-orange]');
                  }
                }}
                style={{
                  background: '#fed7aa',
                  border: '2px solid #f97316',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  color: '#c2410c',
                  fontWeight: 600,
                  fontSize: '0.85rem'
                }}
                title="Orange"
              >
                üü†
              </button>

              <div style={{ width: '2px', background: '#cbd5e1' }}></div>

              <button
                onClick={() => {
                  setTempValue(tempValue + '\n# Titre 1');
                }}
                style={{
                  background: 'white',
                  border: '2px solid #e2e8f0',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: 'bold',
                  fontSize: '1.1rem'
                }}
                title="Titre 1"
              >
                H1
              </button>

              <button
                onClick={() => {
                  setTempValue(tempValue + '\n## Titre 2');
                }}
                style={{
                  background: 'white',
                  border: '2px solid #e2e8f0',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: 'bold',
                  fontSize: '1rem'
                }}
                title="Titre 2"
              >
                H2
              </button>

              <button
                onClick={() => {
                  setTempValue(tempValue + '\n### Titre 3');
                }}
                style={{
                  background: 'white',
                  border: '2px solid #e2e8f0',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: 'bold',
                  fontSize: '0.9rem'
                }}
                title="Titre 3"
              >
                H3
              </button>

              <div style={{ width: '2px', background: '#cbd5e1' }}></div>

              <button
                onClick={() => {
                  setTempValue(tempValue + '\n- Point de liste');
                }}
                style={{
                  background: 'white',
                  border: '2px solid #e2e8f0',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontSize: '0.9rem'
                }}
                title="Liste √† puces"
              >
                ‚Ä¢ Liste
              </button>

              <button
                onClick={() => {
                  setTempValue(tempValue + '\n1. Premier point\n2. Deuxi√®me point');
                }}
                style={{
                  background: 'white',
                  border: '2px solid #e2e8f0',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontSize: '0.9rem'
                }}
                title="Liste num√©rot√©e"
              >
                1. Liste
              </button>
            </div>

            <textarea
              value={tempValue}
              onChange={(e) => setTempValue(e.target.value)}
              placeholder="D√©marche √† suivre, questions √† poser, sch√©ma, notes de cours..."
              style={{
                width: '100%',
                minHeight: '300px',
                padding: '1rem',
                border: `2px solid ${couleur}`,
                borderRadius: '12px',
                fontSize: '1rem',
                fontFamily: 'inherit',
                resize: 'vertical',
                marginBottom: '1rem'
              }}
            />

            <div style={{ display: 'flex', gap: '0.75rem', marginBottom: '1rem' }}>
              <button
                onClick={() => {
                  handleImageURL((url) => {
                    setTempValue(tempValue + '\n[img-medium]' + url + '[/img-medium]');
                  });
                }}
                style={{
                  background: '#f8fafc',
                  border: '2px solid #e2e8f0',
                  padding: '0.75rem 1.5rem',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: 600,
                  color: '#475569'
                }}
              >
                + Ajouter une image (URL)
              </button>
            </div>

            <div style={{ display: 'flex', gap: '0.75rem' }}>
              <button
                onClick={() => {
                  onUpdateInfo(tempValue);
                  setEditing(false);
                }}
                style={{
                  background: couleur,
                  color: 'white',
                  border: 'none',
                  padding: '0.75rem 1.5rem',
                  borderRadius: '12px',
                  fontWeight: 600,
                  cursor: 'pointer'
                }}
              >
                Enregistrer
              </button>
              <button
                onClick={() => {
                  setTempValue(plainte.informations || '');
                  setEditing(false);
                }}
                style={{
                  background: '#e2e8f0',
                  color: '#475569',
                  border: 'none',
                  padding: '0.75rem 1.5rem',
                  borderRadius: '12px',
                  fontWeight: 600,
                  cursor: 'pointer'
                }}
              >
                Annuler
              </button>
            </div>
          </div>
        );
      }

      return (
        <div style={{ background: 'white', borderRadius: '20px', padding: '2rem', boxShadow: '0 4px 20px rgba(0,0,0,0.1)', position: 'relative' }}>
          <button
            onClick={() => setEditing(true)}
            style={{
              position: 'absolute',
              top: '1.5rem',
              right: '1.5rem',
              background: couleur,
              color: 'white',
              border: 'none',
              width: '40px',
              height: '40px',
              borderRadius: '8px',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center'
            }}
          >
            <EditIcon />
          </button>

          {plainte.informations ? (
            <div style={{ color: '#1e293b', fontSize: '1rem', lineHeight: '1.8', paddingRight: '3rem' }}>
              {renderParsedContent(parseContent(plainte.informations, couleur), couleur)}
            </div>
          ) : (
            <p style={{ color: '#94a3b8', fontStyle: 'italic' }}>Cliquez sur l'ic√¥ne pour ajouter du contenu</p>
          )}
        </div>
      );
    }

    function SpecialitesTab({ plainte, onAddSpecialite, onEditSpecialite, onDeleteSpecialite, onShowImportModal, setImageModalUrl }) {
      return (
        <div>
          <div style={{ display: 'flex', gap: '0.75rem', marginBottom: '1.5rem' }}>
            <button
              onClick={onAddSpecialite}
              style={{
                flex: 1,
                background: plainte.couleur,
                color: 'white',
                border: 'none',
                padding: '1rem 2rem',
                borderRadius: '12px',
                fontWeight: 600,
                cursor: 'pointer',
                boxShadow: '0 4px 15px rgba(0,0,0,0.2)'
              }}
            >
              + Ajouter une sp√©cialit√©
            </button>
            {onShowImportModal && (
              <button
                onClick={onShowImportModal}
                style={{
                  background: '#3B82F6',
                  color: 'white',
                  border: 'none',
                  padding: '1rem 1.5rem',
                  borderRadius: '12px',
                  fontWeight: 600,
                  cursor: 'pointer',
                  boxShadow: '0 4px 15px rgba(59, 130, 246, 0.3)',
                  whiteSpace: 'nowrap'
                }}
                title="Importer depuis Flashcards"
              >
                üìã Import
              </button>
            )}
          </div>

          {plainte.specialites.length === 0 ? (
            <div style={{
              background: 'white',
              padding: '3rem',
              borderRadius: '16px',
              textAlign: 'center',
              color: '#64748b'
            }}>
              <p>Aucune sp√©cialit√© ajout√©e</p>
            </div>
          ) : (
            <div style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))',
              gap: '1.5rem'
            }}>
              {plainte.specialites.map(spec => (
                <SpecialiteCard
                  key={spec.id}
                  specialite={spec}
                  couleur={plainte.couleur}
                  onEdit={() => onEditSpecialite(spec)}
                  onDelete={() => onDeleteSpecialite(spec.id)}
                  setImageModalUrl={setImageModalUrl}
                />
              ))}
            </div>
          )}
        </div>
      );
    }

    function DocumentsTab({ plainte, onAddDocument, onDeleteDocument, onEditDocument }) {
      const [showAddModal, setShowAddModal] = useState(false);
      const [editingDoc, setEditingDoc] = useState(null);
      const [editName, setEditName] = useState('');
      const [editUrl, setEditUrl] = useState('');
      const [editCategory, setEditCategory] = useState('');
      const [linkName, setLinkName] = useState('');
      const [linkUrl, setLinkUrl] = useState('');
      const [linkCategory, setLinkCategory] = useState('');
      const [showCategoryManager, setShowCategoryManager] = useState(false);
      const [docCategories, setDocCategories] = useState(() => {
        const saved = localStorage.getItem('docCategories_' + plainte.id);
        return saved ? JSON.parse(saved) : ['G√©n√©raux', 'Protocoles', '√âtudes'];
      });
      const [newCategory, setNewCategory] = useState('');
      const [editingCategory, setEditingCategory] = useState(null);
      const [editCategoryName, setEditCategoryName] = useState('');

      // Sauvegarder les cat√©gories dans localStorage
      React.useEffect(() => {
        localStorage.setItem('docCategories_' + plainte.id, JSON.stringify(docCategories));
      }, [docCategories, plainte.id]);

      const handleAddLink = () => {
        if (!linkName.trim() || !linkUrl.trim()) {
          alert('Nom et URL sont obligatoires');
          return;
        }
        if (!linkUrl.startsWith('http')) {
          alert("L'URL doit commencer par http:// ou https://");
          return;
        }

        onAddDocument({
          type: 'link',
          nom: linkName,
          data: linkUrl,
          category: linkCategory || 'G√©n√©raux'
        });

        setLinkName('');
        setLinkUrl('');
        setLinkCategory('');
        setShowAddModal(false);
      };

      const handleAddCategory = () => {
        if (!newCategory.trim()) {
          alert('Le nom de la cat√©gorie ne peut pas √™tre vide');
          return;
        }
        if (docCategories.includes(newCategory.trim())) {
          alert('Cette cat√©gorie existe d√©j√†');
          return;
        }
        setDocCategories([...docCategories, newCategory.trim()]);
        setNewCategory('');
      };

      const handleEditCategory = (oldName, newName) => {
        if (!newName.trim()) {
          alert('Le nom de la cat√©gorie ne peut pas √™tre vide');
          return;
        }
        if (oldName !== newName && docCategories.includes(newName)) {
          alert('Cette cat√©gorie existe d√©j√†');
          return;
        }
        setDocCategories(docCategories.map(cat => cat === oldName ? newName : cat));
        setEditingCategory(null);
        setEditCategoryName('');
      };

      const handleDeleteCategory = (categoryName) => {
        const docsInCategory = (plainte.documents || []).filter(doc => (doc.category || 'G√©n√©raux') === categoryName).length;
        if (docsInCategory > 0) {
          if (!confirm(`${docsInCategory} document(s) sont dans cette cat√©gorie. Supprimer quand m√™me ? (Les documents seront d√©plac√©s vers "G√©n√©raux")`)) {
            return;
          }
        }
        setDocCategories(docCategories.filter(cat => cat !== categoryName));
      };

      const openDocument = (doc) => {
        window.open(doc.data, '_blank');
      };

      // Grouper les documents par cat√©gorie (recalcul√© quand plainte.documents ou docCategories changent)
      const groupedDocs = React.useMemo(() => {
        const grouped = {};
        docCategories.forEach(cat => {
          grouped[cat] = (plainte.documents || []).filter(doc => (doc.category || 'G√©n√©raux') === cat);
        });
        // Ajouter les documents sans cat√©gorie ou avec cat√©gorie supprim√©e
        const uncategorized = (plainte.documents || []).filter(doc => !docCategories.includes(doc.category || 'G√©n√©raux'));
        if (uncategorized.length > 0) {
          grouped['G√©n√©raux'] = [...(grouped['G√©n√©raux'] || []), ...uncategorized];
        }
        return grouped;
      }, [plainte.documents, docCategories]);

      return (
        <div>
          <div style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem' }}>
            <button
              onClick={() => setShowAddModal(true)}
              style={{
                background: plainte.couleur,
                color: 'white',
                border: 'none',
                padding: '1rem 2rem',
                borderRadius: '12px',
                fontWeight: 600,
                cursor: 'pointer',
                boxShadow: '0 4px 15px rgba(0,0,0,0.2)',
                flex: 1
              }}
            >
              + Ajouter un lien
            </button>
            <button
              onClick={() => setShowCategoryManager(true)}
              style={{
                background: '#64748b',
                color: 'white',
                border: 'none',
                padding: '1rem 2rem',
                borderRadius: '12px',
                fontWeight: 600,
                cursor: 'pointer',
                boxShadow: '0 4px 15px rgba(0,0,0,0.2)'
              }}
            >
              üìÅ Cat√©gories
            </button>
          </div>

          {/* MODAL GESTIONNAIRE DE CAT√âGORIES */}
          {showCategoryManager && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.5)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 1000
            }}>
              <div 
                onClick={(e) => e.stopPropagation()}
                style={{
                  background: 'white',
                  borderRadius: '20px',
                  padding: '2rem',
                  maxWidth: '500px',
                  width: '90%',
                  maxHeight: '80vh',
                  overflow: 'auto'
                }}>
                <h3 style={{ marginBottom: '1.5rem', color: '#1e293b' }}>G√©rer les cat√©gories</h3>

                {/* Ajouter nouvelle cat√©gorie */}
                <div style={{ marginBottom: '1.5rem', padding: '1rem', background: '#f8fafc', borderRadius: '12px' }}>
                  <h4 style={{ marginBottom: '0.75rem', color: '#475569', fontSize: '0.9rem' }}>Ajouter une cat√©gorie</h4>
                  <div style={{ display: 'flex', gap: '0.5rem' }}>
                    <input
                      type="text"
                      placeholder="Nom de la cat√©gorie"
                      value={newCategory}
                      onChange={(e) => setNewCategory(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && handleAddCategory()}
                      style={{
                        flex: 1,
                        padding: '0.75rem',
                        border: '2px solid #e2e8f0',
                        borderRadius: '8px'
                      }}
                    />
                    <button
                      onClick={handleAddCategory}
                      style={{
                        background: '#10B981',
                        color: 'white',
                        border: 'none',
                        padding: '0.75rem 1.5rem',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontWeight: 600
                      }}
                    >
                      Ajouter
                    </button>
                  </div>
                </div>

                {/* Liste des cat√©gories */}
                <div style={{ marginBottom: '1rem' }}>
                  <h4 style={{ marginBottom: '0.75rem', color: '#475569', fontSize: '0.9rem' }}>Cat√©gories existantes</h4>
                  {docCategories.map(cat => {
                    const docsCount = (plainte.documents || []).filter(doc => (doc.category || 'G√©n√©raux') === cat).length;
                    return editingCategory === cat ? (
                      <div key={cat} style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.5rem' }}>
                        <input
                          type="text"
                          value={editCategoryName}
                          onChange={(e) => setEditCategoryName(e.target.value)}
                          onKeyPress={(e) => e.key === 'Enter' && handleEditCategory(cat, editCategoryName)}
                          style={{
                            flex: 1,
                            padding: '0.5rem',
                            border: '2px solid #3B82F6',
                            borderRadius: '6px'
                          }}
                          autoFocus
                        />
                        <button
                          onClick={() => handleEditCategory(cat, editCategoryName)}
                          style={{
                            background: '#3B82F6',
                            color: 'white',
                            border: 'none',
                            padding: '0.5rem 1rem',
                            borderRadius: '6px',
                            cursor: 'pointer'
                          }}
                        >
                          ‚úì
                        </button>
                        <button
                          onClick={() => {
                            setEditingCategory(null);
                            setEditCategoryName('');
                          }}
                          style={{
                            background: '#e2e8f0',
                            color: '#475569',
                            border: 'none',
                            padding: '0.5rem 1rem',
                            borderRadius: '6px',
                            cursor: 'pointer'
                          }}
                        >
                          ‚úï
                        </button>
                      </div>
                    ) : (
                      <div key={cat} style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between',
                        padding: '0.75rem',
                        background: 'white',
                        border: '2px solid #e2e8f0',
                        borderRadius: '8px',
                        marginBottom: '0.5rem'
                      }}>
                        <span style={{ fontWeight: 500 }}>
                          {cat} <span style={{ color: '#94a3b8', fontSize: '0.85rem' }}>({docsCount})</span>
                        </span>
                        <div style={{ display: 'flex', gap: '0.5rem' }}>
                          <button
                            onClick={() => {
                              setEditingCategory(cat);
                              setEditCategoryName(cat);
                            }}
                            style={{
                              background: '#f1f5f9',
                              color: '#475569',
                              border: 'none',
                              padding: '0.4rem 0.8rem',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontSize: '0.85rem'
                            }}
                          >
                            ‚úèÔ∏è
                          </button>
                          <button
                            onClick={() => handleDeleteCategory(cat)}
                            style={{
                              background: '#fee2e2',
                              color: '#dc2626',
                              border: 'none',
                              padding: '0.4rem 0.8rem',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontSize: '0.85rem'
                            }}
                          >
                            üóëÔ∏è
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>

                <button
                  onClick={() => setShowCategoryManager(false)}
                  style={{
                    width: '100%',
                    background: '#e2e8f0',
                    color: '#475569',
                    border: 'none',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontWeight: 600
                  }}
                >
                  Fermer
                </button>
              </div>
            </div>
          )}

          {showAddModal && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.5)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 1000
            }}>
              <div 
                onClick={(e) => e.stopPropagation()}
                style={{
                  background: 'white',
                  borderRadius: '20px',
                  padding: '2rem',
                  maxWidth: '500px',
                  width: '90%'
                }}>
                <h3 style={{ marginBottom: '1.5rem', color: '#1e293b' }}>Ajouter un lien</h3>

                <input
                  type="text"
                  placeholder="Nom du lien"
                  value={linkName}
                  onChange={(e) => setLinkName(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid #e2e8f0',
                    borderRadius: '8px',
                    marginBottom: '1rem'
                  }}
                />
                <input
                  type="text"
                  placeholder="https://drive.google.com/..."
                  value={linkUrl}
                  onChange={(e) => setLinkUrl(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid #e2e8f0',
                    borderRadius: '8px',
                    marginBottom: '1rem'
                  }}
                />
                <select
                  value={linkCategory}
                  onChange={(e) => setLinkCategory(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid #e2e8f0',
                    borderRadius: '8px',
                    marginBottom: '1rem',
                    cursor: 'pointer'
                  }}
                >
                  {docCategories.map(cat => (
                    <option key={cat} value={cat}>{cat}</option>
                  ))}
                </select>
                <button
                  onClick={handleAddLink}
                  style={{
                    width: '100%',
                    background: plainte.couleur,
                    color: 'white',
                    border: 'none',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontWeight: 600,
                    marginBottom: '0.75rem'
                  }}
                >
                  Ajouter le lien
                </button>

                <button
                  onClick={() => setShowAddModal(false)}
                  style={{
                    width: '100%',
                    background: '#e2e8f0',
                    color: '#475569',
                    border: 'none',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontWeight: 600
                  }}
                >
                  Annuler
                </button>
              </div>
            </div>
          )}

          {/* MODAL √âDITION */}
          {editingDoc && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.5)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 1000
            }}>
              <div 
                onClick={(e) => e.stopPropagation()}
                style={{
                  background: 'white',
                  borderRadius: '20px',
                  padding: '2rem',
                  maxWidth: '500px',
                  width: '90%'
                }}>
                <h3 style={{ marginBottom: '1.5rem', color: '#1e293b' }}>Modifier le lien</h3>

                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, fontSize: '0.9rem', color: '#64748b' }}>
                  Nom du lien
                </label>
                <input
                  type="text"
                  placeholder="Nom du lien"
                  value={editName}
                  onChange={(e) => setEditName(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid #e2e8f0',
                    borderRadius: '8px',
                    marginBottom: '1rem'
                  }}
                />

                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, fontSize: '0.9rem', color: '#64748b' }}>
                  URL du lien
                </label>
                <input
                  type="text"
                  placeholder="https://..."
                  value={editUrl}
                  onChange={(e) => setEditUrl(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid #e2e8f0',
                    borderRadius: '8px',
                    marginBottom: '1rem'
                  }}
                />

                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, fontSize: '0.9rem', color: '#64748b' }}>
                  Cat√©gorie
                </label>
                <select
                  value={editCategory}
                  onChange={(e) => setEditCategory(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid #e2e8f0',
                    borderRadius: '8px',
                    marginBottom: '1rem',
                    cursor: 'pointer'
                  }}
                >
                  {docCategories.map(cat => (
                    <option key={cat} value={cat}>{cat}</option>
                  ))}
                </select>

                <button
                  onClick={() => {
                    if (!editName.trim()) {
                      alert('Le nom ne peut pas √™tre vide');
                      return;
                    }
                    if (!editUrl.trim() || !editUrl.startsWith('http')) {
                      alert('L\'URL doit commencer par http:// ou https://');
                      return;
                    }
                    onEditDocument(editingDoc.id, editName, editUrl, editCategory);
                    setEditingDoc(null);
                    setEditName('');
                    setEditUrl('');
                    setEditCategory('');
                  }}
                  style={{
                    width: '100%',
                    background: plainte.couleur,
                    color: 'white',
                    border: 'none',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontWeight: 600,
                    marginBottom: '0.75rem'
                  }}
                >
                  Enregistrer
                </button>

                <button
                  onClick={() => {
                    setEditingDoc(null);
                    setEditName('');
                    setEditUrl('');
                    setEditCategory('');
                  }}
                  style={{
                    width: '100%',
                    background: '#e2e8f0',
                    color: '#475569',
                    border: 'none',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontWeight: 600
                  }}
                >
                  Annuler
                </button>
              </div>
            </div>
          )}

          {(plainte.documents || []).length === 0 ? (
            <div style={{
              background: 'white',
              padding: '3rem',
              borderRadius: '16px',
              textAlign: 'center',
              color: '#64748b'
            }}>
              <p>Aucun lien ajout√©</p>
            </div>
          ) : (
            <div>
              {docCategories.map(category => {
                const docsInCategory = groupedDocs[category] || [];
                if (docsInCategory.length === 0) return null;
                
                return (
                  <div key={category} style={{ marginBottom: '2rem' }}>
                    <h3 style={{
                      color: plainte.couleur,
                      fontSize: '1.1rem',
                      fontWeight: 600,
                      marginBottom: '1rem',
                      paddingBottom: '0.5rem',
                      borderBottom: `2px solid ${plainte.couleur}40`
                    }}>
                      üìÅ {category} <span style={{ color: '#94a3b8', fontSize: '0.85rem', fontWeight: 400 }}>({docsInCategory.length})</span>
                    </h3>
                    <div style={{
                      display: 'grid',
                      gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))',
                      gap: '1rem'
                    }}>
                      {docsInCategory.map(doc => (
                        <div
                          key={doc.id}
                          style={{
                            background: 'white',
                            borderRadius: '12px',
                            padding: '1.5rem',
                            boxShadow: '0 4px 20px rgba(0,0,0,0.1)',
                            border: '2px solid #33415540',
                            position: 'relative',
                            cursor: 'pointer',
                            transition: 'transform 0.2s, box-shadow 0.2s'
                          }}
                          onClick={() => openDocument(doc)}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.transform = 'translateY(-4px)';
                            e.currentTarget.style.boxShadow = '0 8px 30px rgba(0,0,0,0.15)';
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.transform = 'translateY(0)';
                            e.currentTarget.style.boxShadow = '0 4px 20px rgba(0,0,0,0.1)';
                          }}
                        >
                          <div style={{ position: 'absolute', top: '0.5rem', right: '0.5rem', display: 'flex', gap: '0.25rem' }}>
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                setEditingDoc(doc);
                                setEditName(doc.nom);
                                setEditUrl(doc.data);
                                setEditCategory(doc.category || 'G√©n√©raux');
                              }}
                              style={{
                                background: '#3B82F6',
                                color: 'white',
                                border: 'none',
                                width: '28px',
                                height: '28px',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '0.8rem'
                              }}
                            >
                              ‚úé
                            </button>
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                onDeleteDocument(doc.id);
                              }}
                              style={{
                                background: '#ef4444',
                                color: 'white',
                                border: 'none',
                                width: '28px',
                                height: '28px',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '0.8rem'
                              }}
                            >
                              <DeleteIcon />
                            </button>
                          </div>

                          {/* FAVICON DU SITE */}
                          <div style={{
                            width: '80px',
                            height: '80px',
                            margin: '0 auto 1rem',
                            borderRadius: '12px',
                            background: `linear-gradient(135deg, ${plainte.couleur}20, ${plainte.couleur}40)`,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            border: `2px solid ${plainte.couleur}60`
                          }}>
                            <img
                              src={`https://www.google.com/s2/favicons?domain=${new URL(doc.data).hostname}&sz=64`}
                              alt="favicon"
                              style={{
                                width: '48px',
                                height: '48px'
                              }}
                              onError={(e) => {
                                e.target.style.display = 'none';
                                e.target.parentElement.innerHTML = '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>';
                              }}
                            />
                          </div>

                          <div style={{
                            color: '#1e293b',
                            fontWeight: 600,
                            fontSize: '0.95rem',
                            textAlign: 'center',
                            wordBreak: 'break-word',
                            marginBottom: '0.5rem'
                          }}>
                            {doc.nom}
                          </div>
                          
                          <div style={{
                            color: '#64748b',
                            fontSize: '0.75rem',
                            textAlign: 'center',
                            wordBreak: 'break-all',
                            opacity: 0.7
                          }}>
                            {new URL(doc.data).hostname}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    }

    function SpecialiteCard({ specialite, couleur, onEdit, onDelete, setImageModalUrl }) {
      const pharmaData = getPharmaQuizzMed(specialite.dci);

      return (
        <div style={{
          background: 'white',
          borderRadius: '12px',
          padding: '1.25rem',
          boxShadow: '0 4px 20px rgba(0,0,0,0.1)',
          border: `2px solid ${couleur}40`,
          position: 'relative'
        }}>
          <div style={{
            position: 'absolute',
            top: '0.75rem',
            right: '0.75rem',
            display: 'flex',
            gap: '0.5rem'
          }}>
            <button onClick={onEdit} style={{
              background: couleur,
              color: 'white',
              border: 'none',
              width: '32px',
              height: '32px',
              borderRadius: '6px',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center'
            }}>
              <EditIcon />
            </button>
            <button onClick={onDelete} style={{
              background: '#ef4444',
              color: 'white',
              border: 'none',
              width: '32px',
              height: '32px',
              borderRadius: '6px',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center'
            }}>
              <DeleteIcon />
            </button>
          </div>

          {(() => {
            const images = specialite.imageUrls && specialite.imageUrls.length > 0 
              ? specialite.imageUrls.filter(img => img && img.trim() !== '')
              : (specialite.image ? [specialite.image] : []);
            
            return images.length > 0 ? (
              <div style={{
                display: 'flex',
                gap: '0.5rem',
                marginBottom: '1rem',
                flexWrap: 'wrap'
              }}>
                {images.map((img, idx) => (
                  <div key={idx} style={{
                    width: images.length === 1 ? '100%' : 'calc(50% - 0.25rem)',
                    height: '140px',
                    borderRadius: '8px',
                    overflow: 'hidden',
                    border: `2px solid ${couleur}`,
                    background: '#f8fafc'
                  }}>
                    <img 
                      src={img} 
                      alt={`${specialite.nomCommercial} ${idx + 1}`} 
                      style={{
                        width: '100%',
                        height: '100%',
                        objectFit: 'cover',
                        cursor: 'pointer'
                      }} 
                      onClick={() => setImageModalUrl(img)}
                      onError={(e) => e.target.style.display = 'none'} 
                    />
                  </div>
                ))}
              </div>
            ) : null;
          })()}

          <h4 style={{
            color: '#1e293b',
            fontSize: '1.2rem',
            marginBottom: '0.5rem',
            fontWeight: 600,
            paddingRight: '4rem'
          }}>{specialite.nomCommercial || specialite.dci}</h4>

          {specialite.dci && specialite.nomCommercial && (
            <div style={{ marginBottom: '0.75rem', fontSize: '0.9rem', color: '#64748b' }}>
              {specialite.dci}
            </div>
          )}

          {pharmaData && (
            <div style={{
              display: 'inline-flex',
              alignItems: 'center',
              gap: '0.5rem',
              padding: '0.4rem 0.8rem',
              background: pharmaData.couleur || '#667eea',
              color: 'white',
              borderRadius: '20px',
              fontSize: '0.75rem',
              fontWeight: 600,
              marginBottom: '0.75rem'
            }}>
              {pharmaData.classe || 'PharmaQuizz'}
            </div>
          )}

          {specialite.formePharma && (
            <div style={{
              padding: '0.75rem',
              background: '#f3f4f6',
              borderRadius: '6px',
              marginBottom: '0.5rem',
              fontSize: '0.85rem',
              color: '#374151'
            }}>
              <strong>Forme pharmaceutique</strong> {specialite.formePharma}
            </div>
          )}

          {specialite.posologie && (
            <div style={{
              padding: '0.75rem',
              background: '#f0fdf4',
              borderRadius: '6px',
              marginBottom: '0.5rem',
              fontSize: '0.85rem',
              color: '#065f46',
              whiteSpace: 'pre-wrap'
            }}>
              <strong>Posologie</strong> {specialite.posologie}
            </div>
          )}

          {specialite.conseils && (
            <div style={{
              padding: '0.75rem',
              background: '#eff6ff',
              borderRadius: '6px',
              marginBottom: '0.5rem',
              fontSize: '0.85rem',
              color: '#1e40af'
            }}>
              <strong>Conseils</strong> {specialite.conseils}
            </div>
          )}

          {specialite.contreIndications && (
            <div style={{
              padding: '0.75rem',
              background: '#fef2f2',
              borderRadius: '6px',
              marginBottom: '0.5rem',
              fontSize: '0.85rem',
              color: '#991b1b'
            }}>
              <strong>CI</strong> {specialite.contreIndications}
            </div>
          )}

          {specialite.notes && (
            <div style={{
              padding: '0.75rem',
              background: '#fefce8',
              borderRadius: '6px',
              fontSize: '0.85rem',
              color: '#854d0e'
            }}>
              <strong>Notes</strong> {specialite.notes}
            </div>
          )}
        </div>
      );
    }

    function FormSpecialite({ specialite, onSave, onCancel, handleImageUpload, handleImageURL, plainte, medications }) {
      // Initialisation des images pour le mode √©dition
      // Utiliser allImageUrls (toutes les images) plut√¥t que imageUrls (seulement les s√©lectionn√©es)
      const initImages = specialite && specialite.allImageUrls && specialite.allImageUrls.length > 0
        ? specialite.allImageUrls.filter(img => img && img.trim() !== '')
        : (specialite && specialite.imageUrls ? specialite.imageUrls.filter(img => img && img.trim() !== '') : []);
      const initForms = specialite && specialite.formePharma ? specialite.formePharma.split(',').map(f => f.trim()) : [];
      
      // Calculer les index des images actuellement s√©lectionn√©es
      const initSelectedIndexes = specialite && specialite.imageUrls && initImages.length > 0
        ? specialite.imageUrls
            .filter(img => img && img.trim() !== '')
            .map(selectedImg => initImages.findIndex(img => img === selectedImg))
            .filter(idx => idx !== -1)
        : initImages.map((_, i) => i);
      
      const [formData, setFormData] = useState(specialite ? {
        ...specialite,
        selectedImages: initSelectedIndexes // Images actuellement s√©lectionn√©es
      } : {
        nomCommercial: '',
        dci: '',
        image: null,
        imageUrls: [],
        allImageUrls: [],
        selectedImages: [],
        posologie: '',
        conseils: '',
        contreIndications: '',
        notes: '',
        formePharma: ''
      });

      const [originalImages, setOriginalImages] = useState(initImages);
      const [originalForms, setOriginalForms] = useState(initForms);

      return (
        <div style={{ maxWidth: 'none', margin: '0', padding: '0 2rem' }}>
          <div style={{
            background: 'white',
            borderRadius: '20px',
            padding: '2rem',
            boxShadow: '0 10px 40px rgba(0,0,0,0.1)',
            maxWidth: '800px',
            margin: '0 auto'
          }}>
            <h2 style={{ marginBottom: '1rem', color: '#1e293b' }}>
              {specialite ? 'Modifier' : 'Ajouter une sp√©cialit√©'}
            </h2>

            {/* IMPORT DEPUIS FLASHCARD */}
            <div style={{ marginBottom: '1.5rem', padding: '1rem', background: '#F0F9FF', borderRadius: '12px', border: '2px solid #3B82F6' }}>
              <label style={{ display: 'block', marginBottom: '0.75rem', fontWeight: 600, color: '#1e293b' }}>
                üìö Importer depuis mes flashcards
              </label>
              <select
                value=""
                onChange={(e) => {
                  if (e.target.value !== '') {
                    const selectedIndex = parseInt(e.target.value);
                    const sortedMeds = medications.sort((a, b) => a.dci.localeCompare(b.dci));
                    const med = sortedMeds[selectedIndex];
                    
                    if (med) {
                      // R√©cup√©rer TOUTES les images et formes
                      const allImages = med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []));
                      const allForms = med.pharmaceuticalForm ? med.pharmaceuticalForm.split(',').map(f => f.trim()) : [];
                      
                      setOriginalImages(allImages);
                      setOriginalForms(allForms);
                      setFormData({
                        nomCommercial: med.commercial[0] || '',
                        dci: med.dci,
                        image: allImages.length > 0 ? allImages[0] : null,
                        imageUrls: allImages,
                        allImageUrls: allImages, // Sauvegarder TOUTES les images
                        selectedImages: allImages.map((_, i) => i),
                        formePharma: allForms.join(', '),
                        posologie: '',
                        conseils: '',
                        contreIndications: '',
                        notes: ''
                      });
                    }
                  }
                }}
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #3B82F6',
                  borderRadius: '8px',
                  fontSize: '0.9rem',
                  cursor: 'pointer',
                  background: 'white'
                }}
              >
                <option value="">-- S√©lectionner un m√©dicament --</option>
                {medications.sort((a, b) => a.dci.localeCompare(b.dci)).map((med, idx) => (
                  <option key={idx} value={idx}>
                    {med.dci} ({med.commercial.join(', ')})
                  </option>
                ))}
              </select>
              <div style={{ fontSize: '0.75rem', color: '#64748b', marginTop: '0.5rem', fontStyle: 'italic' }}>
                üí° Cliquer ici pour importer les infos d'un m√©dicament de vos flashcards
              </div>

              {/* S√âLECTION DES IMAGES */}
              {originalImages && originalImages.length > 0 && (
                <div style={{ marginTop: '1rem', padding: '1rem', background: 'white', borderRadius: '8px', border: '2px solid #e2e8f0' }}>
                  <div style={{ fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.75rem', color: '#1e293b' }}>
                    ‚úì S√©lectionnez les images √† afficher ({formData.selectedImages?.length || 0}/{originalImages.length})
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))', gap: '0.75rem' }}>
                    {originalImages.map((url, idx) => {
                      const isSelected = formData.selectedImages?.includes(idx);
                      return (
                        <div
                          key={idx}
                          onClick={(e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            const selected = formData.selectedImages || [];
                            const newSelected = isSelected
                              ? selected.filter(i => i !== idx)
                              : [...selected, idx];
                            
                            // R√©cup√©rer les images et formes correspondantes
                            const selectedImages = newSelected.map(i => originalImages[i]);
                            const selectedForms = newSelected
                              .map(i => originalForms[i])
                              .filter(f => f)
                              .join(', ');
                            
                            setFormData({
                              ...formData,
                              selectedImages: newSelected,
                              imageUrls: selectedImages,
                              image: selectedImages.length > 0 ? selectedImages[0] : null,
                              formePharma: selectedForms
                            });
                          }}
                          style={{
                            position: 'relative',
                            cursor: 'pointer',
                            border: `3px solid ${isSelected ? '#10B981' : '#e2e8f0'}`,
                            borderRadius: '8px',
                            overflow: 'hidden',
                            background: isSelected ? '#D1FAE5' : '#f8fafc',
                            transition: 'all 0.2s'
                          }}
                        >
                          <img
                            src={url}
                            alt={`Image ${idx + 1}`}
                            style={{
                              width: '100%',
                              height: '120px',
                              objectFit: 'cover',
                              opacity: isSelected ? 1 : 0.5
                            }}
                          />
                          <div style={{
                            position: 'absolute',
                            top: '0.5rem',
                            right: '0.5rem',
                            width: '24px',
                            height: '24px',
                            borderRadius: '50%',
                            background: isSelected ? '#10B981' : 'white',
                            border: `2px solid ${isSelected ? '#10B981' : '#cbd5e1'}`,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: 'white',
                            fontSize: '0.75rem',
                            fontWeight: 700
                          }}>
                            {isSelected ? '‚úì' : ''}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' }}>
              <div>
                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Nom commercial</label>
                <input
                  type="text"
                  value={formData.nomCommercial}
                  onChange={(e) => setFormData({ ...formData, nomCommercial: e.target.value })}
                  placeholder="Ex: Dafalgan"
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid #e2e8f0',
                    borderRadius: '8px'
                  }}
                />
              </div>
              <div>
                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>DCI *</label>
                <input
                  type="text"
                  value={formData.dci}
                  onChange={(e) => setFormData({ ...formData, dci: e.target.value })}
                  placeholder="Ex: Parac√©tamol"
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid #e2e8f0',
                    borderRadius: '8px'
                  }}
                />
              </div>
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>üíä Forme pharmaceutique</label>
              <input
                type="text"
                value={formData.formePharma}
                onChange={(e) => setFormData({ ...formData, formePharma: e.target.value })}
                placeholder="Ex: Comprim√©, Sirop, Spray..."
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px'
                }}
              />
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Images de la bo√Æte</label>
              
              <button
                type="button"
                onClick={() => {
                  handleImageURL((url) => {
                    const currentImages = formData.imageUrls || [];
                    setFormData({ 
                      ...formData, 
                      imageUrls: [...currentImages, url],
                      image: currentImages.length === 0 ? url : formData.image
                    });
                  });
                }}
                style={{
                  width: '100%',
                  padding: '1rem',
                  border: '2px dashed #3B82F6',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  background: '#EFF6FF',
                  color: '#3B82F6',
                  fontWeight: 600,
                  marginBottom: '1rem'
                }}
              >
                + Ajouter une image par URL
              </button>

              {formData.imageUrls && formData.imageUrls.length > 0 && (
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(120px, 1fr))', gap: '0.75rem' }}>
                  {formData.imageUrls.filter(img => img && img.trim() !== '').map((img, idx) => (
                    <div key={idx} style={{ position: 'relative' }}>
                      <img
                        src={img}
                        alt={`Image ${idx + 1}`}
                        style={{
                          width: '100%',
                          height: '120px',
                          objectFit: 'cover',
                          borderRadius: '8px',
                          border: '2px solid #e2e8f0',
                          cursor: 'pointer'
                        }}
                        onClick={() => setFormData({ ...formData, zoomedImage: img })}
                      />
                      <button
                        type="button"
                        onClick={() => {
                          const newImages = formData.imageUrls.filter((_, i) => i !== idx);
                          setFormData({ 
                            ...formData, 
                            imageUrls: newImages,
                            image: newImages.length > 0 ? newImages[0] : null
                          });
                        }}
                        style={{
                          position: 'absolute',
                          top: '-8px',
                          right: '-8px',
                          background: '#ef4444',
                          color: 'white',
                          border: 'none',
                          width: '24px',
                          height: '24px',
                          borderRadius: '50%',
                          cursor: 'pointer',
                          fontSize: '0.7rem'
                        }}
                      >
                        ‚úï
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Posologie</label>
              <textarea
                value={formData.posologie}
                onChange={(e) => setFormData({ ...formData, posologie: e.target.value })}
                placeholder="Ex: Adultes: 1 cp toutes les 6h&#10;Enfants: 15mg/kg/6h"
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px',
                  minHeight: '100px',
                  fontFamily: 'inherit'
                }}
              />
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Conseils</label>
              <textarea
                value={formData.conseils}
                onChange={(e) => setFormData({ ...formData, conseils: e.target.value })}
                placeholder="Ex: Avec de l'eau, pendant les repas"
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px',
                  minHeight: '60px',
                  fontFamily: 'inherit'
                }}
              />
            </div>

            <div style={{ marginBottom: '1.5rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Contre-indications</label>
              <textarea
                value={formData.contreIndications}
                onChange={(e) => setFormData({ ...formData, contreIndications: e.target.value })}
                placeholder="Ex: Insuffisance h√©patique"
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px',
                  minHeight: '60px',
                  fontFamily: 'inherit'
                }}
              />
            </div>

            <div style={{ marginBottom: '2rem' }}>
              <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>Notes</label>
              <textarea
                value={formData.notes}
                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                placeholder="Ex: Rayon 3, tr√®s demand√©"
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px',
                  minHeight: '60px',
                  fontFamily: 'inherit'
                }}
              />
            </div>

            <div style={{ display: 'flex', gap: '1rem' }}>
              <button
                onClick={() => {
                  if (!formData.dci?.trim()) {
                    alert('La DCI est obligatoire');
                    return;
                  }
                  // Filtrer les images selon la s√©lection
                  // formData.imageUrls contient d√©j√† les images s√©lectionn√©es (mises √† jour dans le onChange)
                  const filteredData = {
                    ...formData,
                    imageUrls: (formData.imageUrls || []).filter(img => img && img.trim() !== ''),
                    allImageUrls: originalImages.length > 0 ? originalImages : (formData.allImageUrls || []), // Garder TOUTES les images
                    image: formData.imageUrls && formData.imageUrls.length > 0
                      ? formData.imageUrls[0]
                      : formData.image
                  };
                  onSave(filteredData);
                }}
                style={{
                  flex: 1,
                  background: plainte.couleur,
                  color: 'white',
                  border: 'none',
                  padding: '1rem',
                  borderRadius: '12px',
                  fontWeight: 600,
                  cursor: 'pointer'
                }}
              >
                {specialite ? 'Enregistrer' : 'Ajouter'}
              </button>
              <button
                onClick={onCancel}
                style={{
                  flex: 1,
                  background: '#e2e8f0',
                  color: '#475569',
                  border: 'none',
                  padding: '1rem',
                  borderRadius: '12px',
                  fontWeight: 600,
                  cursor: 'pointer'
                }}
              >
                Annuler
              </button>
            </div>
          </div>
        </div>
      );
    }
    // ========== FIN CODE CONSEILS OFFICINE ==========



    // IC√îNES SVG
    const BookOpen = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
      </svg>
    );
    const Brain = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/>
        <path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/>
      </svg>
    );
    const ChevronLeft = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="15 18 9 12 15 6"/>
      </svg>
    );
    const ChevronRight = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="9 18 15 12 9 6"/>
      </svg>
    );
    const Settings = ({ size = 24, style }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={style}>
        <circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6"/>
      </svg>
    );
    const Plus = ({ size = 24, style }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={style}>
        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
    );
    const Trash2 = ({ size = 24, color }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
      </svg>
    );
    const Edit = ({ size = 24, color }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
      </svg>
    );
    const Camera = ({ size = 24, color }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/>
      </svg>
    );
    const Check = ({ size = 24, style }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={style}>
        <polyline points="20 6 9 17 4 12"/>
      </svg>
    );
    const X = ({ size = 24, style }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={style}>
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    );

    
// ========================================
    // LISTE DES M√âDICAMENTS DE D√âPART
    // ========================================
    // Cette liste sera charg√©e automatiquement pour tous les utilisateurs
    // Pour ajouter vos 272 m√©dicaments, remplacez simplement ce tableau
    // Format : { dci: "...", commercial: ["..."], category: "...", image: null }
    
    const INITIAL_MEDS = [];

const INITIAL_CLASSES = {};

function PharmaSpace() {
  
  const [mode, setMode] = useState('menu');
  const [imageModalUrl, setImageModalUrl] = useState(null);
  const [medications, setMedications] = useState(() => {
    const saved = localStorage.getItem('pharmaspace_medications');
    return saved ? JSON.parse(saved) : INITIAL_MEDS;
  });
  const [therapeuticClasses, setTherapeuticClasses] = useState(() => {
    const saved = localStorage.getItem('pharmaspace_classes');
    return saved ? JSON.parse(saved) : INITIAL_CLASSES;
  });
  const [pharmaceuticalForms, setPharmaceuticalForms] = useState(() => {
    const saved = localStorage.getItem('pharmaspace_forms');
    return saved ? JSON.parse(saved) : [
      'A√©rosol-doseur',
      'Autre',
      'Bain de bouche',
      'Capsule',
      'Capsule P√©dia.',
      'Capsules molles',
      'Collyre',
      'Comprim√©',
      'Comprim√© effervescent',
      'Comprim√© orodispersible',
      'Comprim√© sublingual',
      'Comprim√©s √† croquer',
      'Cr√®me',
      'Gel',
      'Globules',
      'Gouttes',
      'Gouttes auriculaires',
      'Gouttes auriculaires et collyre',
      'Gouttes nasal',
      'Granule effervescent',
      'Granul√©s',
      'G√©lule',
      'Lotion',
      'Lyophilisat',
      'Ovule',
      'Pastille',
      'Patch',
      'Pommade',
      'Pommade nasal',
      'Pommade ophtalmique',
      'Poudre pour inhalation',
      'Poudre pour sirop',
      'Poudre pour solution',
      'Poudre pour solution injectable',
      'Poudre pour suspension',
      'Poudre pour suspension buvable',
      'Poudre pour suspension injectable',
      'Sachet',
      'Sachet P√©dia.',
      'Sachet pour sirop',
      'Shampoing',
      'Sirop',
      'Sirop P√©dia.',
      'Solution',
      'Solution buvable',
      'Solution buvable en gouttes',
      'Solution cutan√©e',
      'Solution injectable',
      'Solution nasal',
      'Solution pour inhalation',
      'Solution pour inhalation/n√©bulisation',
      'Solution pour n√©bulisation',
      'Solution pour n√©bulisation/inhalation',
      'Solution rectale',
      'Spray',
      'Spray buccal',
      'Spray nasal',
      'Spray nasal Baby',
      'Spray nasal P√©dia.',
      'Suppo P√©dia',
      'Suppositoire',
      'Suppositoire P√©dia.',
      'Suspension',
      'Suspension buvable',
      'Suspension injectable',
      'Suspension pour inhalation'
    ];
  });
    const [currentIndex, setCurrentIndex] = useState(0);
  const [showAnswer, setShowAnswer] = useState(false);
  const [flashcardView, setFlashcardView] = useState('list');
  const [showSettings, setShowSettings] = useState(false);
  const [showManagement, setShowManagement] = useState(false);
  
  const [selectionMode, setSelectionMode] = useState('all');
  const [selectedClasses, setSelectedClasses] = useState([]);
  const [selectedMeds, setSelectedMeds] = useState([]);
    const [stats, setStats] = useState({ correct: 0, total: 0 });
  const [userAnswer, setUserAnswer] = useState('');
          const [sortBy, setSortBy] = useState('commercial');
  const [filterCategory, setFilterCategory] = useState('all');
  const [editingIndex, setEditingIndex] = useState(null);
  const [customMed, setCustomMed] = useState({ dci: '', commercial: '', category: '', imageUrls: '', pharmaceuticalForm: '' });
  const [imageUpdated, setImageUpdated] = useState(false);
  const [listUpdateKey, setListUpdateKey] = useState(0);
  const [searchQuery, setSearchQuery] = useState('');
  const [errorMessage, setErrorMessage] = useState('');
  const [showClassManager, setShowClassManager] = useState(false);
  const [newClassName, setNewClassName] = useState('');
  const [newClassColor, setNewClassColor] = useState('#64748b');
  const [editingClass, setEditingClass] = useState(null);
  const [showFormManager, setShowFormManager] = useState(false);
  const [newFormName, setNewFormName] = useState('');
  const [editingForm, setEditingForm] = useState(null);
  const [flashcardListSort, setFlashcardListSort] = useState('commercial');
  const [showDataManagement, setShowDataManagement] = useState(false);
  const [showImgurGuide, setShowImgurGuide] = useState(false);



  // Chargement des donn√©es depuis data.json au d√©marrage
  React.useEffect(() => {
    // V√©rifier si les donn√©es sont d√©j√† dans localStorage
    const hasMeds = localStorage.getItem('pharmaspace_medications');
    const hasClasses = localStorage.getItem('pharmaspace_classes');
    const hasForms = localStorage.getItem('pharmaspace_forms');
    
    // Si aucune donn√©e dans localStorage, charger depuis data.json
    if (!hasMeds || !hasClasses) {
      fetch('./data.json')
        .then(response => {
          if (!response.ok) {
            console.warn('‚ö†Ô∏è data.json non trouv√©, utilisation des donn√©es par d√©faut');
            return null;
          }
          return response.json();
        })
        .then(data => {
          if (data) {
            console.log('‚úÖ Donn√©es charg√©es depuis data.json');
            // Charger medications si absent de localStorage
            if (!hasMeds && data.medications) {
              setMedications(data.medications);
              localStorage.setItem('pharmaspace_medications', JSON.stringify(data.medications));
            }
            // Charger classes si absent de localStorage
            if (!hasClasses && data.therapeuticClasses) {
              setTherapeuticClasses(data.therapeuticClasses);
              localStorage.setItem('pharmaspace_classes', JSON.stringify(data.therapeuticClasses));
            }
            // Charger formes si absent de localStorage
            if (!hasForms && data.pharmaceuticalForms) {
              setPharmaceuticalForms(data.pharmaceuticalForms);
              localStorage.setItem('pharmaspace_forms', JSON.stringify(data.pharmaceuticalForms));
            }
            // Charger conseils si pr√©sents et absents de localStorage
            if (data.conseilsCategories && !localStorage.getItem('conseilsCategories')) {
              localStorage.setItem('conseilsCategories', JSON.stringify(data.conseilsCategories));
            }
            if (data.conseilsOfficine && !localStorage.getItem('conseilsOfficine')) {
              localStorage.setItem('conseilsOfficine', JSON.stringify(data.conseilsOfficine));
            }
          }
        })
        .catch(error => {
          console.error('‚ùå Erreur chargement data.json:', error);
        });
    } else {
      console.log('‚úÖ Donn√©es charg√©es depuis localStorage');
    }
  }, []); // Ex√©cut√© une seule fois au d√©marrage

  // Sauvegarde automatique
  React.useEffect(() => {
    localStorage.setItem('pharmaspace_medications', JSON.stringify(medications));
  }, [medications]);

  React.useEffect(() => {
    localStorage.setItem('pharmaspace_classes', JSON.stringify(therapeuticClasses));
  }, [therapeuticClasses]);

  React.useEffect(() => {
    localStorage.setItem('pharmaspace_forms', JSON.stringify(pharmaceuticalForms));
  }, [pharmaceuticalForms]);

  // R√©initialiser l'index quand la recherche change
  React.useEffect(() => {
    if (mode === 'flashcard') {
      setCurrentIndex(0);
    }
  }, [searchQuery]);

  // ========== ALGORITHME SRS ==========
  

  

  

  // ========== STATISTIQUES ==========
  

  // ========== FONCTIONS UTILITAIRES ==========
  const normalizeString = (str) => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "");

  const levenshteinDistance = (str1, str2) => {
    const matrix = [];
    for (let i = 0; i <= str2.length; i++) matrix[i] = [i];
    for (let j = 0; j <= str1.length; j++) matrix[0][j] = j;
    for (let i = 1; i <= str2.length; i++) {
      for (let j = 1; j <= str1.length; j++) {
        matrix[i][j] = str2.charAt(i - 1) === str1.charAt(j - 1) ? matrix[i - 1][j - 1] : Math.min(matrix[i - 1][j - 1] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1);
      }
    }
    return matrix[str2.length][str1.length];
  };

  const checkAnswer = (userAns, correctAns) => {
    const normalized1 = normalizeString(userAns);
    const normalized2 = normalizeString(correctAns);
    return levenshteinDistance(normalized1, normalized2) <= Math.floor(normalized2.length * 0.2);
  };

  const getCategories = () => {
    // R√©cup√©rer les classes des m√©dicaments
    const medsCategories = medications.map(med => med.category);
    // R√©cup√©rer toutes les classes de therapeuticClasses
    const allClasses = Object.keys(therapeuticClasses);
    // Combiner et d√©dupliquer
    return [...new Set([...medsCategories, ...allClasses])].sort();
  };
  const getClassColor = (className) => therapeuticClasses[className] || '#64748b';

  const getSortedMedications = () => {
    let sorted = [...medications];
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase();
      sorted = sorted.filter(med => 
        med.dci.toLowerCase().includes(query) ||
        med.commercial.some(name => name.toLowerCase().includes(query)) ||
        med.category.toLowerCase().includes(query) ||
        (med.pharmaceuticalForm && med.pharmaceuticalForm.toLowerCase().includes(query))
      );
    }
    if (filterCategory !== 'all') sorted = sorted.filter(med => med.category === filterCategory);
    switch(sortBy) {
      case 'dci': sorted.sort((a, b) => a.dci.localeCompare(b.dci)); break;
      case 'commercial': sorted.sort((a, b) => a.commercial[0].localeCompare(b.commercial[0])); break;
      case 'category': sorted.sort((a, b) => a.category.localeCompare(b.category)); break;
      case 'form': sorted.sort((a, b) => (a.pharmaceuticalForm || '').localeCompare(b.pharmaceuticalForm || '')); break;
    }
    return sorted;
  };

  const getFlashcardListMedications = () => {
    let sorted = [...medications];
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase();
      sorted = sorted.filter(med => 
        med.dci.toLowerCase().includes(query) ||
        med.commercial.some(name => name.toLowerCase().includes(query)) ||
        med.category.toLowerCase().includes(query) ||
        (med.pharmaceuticalForm && med.pharmaceuticalForm.toLowerCase().includes(query))
      );
    }
    switch(flashcardListSort) {
      case 'dci': sorted.sort((a, b) => a.dci.localeCompare(b.dci)); break;
      case 'commercial': sorted.sort((a, b) => a.commercial[0].localeCompare(b.commercial[0])); break;
      case 'category': sorted.sort((a, b) => a.category.localeCompare(b.category)); break;
      case 'form': sorted.sort((a, b) => (a.pharmaceuticalForm || '').localeCompare(b.pharmaceuticalForm || '')); break;
    }
    return sorted;
  };

  const handleQuizSubmit = (e) => {
    e.preventDefault();
    if (!userAnswer.trim()) return;
    const isCorrect = checkAnswer(userAnswer, getFlashcardListMedications()[currentIndex].dci);
    setShowQuizFeedback(true);
    setStats({ correct: stats.correct + (isCorrect ? 1 : 0), total: stats.total + 1 });
  };

  const handleNext = () => {
    if (currentIndex < getFlashcardListMedications().length - 1) {
      setCurrentIndex(currentIndex + 1);
      setShowAnswer(false);
    } else {
      // Quiz supprim√©
      setMode('menu');
      // setShuffledMeds([]);
    }
  };

  const applySelection = () => {
    let medsToUse = [];
    
    if (selectionMode === 'all') {
      medsToUse = [...medications];
    } else if (selectionMode === 'class') {
      medsToUse = medications.filter(med => selectedClasses.includes(med.category));
    } else if (selectionMode === 'custom') {
      medsToUse = selectedMeds.map(i => medications[i]);
    }
    
    if (medsToUse.length === 0) {
      alert('Aucun m√©dicament s√©lectionn√©');
      return;
    }
    
    // M√©langer les m√©dicaments
    
    // shuffledMeds non utilis√©
    setCurrentIndex(0);
    setShowAnswer(false);
    setStats({ correct: 0, total: 0 });
    setShowSettings(false);
  };

  const startMode = (newMode) => {
    setMode(newMode);
    setSelectionMode('all');
    setSelectedClasses([]);
    setSelectedMeds([]);
    
    // Initialiser le mode
    const medsToUse = [...medications];
    setCurrentIndex(0);
    setShowAnswer(false);
    setStats({ correct: 0, total: 0 });
    setSearchQuery('');
    
    if (newMode === 'flashcard') {
      setFlashcardView('card');
    }
  };

  

  const startEditMedication = (index) => {
    const med = medications[index];
    const imageText = med.imageUrls ? med.imageUrls.join('\n') : (med.imageUrl ? med.imageUrl : (med.image || ''));
    setCustomMed({ 
      dci: med.dci, 
      commercial: med.commercial.join(', '), 
      category: med.category, 
      imageUrls: imageText,
      pharmaceuticalForm: med.pharmaceuticalForm || ''
    });
    setEditingIndex(index);
  };

  const cancelEdit = () => {
    setEditingIndex(null);
    setCustomMed({ dci: '', commercial: '', category: '', imageUrls: '', pharmaceuticalForm: '' });
    setErrorMessage('');
    setShowClassManager(false);
    setEditingClass(null);
  };

  const saveMedication = () => {
    if (!customMed.dci || !customMed.commercial || !customMed.category) {
      setErrorMessage('‚ö†Ô∏è Veuillez remplir tous les champs obligatoires (DCI, Nom commercial, Classe)');
      setTimeout(() => setErrorMessage(''), 3000);
      return;
    }
    
    const newMed = {
      dci: customMed.dci,
      commercial: customMed.commercial.split(',').map(s => s.trim()).filter(s => s),
      category: customMed.category,
      imageUrls: customMed.imageUrls.split('\n').map(s => s.trim()).filter(s => s),
      pharmaceuticalForm: customMed.pharmaceuticalForm.trim()
    };
    
    if (editingIndex !== null) {
      const updated = [...medications];
      newMed.nextReview = medications[editingIndex].nextReview;
      newMed.interval = medications[editingIndex].interval;
      updated[editingIndex] = newMed;
      setMedications(updated);
      setEditingIndex(null);
    } else {
      setMedications([...medications, newMed]);
    }
    setCustomMed({ dci: '', commercial: '', category: '', imageUrls: '', pharmaceuticalForm: '' });
    setErrorMessage('');
    // Forcer le re-render de la liste
    setListUpdateKey(prev => prev + 1);
  };

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onloadend = () => {
      // Ancien code d'upload supprim√©
    };
    reader.readAsDataURL(file);
  };
  
  // NOUVELLE : Fonction pour ajouter une image par URL
  const handleImageURL = () => {
    let url = prompt("üåê Collez l'URL de votre image\n\nüìç Services recommand√©s :\n‚Ä¢ Imgur.com (gratuit, rapide)\n‚Ä¢ imgbb.com\n‚Ä¢ Google Photos\n\nüí° L'URL doit finir par .jpg, .png, .gif ou .webp\n\nExemple :\nhttps://i.imgur.com/abc123.jpg");
    if (!url) return;
    
    // Valider que c'est une URL
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
      alert("‚ùå L'URL doit commencer par http:// ou https://");
      return;
    }
    
    // D√âTECTION D'ALBUM IMGUR
    if (url.includes('imgur.com/a/')) {
      alert("‚ùå C'est une URL d'ALBUM !\n\n" +
            "Vous avez coll√© : " + url + "\n\n" +
            "üìç Comment obtenir la bonne URL :\n\n" +
            "1. Ouvrez votre album\n" +
            "2. Cliquez sur l'image que vous voulez\n" +
            "3. Faites clic droit sur l'image\n" +
            "4. 'Copier l'adresse de l'image'\n\n" +
            "‚úÖ Vous obtiendrez une URL comme :\n" +
            "https://i.imgur.com/abc123.jpg");
      return;
    }
    
    // AUTO-CORRECTION DES URLs IMGUR
    // Si c'est une URL Imgur sans "i." au d√©but, la corriger
    if (url.includes('imgur.com') && !url.includes('i.imgur.com')) {
      // Extraire l'ID de l'image
      const match = url.match(/imgur\.com\/(?:gallery\/)?([a-zA-Z0-9]+)/);
      if (match && match[1]) {
        const imageId = match[1];
        // Demander l'extension
        const ext = prompt("üîß Auto-correction Imgur\n\nQuelle est l'extension de votre image ?\n\nTapez : jpg, png, gif ou webp", "jpg");
        if (ext) {
          url = `https://i.imgur.com/${imageId}.${ext}`;
          alert(`‚úÖ URL corrig√©e automatiquement :\n${url}`);
        }
      }
    }
    
    // V√©rifier que c'est une image
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];
    const hasImageExtension = imageExtensions.some(ext => url.toLowerCase().includes(ext));
    
    if (!hasImageExtension && !url.includes('imgur.com') && !url.includes('googleusercontent.com') && !url.includes('ibb.co')) {
      const confirm = window.confirm("‚ö†Ô∏è Cette URL ne semble pas √™tre une image.\nVoulez-vous quand m√™me l'utiliser ?");
      if (!confirm) return;
    }
    
    // Mettre √† jour l'image directement
    // Ancien code URL supprim√©
  }
  
  // Nouvelle fonction pour valider l'image
  const validateImage = () => {
    if (!tempImageUrl) return;
    // Ancien code temp image supprim√©
    setImageUpdated(true);
    setTimeout(() => setImageUpdated(false), 100);
    alert('‚úÖ Image ajout√©e avec succ√®s !\n\nVous pouvez maintenant modifier le m√©dicament.');
  }

  const addNewClass = () => {
    if (!newClassName.trim()) {
      setErrorMessage('‚ö†Ô∏è Veuillez entrer un nom de classe');
      setTimeout(() => setErrorMessage(''), 3000);
      return;
    }
    if (getCategories().includes(newClassName.trim())) {
      setErrorMessage('‚ö†Ô∏è Cette classe existe d√©j√†');
      setTimeout(() => setErrorMessage(''), 3000);
      return;
    }
    setTherapeuticClasses({...therapeuticClasses, [newClassName.trim()]: newClassColor});
    setCustomMed({...customMed, category: newClassName.trim()});
    setNewClassName('');
    setNewClassColor('#64748b');
    setShowClassManager(false);
    setErrorMessage('');
  };

  const updateClass = (oldName, newName, newColor) => {
    if (!newName.trim()) {
      setErrorMessage('‚ö†Ô∏è Veuillez entrer un nom de classe');
      setTimeout(() => setErrorMessage(''), 3000);
      return;
    }
    if (newName !== oldName && getCategories().includes(newName.trim())) {
      setErrorMessage('‚ö†Ô∏è Cette classe existe d√©j√†');
      setTimeout(() => setErrorMessage(''), 3000);
      return;
    }
    const updatedClasses = {...therapeuticClasses};
    delete updatedClasses[oldName];
    updatedClasses[newName.trim()] = newColor;
    setTherapeuticClasses(updatedClasses);
    const updatedMeds = medications.map(med => 
      med.category === oldName ? {...med, category: newName.trim()} : med
    );
    setMedications(updatedMeds);
    setEditingClass(null);
    setErrorMessage('');
  };

  
  const resetToDefault = () => {
    if (window.confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir r√©initialiser TOUTES vos donn√©es ? Cette action est irr√©versible.')) {
      localStorage.removeItem('pharmaspace_medications');
      localStorage.removeItem('pharmaspace_classes');
      setMedications(INITIAL_MEDS);
      setTherapeuticClasses(INITIAL_CLASSES);
      alert('‚úÖ R√©initialisation termin√©e !\n\nüîÑ Retour aux 7 m√©dicaments par d√©faut\nüí° Pensez √† exporter avant de r√©initialiser la prochaine fois !');
    }
  };

  // Fonction pour recharger intelligemment sans perdre les personnalisations
  const smartReload = () => {
    if (confirm('üîÑ Recharger les donn√©es depuis data.json ?\n\n‚úÖ Rechargera: M√©dicaments et classes th√©rapeutiques depuis data.json\n‚úÖ Conservera: Formes pharmaceutiques et conseils officine (tes personnalisations)\n\nContinuer ?')) {
      // Sauvegarder les formes et conseils
      const savedForms = localStorage.getItem('pharmaspace_forms');
      const savedConseilsCategories = localStorage.getItem('conseilsCategories');
      const savedConseilsOfficine = localStorage.getItem('conseilsOfficine');
      
      // Vider seulement medications et classes
      localStorage.removeItem('pharmaspace_medications');
      localStorage.removeItem('pharmaspace_classes');
      
      // Recharger la page
      alert('‚úÖ Rechargement en cours...\n\nüíä M√©dicaments: recharg√©s depuis data.json\nüé® Classes: recharg√©es depuis data.json\nüíä Formes: conserv√©es (tes suppressions maintenues)\nüìã Conseils: conserv√©s (tes modifications maintenues)');
      location.reload(true);
    }
  };

  const exportData = () => {
    // R√©cup√©rer les donn√©es conseils depuis localStorage
    const conseilsCategories = localStorage.getItem('conseilsCategories');
    const conseilsOfficine = localStorage.getItem('conseilsOfficine');
    
    // R√©cup√©rer toutes les cat√©gories de documents pour chaque fiche
    const docCategories = {};
    const plaintes = conseilsOfficine ? JSON.parse(conseilsOfficine) : [];
    plaintes.forEach(plainte => {
      const savedCategories = localStorage.getItem('docCategories_' + plainte.id);
      if (savedCategories) {
        docCategories[plainte.id] = JSON.parse(savedCategories);
      }
    });
    
    const data = { 
      medications, 
      therapeuticClasses,
      pharmaceuticalForms,
      conseilsCategories: conseilsCategories ? JSON.parse(conseilsCategories) : null,
      conseilsOfficine: conseilsOfficine ? JSON.parse(conseilsOfficine) : null,
      docCategories: Object.keys(docCategories).length > 0 ? docCategories : null,
      exportDate: new Date().toISOString() 
    };
    
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pharmaspace_backup_${new Date().toISOString().split('T')[0]}.json`;
    const categoriesCount = Object.keys(docCategories).length;
    alert('‚úÖ Sauvegarde compl√®te t√©l√©charg√©e !\n\nüìÅ Fichier : pharmaspace_backup_' + new Date().toISOString().split('T')[0] + '.json\nüíä Flashcards: ' + medications.length + ' m√©dicaments\nüé® Classes th√©rapeutiques: ' + Object.keys(therapeuticClasses).length + '\nüíä Formes pharmaceutiques: ' + pharmaceuticalForms.length + '\nüìã Conseils: ' + (conseilsOfficine ? JSON.parse(conseilsOfficine).length : 0) + ' fiches' + (categoriesCount > 0 ? '\nüìÅ Cat√©gories documents: ' + categoriesCount + ' fiches avec cat√©gories' : '') + '\nüíæ Gardez ce fichier pr√©cieusement !\nüì§ Vous pouvez le partager avec vos coll√®gues.');
    a.click();
    URL.revokeObjectURL(url);
  };

  const importData = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          // D√âTECTION D'IMPORT AUTOMATIQUE D'IMAGES
          if (data.urlsMap && data.metadata) {
            const urlsMap = data.urlsMap;
            const count = Object.keys(urlsMap).length;
            
            if (!window.confirm('üéâ Import automatique d\'images d√©tect√© !\n\n' + count + ' images √† importer.\n\nVoulez-vous appliquer ces images aux m√©dicaments correspondants ?')) {
              return;
            }
            
            // Appliquer les URLs aux m√©dicaments existants
            let applied = 0;
            let notFound = [];
            
            const updatedMeds = medications.map(med => {
              // Chercher par nom commercial (premier de la liste)
              const medName = med.commercial[0];
              
              if (urlsMap[medName]) {
                applied++;
                return { ...med, image: urlsMap[medName] };
              }
              
              notFound.push(medName);
              return med;
            });
            
            setMedications(updatedMeds);
            
            alert('‚úÖ Import r√©ussi !\n\n' + applied + ' images appliqu√©es\n' + notFound.length + ' m√©dicaments sans correspondance\n\n' + (notFound.length > 0 ? 'M√©dicaments non trouv√©s : ' + notFound.slice(0, 5).join(', ') + (notFound.length > 5 ? '...' : '') : ''));
            return;
          }
          
          // IMPORT NORMAL (donn√©es compl√®tes)
          if (data.medications && data.therapeuticClasses) {
            setMedications(data.medications);
            setTherapeuticClasses(data.therapeuticClasses);
            
            // Importer les formes pharmaceutiques intelligemment
            if (data.pharmaceuticalForms) {
              // R√©cup√©rer les formes actuelles (avec suppressions)
              const currentForms = pharmaceuticalForms;
              // Trouver les nouvelles formes du fichier (pas dans les formes actuelles)
              const newForms = data.pharmaceuticalForms.filter(form => !currentForms.includes(form));
              // Ajouter seulement les nouvelles formes (garder les suppressions)
              if (newForms.length > 0) {
                setPharmaceuticalForms([...currentForms, ...newForms].sort());
              }
              // Si pas de nouvelles formes, garder les formes actuelles (avec suppressions)
            }
            
            // Restaurer les conseils si pr√©sents
            if (data.conseilsCategories) {
              localStorage.setItem('conseilsCategories', JSON.stringify(data.conseilsCategories));
            }
            if (data.conseilsOfficine) {
              localStorage.setItem('conseilsOfficine', JSON.stringify(data.conseilsOfficine));
            }
            
            // Restaurer les cat√©gories de documents si pr√©sentes
            if (data.docCategories) {
              Object.keys(data.docCategories).forEach(plainteId => {
                localStorage.setItem('docCategories_' + plainteId, JSON.stringify(data.docCategories[plainteId]));
              });
            }
            
            const conseilsCount = data.conseilsOfficine ? data.conseilsOfficine.length : 0;
            const formsCount = data.pharmaceuticalForms ? data.pharmaceuticalForms.length : 0;
            const categoriesCount = data.docCategories ? Object.keys(data.docCategories).length : 0;
            alert('‚úÖ Donn√©es import√©es avec succ√®s !\n\nüíä ' + data.medications.length + ' m√©dicaments charg√©s\nüé® ' + Object.keys(data.therapeuticClasses).length + ' classes th√©rapeutiques' + (formsCount > 0 ? '\nüíä ' + formsCount + ' formes pharmaceutiques' : '') + '\nüìã ' + conseilsCount + ' fiches conseils' + (categoriesCount > 0 ? '\nüìÅ ' + categoriesCount + ' fiches avec cat√©gories documents' : '') + (conseilsCount > 0 ? '\n\n‚ö†Ô∏è Rechargez la page pour voir les conseils' : ''));
          } else {
            alert('‚ùå Fichier invalide');
          }
        } catch (err) {
          alert('‚ùå Erreur lors de l\'import : ' + err.message);
        }
      };
      reader.readAsText(file);
    }
  };

  const ImagePlaceholder = () => (
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
      <circle cx="8.5" cy="8.5" r="1.5"/>
      <polyline points="21 15 16 10 5 21"/>
    </svg>
  );

  

  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #f8fafc 0%, #e2e8f0 100%)', padding: '1rem' }}>
      <style>{`.button-hover { transition: all 0.3s; } .button-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); }`}</style>

      <div style={{ maxWidth: 'none', margin: '0', padding: '0 2rem' }}>
        {mode !== 'conseils' ? (
          <>
          <div style={{ background: 'linear-gradient(135deg, #1e293b 0%, #334155 100%)', padding: '1.5rem', color: 'white', textAlign: 'center', borderRadius: '20px 20px 0 0', position: 'relative' }}>
            {/* BOUTON MENU EN HAUT √Ä GAUCHE */}
            {mode === 'flashcard' && (
              <div style={{ position: 'absolute', top: '1.5rem', left: '1.5rem' }}>
                <button 
                  onClick={() => setMode('menu')}
                  className="button-hover" 
                  style={{ 
                    background: 'rgba(255,255,255,0.2)',
                    border: 'none',
                    color: 'white',
                    padding: '0.75rem 1.25rem',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontSize: '1rem',
                    fontWeight: 600,
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem'
                  }}
                >
                  <span>‚Üê</span> Menu
                </button>
              </div>
            )}
            
            <h1 style={{ margin: 0, fontSize: '1.8rem', fontWeight: 700 }}>PharmaSpace</h1>
            <p style={{ margin: '0.5rem 0 0 0', opacity: 0.9, fontSize: '0.85rem' }}>
              {medications.length} m√©dicaments
            </p>

            
            {stats.total > 0 && (
              <div style={{ marginTop: '1rem', padding: '0.75rem', background: 'rgba(255, 255, 255, 0.1)', borderRadius: '12px' }}>
                <div style={{ fontSize: '0.85rem', opacity: 0.8 }}>Score</div>
                <div style={{ fontSize: '1.5rem', fontWeight: 700 }}>{Math.round((stats.correct / stats.total) * 100)}% ({stats.correct}/{stats.total})</div>
              </div>
            )}
          </div>

          <div style={{ background: 'white', borderRadius: '0 0 20px 20px', padding: '1.5rem', boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)', minHeight: '400px' }}>
          
          {mode === 'menu' && (
            <div>
              <h2 style={{ textAlign: 'center', marginBottom: '2rem', color: '#1e293b', fontSize: '1.8rem' }}>Choisissez votre mode</h2>
              
              <div style={{ display: 'grid', gap: '1rem', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', marginBottom: '1rem' }}>
                <button onClick={() => startMode('flashcard')} className="button-hover" style={{ background: 'linear-gradient(135deg, #3B82F6 0%, #2563EB 100%)', border: 'none', borderRadius: '16px', padding: '2rem', color: 'white', cursor: 'pointer', position: 'relative', textAlign: 'center' }}>
                  <div style={{ position: 'absolute', top: '2rem', left: '2rem' }}><BookOpen size={24} /></div>
                  <div>
                    <div style={{ fontSize: '1.3rem', fontWeight: 700, marginBottom: '0.5rem' }}>Flashcards</div>
                    <div style={{ fontSize: '0.9rem', opacity: 0.9 }}>Apprentissage</div>
                  </div>
                </button>
                
                <button onClick={() => startMode('conseils')} className="button-hover" style={{ background: 'linear-gradient(135deg, #10B981 0%, #059669 100%)', border: 'none', borderRadius: '16px', padding: '2rem', color: 'white', cursor: 'pointer', position: 'relative', textAlign: 'center' }}>
                  <div style={{ position: 'absolute', top: '2rem', left: '2rem' }}>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                      <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                  </div>
                  <div>
                    <div style={{ fontSize: '1.3rem', fontWeight: 700, marginBottom: '0.5rem' }}>Conseils Officine</div>
                    <div style={{ fontSize: '0.9rem', opacity: 0.9 }}>Plaintes courantes</div>
                  </div>
                </button>

              </div>

              {/* BOUTON GESTION DES DONN√âES */}
              <div style={{ marginTop: '2rem', display: 'flex', justifyContent: 'center' }}>
                <button 
                  onClick={() => setShowDataManagement(true)}
                  className="button-hover"
                  style={{ 
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', 
                    border: 'none', 
                    borderRadius: '12px', 
                    padding: '0.75rem 1.5rem', 
                    cursor: 'pointer',
                    transition: 'all 0.3s',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.75rem',
                    boxShadow: '0 4px 16px rgba(102, 126, 234, 0.4)',
                    color: 'white'
                  }}
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/>
                    <polyline points="7 3 7 8 15 8"/>
                  </svg>
                  <span style={{ fontSize: '0.95rem', fontWeight: 600 }}>Gestion des donn√©es</span>
                </button>
              </div>
              
            </div>
          )}



          {/* MODE FLASHCARD */}
          {mode === 'flashcard' && (
            <div>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', flexWrap: 'wrap', gap: '1rem' }}>
                <div style={{ fontSize: '0.9rem', color: '#64748b', fontWeight: 600 }}>{currentIndex + 1} / {getFlashcardListMedications().length}</div>
                <div style={{ display: 'flex', gap: '0.5rem' }}>
                  <button onClick={() => setShowSettings(true)} className="button-hover" style={{ padding: '0.6rem', background: '#f1f5f9', border: '2px solid #e2e8f0', borderRadius: '8px', cursor: 'pointer' }}>
                    <Settings size={20} style={{ color: '#64748b' }} />
                  </button>
                  <button onClick={() => setShowManagement(true)} className="button-hover" style={{ padding: '0.6rem', background: '#D1FAE5', border: '2px solid #10B981', borderRadius: '8px', cursor: 'pointer' }}>
                    <Plus size={20} style={{ color: '#10B981' }} />
                  </button>
                  <button onClick={() => setFlashcardView('card')} className="button-hover" style={{ padding: '0.5rem 1rem', background: flashcardView === 'card' ? '#334155' : '#e2e8f0', border: 'none', borderRadius: '8px', color: flashcardView === 'card' ? 'white' : '#64748b', cursor: 'pointer', fontSize: '0.9rem', fontWeight: 600 }}>
                    Carte
                  </button>
                  <button onClick={() => setFlashcardView('list')} className="button-hover" style={{ padding: '0.5rem 1rem', background: flashcardView === 'list' ? '#334155' : '#e2e8f0', border: 'none', borderRadius: '8px', color: flashcardView === 'list' ? 'white' : '#64748b', cursor: 'pointer', fontSize: '0.9rem', fontWeight: 600 }}>
                    Liste
                  </button>
                </div>
              </div>

              {/* BARRE DE RECHERCHE ET TRI MODE CARTE */}
              {flashcardView === 'card' && (
                <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem' }}>
                  <input
                    type="text"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    placeholder="üîç Rechercher un m√©dicament..."
                    style={{
                      flex: 1,
                      padding: '0.75rem',
                      border: '2px solid #e2e8f0',
                      borderRadius: '8px',
                      fontSize: '0.9rem'
                    }}
                  />
                  <select value={flashcardListSort} onChange={(e) => setFlashcardListSort(e.target.value)} style={{ padding: '0.75rem', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '0.9rem', cursor: 'pointer', background: 'white' }}>
                    <option value="dci">Tri: DCI A-Z</option>
                    <option value="commercial">Tri: Commercial A-Z</option>
                    <option value="category">Tri: Par classe</option>
                    <option value="form">Tri: Par forme</option>
                  </select>
                </div>
              )}

              {flashcardView === 'card' ? (
                <>
                  {getFlashcardListMedications()[currentIndex] ? (
                  <div 
                    onClick={() => setShowAnswer(!showAnswer)} 
                    style={{ 
                      background: showAnswer ? getClassColor(getFlashcardListMedications()[currentIndex].category) : 'white', 
                      borderRadius: '20px', 
                      padding: '3rem 2rem', 
                      cursor: 'pointer', 
                      minHeight: '300px', 
                      display: 'flex', 
                      flexDirection: 'column', 
                      alignItems: 'center', 
                      justifyContent: 'center', 
                      transition: 'all 0.4s', 
                      boxShadow: '0 10px 40px rgba(0, 0, 0, 0.1)', 
                      border: showAnswer ? 'none' : '3px solid #334155',
                      position: 'relative'
                    }}
                  >
                    <div style={{ fontSize: '0.85rem', color: showAnswer ? 'rgba(255, 255, 255, 0.9)' : '#334155', marginBottom: '1rem', textTransform: 'uppercase', letterSpacing: '0.1em', fontWeight: 700 }}>
                      {showAnswer ? 'DCI' : 'Nom Commercial'}
                    </div>
                    <div style={{ fontSize: showAnswer ? '2.5rem' : '1.8rem', fontWeight: 700, color: showAnswer ? 'white' : '#1e293b', marginBottom: '1rem', textAlign: 'center' }}>
                      {showAnswer ? getFlashcardListMedications()[currentIndex].dci : getFlashcardListMedications()[currentIndex].commercial.join(' ‚Ä¢ ')}
                    </div>
                    <div style={{ display: showAnswer ? 'inline-block' : 'none', padding: '0.5rem 1.5rem', background: showAnswer ? 'rgba(255, 255, 255, 0.2)' : `${getClassColor(getFlashcardListMedications()[currentIndex].category)}20`, borderRadius: '20px', color: showAnswer ? 'white' : getClassColor(getFlashcardListMedications()[currentIndex].category), fontSize: '0.85rem', fontWeight: 600, marginBottom: '1rem' }}>
                      {getFlashcardListMedications()[currentIndex].category}
                    </div>
                    {showAnswer && (() => {
                      const med = getFlashcardListMedications()[currentIndex];
                      const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
                      const forms = med.pharmaceuticalForm ? med.pharmaceuticalForm.split(',').map(f => f.trim()) : [];
                      
                      return images.length > 0 ? (
                        <div style={{ display: 'flex', gap: '1.5rem', justifyContent: 'center', marginTop: '1rem', flexWrap: 'wrap' }}>
                          {images.map((url, idx) => (
                            <div key={idx} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '0.5rem' }}>
                              <img 
                                src={url} 
                                alt={`${med.dci} ${idx + 1}`}
                                style={{ 
                                  maxWidth: images.length > 1 ? '180px' : '280px',
                                  maxHeight: images.length > 1 ? '180px' : '280px',
                                  borderRadius: '12px',
                                  cursor: 'pointer',
                                  transition: 'transform 0.2s'
                                }}
                                onClick={(e) => { e.stopPropagation(); setImageModalUrl(url); }}
                                onMouseEnter={(e) => e.target.style.transform = 'scale(1.05)'}
                                onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                              />
                              {forms[idx] && (
                                <div style={{ fontSize: '0.85rem', color: 'rgba(255,255,255,0.9)', fontStyle: 'italic', fontWeight: 600 }}>
                                  {forms[idx]}
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      ) : null;
                    })()}
                  </div>
                  ) : (
                  <div style={{
                    textAlign: 'center',
                    padding: '3rem 2rem',
                    color: '#64748b'
                  }}>
                    <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üîç</div>
                    <div style={{ fontSize: '1.2rem', fontWeight: 600, marginBottom: '0.5rem' }}>Aucun r√©sultat</div>
                    <div style={{ fontSize: '0.9rem' }}>Essayez une autre recherche ou revenez au menu</div>
                  </div>
                  )}
                  
                  <div style={{ display: 'flex', gap: '1rem', marginTop: '2rem' }}>
                    <button onClick={() => currentIndex > 0 && (setCurrentIndex(currentIndex - 1), setShowAnswer(false))} disabled={currentIndex === 0} className="button-hover" style={{ flex: 1, padding: '1rem', background: currentIndex === 0 ? '#f1f5f9' : '#e2e8f0', border: 'none', borderRadius: '12px', color: currentIndex === 0 ? '#cbd5e1' : '#1e293b', cursor: currentIndex === 0 ? 'not-allowed' : 'pointer', fontWeight: 600, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.5rem' }}>
                      <ChevronLeft size={20} />
                      <span>Pr√©c√©dent</span>
                    </button>
                    <button 
                      onClick={() => getFlashcardListMedications().length > 1 && handleNext()} 
                      disabled={getFlashcardListMedications().length === 1}
                      className="button-hover" 
                      style={{ 
                        flex: 1, 
                        padding: '1rem', 
                        background: getFlashcardListMedications().length === 1 ? '#f1f5f9' : '#334155', 
                        border: 'none', 
                        borderRadius: '12px', 
                        color: getFlashcardListMedications().length === 1 ? '#cbd5e1' : 'white', 
                        cursor: getFlashcardListMedications().length === 1 ? 'not-allowed' : 'pointer', 
                        fontWeight: 600, 
                        display: 'flex', 
                        alignItems: 'center', 
                        justifyContent: 'center', 
                        gap: '0.5rem' 
                      }}
                    >
                      <span>Suivant</span>
                      <ChevronRight size={20} />
                    </button>
                  </div>
                </>
              ) : (
                <div>
                  <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem' }}>
                    <input type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} placeholder="üîç Rechercher..." style={{ flex: 1, padding: '0.75rem', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '0.9rem' }} />
                    <select value={flashcardListSort} onChange={(e) => setFlashcardListSort(e.target.value)} style={{ padding: '0.75rem', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '0.9rem', cursor: 'pointer', background: 'white' }}>
                      <option value="dci">Tri: DCI A-Z</option>
                      <option value="commercial">Tri: Commercial A-Z</option>
                      <option value="category">Tri: Par classe</option>
                      <option value="form">Tri: Par forme</option>
                    </select>
                  </div>
                  <div style={{ maxHeight: '75vh', overflowY: 'auto' }}>
                    {getFlashcardListMedications().length === 0 ? (
                      <div style={{ textAlign: 'center', padding: '3rem', color: '#64748b' }}>
                        <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üîç</div>
                        <div style={{ fontSize: '1.2rem', fontWeight: 600, marginBottom: '0.5rem' }}>Aucun r√©sultat</div>
                        <div style={{ fontSize: '0.9rem' }}>Essayez une autre recherche ou revenez au menu</div>
                      </div>
                    ) : (
                    getFlashcardListMedications().map((med, i) => (
                      <div key={`${med.dci}-${listUpdateKey}-${i}`} style={{ padding: '1rem', background: 'white', border: `3px solid ${getClassColor(med.category)}`, borderRadius: '12px', marginBottom: '0.75rem', display: 'flex', gap: '1rem' }}>
                        {(() => {
                          const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
                          return images.length > 0 ? (
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.25rem', width: '60px' }}>
                              {images.map((img, idx) => (
                                <img 
                                  key={idx}
                                  src={img} 
                                  alt={`${med.dci} ${idx+1}`} 
                                  style={{ 
                                    width: images.length === 1 ? '60px' : '28px', 
                                    height: images.length === 1 ? '60px' : '28px', 
                                    objectFit: 'cover', 
                                    borderRadius: '6px', 
                                    border: `2px solid ${getClassColor(med.category)}`, 
                                    cursor: 'pointer' 
                                  }} 
                                  onClick={() => setImageModalUrl(img)} 
                                />
                              ))}
                            </div>
                          ) : (
                            <div style={{ width: '60px', height: '60px', background: '#f1f5f9', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#cbd5e1' }}>
                              <ImagePlaceholder />
                            </div>
                          );
                        })()}
                        <div style={{ flex: 1 }}>
                          <div style={{ fontSize: '1rem', fontWeight: 700, color: '#1e293b' }}>{med.commercial.join(' ‚Ä¢ ')}</div>
                          <div style={{ fontSize: '0.9rem', color: '#64748b' }}>{med.dci}</div>
                          <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center', marginTop: '0.5rem', flexWrap: 'wrap' }}>
                            <div style={{ display: 'inline-block', padding: '0.25rem 0.75rem', background: `${getClassColor(med.category)}20`, borderRadius: '12px', color: getClassColor(med.category), fontSize: '0.75rem', fontWeight: 600 }}>
                              {med.category}
                            </div>
                            {med.pharmaceuticalForm && (
                              <div style={{ fontSize: '0.75rem', color: '#64748b', fontStyle: 'italic', display: 'flex', gap: '0.25rem', flexWrap: 'wrap' }}>
                                {[...new Set(med.pharmaceuticalForm.split(',').map(f => f.trim()))].map((form, i) => (
                                  <span key={i} style={{ background: '#f1f5f9', padding: '0.2rem 0.5rem', borderRadius: '6px' }}>
                                    {form}
                                  </span>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    ))
                    )}
                  </div>

                  <button onClick={() => setMode('menu')} className="button-hover" style={{ width: '100%', marginTop: '1rem', padding: '1rem', background: '#e2e8f0', border: 'none', borderRadius: '12px', color: '#1e293b', cursor: 'pointer', fontWeight: 600 }}>
                    Menu
                  </button>
                </div>
              )}
            </div>
          )}


          {/* MODAL IMAGE AGRANDIE */}
          {imageModalUrl && (
            <div 
              onClick={() => setImageModalUrl(null)} 
              style={{ 
                position: 'fixed', 
                top: 0, 
                left: 0, 
                right: 0, 
                bottom: 0, 
                background: 'rgba(0, 0, 0, 0.7)', 
                backdropFilter: 'blur(8px)',
                zIndex: 9999, 
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'center', 
                padding: '2rem',
                cursor: 'pointer'
              }}
            >
              <div 
                style={{ 
                  background: 'white', 
                  borderRadius: '16px', 
                  padding: '1.5rem',
                  boxShadow: '0 25px 80px rgba(0, 0, 0, 0.3)',
                  maxWidth: '90%',
                  maxHeight: '90%',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}
                onClick={(e) => e.stopPropagation()}
              >
                <img 
                  src={imageModalUrl} 
                  alt="Image agrandie" 
                  style={{ 
                    maxWidth: '100%', 
                    maxHeight: '80vh', 
                    objectFit: 'contain', 
                    borderRadius: '8px'
                  }} 
                />


              </div>
            </div>
          )}

          {/* MODE QUIZ */}

          
          {/* MODAL GESTION DES DONN√âES */}
          {showDataManagement && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', zIndex: 2000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '1rem' }} onClick={() => setShowDataManagement(false)}>
              <div onClick={(e) => e.stopPropagation()} style={{ background: 'white', borderRadius: '20px', padding: '2rem', maxWidth: '500px', width: '100%' }}>
                <h2 style={{ fontSize: '1.5rem', marginBottom: '1.5rem', color: '#1e293b', display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#3B82F6" strokeWidth="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/>
                    <polyline points="7 3 7 8 15 8"/>
                  </svg>
                  Gestion des donn√©es
                </h2>

                <div style={{ display: 'grid', gap: '0.75rem', marginBottom: '1.5rem' }}>
                  <button onClick={() => { exportData(); setShowDataManagement(false); }} className="button-hover" style={{ padding: '1rem', background: '#10B981', border: 'none', borderRadius: '12px', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '1rem', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.75rem' }}>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7 10 12 15 17 10"/>
                      <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Exporter mes donn√©es
                  </button>
                  
                  <label style={{ padding: '1rem', background: '#3B82F6', border: 'none', borderRadius: '12px', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '1rem', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.75rem', transition: 'all 0.3s' }} className="button-hover">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="17 8 12 3 7 8"/>
                      <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Importer des donn√©es
                    <input type="file" accept=".json" onChange={(e) => { importData(e); setShowDataManagement(false); }} style={{ display: 'none' }} />
                  </label>
                  
                  <button onClick={() => { smartReload(); setShowDataManagement(false); }} className="button-hover" style={{ padding: '1rem', background: '#8B5CF6', border: 'none', borderRadius: '12px', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '1rem', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.75rem' }}>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <polyline points="23 4 23 10 17 10"/>
                      <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                    Recharger depuis GitHub
                  </button>
                  
                  <button onClick={() => { resetToDefault(); setShowDataManagement(false); }} className="button-hover" style={{ padding: '1rem', background: '#EF4444', border: 'none', borderRadius: '12px', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '1rem', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.75rem' }}>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <polyline points="1 4 1 10 7 10"/>
                      <polyline points="23 20 23 14 17 14"/>
                      <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                    </svg>
                    R√©initialiser tout
                  </button>
                </div>

                <div style={{ padding: '1rem', background: '#FEF3C7', borderRadius: '10px', fontSize: '0.85rem', color: '#92400E', lineHeight: '1.5', marginBottom: '1.5rem' }}>
                  <strong>üí° Conseil :</strong> Apr√®s avoir mis √† jour <strong>data.json</strong> sur GitHub, utilisez <strong>"Recharger depuis GitHub"</strong> pour obtenir les nouveaut√©s. Vos suppressions de formes et cat√©gories conseils seront conserv√©es automatiquement.
                </div>

                <button onClick={() => setShowDataManagement(false)} className="button-hover" style={{ width: '100%', padding: '1rem', background: '#e2e8f0', border: 'none', borderRadius: '12px', color: '#1e293b', cursor: 'pointer', fontWeight: 600, fontSize: '1rem' }}>
                  Fermer
                </button>
              </div>
            </div>
          )}

          {/* MODAL GUIDE IMGUR */}
          {showImgurGuide && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.7)', zIndex: 3000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '1rem' }} onClick={() => setShowImgurGuide(false)}>
              <div onClick={(e) => e.stopPropagation()} style={{ background: 'white', borderRadius: '20px', padding: '2rem', maxWidth: '600px', width: '100%', maxHeight: '90vh', overflowY: 'auto' }}>
                <h2 style={{ fontSize: '1.5rem', marginBottom: '1.5rem', color: '#1e293b', display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#3B82F6" strokeWidth="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                  </svg>
                  Comment obtenir une URL d'image ?
                </h2>
                
                <div style={{ marginBottom: '1.5rem' }}>
                  <h3 style={{ fontSize: '1.1rem', color: '#3B82F6', marginBottom: '0.75rem', fontWeight: 700 }}>
                    üåê M√©thode 1 : Imgur (Recommand√©)
                  </h3>
                  
                  <div style={{ background: '#F0F9FF', padding: '1rem', borderRadius: '12px', marginBottom: '1rem' }}>
                    <div style={{ fontSize: '0.9rem', lineHeight: '1.6', color: '#1e293b' }}>
                      <strong style={{ color: '#3B82F6' }}>√âtape 1 :</strong> Allez sur <a href="https://imgur.com/upload" target="_blank" style={{ color: '#3B82F6', fontWeight: 600 }}>imgur.com/upload</a>
                    </div>
                  </div>
                  
                  <div style={{ background: '#F0F9FF', padding: '1rem', borderRadius: '12px', marginBottom: '1rem' }}>
                    <div style={{ fontSize: '0.9rem', lineHeight: '1.6', color: '#1e293b' }}>
                      <strong style={{ color: '#3B82F6' }}>√âtape 2 :</strong> Cliquez sur "New post" ou glissez votre image
                    </div>
                  </div>
                  
                  <div style={{ background: '#F0F9FF', padding: '1rem', borderRadius: '12px', marginBottom: '1rem' }}>
                    <div style={{ fontSize: '0.9rem', lineHeight: '1.6', color: '#1e293b' }}>
                      <strong style={{ color: '#3B82F6' }}>√âtape 3 :</strong> Une fois upload√©e, faites <strong>clic droit</strong> sur l'image ‚Üí "Copier l'adresse de l'image"
                    </div>
                  </div>
                  
                  <div style={{ padding: '1rem', background: '#FEE', borderRadius: '10px', fontSize: '0.85rem', lineHeight: '1.5', marginBottom: '1rem', border: '2px solid #EF4444' }}>
                    <strong style={{ color: '#C00' }}>‚ö†Ô∏è IMPORTANT - Diff√©rence d'URL :</strong><br/><br/>
                    <div style={{ fontFamily: 'monospace', fontSize: '0.8rem' }}>
                      ‚ùå <span style={{ color: '#C00', fontWeight: 'bold' }}>MAUVAISE</span> (URL de la page) :<br/>
                      <code style={{ background: 'white', padding: '0.2rem 0.4rem', borderRadius: '4px' }}>https://imgur.com/abc123</code><br/><br/>
                      
                      ‚úÖ <span style={{ color: '#10B981', fontWeight: 'bold' }}>BONNE</span> (URL directe) :<br/>
                      <code style={{ background: 'white', padding: '0.2rem 0.4rem', borderRadius: '4px' }}>https://i.imgur.com/abc123.jpg</code>
                    </div>
                    <div style={{ marginTop: '0.75rem', fontSize: '0.85rem', color: '#92400E' }}>
                      üí° Notez le <strong>"i."</strong> au d√©but et <strong>".jpg"</strong> √† la fin !
                    </div>
                  </div>
                  
                  <div style={{ background: '#F0F9FF', padding: '1rem', borderRadius: '12px', marginBottom: '1rem' }}>
                    <div style={{ fontSize: '0.9rem', lineHeight: '1.6', color: '#1e293b' }}>
                      <strong style={{ color: '#3B82F6' }}>√âtape 4 :</strong> Collez l'URL dans PharmaSpace !
                    </div>
                  </div>
                  
                  <div style={{ padding: '0.75rem', background: '#DBEAFE', borderRadius: '8px', fontSize: '0.85rem', color: '#1e40af', marginTop: '0.75rem' }}>
                    ‚úÖ L'URL ressemble √† : <code style={{ background: 'white', padding: '0.2rem 0.4rem', borderRadius: '4px', fontFamily: 'monospace' }}>https://i.imgur.com/abc123.jpg</code>
                  </div>
                </div>
                
                <div style={{ marginBottom: '1.5rem' }}>
                  <h3 style={{ fontSize: '1.1rem', color: '#10B981', marginBottom: '0.75rem', fontWeight: 700 }}>
                    üñºÔ∏è M√©thode 2 : Autres services
                  </h3>
                  
                  <div style={{ fontSize: '0.9rem', lineHeight: '1.6', color: '#64748b' }}>
                    ‚Ä¢ <strong>imgbb.com</strong> - Gratuit, sans compte<br/>
                    ‚Ä¢ <strong>Google Photos</strong> - Si vous avez un compte Google<br/>
                    ‚Ä¢ <strong>Cloudinary</strong> - Pour usage avanc√©<br/>
                  </div>
                </div>
                
                <div style={{ padding: '1rem', background: '#FEF3C7', borderRadius: '10px', fontSize: '0.85rem', color: '#92400E', lineHeight: '1.5', marginBottom: '1.5rem' }}>
                  <strong>üí° Astuce :</strong> Avec des URLs, vous pouvez avoir <strong>272 images</strong> sans limite de stockage ! Une seule image est charg√©e √† la fois depuis internet.
                </div>
                
                <div style={{ padding: '1rem', background: '#FEE', borderRadius: '10px', fontSize: '0.85rem', color: '#C00', lineHeight: '1.5', marginBottom: '1.5rem' }}>
                  <strong>‚ö†Ô∏è Important :</strong> Vous aurez besoin d'une connexion internet pour voir les images. Les images upload√©es via "üìÅ Fichier" fonctionnent hors ligne.
                </div>
                
                <button onClick={() => setShowImgurGuide(false)} className="button-hover" style={{ width: '100%', padding: '1rem', background: '#3B82F6', border: 'none', borderRadius: '12px', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '1rem' }}>
                  J'ai compris !
                </button>
              </div>
            </div>
          )}

          {/* MODAL SETTINGS */}
          {showSettings && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', zIndex: 1000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '1rem' }} onClick={() => { setShowSettings(false); setSelectionMode('all'); }}>
              <div onClick={(e) => e.stopPropagation()} style={{ background: 'white', borderRadius: '20px', padding: '2rem', maxWidth: '600px', width: '100%', maxHeight: '90vh', overflowY: 'auto' }}>
                <h2 style={{ fontSize: '1.5rem', marginBottom: '1.5rem', color: '#1e293b' }}>
                  S√©lection
                </h2>
                
                <div style={{ marginBottom: '1.5rem' }}>
                  
                  <div style={{ marginBottom: '1rem' }}>
                    <label style={{ display: 'flex', alignItems: 'center', padding: '1rem', background: selectionMode === 'all' ? '#EFF6FF' : 'white', border: `2px solid ${selectionMode === 'all' ? '#3B82F6' : '#e2e8f0'}`, borderRadius: '12px', cursor: 'pointer', marginBottom: '0.5rem' }}>
                      <input type="radio" name="mode" value="all" checked={selectionMode === 'all'} onChange={(e) => setSelectionMode(e.target.value)} style={{ marginRight: '0.75rem' }} />
                      <span style={{ fontWeight: 600, color: '#1e293b' }}>
                        Tous les m√©dicaments ({medications.length})
                      </span>
                    </label>
                    
                    <label style={{ display: 'flex', alignItems: 'center', padding: '1rem', background: selectionMode === 'class' ? '#EFF6FF' : 'white', border: `2px solid ${selectionMode === 'class' ? '#3B82F6' : '#e2e8f0'}`, borderRadius: '12px', cursor: 'pointer', marginBottom: '0.5rem' }}>
                      <input type="radio" name="mode" value="class" checked={selectionMode === 'class'} onChange={(e) => setSelectionMode(e.target.value)} style={{ marginRight: '0.75rem' }} />
                      <span style={{ fontWeight: 600, color: '#1e293b' }}>S√©lection par classe</span>
                    </label>
                    
                    <label style={{ display: 'flex', alignItems: 'center', padding: '1rem', background: selectionMode === 'custom' ? '#EFF6FF' : 'white', border: `2px solid ${selectionMode === 'custom' ? '#3B82F6' : '#e2e8f0'}`, borderRadius: '12px', cursor: 'pointer' }}>
                      <input type="radio" name="mode" value="custom" checked={selectionMode === 'custom'} onChange={(e) => setSelectionMode(e.target.value)} style={{ marginRight: '0.75rem' }} />
                      <span style={{ fontWeight: 600, color: '#1e293b' }}>S√©lection personnalis√©e</span>
                    </label>
                  </div>

                  {selectionMode === 'class' && (
                    <div style={{ padding: '1rem', background: '#f8fafc', borderRadius: '12px', border: '2px solid #e2e8f0' }}>
                      <div style={{ fontSize: '0.85rem', color: '#64748b', marginBottom: '0.75rem', fontWeight: 600 }}>Classes th√©rapeutiques :</div>
                      <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                        {getCategories().map(cat => {
                          const count = medications.filter(m => m.category === cat).length;
                          const isSelected = selectedClasses.includes(cat);
                          return (
                            <button 
                              key={cat}
                              onClick={() => setSelectedClasses(
                                isSelected 
                                  ? selectedClasses.filter(c => c !== cat) 
                                  : [...selectedClasses, cat]
                              )}
                              style={{ 
                                padding: '0.5rem 1rem', 
                                background: isSelected ? getClassColor(cat) : 'white', 
                                border: `2px solid ${getClassColor(cat)}`, 
                                borderRadius: '8px', 
                                color: isSelected ? 'white' : getClassColor(cat), 
                                cursor: 'pointer', 
                                fontWeight: 600, 
                                fontSize: '0.85rem',
                                transition: 'all 0.2s'
                              }}
                            >
                              {cat} ({count})
                            </button>
                          );
                        })}
                      </div>
                    </div>
                  )}
                  
                  {selectionMode === 'custom' && mode === 'flashcard' && (
                    <div style={{ padding: '1rem', background: '#f8fafc', borderRadius: '12px', border: '2px solid #e2e8f0', maxHeight: '300px', overflowY: 'auto' }}>
                      <div style={{ fontSize: '0.85rem', color: '#64748b', marginBottom: '0.75rem', fontWeight: 600 }}>
                        S√©lectionnez les m√©dicaments ({selectedMeds.length} s√©lectionn√©{selectedMeds.length > 1 ? 's' : ''}) :
                      </div>
                      {medications.map((med, idx) => {
                        const isSelected = selectedMeds.includes(idx);
                        return (
                          <label 
                            key={idx} 
                            style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              padding: '0.75rem', 
                              background: isSelected ? `${getClassColor(med.category)}20` : 'white', 
                              border: `2px solid ${isSelected ? getClassColor(med.category) : '#e2e8f0'}`,
                              borderRadius: '8px', 
                              marginBottom: '0.5rem', 
                              cursor: 'pointer',
                              transition: 'all 0.2s'
                            }}
                          >
                            <input 
                              type="checkbox" 
                              checked={isSelected}
                              onChange={() => setSelectedMeds(
                                isSelected 
                                  ? selectedMeds.filter(i => i !== idx)
                                  : [...selectedMeds, idx]
                              )}
                              style={{ marginRight: '0.75rem', width: '18px', height: '18px', cursor: 'pointer' }}
                            />
                            <div style={{ flex: 1 }}>
                              <div style={{ fontWeight: 600, color: '#1e293b', fontSize: '0.9rem' }}>{med.commercial.join(' ‚Ä¢ ')}</div>
                              <div style={{ fontSize: '0.8rem', color: '#64748b' }}>{med.dci}</div>
                            </div>
                            
                          </label>
                        );
                      })}
                    </div>
                  )}
                </div>

                <div style={{ display: 'flex', gap: '1rem' }}>
                  <button onClick={() => { setShowSettings(false); setSelectionMode('all'); }} className="button-hover" style={{ flex: 1, padding: '1rem', background: '#e2e8f0', border: 'none', borderRadius: '12px', color: '#1e293b', cursor: 'pointer', fontWeight: 600 }}>
                    Annuler
                  </button>
                  <button onClick={applySelection} className="button-hover" style={{ flex: 1, padding: '1rem', background: '#334155', border: 'none', borderRadius: '12px', color: 'white', cursor: 'pointer', fontWeight: 600 }}>
                    'Appliquer'
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* MODAL GESTION */}
          {showManagement && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', zIndex: 1000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '1rem' }} onClick={() => { setShowManagement(false); cancelEdit(); setErrorMessage(''); setShowClassManager(false); setEditingClass(null); }}>
              <div onClick={(e) => e.stopPropagation()} style={{ background: 'white', borderRadius: '20px', padding: '2rem', maxWidth: '700px', width: '100%', maxHeight: '90vh', overflowY: 'auto' }}>
                <h2 style={{ fontSize: '1.5rem', marginBottom: '1.5rem', color: '#1e293b' }}>Gestion des cartes</h2>

                <div style={{ marginBottom: '1rem' }}>
                  <input type="text" placeholder="üîç Rechercher un m√©dicament..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} style={{ width: '100%', padding: '0.75rem', border: '2px solid #3B82F6', borderRadius: '8px', fontSize: '0.9rem', outline: 'none' }} />
                </div>

                {errorMessage && (
                  <div style={{ padding: '1rem', background: '#FEE2E2', border: '2px solid #DC2626', borderRadius: '8px', color: '#991B1B', marginBottom: '1rem', fontSize: '0.9rem' }}>
                    {errorMessage}
                  </div>
                )}

                <div style={{ padding: '1.5rem', background: editingIndex !== null ? '#FEF3C7' : '#f8fafc', borderRadius: '12px', marginBottom: '1.5rem', border: editingIndex !== null ? '2px solid #F59E0B' : 'none' }}>
                  <h3 style={{ fontSize: '1rem', marginBottom: '1rem', color: '#1e293b' }}>
                    {editingIndex !== null ? '‚úèÔ∏è Modifier' : '‚ûï Ajouter'}
                  </h3>
                  
                  <input type="text" placeholder="DCI *" value={customMed.dci} onChange={(e) => setCustomMed({...customMed, dci: e.target.value})} style={{ width: '100%', padding: '0.75rem', border: '2px solid #e2e8f0', borderRadius: '8px', marginBottom: '0.75rem', fontSize: '0.9rem' }} />
                  
                  <input type="text" placeholder="Nom(s) commercial(aux) s√©par√©s par des virgules *" value={customMed.commercial} onChange={(e) => setCustomMed({...customMed, commercial: e.target.value})} style={{ width: '100%', padding: '0.75rem', border: '2px solid #e2e8f0', borderRadius: '8px', marginBottom: '0.75rem', fontSize: '0.9rem' }} />
                  
                  <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.75rem' }}>
                    <select value={customMed.category} onChange={(e) => setCustomMed({...customMed, category: e.target.value})} style={{ flex: 1, padding: '0.75rem', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '0.9rem', cursor: 'pointer' }}>
                      <option value="">-- S√©lectionner --</option>
                      {getCategories().map(cat => (
                        <option key={cat} value={cat}>{cat}</option>
                      ))}
                    </select>
                    <button onClick={() => setShowClassManager(!showClassManager)} className="button-hover" style={{ padding: '0.75rem', background: showClassManager ? '#3B82F6' : '#e2e8f0', border: 'none', borderRadius: '8px', color: showClassManager ? 'white' : '#64748b', cursor: 'pointer', fontWeight: 600, fontSize: '0.85rem' }}>
                      Modifier
                    </button>
                  </div>
                  
                  {showClassManager && (
                    <div style={{ padding: '1rem', background: 'white', borderRadius: '8px', marginBottom: '0.75rem', border: '2px solid #3B82F6' }}>
                      <div style={{ fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem', color: '#1e293b' }}>Ajouter une nouvelle classe</div>
                      <input type="text" placeholder="Nom de la classe" value={newClassName} onChange={(e) => setNewClassName(e.target.value)} style={{ width: '100%', padding: '0.5rem', border: '2px solid #e2e8f0', borderRadius: '6px', marginBottom: '0.5rem', fontSize: '0.85rem' }} />
                      <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem' }}>
                        <input type="color" value={newClassColor} onChange={(e) => setNewClassColor(e.target.value)} style={{ width: '40px', height: '40px', border: 'none', borderRadius: '6px', cursor: 'pointer' }} />
                        <div style={{ flex: 1, padding: '0.5rem', background: newClassColor, borderRadius: '6px', color: 'white', textAlign: 'center', fontWeight: 600, fontSize: '0.85rem' }}>
                          Aper√ßu
                        </div>
                      </div>
                      <button onClick={addNewClass} className="button-hover" style={{ width: '100%', padding: '0.5rem', background: '#10B981', border: 'none', borderRadius: '6px', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '0.85rem' }}>
                        Ajouter
                      </button>
                      
                      <div style={{ marginTop: '1rem', paddingTop: '1rem', borderTop: '1px solid #e2e8f0' }}>
                        <div style={{ fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem', color: '#1e293b' }}>G√©rer les classes existantes</div>
                        {Object.entries(therapeuticClasses).map(([className, color]) => {
                          const isEditing = editingClass === className;
                          const medsInClass = medications.filter(m => m.category === className).length;
                          return (
                            <div key={className} style={{ padding: '0.5rem', background: isEditing ? '#FEF3C7' : '#f8fafc', borderRadius: '6px', marginBottom: '0.5rem', border: isEditing ? '2px solid #F59E0B' : '1px solid #e2e8f0' }}>
                              {isEditing ? (
                                <div>
                                  <input type="text" defaultValue={className} id={`edit-${className}`} style={{ width: '100%', padding: '0.4rem', border: '1px solid #e2e8f0', borderRadius: '4px', marginBottom: '0.3rem', fontSize: '0.8rem' }} />
                                  <div style={{ display: 'flex', gap: '0.3rem', marginBottom: '0.3rem' }}>
                                    <input type="color" defaultValue={color} id={`color-${className}`} style={{ width: '30px', height: '30px', border: 'none', borderRadius: '4px' }} />
                                    <div style={{ flex: 1, padding: '0.3rem', background: color, borderRadius: '4px', color: 'white', textAlign: 'center', fontSize: '0.75rem', fontWeight: '600' }}>
                                      Aper√ßu
                                    </div>
                                  </div>
                                  <div style={{ display: 'flex', gap: '0.3rem' }}>
                                    <button onClick={() => { const newName = document.getElementById(`edit-${className}`).value; const newColor = document.getElementById(`color-${className}`).value; updateClass(className, newName, newColor); }} className="button-hover" style={{ flex: 1, padding: '0.4rem', background: '#10B981', border: 'none', borderRadius: '4px', color: 'white', cursor: 'pointer', fontSize: '0.75rem', fontWeight: 600 }}>
                                      Valider
                                    </button>
                                    <button onClick={() => setEditingClass(null)} className="button-hover" style={{ flex: 1, padding: '0.4rem', background: '#e2e8f0', border: 'none', borderRadius: '4px', color: '#64748b', cursor: 'pointer', fontSize: '0.75rem', fontWeight: 600 }}>
                                      Annuler
                                    </button>
                                  </div>
                                </div>
                              ) : (
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                  <div style={{ width: '20px', height: '20px', background: color, borderRadius: '4px' }} />
                                  <span style={{ flex: 1, fontSize: '0.85rem', fontWeight: 600, color: '#1e293b' }}>{className} ({medsInClass})</span>
                                  <button onClick={() => setEditingClass(className)} className="button-hover" style={{ padding: '0.3rem', background: '#DBEAFE', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                                    <Edit size={12} color="#1E40AF" />
                                  </button>
                                  <button type="button" onClick={() => {
                                    console.log('className:', className);
                                    const medsCount = medications.filter(m => m.category === className).length;
                                    console.log('Nombre de m√©dicaments avec cette classe:', medsCount);
                                    if (medsCount > 0) {
                                      const updatedMeds = medications.map(med => 
                                        med.category === className ? {...med, category: 'Non attribu√©e'} : med
                                      );
                                      setMedications(updatedMeds);
                                      if (!therapeuticClasses['Non attribu√©e']) {
                                        setTherapeuticClasses({...therapeuticClasses, 'Non attribu√©e': '#9CA3AF'});
                                      }
                                    }
                                    console.log('Suppression directe');
                                    const updated = {...therapeuticClasses};
                                    delete updated[className];
                                    console.log('Nouveau dictionnaire de classes:', updated);
                                    setTherapeuticClasses(updated);
                                    console.log('Suppression classe termin√©e');
                                  }} className="button-hover" style={{ padding: '0.3rem', background: '#FEE2E2', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                                    <Trash2 size={12} color="#DC2626" />
                                  </button>
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                  
                  <div style={{ marginBottom: '1rem' }}>
                    <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.85rem', fontWeight: 600, color: '#64748b' }}>
                      üì∏ URLs des images (optionnel)
                    </label>
                    <textarea 
                      placeholder="Une URL par ligne&#10;https://example.com/image1.jpg&#10;https://example.com/image2.jpg"
                      value={customMed.imageUrls}
                      onChange={(e) => setCustomMed({...customMed, imageUrls: e.target.value})}
                      style={{ width: '100%', padding: '0.75rem', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '0.9rem', minHeight: '80px', fontFamily: 'monospace' }}
                    />
                    {customMed.imageUrls && customMed.imageUrls.split('\n').filter(s => s.trim()).length > 0 && (
                      <div style={{ marginTop: '0.5rem', padding: '0.75rem', background: '#F0F9FF', borderRadius: '8px', border: '2px solid #3B82F6' }}>
                        <div style={{ fontSize: '0.75rem', color: '#64748b', marginBottom: '0.5rem', fontWeight: 600 }}>
                          üì∏ Aper√ßu ({customMed.imageUrls.split('\n').filter(s => s.trim()).length} image(s))
                        </div>
                        <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                          {customMed.imageUrls.split('\n').filter(s => s.trim()).map((url, idx) => (
                            <img 
                              key={idx}
                              src={url.trim()} 
                              alt={`Aper√ßu ${idx+1}`}
                              style={{ maxWidth: '80px', maxHeight: '80px', objectFit: 'contain', borderRadius: '4px', background: 'white', border: '1px solid #e2e8f0' }}
                              onError={(e) => { e.target.style.border = '2px solid #EF4444'; }}
                            />
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                  
                  <div style={{ marginBottom: '1rem' }}>
                    <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.85rem', fontWeight: 600, color: '#64748b' }}>
                      üíä Forme(s) pharmaceutique(s) (optionnel)
                    </label>
                    
                    {/* FORMES S√âLECTIONN√âES DANS L'ORDRE */}
                    {customMed.pharmaceuticalForm && (
                      <div style={{ marginBottom: '0.75rem', padding: '0.75rem', background: '#f8fafc', borderRadius: '8px', border: '2px solid #3B82F6' }}>
                        <div style={{ fontSize: '0.75rem', fontWeight: 600, color: '#64748b', marginBottom: '0.5rem' }}>
                          Formes s√©lectionn√©es (ordre = ordre des images):
                        </div>
                        <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap', alignItems: 'center' }}>
                          {customMed.pharmaceuticalForm.split(',').map((form, idx) => (
                            <div key={idx} style={{ display: 'flex', alignItems: 'center', gap: '0.25rem', padding: '0.5rem 0.75rem', background: '#3B82F6', color: 'white', borderRadius: '8px', fontSize: '0.85rem', fontWeight: 600 }}>
                              <span style={{ fontSize: '0.7rem', opacity: 0.8 }}>#{idx + 1}</span>
                              <span>{form.trim()}</span>
                              <button
                                type="button"
                                onClick={() => {
                                  const forms = customMed.pharmaceuticalForm.split(',').map(f => f.trim());
                                  forms.splice(idx, 1);
                                  setCustomMed({...customMed, pharmaceuticalForm: forms.join(', ')});
                                }}
                                style={{ marginLeft: '0.25rem', background: 'transparent', border: 'none', color: 'white', cursor: 'pointer', padding: '0.1rem', lineHeight: 1 }}
                              >
                                ‚úï
                              </button>
                            </div>
                          ))}
                          <button
                            type="button"
                            onClick={() => setCustomMed({...customMed, pharmaceuticalForm: ''})}
                            className="button-hover"
                            style={{ padding: '0.5rem 0.75rem', background: '#FEE2E2', border: 'none', borderRadius: '8px', color: '#DC2626', cursor: 'pointer', fontSize: '0.75rem', fontWeight: 600 }}
                          >
                            Tout effacer
                          </button>
                        </div>
                      </div>
                    )}
                    
                    {/* DROPDOWN COMPACT POUR AJOUTER DES FORMES */}
                    <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.75rem' }}>
                      <select
                        value=""
                        onChange={(e) => {
                          if (e.target.value) {
                            const currentForms = customMed.pharmaceuticalForm ? customMed.pharmaceuticalForm.split(',').map(f => f.trim()) : [];
                            currentForms.push(e.target.value);
                            setCustomMed({...customMed, pharmaceuticalForm: currentForms.join(', ')});
                            e.target.value = ''; // Reset
                          }
                        }}
                        style={{ 
                          flex: 1, 
                          padding: '0.75rem', 
                          border: '2px solid #e2e8f0', 
                          borderRadius: '8px', 
                          fontSize: '0.9rem',
                          cursor: 'pointer',
                          background: 'white'
                        }}
                      >
                        <option value="">‚ûï Ajouter une forme...</option>
                        {pharmaceuticalForms.sort().map(form => {
                          const isSelected = customMed.pharmaceuticalForm && customMed.pharmaceuticalForm.split(',').map(f => f.trim()).includes(form);
                          return (
                            <option key={form} value={form}>
                              {isSelected ? '‚úì ' : ''}{form}
                            </option>
                          );
                        })}
                      </select>
                      <button 
                        onClick={() => setShowFormManager(!showFormManager)} 
                        className="button-hover" 
                        style={{ 
                          padding: '0.75rem', 
                          background: showFormManager ? '#3B82F6' : '#e2e8f0', 
                          border: 'none', 
                          borderRadius: '8px', 
                          color: showFormManager ? 'white' : '#64748b', 
                          cursor: 'pointer', 
                          fontWeight: 600, 
                          fontSize: '0.85rem' 
                        }}
                      >
                        G√©rer
                      </button>
                    </div>
                    <div style={{ fontSize: '0.75rem', color: '#64748b', fontStyle: 'italic' }}>
                      üí° S√©lectionnez les formes dans l'ordre de vos images. #1 = 1√®re image, #2 = 2√®me image, etc.
                    </div>
                    
                    {showFormManager && (
                      <div style={{ padding: '1rem', background: 'white', borderRadius: '8px', marginTop: '0.75rem', border: '2px solid #3B82F6' }}>
                        <div style={{ fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem', color: '#1e293b' }}>Ajouter une nouvelle forme</div>
                        <input 
                          type="text" 
                          placeholder="Nom de la forme" 
                          value={newFormName} 
                          onChange={(e) => setNewFormName(e.target.value)} 
                          style={{ width: '100%', padding: '0.5rem', border: '2px solid #e2e8f0', borderRadius: '6px', marginBottom: '0.5rem', fontSize: '0.85rem' }} 
                        />
                        <button 
                          onClick={() => {
                            if (!newFormName.trim()) {
                              alert('Le nom de la forme est obligatoire');
                              return;
                            }
                            if (pharmaceuticalForms.includes(newFormName.trim())) {
                              alert('Cette forme existe d√©j√†');
                              return;
                            }
                            setPharmaceuticalForms([...pharmaceuticalForms, newFormName.trim()]);
                            setNewFormName('');
                          }} 
                          className="button-hover" 
                          style={{ width: '100%', padding: '0.5rem', background: '#10B981', border: 'none', borderRadius: '6px', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '0.85rem' }}
                        >
                          Ajouter
                        </button>
                        
                        <div style={{ marginTop: '1rem', paddingTop: '1rem', borderTop: '1px solid #e2e8f0' }}>
                          <div style={{ fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem', color: '#1e293b' }}>G√©rer les formes existantes</div>
                          <div style={{ maxHeight: '200px', overflowY: 'auto' }}>
                            {pharmaceuticalForms.sort().map((form) => {
                              const isEditing = editingForm === form;
                              const medsWithForm = medications.filter(m => m.pharmaceuticalForm && m.pharmaceuticalForm.includes(form)).length;
                              return (
                                <div key={form} style={{ padding: '0.5rem', background: isEditing ? '#FEF3C7' : '#f8fafc', borderRadius: '6px', marginBottom: '0.5rem', border: isEditing ? '2px solid #F59E0B' : '1px solid #e2e8f0' }}>
                                  {isEditing ? (
                                    <div>
                                      <input 
                                        type="text" 
                                        defaultValue={form} 
                                        id={`edit-form-${form}`} 
                                        style={{ width: '100%', padding: '0.4rem', border: '1px solid #e2e8f0', borderRadius: '4px', marginBottom: '0.3rem', fontSize: '0.8rem' }} 
                                      />
                                      <div style={{ display: 'flex', gap: '0.3rem' }}>
                                        <button 
                                          onClick={() => {
                                            const newName = document.getElementById(`edit-form-${form}`).value.trim();
                                            if (!newName) {
                                              alert('Le nom ne peut pas √™tre vide');
                                              return;
                                            }
                                            if (newName !== form && pharmaceuticalForms.includes(newName)) {
                                              alert('Cette forme existe d√©j√†');
                                              return;
                                            }
                                            // Mettre √† jour la forme dans les m√©dicaments
                                            const updatedMeds = medications.map(med => {
                                              if (med.pharmaceuticalForm && med.pharmaceuticalForm.includes(form)) {
                                                const forms = med.pharmaceuticalForm.split(',').map(f => f.trim());
                                                const newForms = forms.map(f => f === form ? newName : f);
                                                return {...med, pharmaceuticalForm: newForms.join(', ')};
                                              }
                                              return med;
                                            });
                                            setMedications(updatedMeds);
                                            // Mettre √† jour la liste des formes
                                            const updatedForms = pharmaceuticalForms.map(f => f === form ? newName : f);
                                            setPharmaceuticalForms(updatedForms);
                                            setEditingForm(null);
                                          }} 
                                          className="button-hover" 
                                          style={{ flex: 1, padding: '0.4rem', background: '#10B981', border: 'none', borderRadius: '4px', color: 'white', cursor: 'pointer', fontSize: '0.75rem', fontWeight: 600 }}
                                        >
                                          Valider
                                        </button>
                                        <button 
                                          onClick={() => setEditingForm(null)} 
                                          className="button-hover" 
                                          style={{ flex: 1, padding: '0.4rem', background: '#e2e8f0', border: 'none', borderRadius: '4px', color: '#64748b', cursor: 'pointer', fontSize: '0.75rem', fontWeight: 600 }}
                                        >
                                          Annuler
                                        </button>
                                      </div>
                                    </div>
                                  ) : (
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                      <span style={{ flex: 1, fontSize: '0.85rem', fontWeight: 600, color: '#1e293b' }}>{form} ({medsWithForm})</span>
                                      <button 
                                        onClick={() => setEditingForm(form)} 
                                        className="button-hover" 
                                        style={{ padding: '0.3rem', background: '#DBEAFE', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
                                      >
                                        <Edit size={12} color="#1E40AF" />
                                      </button>
                                      <button 
                                        type="button" 
                                        onClick={() => {
                                          if (medsWithForm > 0 && !confirm(`${medsWithForm} m√©dicament(s) utilisent cette forme. Voulez-vous vraiment la supprimer ?`)) {
                                            return;
                                          }
                                          // Supprimer la forme de tous les m√©dicaments
                                          const updatedMeds = medications.map(med => {
                                            if (med.pharmaceuticalForm && med.pharmaceuticalForm.includes(form)) {
                                              const forms = med.pharmaceuticalForm.split(',').map(f => f.trim()).filter(f => f !== form);
                                              return {...med, pharmaceuticalForm: forms.join(', ')};
                                            }
                                            return med;
                                          });
                                          setMedications(updatedMeds);
                                          // Supprimer de la liste
                                          setPharmaceuticalForms(pharmaceuticalForms.filter(f => f !== form));
                                        }} 
                                        className="button-hover" 
                                        style={{ padding: '0.3rem', background: '#FEE2E2', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
                                      >
                                        <Trash2 size={12} color="#DC2626" />
                                      </button>
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                  
                  <div style={{ display: 'flex', gap: '0.5rem' }}>
                    {editingIndex !== null && (
                      <button onClick={cancelEdit} className="button-hover" style={{ flex: 1, padding: '0.75rem', background: '#e2e8f0', border: 'none', borderRadius: '8px', color: '#64748b', cursor: 'pointer', fontWeight: 600, fontSize: '0.9rem' }}>
                        Annuler
                      </button>
                    )}
                    <button  onClick={saveMedication} className="button-hover" style={{ flex: 1, padding: '0.75rem', background: '#10B981', border: 'none', borderRadius: '8px', color: 'white', cursor: 'pointer', fontWeight: 600, fontSize: '0.9rem' }}>
                      {editingIndex !== null ? 'Modifier' : 'Ajouter'}
                    </button>
                  </div>
                </div>

                <div style={{ marginBottom: '1rem' }}>
                  <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.75rem' }}>
                    <select value={sortBy} onChange={(e) => setSortBy(e.target.value)} style={{ flex: 1, padding: '0.5rem', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '0.85rem', cursor: 'pointer' }}>
                      <option value="dci">Trier par: DCI</option>
                      <option value="commercial">Trier par: Nom commercial</option>
                      <option value="category">Trier par: Classe</option>
                      <option value="form">Trier par: Forme</option>
                    </select>
                    <select value={filterCategory} onChange={(e) => setFilterCategory(e.target.value)} style={{ flex: 1, padding: '0.5rem', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '0.85rem', cursor: 'pointer' }}>
                      <option value="all">Toutes les classes</option>
                      {getCategories().map(cat => (
                        <option key={cat} value={cat}>{cat}</option>
                      ))}
                    </select>
                  </div>
                </div>

                <div style={{ maxHeight: '300px', overflowY: 'auto', marginBottom: '1rem' }}>
                  {getSortedMedications().map((med, i) => {
                    const originalIndex = medications.indexOf(med);
                    const isEditing = editingIndex === originalIndex;
                    return (
                      <div key={i} style={{ padding: '1rem', background: isEditing ? '#FEF3C7' : 'white', border: `2px solid ${getClassColor(med.category)}`, borderRadius: '8px', marginBottom: '0.5rem', display: 'flex', gap: '1rem', alignItems: 'center' }}>
                        {(() => {
                          const images = (med.imageUrls || (med.imageUrl ? [med.imageUrl] : (med.image ? [med.image] : []))).filter(Boolean);
                          return images.length > 0 ? (
                            <div style={{ position: 'relative' }}>
                              <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.25rem', width: '50px' }}>
                                {images.map((img, idx) => (
                                  <img 
                                    key={idx}
                                    src={img} 
                                    alt={`${med.dci} ${idx+1}`}
                                    style={{ 
                                      width: images.length === 1 ? '50px' : '24px', 
                                      height: images.length === 1 ? '50px' : '24px', 
                                      objectFit: 'cover', 
                                      borderRadius: '6px', 
                                      border: `2px solid ${getClassColor(med.category)}` 
                                    }} 
                                  />
                                ))}
                              </div>
                              <div style={{ position: 'absolute', bottom: -4, right: -4, width: '20px', height: '20px', background: '#10B981', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                <Camera size={12} color="white" />
                              </div>
                            </div>
                          ) : (
                            <div style={{ width: '50px', height: '50px', background: '#f1f5f9', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#cbd5e1' }}>
                              <ImagePlaceholder />
                            </div>
                          );
                        })()}
                        <div style={{ flex: 1 }}>
                          <div style={{ fontSize: '0.9rem', fontWeight: 700, color: '#1e293b' }}>{med.commercial.join(' ‚Ä¢ ')}</div>
                          <div style={{ fontSize: '0.8rem', color: '#64748b' }}>{med.dci}</div>
                          <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center', marginTop: '0.25rem', flexWrap: 'wrap' }}>
                            <div style={{ display: 'inline-block', padding: '0.2rem 0.5rem', background: `${getClassColor(med.category)}20`, borderRadius: '8px', color: getClassColor(med.category), fontSize: '0.7rem', fontWeight: 600 }}>
                              {med.category}
                            </div>
                            {med.pharmaceuticalForm && (
                              <div style={{ fontSize: '0.7rem', color: '#64748b', fontStyle: 'italic' }}>
                                {[...new Set(med.pharmaceuticalForm.split(',').map(f => f.trim()))].join(', ')}
                              </div>
                            )}
                          </div>
                          
                        </div>
                        <div style={{ display: 'flex', gap: '0.5rem' }}>
                          <button type="button" onClick={() => startEditMedication(originalIndex)} className="button-hover" style={{ padding: '0.5rem', background: isEditing ? '#F59E0B' : '#DBEAFE', border: 'none', borderRadius: '6px', color: isEditing ? 'white' : '#1E40AF', cursor: 'pointer' }}>
                            <Edit size={16} />
                          </button>
                          <button type="button" onClick={() => {
                            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer ${med.commercial.join(', ')} (${med.dci}) ?\n\nCette action est irr√©versible.`)) {
                              return;
                            }
                            console.log('originalIndex:', originalIndex);
                            console.log('med:', med);
                            console.log('medications actuel:', medications);
                            console.log('medications.length:', medications.length);
                            console.log('Suppression confirm√©e');
                            const newMeds = medications.filter((_, idx) => idx !== originalIndex);
                            console.log('Nouveau tableau:', newMeds);
                            console.log('Nouvelle longueur:', newMeds.length);
                            setMedications(newMeds);
                            if (editingIndex === originalIndex) cancelEdit();
                            console.log('Suppression termin√©e');
                          }} className="button-hover" style={{ padding: '0.5rem', background: '#FEE2E2', border: 'none', borderRadius: '6px', color: '#DC2626', cursor: 'pointer' }}>
                            <Trash2 size={16} />
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>

                <button onClick={() => { setShowManagement(false); cancelEdit(); setErrorMessage(''); setShowClassManager(false); setEditingClass(null); }} className="button-hover" style={{ width: '100%', marginTop: '1rem', padding: '1rem', background: '#e2e8f0', border: 'none', borderRadius: '12px', color: '#1e293b', cursor: 'pointer', fontWeight: 600 }}>
                  Fermer
                </button>
              </div>
            </div>
          )}
          </div>
          </>
        ) : (
          <ConseilsOfficine onReturnToMenu={() => setMode('menu')} medications={medications} />
        )}
      </div>
    </div>
  );
}


    ReactDOM.createRoot(document.getElementById('root')).render(<PharmaSpace />);
  </script>
</body>
</html>